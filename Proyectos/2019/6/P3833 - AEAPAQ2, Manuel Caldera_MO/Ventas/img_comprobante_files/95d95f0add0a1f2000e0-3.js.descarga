webpackJsonp([3],{1213:function(e,t){},1214:function(e,t){Daria.utils=Daria.utils||{},Daria.utils.dirname=function(e){e=e||"";var t="/"===e.charAt(0),o=$.grep(e.split("/"),(function(e){return e.length}));return o.pop(),(t?"/":"")+o.join("/")},Daria.utils.checkReplaceFakeMessage=function(e){if("message"===ns.page.current.page)return!1;if("yes"!==ns.page.current.params.threaded)return!1;if(!ns.Model.get("settings").isThreaded())return!1;var t=no.jpath(".message.hdr_message_id",e),o=no.jpath(".message.mid",e),n=no.jpath(".message.thread_id",e);return!!(n&&t&&o)&&!!ns.Model.get("messages",{thread_id:"t"+n}).isValid()},Daria.utils.getNarodHTML=function(e){var t=' href="'.concat(e.narodUrl,'"'),o=e.previewSrc?' data-preview="'.concat(encodeURIComponent(e.previewSrc),'"'):"",n=e.size?" (".concat(e.size,")"):"",s=e.folder?" (".concat(i18n("%Attachments_Disk_folder"),")"):"",i="".concat(e.name).concat(n).concat(s);return"<a".concat(' class="narod-attachment"').concat(' target="_blank" rel="noopener noreferrer"').concat(t).concat(o,">").concat(i,"</a><br>")}},1215:function(e,t){Daria.UI=Daria.UI||{},Daria.UI.IEvent=function(e){function t(t){return n[t]||(a[t]=e[t]||"unique",n[t]=$.Callbacks(a[t])),n[t]}function o(e){if(i[e]){for(var o=0,n=i[e].length;o<n;o++)t(e).add(i[e][o]);delete i[e]}}e=e||{};var n={},s={},i={},a={};return{_events:{lock:function(e){s[e]=!0,i[e]=[]},unlock:function(e){delete s[e]},empty:function(e){e?(t(e).empty(),delete i[e]):(n={},i={})}},on:function(e,o){if(s[e]){-1===$.inArray(o,i[e])&&i[e].push(o)}else t(e).add(o);return this},off:function(e,o){if(s[e]){var n=$.inArray(o,i[e]);-1!==n&&i[e].splice(n,1)}return t(e).remove(o),this},trigger:function(e,n){if(!s[e]){var i=a[e]&&-1!==a[e].indexOf("memory");i||o(e),t(e).fireWith(this,n),i&&o(e)}return this}}}},1216:function(e,t,o){Daria.ComposeComponents={},o(1217),o(1218),o(1219),o(1220),o(1221),o(1222),o(1223),o(1224),o(1225),o(1226),o(1227),o(1228),o(1229),o(1230),o(1231),o(1232),o(1234),o(1235),o(1236),o(1237),o(1238)},1217:function(e,t){Daria.FileSizer=function(e,t){var o=Daria.getRandomNumber(),n="attach-iframe-"+o;ns.events.on("attach-size:"+o,function(e,o){o>-1?(this.stop(),t(o)):this._getSizeAttempt()}.bind(this)),this.url="//filesize.mail.yandex.net/poster/"+o+"/",this.attachId=o,this.attempts=5,this.$iframe=$('<iframe class="g-hidden" name="'+n+'" src="javascript:false"/>').appendTo("body"),this.$form=$('<form class="g-hidden" method="post" enctype="multipart/form-data" action="'+this.url+'" target="'+n+'"/>').append(e).append('<input name="txt" value=""/>').appendTo("body").submit(),this._failTimer=window.setTimeout(this._fail.bind(this),5e3),this._getSizeAttempt()},Daria.FileSizer.prototype={_getSizeAttempt:function(){var e=this.url;this.attempts>0?(this.attempts--,this._getSizeTimer=window.setTimeout((function(){$.getScript(e)}),300)):this._fail()},_fail:function(){ns.events.trigger("attach-size:"+this.attachId,0)},stop:function(){this.$iframe&&(this.$iframe.remove(),delete this.$iframe),this.$form&&(this.$form.remove(),delete this.$iframe),ns.events.off("attach-size:"+this.attachId),window.clearTimeout(this._getSizeTimer),window.clearTimeout(this._failTimer)}},window.setFileSize=function(e,t){ns.events.trigger("attach-size:"+e,t)}},1218:function(e,t){ns.action.define("attachments.retry",(function(e,t){ns.events.trigger("daria:vComposeAttachArea:retryAttach",t)}))},1219:function(e,t){!(function(){var e={ATTACHING_TO_DISK:"ATTACHING_TO_DISK",ATTACHING_TO_DISK_FAILED:"ATTACHING_TO_DISK_FAILED"},t=Daria.Attachment2=function(e,t){this.bindMethodsToContext(),this._collection=t,this._aborted=!1,this.deleted=!1,this.info=e||{},"mail"===this.info.class&&"eml"!==Daria.getExtension(_.unescape(this.info.name))&&(this.info.name+=".eml"),ns.assert(e.mComposeMessage,"Daria.Attachment2",'"mComposeMessage" parameter is not passed to the constructor'),this.mComposeMessage=e.mComposeMessage,this._setAttachId(),this.info.name=_.unescape(this.info.name||this._getFileName()),this.info["name-uri-encoded"]=encodeURIComponent(this.info.name),this.info.extension=Daria.getExtensionInfo(this.info.name),this.info.class=this.info.class||this.info.extension.class,this.previewSupported=this.info.extension.preview||"audio"===this.info.class&&"mp3"===this.info.extension.icon,"narod"===this.type()&&(this.previewSupported=Boolean(this.info.narodPreview)),this._updatePreviewUrls(),this.status=this.info.type?this.ATTACH_STATUS_COMPLETED:this.ATTACH_STATUS_NEW,this._uploadDeferred=$.Deferred(),this._requests=[],this.getSize()};t.fromMessageBody=function(e,o,n){var s=e.narod,i={stid:o.getSTID(),mid:o.params.ids,bid:e.bid,hid:e.hid,name:_.unescape(e.name),"browser-supports":e["browser-supports"]};return s?(i.narodUrl=e.unsafeUrl,i.size=e.size,i.type="narod",i.folder=e.folder,i.narodPreview=e.preview):(i.size=parseInt(e.length,10),i.type="simple",i.class=e.class,i.message=Boolean(e.message),i.external_transformer=e.external_transformer,i.external_transformer_filetype=e.external_transformer_filetype),_.assign(i,_.pick(e,["from_template","template_mid","template_hid"])),i.mComposeMessage=n,new t(i)},t.METRIKA_EVENTS=e,t.prototype={ATTACH_STATUS_NEW:0,ATTACH_STATUS_UPLOADING:1,ATTACH_STATUS_COMPLETED:2,ATTACH_STATUS_FAILED:3,ATTACH_STATUS_VIRUS:4,_setAttachId:function(){this.info.id=Daria.getAttachId(this.info)},bindMethodsToContext:function(){this._updateShrinker=this._updateShrinker.bind(this)},isRegularFile:function(){var e=$.Deferred(),t=this.info.file;if(!t||Modernizr.webkit)return e.resolve(!0),e;if(!window.FileReader){var o=t.size,n=0===o||102===o||4096===o;return e.resolve(!(n&&""===t.type&&-1===t.name.indexOf("."))),e}if(window.opera&&navigator.platform.toLowerCase().indexOf("mac")>-1&&"12.00"===window.opera.version())e.resolve(null);else{if(t.size>4096)return e.resolve(!0),e;try{var s=new FileReader;s.onerror=function(){s.onloadend=s.onprogress=s.onerror=null,e.resolve(!1)},s.onloadend=s.onprogress=function(t){s.onloadend=s.onprogress=s.onerror=null;try{"loadend"!==t.type&&s.abort()}catch(e){}e.resolve(!0)},s.readAsDataURL(t)}catch(t){e.resolve(!1)}}return e},isCancelled:function(){return this._aborted||this.deleted},setNode:function(e){return this._$node&&this._$node.replaceWith(e),this._$node=e,this.bindEvents(),_.defer(this._updateShrinker),this.status===this.ATTACH_STATUS_FAILED&&this.setStatus(this.ATTACH_STATUS_FAILED),this._addToComposeMessage(),this.trigger("update"),this},bindEvents:function(){this._$node&&this._$node.on("click",".js-mark-deleted",this.markDeleted.bind(this)).on("click",".js-unmark-deleted",this.unmarkDeleted.bind(this)).on("click",".js-retry",this.retry.bind(this))},getNode:function(e){if(e||!this._$node){var t=this._collection?this._collection.templateMode:"compose2:attachments",o=Jane.tt(t,{attachment:[this.getJSONForTransform()]});this.setNode($(o.firstChild))}return this._$node},getJSONForTransform:function(){var e=this.info.name,t=Daria.splitName(e),o={id:this.info.id,name:e,"name-uri-encoded":this.info["name-uri-encoded"],filename:t[0],fileext:t[1]?"."+t[1]:"",class:this.info.class,folder:this.info.folder,"browser-supports":this.info["browser-supports"],length:this.info.size,status:this.status};return this.status===this.ATTACH_STATUS_VIRUS&&$.extend(o,{errorCode:106}),this.info.stid&&(o.stid=this.info.stid),this.info.extension.icon&&(o.icon=this.info.extension.icon),this.info.external_transformer&&(o.external_transformer=this.info.external_transformer,o.external_transformer_filetype=this.info.external_transformer_filetype),this.info.message&&(o.message=!0),this.info.narodUrl||this.info.url?o.url=this.info.narodUrl||this.info.url:this.info.mid&&this.info.hid?(o.mid=this.info.mid,o.hid=this.info.hid,o.bid=this.info.bid):this.info.from_template?(o.mid=this.info.template_mid,o.hid=this.info.template_hid):o.uploading=!0,"narod"===this.info.type&&(o.narod=!0),this.previewSupported&&(o["preview-supported"]=!0,o["preview-src"]=!!this.info.previewSrc&&this.info.previewSrc,o["preview-href"]=!!this.info.previewHref&&this.info.previewHref),o},_updateShrinker:function(){var e=this.getNode().find(".b-shrinker");if(e[0]){var t=e.find(".b-shrinker__right").width();e.css("margin-right",t)}},markDeleted:function(){return this.status===this.ATTACH_STATUS_COMPLETED&&this.isDiskAttach()?(this.getNode().removeClass("b-file_deletable").addClass("b-file_deleted"),this.deleted=!0,this._removeFromComposeMessage(),!1):(this.forceRemove(),!0)},forceRemove:function(){this.remove(),this._uploadDeferred.reject()},unmarkDeleted:function(){this.getNode().removeClass("b-file_deleted").addClass("b-file_deletable"),this._addToComposeMessage(),this.deleted=!1},removeIfMarked:function(){return!!this.deleted&&(this.remove(),!0)},stop:function(){if(this.status!==this.ATTACH_STATUS_COMPLETED){this.getNode().remove(),this._aborted=!0,this._fileSizer&&(this._fileSizer.stop(),delete this._fileSizer);for(var e,t=0,o=this._requests.length;t<o;t++)e=this._requests[t],e instanceof Vow.Promise?e.notify("abort"):e.abort();var n=this.getDiskResourceId();n&&ns.Model.get("disk-resources").removeAttach(n),this._stopNarod(),this._requests=[]}},_stopNarod:function(){this.info.narod&&(this.info.narod.$iframe&&(this.info.narod.$iframe.remove(),this.info.narod.$form.remove()),window.clearTimeout(this.info.narod.getNarodProgressTimer),delete this.info.narod)},remove:function(){this._removeFromComposeMessage(),this.stop(),this.getNode().remove(),this.deleted=!1,this.trigger("attachment.removed",this)},getId:function(){return this.info.id},getDiskResourceId:function(){return this.info._id},getSize:function(){if(!this._sizeDeferred){this._sizeDeferred=$.Deferred();var e=this.info.file;"size"in this.info?this._sizeDeferred.resolve(this.info.size,this):e?(this.info.size="size"in e?e.size:e.fileSize,this._sizeDeferred.resolve(this.info.size,this)):this._fileSizer=new Daria.FileSizer(this.info.input,function(e){this.info.size=e||0,this._sizeDeferred.resolve(this.info.size,this),delete this._fileSizer,this.getNode().find(".b-file__size").text(Jane.getHumanSize(this.info.size))}.bind(this))}return this._sizeDeferred},type:function(e){return e&&(this.info.type=e),this.info.type},isSimpleAttach:function(){return"simple"===this.type()},isDiskAttach:function(){return"narod"===this.type()},getMediaType:function(){return this.info.mediaType},isFolder:function(){return this.info.folder},metrika:function(t){var o=[];switch(t){case e.ATTACHING_TO_DISK:var n=this.isFolder();o.push(["Аттачи из Диска","Прикрепление",n?"Папка":"Файл"]),n||o.push(["Аттачи из Диска","Типы файлов",this.getMediaType()]),Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("ATTACHFROMDISK");break;case e.ATTACHING_TO_DISK_FAILED:o.push(["Аттачи из Диска","Ошибка загрузки"])}o.forEach((function(e){Jane.c.apply(null,e)}))},launchStriveAnimation:function(){var e=this,t=this.strive(100),o=0;this.animationIntervalId=window.setInterval((function(){e._onUploadProgress(null,t(o++))}),100)},strive:function(e){return function(t){return e*(Math.sqrt(t)/(1+Math.sqrt(t)))}},stopAnimation:function(){clearInterval(this.animationIntervalId),delete this.animationIntervalId},updateWithDiskData:function(e){var t=this;this.info.narodUrl=e.url;var o=(new $.Deferred).resolve().promise();return this.info.narodPreview&&(o=ns.Model.get("disk-resources").getPreview(e.hash).always((function(e){t.info.narodPreview=e}))),o},attach:function(){var t=this;return this.setStatus(this.ATTACH_STATUS_UPLOADING),this.retry=function(){t.attach()},this.metrika(e.ATTACHING_TO_DISK),this.launchStriveAnimation(),ns.Model.get("disk-resources").attach(this.getDiskResourceId()).then(this.updateWithDiskData.bind(this)).then(this._onUploadSuccess.bind(this,!0)).fail((function(){t.metrika(e.ATTACHING_TO_DISK_FAILED),t.setStatus(t.ATTACH_STATUS_FAILED)})).always((function(){t.stopAnimation()}))},upload:function(){return this.status=this.ATTACH_STATUS_UPLOADING,this.isDiskAttach()?this._fileUploadDisk():this.info.file&&window.FormData?this._fileUploadXHR():this._fileUploadIFrame(),this._uploadDeferred},_getUploadUrl:function(){return Daria.url.upload()},_onUploadProgress:function(e,t){if(!this.isFailed()){e&&e.lengthComputable&&(t=e.loaded/e.total*100),t=parseInt(t,10),t=isNaN(t)?-1:t;var o=t>=0&&t<100;this._setBlockMod(o?"loading":"wait"),this.getNode().find(".js-progress").width((o?t:100)+"%")}},_getDiskProgress:function(){this.info&&this.info.narod&&ns.forcedRequest("do-attach-file-status",{oid:this.info.narod.oid}).then(function(e){var t=e[0].getData(),o=jpath(t,".operation")[0];if(!o)return Jane.ErrorLog.send({errorType:"upload.disk.no_operation"}),void this.setStatus(this.ATTACH_STATUS_FAILED,6);var n=o.status;if("EXECUTING"===n||"WAITING"===n){var s=jpath(o,'.stages.stage[.name == "kladun_upload"].progress')[0];void 0===s||100===Number(s)?this._onUploadProgress(null,100):this._onUploadProgress(null,s)}else if("FAILED"===n){var i=jpath(o,".error.code")[0];106===Number(i)?(this.setStatus(this.ATTACH_STATUS_VIRUS,106),Jane.ErrorLog.send({errorType:"upload.disk.virus"})):(Jane.ErrorLog.send({errorType:"upload.disk.failed",code:i}),this.setStatus(this.ATTACH_STATUS_FAILED,6))}else if("DONE"===n){var a=o.file;if(a){var r=function(){delete this.info.narod,this._updatePreviewUrls(),this.info.narodUrl&&this.info.size?this._onUploadSuccess(!0):(Jane.ErrorLog.send({errorType:"upload.disk.no_size_or_nourl",disk_url:this.info.narodUrl,disk_size:this.info.size}),this.setStatus(this.ATTACH_STATUS_FAILED,6))}.bind(this);this.info.narodUrl=jpath(a,".meta.short_url")[0],this.info.size=a.size;var c=jpath(a,".meta.preview")[0],l=jpath(a,".meta.public_hash")[0];c&&l?ns.Model.get("disk-resources").getPreview(l).always(function(e){this.info.narodPreview=e,r()}.bind(this)):(this.info.narodPreview=c,r())}else Jane.ErrorLog.send({errorType:"upload.disk.no_fileinfo"}),this.setStatus(this.ATTACH_STATUS_FAILED,6)}else Jane.ErrorLog.send({errorType:"unknown_disk_status",status:n},window.JSON&&JSON.stringify(t));this.isUploading()&&this._setDiskProgressTimeout()}.bind(this),function(){this.setStatus(this.ATTACH_STATUS_FAILED),Jane.ErrorLog.send({errorType:"fail-do-attach-file-status"})}.bind(this))},_simpleUploadComplete:function(e){var t=e.responseText,o={};if(t)try{o=$.parseJSON(t)}catch(o){Jane.ErrorLog.send({errorType:"simpleUpload.json_parse",aborted:this._aborted,xhr_status:e.status,xhr_readystate:e.readyState,xml_length:t?t.length:0},t)}if(o.write_attachment){var n=o.write_attachment,s=n.id,i=n.downloadUrl,a=n.previewUrl;if(s&&i)return this.info.att_id=s,this.info.url=i.replace("http://","//"),this.previewSupported&&a&&(this.info.previewHref=this.info.url+"&no_disposition=y",this.info.previewSrc=a.replace("http://","//")+"&no_disposition=y"),void this._onUploadSuccess(!0)}else o.error&&"AUTH_NO_AUTH"===o.error.code&&Jane.doLogin("upload_attachment");this._aborted||Jane.ErrorLog.send({errorType:"simpleUpload",aborted:this._aborted,xhr_status:e.status,xhr_readystate:e.readyState,xml_length:t?t.length:0},t),this.setStatus(this.ATTACH_STATUS_FAILED,0)},_setBlockMod:function(e){e=e||"";var t=this.getNode();t.removeClass("b-file_wait b-file_loading b-file_error"),e&&t.addClass("b-file_"+e)},setStatus:function(e,t){this.status=e,e===this.ATTACH_STATUS_FAILED?(this._onUploadFail(t),this._setBlockMod("error")):e===this.ATTACH_STATUS_VIRUS?(this._onUploadFail(t),this._setBlockMod("virus")):(delete this._failErrorCode,this._setBlockMod(""))},retry:function(){Daria.Dialog.close(),this.setStatus(this.ATTACH_STATUS_NEW),this._setBlockMod("wait"),this._uploadDeferred=$.Deferred()},tooBigAttach:function(e){this.type("simple"),this.setStatus(this.ATTACH_STATUS_FAILED,e)},_onUploadSuccess:function(e){if(this.isCancelled())return void this._uploadDeferred.reject();this._updatePreviewUrls(),this.setStatus(this.ATTACH_STATUS_COMPLETED),this.getNode(e),this._addToComposeMessage(),this._uploadDeferred.resolve()},getDataToSend:function(){if(this.isSimpleAttach())return _.pick(this.info,["att_id","hid","from_template","template_mid","template_hid"]);if(this.isDiskAttach()){return{disk:this.status===this.ATTACH_STATUS_COMPLETED?Daria.utils.getNarodHTML(this.info):""}}},_addToComposeMessage:function(){this.mComposeMessage.addAttachment(this)},_removeFromComposeMessage:function(){this.mComposeMessage.removeAttachment(this.getId())},_updatePreviewUrls:function(){if(this.info.mid&&this.previewSupported){var e=this.info;e.from_template&&(e=_.extend({},e,{mid:e.template_mid,hid:e.template_hid})),this.info.previewHref=Daria.url.attachment(e,e.mid,{no_disposition:!0}),this.info.previewSrc=Daria.url.attachment(e,e.mid,{no_disposition:!0,thumb:!0})}this.info.narodPreview&&this.previewSupported&&(this.info.previewSrc=this.info.narodPreview,this.info.previewHref=this.info.narodUrl||this.info.narodPreview)},_onUploadFail:function(e){var t=Daria.AttachmentCollection2.prototype.HAS_DISK?i18n("%Attachments_Error_Code_1"):i18n("%Attachments_Error_Code_1_nodisk"),o={0:i18n("%Attachments_Error_Code_0"),1:t,2:i18n("%Attachments_Error_Code_2"),106:i18n("%Attachments_Error_Code_106_full")};106===e&&this.getNode(!0),e=e||this._failErrorCode||0,e in o||(e=0),this._failErrorCode=e;var n=o[e]+(0===e?'  <a class="b-pseudo-link ns-action" data-click-action="attachments.retry" data-params="id='+this.getId()+'">'+i18n("%Повторить")+"</a>":"");this.getNode().find(".b-file__fail").attr("data-params","width=30em&side=top&text="+encodeURIComponent(n)),this._aborted||(this.trigger("attachment.failed"),Jane.ErrorLog.send({errorType:"UploadFail",aborted:this._aborted,fileName:this.info.name,uploaderType:this.info.type,errorCode:e})),this._uploadDeferred.reject()},_fileUploadIFrame:function(){this._onUploadProgress();var e=$('<form class="g-hidden" method="post" enctype="multipart/form-data">').appendTo("body");e.attr("action",this._getUploadUrl()),this.info.input.name="attachment",e.append(this.info.input);var t=this,o=e.frameSubmit().always((function(e){t._removeRequest(o);var n={responseText:JSON.stringify(e),status:"success",readyState:"complete"};t._simpleUploadComplete(n)}));this._requests.push(o)},_diskUploadIFrame:function(){this._onUploadProgress(null,0);var e=$('<form class="g-hidden" method="post" enctype="multipart/form-data">').appendTo("body");e.attr("action",this.info.narod.url),this.info.input.name="file",e.append(this.info.input);var t=this,o=e.frameSubmit().always((function(){t._removeRequest(o)}));this._requests.push(o)},_diskUploadXHR:function(){var e=this,o=new FormData;o.append("file",this.info.file);var n=new XMLHttpRequest;n.open("POST",this.info.narod.url,!0),n.upload&&!window.opera?n.upload.addEventListener("progress",this._onUploadProgress.bind(this),!1):this._setDiskProgressTimeout(),n.onreadystatechange=function(){4===this.readyState&&(e._removeRequest(this),this.status>=200&&this.status<300?e.info.narod&&e._setDiskProgressTimeout():(e._aborted||Jane.ErrorLog.send({errorType:"upload.disk.xhr_fail",status:this.status},this.responseText),0!==this.status||e._aborted||(t.prototype._failXDR=!0),window.clearTimeout(e.info.narod.getNarodProgressTimer),e.setStatus(e.ATTACH_STATUS_FAILED,0)))},n.send(o),this._requests.push(n)},_removeRequest:function(e){Jane.Array.remove(this._requests,e)},_fileUploadXHR:function(){var e=this,t=new FormData;t.append("Filename",this.info.name);var o=new XMLHttpRequest;o.open("POST",this._getUploadUrl(),!0),o.upload&&o.upload.addEventListener("progress",this._onUploadProgress.bind(this),!1),o.onreadystatechange=function(){4===this.readyState&&(e._removeRequest(this),e._simpleUploadComplete(this))},t.append("attachment",this.info.file,this.info.name),this._onUploadProgress(null,0),o.send(t),this._requests.push(o)},_fileUploadDisk:function(){var e=this,t=ns.forcedRequest("do-attach-file-store",{file:this.info.name}).then((function(o){e._removeRequest(t);var n=o[0].getData(),s=n&&jpath(n,".upload_url")[0],i=n&&jpath(n,".oid")[0];if(!s||!i)return Jane.ErrorLog.send({errorType:"upload.disk.no_url_or_oid"},n&&window.JSON?JSON.stringify(n):""),void e.setStatus(e.ATTACH_STATUS_FAILED);e.info.narod={url:s,oid:i},e.info.file&&window.FormData&&window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?e._diskUploadXHR():(e._diskUploadIFrame(),e._setDiskProgressTimeout())}),(function(){e.setStatus(e.ATTACH_STATUS_FAILED),Jane.ErrorLog.send({errorType:"fail-do-attach-file-store"})}));this._requests.push(t),this._onUploadProgress(null,0)},_setDiskProgressTimeout:function(){this._getDiskProgressBinded||(this._getDiskProgressBinded=this._getDiskProgress.bind(this)),window.clearTimeout(this.info.narod.getNarodProgressTimer),this.info.narod.getNarodProgressTimer=window.setTimeout(this._getDiskProgressBinded,1500)},isUploading:function(){return this.status===this.ATTACH_STATUS_UPLOADING},isFailed:function(){return this.status===this.ATTACH_STATUS_FAILED},needUpload:function(){return this.status===this.ATTACH_STATUS_NEW},_getFileName:function(){var e;if(this.info.file)e=this.info.file.name||this.info.file.fileName;else if(this.info.input){var t=this.info.input.value.replace(/\\/g,"/").split("/");e=t[t.length-1]}else e=i18n("%Без_темы");return _.escape(e)},updateInfo:function(e,t){var o,n=this.info;return"narod"!==n.type&&(n.att_id?o=jpath(e,'.[.att_id == "'+n.att_id+'"]')[0]:n.hid&&(o=jpath(e,'.[.old_hid == "'+n.hid+'"]')[0]),!!o&&(this._removeFromComposeMessage(),delete n.from_template,delete n.template_hid,delete n.template_mid,delete n.att_id,delete n.url,n.hid=o.hid,n.mid=t,this._setAttachId(),this._onUploadSuccess(),Jane.Array.remove(e,o),!0))},updateNarodInfo:function(){"audio"===this.info.class&&(this.previewSupported=!1)},inSize:function(e){return"boolean"==typeof e&&(this._inSize=e),this._inSize}},_.extend(t.prototype,ns.Events)})()},1220:function(e,t){!(function(e,t){var o=t.AttachmentCollection2=function(e){this.bindMethodsToContext(),this._attachments={},this._currentAttachSize=0,this._id=t.getRandomNumber(),this._init=!1,e&&this.setOptionsAndInit(e)};o.prototype={MAX_ATTACH_SIZE:t.IS_CORP?104857600:25165824,HAS_DISK:!t.IS_CORP,setOptionsAndInit:function(e){ns.assert(e,"Daria.AttachmentCollection2",'"options" parameter is not passed to the #setOptions method'),this.options=e,ns.assert(e.node||e.$node,"Daria.AttachmentCollection2",'neither "options.node" nor "options.$node" parameter is passed to the #setOptions method'),this.$node=$(e.node||e.$node),ns.assert(e.mComposeMessage,"Daria.AttachmentCollection2",'"options.mComposeMessage" parameter is not passed to the #setOptions method'),this.mComposeMessage=e.mComposeMessage,ns.assert(e.mComposeState,"Daria.AttachmentCollection2",'"options.mComposeState" parameter is not passed to the #setOptions method'),this.mComposeState=e.mComposeState,this.templateMode=e.templateMode||"compose2:js-attachments-collection",this.$files=this.$node.find(".js-compose-attachments-container");var t={_$attsImg:".js-compose-attachments-images",_$attsRecent:".js-compose-attachments-common",_$attsNarodCommon:".js-compose-attachments-narod-common",_$attsNarodImages:".js-compose-attachments-narod-images",_$attsDiskInfo:".js-compose-attachments-narod-header"};_.keys(t).forEach((function(e){this[e]=this.$files.find(t[e])}),this),this._init=!0,this.checkVisibility()},_appendAttach:function(e,t,o){var n=e.getNode(t);e.previewSupported?e.isDiskAttach()?this._$attsNarodImages.append(n):this._$attsImg.append(n):e.isSimpleAttach()?this._$attsRecent.append(n):this._$attsNarodCommon.append(n),o||(this.checkVisibility(),this.trigger("attachments.appended",e))},addAttachToCollection:function(e,t){t=t||{},t.processAttachSize=!_.isBoolean(t.processAttachSize)||t.processAttachSize,this._attachments[e.getId()]=e,t.processAttachSize&&e.getSize().done(this.onAttachmentGetSize),t.silent||this.trigger("attachments.added",e),this.bindEventsToAttach(e)},removeAttachFromCollection:function(e,t){t=t||{},this.unbindEventsFromAttach(e),this._reduceAttachmentsSize(e),this.checkVisibility(),delete this._attachments[e.getId()],t.silent||this.trigger("attachments.removed",e)},bindMethodsToContext:function(){this.onAttachmentUpdated=this.onAttachmentUpdated.bind(this),this.onAttachmentRemoved=this.onAttachmentRemoved.bind(this),this.onAttachmentFailed=this.onAttachmentFailed.bind(this),this.onAttachmentGetSize=this.onAttachmentGetSize.bind(this)},bindEventsToAttach:function(e){e.on("update",this.onAttachmentUpdated),e.on("attachment.removed",this.onAttachmentRemoved),e.on("attachment.failed",this.onAttachmentFailed)},unbindEventsFromAttach:function(e){e.off("update",this.onAttachmentUpdated),e.off("attachment.removed",this.onAttachmentRemoved),e.off("attachment.failed",this.onAttachmentFailed)},onAttachmentUpdated:function(){this.trigger("attachments.updated")},onAttachmentRemoved:function(e,t){this.removeAttachFromCollection(t)},onAttachmentFailed:function(){this.trigger("attachments.failed")},checkVisibility:function(){var e=this._$attsImg.find("> .b-file").length,t=this._$attsRecent.find("> .b-file").length,o=this._$attsNarodCommon.find("> .b-file").length,n=this._$attsNarodImages.find("> .b-file").length;this._$attsDiskInfo.toggleClass("g-hidden",o+n===0),this._$attsImg.toggleClass("g-hidden",0===e),this._$attsRecent.toggleClass("g-hidden",0===t),this._$attsNarodCommon.toggleClass("g-hidden",0===o),this._$attsNarodImages.toggleClass("g-hidden",0===n)},isCompleted:function(){return _.every(this._attachments,(function(e){return!e.needUpload()&&!e.isUploading()}))},isUploading:function(){for(var e in this._attachments){var t=this._attachments[e];if(!t.isCancelled()&&t.isUploading())return!0}return!1},isFailed:function(){return _.some(this._attachments,(function(e){return e.isFailed()}))},hasFiles:function(){return!$.isEmptyObject(this._attachments)},reset:function(){if(this._init){this.$node.off(),this.off(),$(document).off(".compose");for(var e in this._attachments)this._attachments[e].remove();this._attachments={},this._$attsImg.addClass("g-hidden").empty(),this._$attsRecent.addClass("g-hidden").empty(),this._$attsNarodCommon.addClass("g-hidden").empty(),this._$attsNarodImages.addClass("g-hidden").empty(),this.$dropzone&&this.$dropzone.remove()}},add:function(e,t){this.removeMarkedAsDeleted(),t?this._addAttaches(e,t):this._addAttach(e)},_addAttaches:function(e,o){for(var n=[],s=[],i=0,a=o.length;i<a;i++){var r=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o[i]},this);this.addAttachToCollection(r,{processAttachSize:!1}),s.push(r.isRegularFile()),n.push(r)}$.when.apply(null,s).done(function(){for(var e=[],t=[],o=0,s=arguments.length;o<s;o++)if(!1!==arguments[o]){var i=n[o];this._attachments[i.getId()]=i,t.push(i),e.push(i.getSize().done(this.onAttachmentGetSize))}e.length&&$.when.apply(null,e).done(function(){this.redrawAttachesBulk(t),this._uploadQueue()}.bind(this))}.bind(this))},onAttachmentGetSize:function(e,t){if(e>this.MAX_FILE_SIZE)t.tooBigAttach(1);else{var o=e+this._currentAttachSize;o<this.MAX_ATTACH_SIZE?(t.type("simple"),t.inSize(!0),this._currentAttachSize=o):this.HAS_DISK?(t.type("narod"),t.updateNarodInfo()):t.tooBigAttach(2)}},getAttaches$Html:function(t,o,n){for(var s=[],i=0,a=t.length;i<a;i++)s.push(t[i].getJSONForTransform());var r={"collection-id":this._id,attachment:s};return o&&(r.mid=o),n&&(r=$.extend({},r,n)),$(e.tt(this.templateMode,r))},redrawAttachesBulk:function(e,t,o){e||(e=_(this._attachments).chain().values().filter((function(e){return!e.isCancelled()})).value());var n=this.getAttaches$Html(e,t);this._appendAttachBulk(e,n,o)},_appendAttachBulk:function(e,t,o){if(e.length){for(var n=0,s=e.length;n<s;n++){var i=e[n],a=i.getId(),r=t.find("#att_"+this._id+"_"+a);i.setNode(r),this._appendAttach(i,!1,!0)}o||(this.checkVisibility(),this.trigger("attachments.appended",e))}},_addAttach:function(e,o){var n=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o},this);this.addAttachToCollection(n,{processAttachSize:!1});var s=this;n.getSize().done(this.onAttachmentGetSize).done((function(){s._appendAttach(n,!0),s._scrollToAttachInput(),s._uploadQueue()}))},addDiskAttach:function(e,o){var n,s=this,i="dir"===o.type,a=jpath(o,".meta.mediatype")[0];"image"===a&&(n=jpath(o,".meta.preview")[0]);var r=new t.Attachment2({name:o.name,type:"narod",size:o.meta&&o.meta.size,narodPreview:n,folder:i,mediaType:o.meta&&o.meta.mediatype||"unknown",_id:e,mComposeMessage:this.mComposeMessage},this);this.addAttachToCollection(r,{processAttachSize:!1}),this._appendAttach(r,!0),r.attach().then((function(){s._uploadQueue()})),this.removeMarkedAsDeleted()},_uploadQueue:function(){var e,t=this;for(var o in this._attachments){var n=this._attachments[o];if(n.isUploading())return!1;if(!e&&n.needUpload()){n.removeIfMarked()?(this._reduceAttachmentsSize(n),delete this._attachments[o]):e=n;break}}e?e.getSize().done((function(){t.isUploading()||e.upload().always((function(){e.isDiskAttach()&&e._addToComposeMessage(),e.isFailed()&&t._reduceAttachmentsSize(e),Promise.resolve().then((function(){t._uploadQueue()}))}))})):ns.events.trigger("attachments.all-uploaded")},removeMarkedAsDeleted:function(){for(var e in this._attachments){var t=this._attachments[e];t.removeIfMarked()&&(this._reduceAttachmentsSize(t),delete this._attachments[e])}this.checkVisibility(),this.isUploading()||ns.events.trigger("attachments.all-uploaded")},_reduceAttachmentsSize:function(e){e.inSize()&&(e.inSize(!1),this._sizeReducer||(this._sizeReducer=function(e){this._currentAttachSize-=e}.bind(this)),e.getSize().done(this._sizeReducer))},updateAfterSave:function(e,t,o){if(e){var n=[],s={};_.each(this._attachments,(function(o,i){if(o.updateInfo(e,t)){var a=o.getId();s[a]=o,n.push(o)}else s[i]=o})),this._attachments=s,this.redrawAttachesBulk(n,t,o)}},stopUploading:function(){for(var e in this._attachments)this._attachments[e].stop();this.checkVisibility()},retryAttach:function(e){var t=this._attachments[e];t&&(t.retry(),this._uploadQueue())}},_.extend(o.prototype,ns.Events);var n=o.prototype;n.MAX_FILE_SIZE=n.HAS_DISK?2147483648:n.MAX_ATTACH_SIZE})(Jane,Daria)},1221:function(e,t){!(function(){function e(e,t){this.$node=e,this.selector=t,this.$target=null,this.currentValue=""}$.fn.startEmulateInputEvent=function(t){return"string"==typeof t?this.each((function(){var o=$(this),n=new e(o,t);n.init(),o.data("inputEmulator",n)})):this},$.fn.stopEmulateInputEvent=function(){return this.each((function(){var t=$(this),o=t.data("inputEmulator");o instanceof e&&o.destroy(),t.data("inputEmulator",null)}))},e.prototype.$doc=$(document),e.prototype.init=function(){"string"==typeof this.selector&&this.$node.on("focusin.inputEmulator",this.selector,this.startEmulate.bind(this)).on("focusout.inputEmulator",this.selector,this.stopEmulate.bind(this))},e.prototype.destroy=function(){this.stopEmulate(),this.$node.off(".inputEmulator")},e.prototype.startEmulate=function(e){this.$target=$(e.currentTarget),this.currentValue=this.$target.val(),this.$target.on("keydown.inputEmulator keyup.inputEmulator",this.triggerInputEvent.bind(this)),this.$doc.on("selectionchange.inputEmulator",this.triggerInputEvent.bind(this))},e.prototype.stopEmulate=function(){this.$target&&this.$target.off(".inputEmulator"),this.$target=null,this.currentValue="",this.$doc.off(".inputEmulator")},e.prototype.triggerInputEvent=function(){if(this.$target){var e=this.$target.val();e!==this.currentValue&&this.$target.trigger("input"),this.currentValue=e}},Daria.InputEventEmulator=e})()},1222:function(e,t){!(function(){Daria.ComposeComponents.confirmations={_confirmations:{},addConfirmation:function(e,t){this._confirmations[e]=t},getConfirmation:function(e){return this._confirmations[e]},getConfirmations:function(){return _.map(this._confirmations,(function(e){return e}))}}})()},1223:function(e,t){!(function(){var e="send-without-to",t=function(t){var o=t.get(".to"),n=t.get(".cc"),s=t.get(".bcc");return!(o||!n&&!s)&&e};Daria.ComposeComponents.confirmations.addConfirmation(e,t)})()},1224:function(e,t){!(function(){var e="attachments-forgotten",t=["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении"],o=new RegExp(t.join("|"),"i"),n=function(t,n){if(t.hasAttach())return!1;var s=t.get(".send"),i=t.get(".subj");/^RE:/i.test(i)||(s=i+" "+s),s=s.replace(new RegExp("(?:^\\s*>.*$)|(?:[\\n\\r])","gmi"),""),s=s.replace(/<blockquote[^>]*>.*<\/blockquote>/gi,""),s=s.replace(/<[^>]+>/g,"");var a=o.exec(s);if(!a)return!1;var r=[];return $.each([a.index,a.index+a[0].length-1],(function(e,t){e=2*e-1;for(var o=3,n=!1,i=t,a=s.length;i>=0&&i<a;i+=e)if(/[\s,.!?\-+:;()]/i.test(s.charAt(i))){if(!n){if(!--o)break;n=!0}}else n=!1;r.push(i)})),n.stopWordGroup=$.trim(s.substring.apply(s,r)),e};Daria.ComposeComponents.confirmations.addConfirmation(e,n)})()},1225:function(e,t){!(function(e,t){"use strict";t.Signature=function(){e.extend(this,t.UI.IEvent()),this._log("create"),this.__init=!1,this._isMouseenter=!1,this._isMouseleave=!0,this._coordYBegin=0,this._coordYEnd=0,this._currentYCursor=0,this._limitRangeFind=100,this._maxSignLine=100,this._range=[],this._updateCoords=_.debounce(this._updateCoords,0),this._onInput=_.debounce(this._onInput,50)};var o=t.Signature.prototype;o._log=function(){},o._mouseEnter=function(){this._isMouseenter||(this._isMouseenter=!0,this._isMouseleave=!1,this.trigger("mouseenter",[this]))},o._mouseLeave=function(){this._isMouseleave||(this._isMouseleave=!0,this._isMouseenter=!1,this.trigger("mouseleave",[this]))},o._mouseMove=function(e){if(this._coordYBegin>=this._coordYEnd)return void this._mouseLeave();this._currentYCursor=e,this._currentYCursor>=this._coordYBegin&&this._currentYCursor<=this._coordYEnd?(this._mouseEnter(),this.trigger("mousemove",[this])):this._mouseLeave()},o._updateCoords=function(){var e=this._offset();e&&(this._log("_updateCoords"),this._coordYBegin===e.top&&this._coordYEnd===e.bottom||(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this])))},o.__onInput=function(){if(this._log("__onInput"),this._range=this._findRange(),!this._range.length)return this._coordYBegin=0,this._coordYEnd=0,void this._mouseLeave();this._updateCoords()},o._onInput=function(t){t&&e.inArray(t.keyCode,[37,38,39,40,16,17,18])>-1||(this._log("_onInput"),this.__onInput())},o._onClick=function(){this._range.length&&this._isMouseenter&&(this._log("_onClick"),this.trigger("click",[this]))},o._onScroll=function(){this._range.length&&(this._log("_onScroll"),this._updateCoords())},o.isMouseEntered=function(){return this._isMouseenter},o.offset=function(){return{top:this._coordYBegin,bottom:this._coordYEnd}},o.update=function(){this._range=this._findRange();var e=this._offset();e&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this]))},o._destroy=function(e){this.__init&&(this._log("_destroy"),this.__init=!1,this._updateCoords.cancel(),this._onInput.cancel(),this._events.empty(),this._range=[],this._currentYCursor=0,this._coordYBegin=0,this._coordYEnd=0,this._isMouseenter=!1,this._isMouseleave=!0,e&&e.call(this))},o._init=function(e){this.__init||(this._log("_init"),this.__init=!0,e&&e.call(this),this.__onInput())},o.__offsetY=function(e){var t;return void 0!==e.offsetY?t=e.offsetY:e.originalEvent&&void 0!==e.originalEvent.layerY&&(t=e.originalEvent.layerY),t},o.setFirstSignatureMatch=function(e){this._firstSignatureMatch=e},o.getFirstSignatureMatch=function(){return this._firstSignatureMatch||"--\\s"},o._offset=function(){},o.getLinesCount=function(){return 0},o._findRange=function(){return[]},o._onMouseMove=function(){},o._onMouseLeave=function(){},o._onMouseEnter=function(){},o.destroy=function(){},o.init=function(){},o.select=function(){},o.replace=function(){},o.get=function(){},o.getText=function(){}})(jQuery,Daria)},1226:function(e,t){!(function(e,t){"use strict";t.SignatureTextarea=function(o){t.SignatureTextarea.superClass.constructor.apply(this,arguments),this._$node=e(o)},Jane.extend(t.SignatureTextarea,t.Signature);var o=t.Signature.prototype;o._widthNode=function(){var e=0,t=this._$node[0].scrollWidth||this._$node[0].clientWidth;return window.getComputedStyle&&(e=window.getComputedStyle(this._$node[0],null).getPropertyValue("width"),e=-1!==e.indexOf("px")?parseFloat(e):0),e?Math.min(e,t):t},o._textCoords=function(t,o,n){this._$placeholder.width(this._widthNode()).text(t);var s=parseInt(this._$placeholder.css("top"),10),i=this._$placeholder[0].firstChild,a=document.createRange();a.setStart(i,o),a.setEnd(i,n);var r=a.cloneRange(),c={};if(!Modernizr.msie&&!Modernizr.opera&&(r.getBoundingClientRect&&(c=r.getBoundingClientRect(),c={top:c.top,bottom:c.bottom}),!c.top&&!c.bottom&&r.getClientRects)){var l=r.getClientRects();l.length&&(c.top=l[0].top,c.bottom=l[l.length-1].bottom)}if(c.top||c.bottom){var u=e(window).scrollTop();c.top=c.top+u,c.bottom=c.bottom+u}else{r.surroundContents(this._highlight);var d=e(this._highlight);c.top=d.offset().top,c.bottom=c.top+d.height()}return c.top&&c.bottom?(c.top=c.top-s,c.bottom=c.bottom-s,c):null},o._offset=function(){if(!this._range.length)return null;var e=this._$node.scrollTop();return{top:this._range[0].top-e,bottom:this._range[1].bottom-e}},o._findRange=function(){if(!this._lineHeight)return[];for(var e,t=new RegExp("^"+this.getFirstSignatureMatch()+"$","gm"),o=this._$node.val(),n=/^--------[^\-]+.*--------$/gm,s=[-1,-1],i=!1;null!==(e=n.exec(o));)i||(i=!0,s[0]=e.index),s[1]=n.lastIndex;var a,r,c=t.exec(o);if(c&&c.index>s[0]&&c.index<s[1]&&(t.lastIndex=s[1],c=t.exec(o)),c){a={simbol:c.index,simbolOffset:t.lastIndex+1,top:void 0};var l,u=this._maxSignLine,d=/^.+$/gm,h=!1,p=[0,0],m=/^\s*>/,f=/^\s*$/;for(d.lastIndex=t.lastIndex;null!==(l=d.exec(o))&&u;){if(m.test(l[0])){h=!0;break}if(d.lastIndex>=s[0]&&d.lastIndex<=s[1])break;f.test(l[0])||(p=[d.lastIndex,p[0]]),u--}if(p=h&&p[1]?p[1]:p[0]?p[0]:a.simbolOffset-1){r={simbol:p,bottom:void 0};var g=this._textCoords(o,a.simbol,r.simbol);g?(a.top=g.top,r.bottom=g.bottom):(a=null,r=null)}}return a&&r?[a,r]:[]},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove"),this._mouseMove(this.__offsetY(e))},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){return this._range.length?this._$node.val().slice(this._range[0].simbol,this._range[1].simbol):""},o.getText=function(){return this.get()},o.replace=function(e){if(this._range.length){var t=this._$node.val();t=t.substr(0,this._range[0].simbol)+e+t.substr(this._range[1].simbol),this._$node.val(t),this.__onInput()}},o.select=function(){this._range.length&&t.setSelection(this._$node[0],this._range[0].simbol,this._range[1].simbol)},o.init=function(t,o){t=t||{},this._init((function(){this.setFirstSignatureMatch(t.firstSignatureMatch);var n=parseInt(this._$node.css("font-size"),10)||13;if(this._lineHeight=n+2,this._$node.css("line-height",this._lineHeight+"px"),this._highlight=document.createElement("span"),this._$placeholder=e("<pre></pre>").css({font:this._$node.css("font"),fontFamily:this._$node.css("fontFamily"),fontSize:this._$node.css("fontSize"),fontStyle:this._$node.css("fontStyle"),fontVariant:this._$node.css("fontVariant"),fontWeight:this._$node.css("fontWeight"),lineHeight:this._$node.css("lineHeight"),padding:this._$node.css("padding"),paddingTop:this._$node.css("paddingTop"),paddingBottom:this._$node.css("paddingTop"),paddingLeft:this._$node.css("paddingLeft"),paddingRight:this._$node.css("paddingRight"),margin:this._$node.css("margin"),marginTop:this._$node.css("marginTop"),marginBottom:this._$node.css("marginTop"),marginLeft:this._$node.css("marginLeft"),marginRight:this._$node.css("marginRight"),width:this._widthNode()+"px",wordWrap:"break-word",whiteSpace:"pre-wrap",visibility:"hidden",position:"absolute",top:"-9999px",left:"-9999px"}).appendTo("body"),this._$node.on("keyup",e.proxy(this._onInput,this)).on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("click",e.proxy(this._onClick,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("scroll",e.proxy(this._onScroll,this)),Modernizr.msie){var s=this,i=this._$node.css("overflow-y");this._$node.css("overflow-y","hidden"),setTimeout((function(){s._$node.css("overflow-y",i)}),0)}o&&o.call(this)}))},o.destroy=function(){this._destroy((function(){this._highlight=null,this._$placeholder.remove(),this._$placeholder=null,this._lineHeight=0,this._$node.off("keyup",e.proxy(this._onInput,this)).off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("click",e.proxy(this._onClick,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("scroll",e.proxy(this._onScroll,this))}))},e.fn.signature=function(){return this.each((function(){this.signature||(this.signature=new t.SignatureTextarea(this))}))},e.fn.signatureDestroy=function(){return this.each((function(){this.signature&&(this.signature.destroy(),this.signature=null,delete this.signature)}))}})(jQuery,Daria)},1227:function(e,t){!(function(e,t){"use strict";t.SignatureCkeditor=function(o){t.SignatureCkeditor.superClass.constructor.apply(this,arguments),this._ed=o,this._$node=e(this._ed.editable().$),this._isFirstSignature=!0,this._isNormalizeSupport="normalize"in document.createElement("div")},Jane.extend(t.SignatureCkeditor,t.Signature);var o=t.SignatureCkeditor.prototype;o._offset=function(){if(!this._range.length)return null;var e,t,o;try{if(e=this._range[0][0].getBoundingClientRect(),!e.height)return null;if(t=this._range[1][0].getBoundingClientRect(),!t.height)return null;if(o=this._$node[0].getBoundingClientRect(),!o.height)return null}catch(e){return null}return{top:e.top-o.top,bottom:t.bottom-o.top}},o._findForwardRange=function(){var t=[-1,-1],o=this._ed.getData(!0);if(void 0===o)return t;if(!/<div>--------[^\-]+.*--------<\/div>/i.test(o))return t;var n=this._$node[0],s=n.childNodes.length;if(!s)return t;for(var i,a=0,r=/^--------[^\-]+.*--------$/;a<s;a++)if(i=n.childNodes[a],"DIV"===i.nodeName&&r.test(e.text(i))){t[0]=a;break}for(;s--;)if(i=n.childNodes[s],"DIV"===i.nodeName&&r.test(e.text(i))){t[1]=s;break}return t},o._checkFirstRange=function(e){var o=t.Html2Text.html2text(e.innerHTML),n=new RegExp("^"+this.getFirstSignatureMatch()+"$","m"),s=n.exec(o);return!(!s||0!==s.index)},o._findFirstRangeForward=function(e,t){var o,n,s=this._$node[0],i=s.childNodes.length,a=0;if(!((n=e?Math.min(this._limitRangeFind,i-this._limitRangeFind):Math.min(this._limitRangeFind,i))<=a)){for(;a<n;a++)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRangeBack=function(e,t){var o,n,s=this._$node[0],i=s.childNodes.length,a=i-1;if(n=e?Math.max(this._limitRangeFind,i-this._limitRangeFind):Math.max(0,i-this._limitRangeFind),!(a<n)){for(;a>=n;--a)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRange=function(){var e,t=this._findForwardRange();return this._isFirstSignature?(e=this._findFirstRangeForward(!1,t))||(e=this._findFirstRangeBack(!0,t)):(e=this._findFirstRangeBack(!1,t))||(e=this._findFirstRangeForward(!0,t)),e},o._findRange=function(){var t,o=this._findFirstRange();if(o){t=[];var n=this._maxSignLine,s=!1,i=/^--------[^\-]+.*--------$/,a=/^\s*>/,r=/^\s*$/,c=/<img[^>]*>/;e(o).nextAll().each((function(){if("BLOCKQUOTE"===this.nodeName)return s=!0,!1;var o=e.text(this);return a.test(o)?(s=!0,!1):!i.test(o)&&(!!n&&(r.test(o)?this.childNodes.length>0&&c.test(this.innerHTML)&&(t=[this,t[0]]):t=[this,t[0]],void n--))})),t=s&&t[1]?t[1]:t[0]?t[0]:o}return o&&t?[e(o),e(t)]:[]},o._createRange=function(){if(!this._range.length)return!1;var e=this._ed.createRange();return this._range[0][0]===this._range[1][0]?e.selectNodeContents(new CKEDITOR.dom.node(this._range[0][0])):(e.setStartBefore(new CKEDITOR.dom.node(this._range[0][0])),e.setEndAfter(new CKEDITOR.dom.node(this._range[1][0]))),e},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove");var t=e.currentTarget.getBoundingClientRect(),o=e.clientY-t.top;this._mouseMove(o)},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){if(this._range.length)return this._range[0][0]===this._range[1][0]?this._range[0]:this._range[0].nextUntil(this._range[1]).andSelf().add(this._range[1])},o.getText=function(){var e=this.get();return e?e.map((function(){return t.Html2Text.html2text(this.innerHTML).replace(/^[\u0020\u00a0]+$/gm,"")})).get().join("\n"):""},o.replace=function(e){if(this._range.length){var t=this._createRange();this._ed.insertHtml(e,"html",t),this.__onInput()}},o.select=function(){if(!this._range.length)return!1;var e=this._createRange();return this._ed.getSelection().selectRanges([e]),!0},o.init=function(t,o){t=t||{},this._init((function(){"firstSignature"in t&&(this._isFirstSignature=Boolean(t.firstSignature)),this.setFirstSignatureMatch(t.firstSignatureMatch),this._$node.on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("scroll",e.proxy(this._onScroll,this)).on("keyup",e.proxy(this._onInput,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("click",e.proxy(this._onClick,this)),this._ed.on("setData",e.proxy(this.__onInput,this)),o&&o.call(this)}))},o.destroy=function(){this._destroy((function(){this._$node.off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("scroll",e.proxy(this._onScroll,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("click",e.proxy(this._onClick,this)).off("keyup",e.proxy(this._onInput,this)),this._ed.removeListener("setData",e.proxy(this.__onInput,this))}))}})(jQuery,Daria)},1228:function(e,t,o){function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),e}var a,r,c,l,u=o(724),d={value:null},h=(a=u())((l=c=(function(){function e(t){var o=this;n(this,e),this.AVATAR_SIZE=20;var s=t.dataset,i=this._fields;this._data=Object.keys(i).reduce((function(e,t){var n="yabble".concat(_.capitalize(t)),a=_.unescape(s[n]);return a=i[t]?_.method(i[t][0],a)(o):a,e[t]=a,e}),{})}return i(e,[{key:"_fields",get:function(){return d}}],[{key:"updateBubbleAtNode",value:function(e){if(e.classList.contains(Daria.ContactBubble.BUBBLE_CLASS))Daria.ContactBubble.update(e);else if(e.classList.contains(Daria.PhoneBubble.BUBBLE_CLASS))Daria.PhoneBubble.update(e);else{if(Daria.debug.enabled)throw new Error("uknown bubble type");Daria.BaseBubble.update(e)}}}]),i(e,[{key:"toString",value:function(){return String(this.get("value"))}},{key:"needUpdate",value:function(){return!1}},{key:"get",value:function(e){return _.get(this._data,e)}},{key:"getText",value:function(){return this.get("value")}},{key:"getAvatar",value:function(){return{href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Avatar"}}},{key:"applyTo",value:function(e){var t=this,o=this.renderBubbleNode();for(Object.keys(this._data).forEach((function(o){var n=t._data[o];(n=t._fields[o]?_.method(t._fields[o][1],n)(t):n)&&e.setAttribute("data-yabble-".concat(o),_.escape(n))})),this.get("tid")&&e.setAttribute("readonly","readonly");e.firstChild;)e.removeChild(e.firstChild);e.appendChild(o)}},{key:"getCustomProps",value:function(){return{}}},{key:"renderBubbleNode",value:function(){return ns.renderNode(_.extend({avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},this.getCustomProps()),"bubble","compose2")}},{key:"_fieldToArray",value:function(e){return _.compact(this.constructor.tokenizer(String(e||"").trim()))}},{key:"_fieldToString",value:function(e){return String(e)}}]),e})(),c.BUBBLE_CLASS="js-base-bubble",r=l))||r;Daria.BaseBubble=h},1229:function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,o){return t&&c(e.prototype,t),o&&c(e,o),e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return y(e)}function p(e){return Jane.FormValidation.checkContacts(e)}var m,f,g,b,v=o(724),y=o(543)(),C={cid:null,tid:null,name:null,type:null,phone:null,email:["_fieldToArray","_fieldToString"],value:["_fieldToArray","_fieldToString"]},S=(m=v({tokenizer:h,checkPaste:p}))((b=g=(function(e){function t(e){var o;if(s(this,t),o=i(this,r(t).call(this,e)),o.get("tid"))return i(o);if(_.isEmpty(o.get("value"))){var n=Jane.FormValidation.contact2obj(e.innerText);o._data.name=n.name,o._data.email=o._fieldToArray(n.email)}if(!o.get("cid")&&!_.isEmpty(o.get("email"))){var a=ns.Model.get("abook-contacts").getContactDataByEmail(o.getHeadEmail());a&&(o._data.cid=a.cid)}var c=o.get("cid");if(c){var l=ns.Model.get("abook-contact",{cid:c});l.isValid()&&(o.get("name")||(o._data.name=l.getName()),o.get("phone")||(o._data.phone=l.getPhone()))}return o._data.value=o._fieldToArray(Jane.FormValidation.obj2contact({name:o.get("name"),email:o.getHeadEmail()})),o}return u(t,e),l(t,[{key:"_fields",get:function(){return C}}]),l(t,[{key:"getCustomProps",value:function(){return{isGroup:this.isGroup(),isContact:this.isContact(),hasInvalidEmail:this.hasInvalidEmail(),hasExternalEmail:this.hasExternalEmail()}}},{key:"needUpdate",value:function(){var e=!this.get("tid")&&!this.get("cid"),t=!this.hasInvalidEmail()&&this.getHeadEmail()&&this.getHeadEmail().length<this.constructor.EMAIL_LEN_REQUEST;return e&&t}},{key:"setEmail",value:function(e){this._data.email=this._fieldToArray(e),this._data.value=this._fieldToArray(Jane.FormValidation.obj2contact({name:this._data.name,email:e}))}},{key:"appendEmail",value:function(e,t){this._data.email=_.uniq(this.get("email").concat(e));for(var o=Jane.FormValidation.obj2contact({name:t,email:e}),n=!1,s=0;s<this._data.value.length;){var i=Jane.FormValidation.contact2obj(this.get("value")[s]);i.email===e&&(i.name!==t&&this._data.value.splice(s,1,o),n=!0),s++}n||this._data.value.push(o)}},{key:"removeEmail",value:function(e){this._data.email=_.difference(this.get("email"),[e]);for(var t=0;t<this._data.value.length;){Jane.FormValidation.contact2obj(this.get("value")[t]).email===e?this._data.value.splice(t,1):t++}}},{key:"getHeadEmail",value:function(){return this.get("email")[0]}},{key:"getPhone",value:function(){if(this.get("phone"))return{status:this.constructor.PHONE.FOUND,value:this.get("phone")};var e,t;if(!this.isContact()&&!this.isGroup()||this.hasInvalidEmail()||1!==this.get("email").length)return{status:this.constructor.PHONE.NOT_FOUND,value:null};if(this.isContact())t=ns.Model.get("abook-contact",{cid:this.get("cid")}),e=t.isValid()?t.getPhone():null;else if(this.isGroup()&&1===this.get("email").length){if(t=ns.Model.get("abook-contacts").getContactDataByEmail(this.getHeadEmail()),t=ns.Model.get("abook-contact",{cid:t&&t.cid}),!t.isValid())return{status:this.constructor.PHONE.SHOULD_REQUEST,value:null};e=t.getPhone()}return e?{status:this.constructor.PHONE.FOUND,value:e}:{status:this.constructor.PHONE.NOT_FOUND,value:null}}},{key:"isGroup",value:function(){return Boolean(this.get("tid"))}},{key:"isContact",value:function(){return Boolean(this.get("cid"))}},{key:"hasExternalEmail",value:function(){return this._data.email&&this._data.email.some(Jane.FormValidation.checkExternalEmail)}},{key:"hasInvalidEmail",value:function(){return this._data.email&&!this._data.email.every(Jane.FormValidation.checkEmail.bind(Jane.FormValidation))}},{key:"getText",value:function(){return this.get("name")||this.getHeadEmail()}},{key:"getAvatar",value:function(){return{email:this._data.tid?this._data.tid:_.escape(this.getHeadEmail()),name:_.escape(this.getText()),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:this.isGroup()}}}]),t})(Daria.BaseBubble),g.EMAIL_LEN_REQUEST=256,g.BUBBLE_CLASS="js-contact-bubble",g.PHONE={FOUND:"found",SHOULD_REQUEST:"should_request",NOT_FOUND:"not_found"},f=b))||f;Daria.ContactBubble=S},1230:function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,o){return t&&c(e.prototype,t),o&&c(e,o),e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return Jane.FormValidation.checkPhoneNumber(e)}function p(e){return Jane.FormValidation.splitPhones(e)}var m,f,g,b,v=o(724),y={phone:null,value:null,email:null,name:null,cid:null,type:null},C=(m=v({checkPaste:h,tokenizer:p}))((b=g=(function(e){function t(e){var o;s(this,t),o=i(this,r(t).call(this,e)),o.get("phone")||(o._data.phone=e.innerText);var n=o.get("phone");if(!o.get("cid")&&n){var a=ns.Model.get("abook-contacts").getContactDataByPhone(n);a&&(o._data.cid=a.cid)}var c=o.get("cid"),l=c?ns.Model.get("abook-contact",{cid:c}):ns.Model.get("abook-contact").findContactByPhone(n);return l&&l.isValid()&&(o._data.cid=c||l.get(".cid"),o._data.email=o.get("email")||l.getHeadEmail(),o._data.name=o.get("name")||l.getName()),o._data.value=o.get("phone"),o}return u(t,e),l(t,[{key:"_fields",get:function(){return y}}]),l(t,[{key:"renderBubbleNode",value:function(){return ns.renderNode({isPhone:!0,isValid:this.isValidPhoneNumber(),avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},"bubble-phone","compose2")}},{key:"needUpdate",value:function(){return!1}},{key:"isValidPhoneNumber",value:function(){return!this.getText()||Jane.FormValidation.checkPhoneNumber(this.getText())}},{key:"getAvatar",value:function(){return{email:_.escape(this._data.email),name:_.escape(this._data.name||this._data.email),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:!1}}}]),t})(Daria.BaseBubble),g.BUBBLE_CLASS="js-phone-bubble",f=b))||f;Daria.PhoneBubble=C},1231:function(e,t){ns.action.define("yabble.change-email",(function(e,t){return Daria.Dropdown.closeAll(),ns.events.trigger(e,t),!0})),ns.action.copy("yabble.change-email","yabble.edit"),ns.action.copy("yabble.change-email","yabble.remove"),ns.action.copy("yabble.change-email","yabble.single-target"),ns.action.define("yabble.change-group",(function(e,t){return ns.events.trigger(e,t),!0})),ns.action.define("yabble.add-to-abook",(function(e,t){Jane.Services.run("#contacts",(function(){ns.View.create("abook-person-popup").open({where:$(window),how:{my:"center",at:"center",of:window,fixed:!0}},{email:[t.email],first_name:t.name,yabbleId:t.id})})),Daria.Dropdown.closeAll()}))},1232:function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!(function(e,t){Daria.Yabble=function(e){var t=this;this.id=Daria.Yabble.genId(),this.value={},e&&this.val(e),this.root=$(Daria.Yabble.getHTML()),this.text=this.root.find(".js-yabble-content"),this.input=this.root.find(".js-yabble-input"),this.$smsLink=this.root.find(".js-sms-open-link"),this.$smsLink.on("click",(function(e){e.stopPropagation();var o=t.value;t.$smsLink.trigger("sms-link-click",o)})),this.$smsLink.on("dblclick",(function(e){e.stopPropagation()})),this.hideSmsLink(),Modernizr.msie&&this.root.on("selectstart",(function(e){t.focused||e.preventDefault()})),$.isEmptyObject(this.value)||this.pasteValue()},Daria.Yabble.KEY={UP:38,LEFT:37,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:44,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SHIFT:16,SEMI:59,SPACE:32,META:91,END:35,HOME:36,C:67,X:88,V:86,A:65,Z:90,ALT:18};var s=0,i={contact:"mail-Yabble_contact",group:"mail-Yabble_group",unreachable:"mail-Yabble_unreachable",external:"mail-Yabble_external",selected:"mail-Yabble_selected",focused:"mail-Yabble_focused"};Daria.Yabble.YC=i,Daria.Yabble.genId=function(){return s++},Daria.Yabble.getHTML=function(){return Daria.Yabble.template||(Daria.Yabble.template=$("<div></div>").html(Jane.tt("compose2:yabble"))),Daria.Yabble.template.html()},Daria.Yabble.template=null,Daria.Yabble.mergeContact=function(t,o){return"string"==typeof t&&(t=e.contact2obj(t)),"string"==typeof o&&(o=e.contact2obj(o)),o.email!==t.email?$.extend({},o):$.extend({},t,o)},Daria.Yabble.prototype={value:null,focused:!1,selected:!1,isContact:!1,isGroup:!1,isUnreachable:!1,isExternal:!0,doInput:function(e,t){var o=this.input[0];switch(e){case"focus":try{(t||document.activeElement!==o)&&(o.focus(),o.select())}catch(e){Jane.ErrorLog.sendException("activeElement",e)}break;case"enable":o.removeAttribute("disabled");break;case"disable":o.setAttribute("disabled","disabled")}},focus:function(){if(!this.focused&&!this.isGroup){this.deselect(!0),this.focused=!0;var t=e.obj2contact(this.value),o=this.value.name;this.doInput("enable"),this.doInput("focus"),t&&(this.text.text(t),this.input.val(t),Daria.setSelection(this.input[0],o?1:0,o?o.length+1:t.length)),this.root&&this.root.length&&(Modernizr.msie&&this.root.css("min-width",this.root.parent().width()-this.root.position().left-20),this.root.attr("draggable",""),this.root.addClass(i.focused))}},blur:function(e){this.focused&&(this.val(Daria.Yabble.mergeContact(this.value,this.getValue())),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},select:function(){if(this.selected)return void this.doInput("focus");this.blur(!0),this.selected=!0,this.root.addClass(i.selected),this.doInput("enable"),this.doInput("focus")},deselect:function(e){this.selected&&(e||this.doInput("disable"),this.root&&(this.root.removeClass(i.selected),this.selected=!1))},validate:function(){this.value.email?(this.isUnreachable=!e.checkEmail(this.value.email),this.root.toggleClass(i.unreachable,this.isUnreachable),this.isExternal=e.checkExternalEmail(this.value.email),this.root.toggleClass(i.external,this.isExternal)):this.isUnreachable=!1},pasteValue:function(){var e=this.value.name||this.value.email,t=this.root.find(".js-yabble-avatar");if(t.length){var o={href:!1,size:20,className:"mail-Yabble__avatar"};this.value&&this.value.email&&(o.email=this.value.email,o.name=e),t.replaceWith(Daria.Recipients.add(o))}this.input.val(this.val()),this.text.text(e),this.root.removeClass(i.focused),this.isContact=Boolean(this.value.cid),this.isGroup=Boolean(this.value.tid),this.root.toggleClass(i.contact,this.isContact),this.root.toggleClass(i.group,this.isGroup),this.validate()},userVal:function(){return this.input.val()},getValue:function(){var e=this.input,t=e.data("suggest")||$.trim(this.userVal()).replace(/(?:,|;)$/,"");return e.removeData("suggest"),t},val:function(t){var o=Daria.Constants.CONTACTS.DELIMITER;if(void 0===t)return this.value.tid?$.map(this.value.contacts,(function(t){return!t.ignored&&e.obj2contact(t)||null})).join(o):e.obj2contact(this.value);"object"===n(t)?this.value=t:this.value=e.contact2obj(t)},showSmsLink:function(){this.$smsLink.removeClass("is-hidden")},hideSmsLink:function(){this.$smsLink.addClass("is-hidden")},destroy:function(){this.root.remove(),this.root=this.text=this.input=null},onkeypress:function(){this.focused&&this.text.text(this.userVal())},onkeyup:function(){this.focused&&this.text.text(this.userVal())}},o(1233)})(Jane.FormValidation)},1233:function(e,t){var o=".b-mail-dropdown__box__content_yabble-",n={timeout:null,request:null,delay:150,template:"compose2:yabble-dropdown",json:{},toggle:function(e){var t=$(o+e.id).is(":visible");n.close(e),t||(n.remove(e),this.yabble=e,this.getParams(),this.load())},close:function(e){"number"==typeof this.timeout?(clearTimeout(this.timeout),this.timeout=null):this.request?(this.request.notify("abort"),this.request=null):(Daria.Dropdown.closeCurrent(),e&&n.remove(e))},remove:function(e){$(o+e.id).remove()},getParams:function(){var e=this.yabble,t=e.id,o=e.value,n=_.escape(o.name||""),s=_.escape(o.email||"");switch(!0){case e.isPhone:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown-phone",this.json={email:s,id:t};break;case e.isContact:this.params={cid:o.cid},this.handlers=["abook-contact"],this.template="compose2:yabble-dropdown-contact",this.json={email:s,id:t};break;case e.isGroup:this.params={tid:o.tid},this.handlers=["abook-contacts"],this.template="compose2:yabble-dropdown-group",this.json={id:t,email:$.map(o.contacts,(function(e){return!e.ignored&&e.email||null}))};break;case e.isUnreachable:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,name:n,email:s};break;case e.fromMessage:this.params=null,this.handlers=null,this.template="message:dropdown-contact",this.json={id:t,email:s,name:n,my:e.my,cid:e.cid};break;default:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,email:s,name:n}}},load:function(){var e=this.delay;if(this.handlers){var t,o=$.now();this.request=ns.request(this.handlers,this.params).then((function(){e-=$.now()-o,t=!0,this.request=null,this.open(e<0?0:e)}),this),t&&(this.request=null)}else this.open(e)},initializeNanoislands:function(e){nb.init(e)},open:function(e){var t=this,n=this.yabble,s=o+n.id,i=$(Jane.tt(this.template,this.json,this.handlers,this.params));e="delay"in n?n.delay:e,this.initializeNanoislands(i),$(s).remove();var a=function(){t.timeout=null,Daria.Dropdown.toggle(null,{content:$(i).find(s),dropdown:t.yabble.root,handle:t.yabble.root}),n.value&&n.value.email&&ns.action.run("common.copy",{container:s,text:n.value.email,onmouseup:function(){$(document).trigger("b-mail-dropdown-closeall")},doNotCloseDropdown:!0})};e<0?a():this.timeout=setTimeout(a,e)}};Daria.YabbleDropdown=n},1234:function(e,t){!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Jane.FormValidation,o={onlyFirstEmail:!0,joinName:!0},n=function(e,t){this.options=$.extend({},{maxItems:Number.MAX_VALUE,yabbleCtor:Daria.Yabble,yabbleType:"contact"},t||{}),this.id=Daria.Yabble.genId(),this.ids={},this.yabbles=[],this.strVal="",this.root=e,this.wrapper=e.find(".js-yabbles-container"),this.input=e.find(".js-yabbles-controller"),this.init(),this.multi=new Daria.YabbleMulti(this),Daria.YabbleHistory.start(this)};n.actions=["yabble.change-email","yabble.change-group","yabble.edit","yabble.remove","yabble.add-to-abook","yabble.single-target"],n.yabbleEvents=["dblclick","paste","keydown","keypress","keyup","focusout","focusin"],n.directEvents=["mousedown","mouseup","click"],n.prototype={option:function(e,t){var o=arguments.length;if(1===o)return this.options[e];2===o&&(this.options[e]=t)},getEmails:function(){return _.uniq($.map(this.yabbles,(function(e){return e.value.email})).sort())},recalcStrVal:function(t){t=t||{};var o=[];$.each(this.yabbles,(function(e,t){o.push(t.val())})),this.strVal=$.map(o,(function(e){return e||null})).join(e),this.root.find("input[type=hidden]").val(this.strVal),t.silent||this.trigger("change")},init:function(){var e=this;this.input.focus((function(){e.focus()})),$.each(n.directEvents,(function(t,o){e["ondirect"+o]&&e.root.bind(o,(function(t){e.e=t,e["ondirect"+o].apply(e,arguments)}))})),$.each(n.yabbleEvents,(function(t,o){e._setYabbleEvent(o)})),this.onactionRef=function(){e.onaction.apply(e,arguments)},n.actions.forEach((function(t){ns.events.on(t,e.onactionRef)}))},ondirectmousedown:function(e){if(!Daria.isLeftButton(e))return e.preventDefault(),void(Modernizr.opera||Modernizr.msie?this.add().focus():setTimeout(function(){this.add().focus()}.bind(this),200));var t=this.find("fromEvent",e);this.clicked=!1,this.mousedownId=null,t&&(this.mousedownId=t.id,this.onmousedown&&this.onmousedown(e,t))},ondirectmouseup:function(e){if(Daria.isLeftButton(e)&&this.mousedownId){var t=this.find("fromEvent",e),o=this.find("id",this.mousedownId);this.onmouseup&&this.onmouseup(e,o),o!==t&&(this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null)}},ondirectclick:function(e){if(Daria.isLeftButton(e)){var t=this.find("fromEvent",e);if(this.mousedownId){var o=this.find("id",this.mousedownId);o!==t&&this.onmouseup&&this.onmouseup(e,o),this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null}t||this.clicked||($(e.target).hasClass("js-sms-open-link")||(this.directclick=!0),this.add().focus(),this.directclick=!1)}},onaction:function(e,t){if(t.id in this.ids){var o=this.find("id",t.id);switch(e){case"yabble.change-email":o.value.email=t.email,o.pasteValue(),this.recalcStrVal(),o.select();break;case"yabble.change-group":$.each(o.value.contacts,(function(e,o){o.cid===t.cid&&o.email===t.email&&(o.ignored=!o.ignored)})),this.recalcStrVal();break;case"yabble.edit":o.focus();break;case"yabble.single-target":this.trigger("single-target",o);break;case"yabble.remove":this.remove(o);break;case"yabble.add-to-abook":this.update(o,t.cid)}}},onclick:function(e,t){if(!t.focused){t.select()||Daria.YabbleDropdown.toggle(t)}},ondblclick:function(e,t){Daria.YabbleDropdown.close(),t.focus()},onfocusin:function(e,t){e=e||$.Event("focusin",{target:this.root[0]});var o=this;if(Daria.composeParams){var n=this.input.closest(".js-compose-mail-input_to").length>0;Daria.composeParams["field-to-focused"]=n}var s=this.option("suggest");s&&(s.changeInputField(t.input[0]),t.focused?(s.setOptions({hide:function(){s.options.yabble.blur()},disabled:!1,timeoutOfCopyToSms:!0,yabble:t,previousValues:o.val().split(/,\s*/)}),this.directclick&&(s.show(""),setTimeout(function(){this.directclick=!1}.bind(this)))):s.setOptions({disabled:!0,hide:_.noop})),t.id!==this.mousedownId&&Daria.YabbleDropdown.close(),this.input.attr("disabled","disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))},onfocusout:function(e,o){var n=this;if(this.mousedownId!==o.id){var s=this.option("suggest");if(s){if(s.dontClose)return;s.setOptions({hide:_.noop}),s.hide()}var i=$.trim(o.userVal()).replace(/(?:,|;)$/,"");if(i||o.input.data("suggest"))if(o.focused){if(Daria.YabbleHistory.push(n),Daria.YabbleHistory.ignore=!0,i.indexOf(",")>-1||i.indexOf(";")>-1){var a=t.splitContacts(i),r=[];$.each(a,(function(e,t){r.push(n.add(t,o))})),this.remove(o),"contact"===this.options.yabbleType&&this.resolveContacts(a,r)}else o.blur(),this.recalcStrVal(),o.isContact||o.isGroup||o.isUnreachable||"contact"===this.options.yabbleType&&this.resolveContacts([o.value],[o]);Daria.YabbleHistory.ignore=!1}else o.selected&&o.deselect();else this.remove(o);this.input.removeAttr("disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))}},onkeydown:function(e,t){var o=this;switch(e.which){case Daria.Yabble.KEY.TAB:!e.shiftKey&&this.options.maxItems>this.yabbles.length&&(t.focused&&$.trim(t.userVal())||t.selected)&&(e.preventDefault(),this.add().focus());break;case Daria.Yabble.KEY.RETURN:Daria.isCtrlPressed(e)||e.preventDefault(),this.multi.history.length>1?this.add().focus():$.trim(t.userVal())&&(t.focused?this.add().focus():(t.focus(),this.onfocusin(null,t)));break;case Daria.Yabble.KEY.BACKSPACE:case Daria.Yabble.KEY.DEL:if(this.multi.history.length>1)e.preventDefault(),this.multi.remove();else{var n=this.find(e.which===Daria.Yabble.KEY.DEL?"next":"prev",t),s=this.find(e.which===Daria.Yabble.KEY.DEL?"prev":"next",t);(t.focused&&!$.trim(t.userVal())&&(n||s)||t.selected)&&(e.preventDefault(),this.remove(t),n?n.select():s?s.select():this.add().focus())}break;case Daria.Yabble.KEY.LEFT:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var i=this.find("prev",t);i&&i.select()}break;case Daria.Yabble.KEY.RIGHT:if(t.selected){e.preventDefault();var a=this.find("next",t);a?a.select():this.add().focus()}break;case Daria.Yabble.KEY.HOME:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var r=this.find("first");r&&r.select()}break;case Daria.Yabble.KEY.END:if(t.selected){e.preventDefault();var c=this.find("last");c&&c.select()}break;default:if(t.focused)Daria.isCtrlPressed(e)&&!$.trim(t.val())&&(e.which===Daria.Yabble.KEY.A?this.multi.selectAll():e.which===Daria.Yabble.KEY.Z&&Daria.YabbleHistory.pop(this));else if(Daria.isCtrlPressed(e))switch(e.which){case Daria.Yabble.KEY.C:this.multi.onCtrlC(t);break;case 17:case 91:case 224:break;case Daria.Yabble.KEY.V:o.add().focus();break;case Daria.Yabble.KEY.X:o.multi.history.length&&(o.multi.onCtrlX(t),setTimeout((function(){o.multi.remove()}),16));break;case Daria.Yabble.KEY.A:this.multi.selectAll();break;case Daria.Yabble.KEY.Z:Daria.YabbleHistory.pop(this);break;default:o.add().focus()}else e.which!==Daria.Yabble.KEY.SHIFT&&this.add().focus()}},onkeypress:function(e,o){var n,s=this;switch(e.which){case Daria.Yabble.KEY.SPACE:case Daria.Yabble.KEY.SEMI:case Daria.Yabble.KEY.COMMA:if(n=o.userVal().replace(/[,;\s]/g,""),o.focused&&n){if(e.which===Daria.Yabble.KEY.SPACE&&!t.checkEmail(n))break;setTimeout((function(){s.add().focus()}),0)}else e.preventDefault()}},onpaste:function(e,t){var o=this;setTimeout((function(){o.add().focus(),t.isUnreachable&&(t.focus(),Daria.setSelection(t.input[0],9999))}),0)},add:function(e,t){if(this.options.maxItems<=this.yabbles.length){var o=this.find("last");return o&&o.input&&o.input.val()?(o.select(),this.recalcStrVal()):o&&o.focus(),{focus:$.noop}}var n=this.multi.wrap(new this.options.yabbleCtor(e)),s=t&&$.inArray(t,this.yabbles);return this.ids[n.id]=!0,e&&Daria.YabbleHistory.push(this),s>-1?(n.root.insertBefore(t.root),this.yabbles.splice(s,0,n)):(this.wrapper.append(n.root),this.yabbles.push(n)),n},showSmsYabble:function(){this.yabbles.forEach((function(e){e.showSmsLink&&e.showSmsLink()}))},hideSmsYabble:function(){this.yabbles.forEach((function(e){e.hideSmsLink&&e.hideSmsLink()}))},update:function(e,t){ns.request("abook-contact",{cid:t}).then((function(t){var n=t[0],s=n.getContactInfo(o);$.isEmptyObject(s)||(e.val(s),e.pasteValue()),e.select()}))},remove:function(e,t){var o=$.inArray(e,this.yabbles);if(-1!==o){Daria.YabbleHistory.push(this),this.yabbles.splice(o,1),delete this.ids[e.id],Daria.YabbleDropdown.close(e),e.destroy();var n=this.option("suggest");n&&n.destroy(),this.recalcStrVal(t)}},find:function(e,t){var o;if("fromEvent"===e)return(o=$(t.target).closest(".js-yabble",this.wrapper[0])[0])&&this.find("target",o);if("first"===e)return this.yabbles[0];if("last"===e)return this.yabbles[this.yabbles.length-1];for(var n=0;n<this.yabbles.length;n++)if(o=this.yabbles[n],"target"===e){if(o.root[0]===t)return o}else if("prev"===e||"next"===e){if(o===t){if("prev"===e)return this.yabbles[n-1];if("next"===e)return this.yabbles[n+1]}}else if("id"===e){if(o.id===t)return o}else if(o[e])return o},_setYabbleEvent:function(e,t){var o=this;t=t||this["on"+e],this.root.on(e,".js-yabble",(function(n){if(o.e=n,"focusout"!==e||"input"===n.target.tagName.toLowerCase()){var s=o.find("target",n.currentTarget);s&&(t&&t.call(o,n,s),s["on"+e]&&s["on"+e].call(s,n))}}))},resolveContacts:function(e,t){if(e.length){var n=this;t=t||this.yabbles;var s,i=1/0,a=[];e.forEach((function(e){e.email.length<256&&(i+=e.email.length+1,i>256&&(i=0,s=[],a.push(s)),s.push(e.email))})),a.forEach((function(s){var i=[],a=s.join(",");i.push({id:"abook-contacts",params:{emails:a}}),Daria.Config.workspace&&i.push({id:"abook-contacts",params:{emails:a,shared:1}}),ns.request(i).then((function(i){var a=!1,r=i[0].getContactsInfoByEmails(s,o),c=i[1]?i[1].getContactsInfoByEmails(s,_.extend({shared:!0},o)):[],l=c.concat(r);$.each(e,(function(e,o){var n=o.email,s=t[e];if(s&&s.value.email===n)for(var i=l.length;i--;)if(n===l[i].email)return a=!0,s.val(Daria.Yabble.mergeContact(l[i],s.value)),s.pasteValue(),!0})),a&&n.recalcStrVal()}))}))}},val:function(e){var o=this;if(void 0===e)return this.strVal;for(;this.yabbles[0];)this.remove(this.yabbles[0],{silent:!0});if("string"==typeof e&&e){var n;n="contact"===this.options.yabbleType?t.splitContacts(e):e.split(/[;\s]/),$.each(n,(function(e,t){o.add(t)})),"contact"===this.options.yabbleType&&(o.recalcStrVal(),o.resolveContacts(n))}else $.isArray(e)&&($.each(e,(function(e,t){o.add(t)})),"contact"===this.options.yabbleType&&(o.recalcStrVal(),o.resolveContacts(e)));Daria.YabbleHistory.ignore||Daria.YabbleHistory.start(this)},focus:function(e){e&&(this.directclick=!0),this.add().focus()},isFocused:function(){return _.some(this.yabbles,"focused",!0)},validate:function(){for(var e=this.yabbles.length;e--;)if(this.yabbles[e].isUnreachable)return!1;return!0},destroy:function(){var e=this;this.val(""),n.actions.forEach((function(t){ns.events.off(t,e.onactionRef)})),this.root.unbind(),this.input.unbind(),this.multi.destroy(),Daria.YabbleHistory.stop(this);var t=this.option("suggest");t&&t.destroy()}},no.extend(n.prototype,ns.Events),Daria.Yabbles=n})()},1235:function(e,t){!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Daria.Yabble.prototype,o=Daria.YabbleMulti=function(e){this.set=e,this.clear()};o.prototype={history:null,push:function(e){this.pop(e),this.history.push(e),this.focusLast=void 0},pop:function(e){for(var t=this.history.length;t--;)this.history[t]===e&&this.history.splice(t,1)},clear:function(){this.shiftFirst=void 0,this.focusLast=void 0,this.history=[]},first:function(){return this.history[0]},last:function(){return this.history[this.history.length-1]},val:function(){return $.map(this.history,(function(e){return e.val()})).join(e)},ids:function(){return $.map(this.history,(function(e){return e.id}))},wrap:function(e){var o=this;return e.deselect=function(){var e=o.set.mousedownId;if(!o.set.find("id",e)){var t=o.ids().join(",");setTimeout((function(){t===o.ids().join(",")&&o.deselectAll()}),0)}},e.select=function(){var n=o.set.e||{},s=Daria.isCtrlPressed(n),i=n.shiftKey,a=$.inArray(n.which,[Daria.Yabble.KEY.LEFT,Daria.Yabble.KEY.RIGHT])>-1;if(i&&(!a||0!==o.history.length)||s&&!a)return i?o.selectTo(e):e.selected?(o.pop(e),t.deselect.apply(e),o.last()&&t.select.apply(o.last())):(t.select.apply(e,arguments),o.push(e)),!0;o.deselectAll(),o.push(e),t.select.apply(this,arguments)},e.focus=function(){var n=o.set.find("prev",e);o.deselectAll(),setTimeout((function(){o.focusLast=n}),16),t.focus.apply(e,arguments)},e.destroy=function(){o.pop(e),t.destroy.apply(e,arguments)},e},onCtrlC:function(e){if(this.history.length>1){var t=this.val();e.input.val(t),e.doInput("focus",!0),e.input.one("keyup blur",(function(){e.root&&e.doInput("focus",!0)}))}},remove:function(){var e=this;Daria.YabbleHistory.push(this.set),Daria.YabbleHistory.ignore=!0,$.each(this.history.slice(),(function(t,o){e.set.remove(o)}));var t=e.set.add();t&&t.focus(),Daria.YabbleHistory.ignore=!1},selectAll:function(){var e=this,o=$.map(this.set.yabbles,(function(e){return e.selected?null:e}));$.each(o,(function(o,n){n&&!n.focused&&(t.select.apply(n),e.push(n))}))},selectTo:function(e){var o=this,n=this.shiftFirst||this.focusLast||this.last()||this.set.yabbles[0];this.deselectAll(),this.shiftFirst=n;for(var s=$.inArray(n,this.set.yabbles),i=$.inArray(e,this.set.yabbles),a=s>i?"prev":"next";n&&n!==e;)t.select.apply(n),o.push(n),n=this.set.find(a,n);t.select.apply(e),o.push(e)},deselectAll:function(){this.clear(),$.each(this.set.yabbles,(function(e,o){t.deselect.apply(o)}))},unwrap:function(e){},destroy:function(){this.clear()}},o.prototype.onCtrlX=o.prototype.onCtrlC})()},1236:function(e,t){!(function(){Daria.YabbleHistory={sets:{},history:{},ignore:!1,start:function(e){this.history[e.id]=[],this.sets[e.id]=e},stop:function(e){delete this.history[e.id]},key:function(e){return $.map(e,(function(e){return e.email||""})).join(",")},values:function(e){return $.map(e.yabbles,(function(e){return!$.isEmptyObject(e.value)&&$.extend({},e.value)||null}))},push:function(e,t){if(!this.ignore&&this.history[e.id]){var o=this.history[e.id],n=o[o.length-1],s=this.values(e),i=this.key(s);if(n&&n.key===i)t&&(n.link=t);else{var a={values:s,key:i};t&&(a.link=t),o.push(a)}}},pop:function(e){this.ignore=!0;var t=this.history[e.id];if(t&&t.length){var o=t.pop();e.val(o.values);var n=e.add();if(n&&n.focus(),o.link)for(var s in this.history){var i=this.history[s];i.length&&o.link===i[i.length-1].link&&this.pop(this.sets[s])}}this.ignore=!1}}})()},1237:function(e,t){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Daria.YabblePhone=function(){Daria.Yabble.apply(this,arguments)},Jane.extend(Daria.YabblePhone,Daria.Yabble),Daria.YabblePhone.prototype.validate=function(){var e=this.value;e?(this.isUnreachable=!Jane.FormValidation.checkPhoneNumber(e),this.root.toggleClass(Daria.Yabble.YC.unreachable,this.isUnreachable)):this.isUnreachable=!1},Daria.YabblePhone.prototype.blur=function(e){this.focused&&(this.val(this.getValue()),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},Daria.YabblePhone.prototype.val=function(e){if(void 0===e)return this.value;"object"===o(e)?this.value=e.phone:this.value=e},Daria.YabblePhone.prototype.pasteValue=function(){var e=this.value;this.input.val(this.val()),this.text.text(e),this.root.removeClass(Daria.Yabble.YC.focused),this.isContact=!0,this.isPhone=!0,this.isGroup=!1,this.root.toggleClass(Daria.Yabble.YC.contact,this.isContact),this.root.toggleClass(Daria.Yabble.YC.group,this.isGroup);var t=this.root.find(".js-yabble-avatar");t.length&&t.replaceWith(Daria.Recipients.add({href:!1,size:20,className:"mail-Yabble__avatar"})),this.validate()}},1238:function(e,t){!(function(){if("ontouchend"in window&&/iPad|iPhone/.test(navigator.userAgent)){var e=Daria.Yabble.KEY,t=Daria.Yabbles;t.directEvents=["touchend"];var o=t.prototype.onkeydown;$.extend(t.prototype,{ondirecttouchend:function(e){var t=this.find("fromEvent",e);if(t&&this.onclick&&(!t.focused||t.userVal()))this.onclick(e,t);else{var o=this.add();o&&o.focus()}},onkeydown:function(t,n){if(t.which===e.BACKSPACE||t.which===e.DEL){var s=this.find(t.which===e.DEL?"next":"prev",n),i=this.find(t.which===e.DEL?"prev":"next",n);if(n.focused&&!$.trim(n.userVal())&&(s||i))t.preventDefault(),s?this.remove(s):i&&this.remove(i);else if(n.selected)if(t.preventDefault(),this.remove(n),s)s.select();else if(i)i.select();else{var a=this.add();a&&a.focus()}}else o.apply(this,arguments)}})}})()},1239:function(e,t,o){o(1240),o(1241),o(1242),o(1243),o(1244),o(1245),o(1246),o(1247),o(1248),o(1249),o(1251),o(1252),o(1253),o(1254),o(1255),o(1256),o(1257),o(1258),o(1259),o(1260),o(1261)},1240:function(e,t){!(function(){ns.Model.define("do-attach-file-status",{params:{oid:null}})})()},1241:function(e,t){!(function(){ns.Model.define("do-attach-file-store",{params:{file:null}})})()},1242:function(e,t){!(function(){var e=ns.ModelStatic,t=["attachments.added","attachments.appended","attachments.updated","attachments.removed","attachments.failed"];ns.Model.define("compose-attachments",{params:{ids:null,tids:null,oper:null},ctor:function(){this._attachments=null,this.processCollectionEvent=this.processCollectionEvent.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this,t=ns.Model.info("message-body").calculateParamsForMessageBody(this.params);return t?ns.request(["message-body","compose-message"],t).then((function(t){e._initByModels(t[0],t[1])})):(e.setData({}),vow.resolve())},init:function(e){this._attachments?this._attachments.setOptionsAndInit(e):(this._attachments=new Daria.AttachmentCollection2(e),this.bindEventsToAttachments())},_initByModels:function(e,t){this.setData({}),this._mMessageBody=e,this._mComposeMessage=t;var o=new Daria.AttachmentCollection2;o.mComposeMessage=t,this._attachments=o,this.bindEventsToAttachments(),t.isReplyAny()||e.getAttachments().forEach((function(e){e.inline||this.addAttachData(e)}),this)},addAttachData:function(e,t){if(this._attachments){var o=t&&t.mMessageBody?t.mMessageBody:this._mMessageBody,n=t&&t.mComposeMessage?t.mComposeMessage:this._mComposeMessage,s=Daria.Attachment2.fromMessageBody(e,o,n);return this._attachments.addAttachToCollection(s,{silent:!0,processAttachSize:!1}),s}},destroy:function(){e.prototype.destroy.apply(this,arguments),this.unbindEventsFromAttachments(),this._attachments&&(this._attachments.reset(),this._attachments=null)},bindEventsToAttachments:function(){this._attachments&&_.each(t,(function(e){this._attachments.on(e,this.processCollectionEvent)}),this)},unbindEventsFromAttachments:function(){this._attachments&&_.each(t,(function(e){this._attachments.off(e,this.processCollectionEvent)}),this)},processCollectionEvent:function(e,t){this.trigger("ns-model:"+e,t)},addAttach:function(e){this._attachments&&(e.resource?this._attachments.addDiskAttach(e.id,e.resource):this._attachments.add(e.input,e.files))},appendAttach:function(e,t,o){this._attachments&&this._attachments._appendAttach(e,t,o)},drawAttaches:function(){if(this._attachments){var e=this.params.ids||Daria.getPageComposeIds();this._attachments.redrawAttachesBulk(null,e)}},updateAfterSave:function(e,t){this._attachments&&this._attachments.updateAfterSave(e,t,!0)},isUploading:function(){return this._attachments&&this._attachments.isUploading()},isFailed:function(){return!!this._attachments&&this._attachments.isFailed()},hasFiles:function(){return this._attachments&&this._attachments.hasFiles()},retryAttach:function(e){this._attachments.retryAttach(e)}}})})()},1243:function(e,t){!(function(){ns.Model.define("disk-default-folders",{methods:{isPhotostream:function(e){return e&&this.get(".photostream")===e}}})})()},1244:function(e,t){!(function(e,t){function o(e){e.meta&&e.meta.sizes&&$.each(e.meta.sizes,(function(o,i){var a=t.Config["downloader-domain-zone"];"mail"===e.service?-1===i.url.indexOf("yandex.net")&&(i.url=s(i.url,a)):"ua"===a&&(i.url=s(i.url,"ru")),i.url=n(i.url)}))}function n(e){return e.replace(r,"")}function s(e,t){var o=e.match(/(?:(?:https?\:)?\/\/)?[^\/]*/g)[0];return e.replace(o,o.replace(a,t))}var i=null;ns.Model.define("disk-resources",{params:{path:null,offset:null,sort:null,order:null},methods:{cancelledAttachPaths:[],getDefaultSort:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"etime":"name"},removeAttach:function(e){this.cancelledAttachPaths.push(e)},getDefaultOrder:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"0":"1"},deselect:function(){var e=i;i=null,ns.events.trigger("disk-resources.selected",{before:e})},select:function(e){if(e&&e!==i){var t=i;i=e,ns.events.trigger("disk-resources.selected",{before:t,now:e})}},getSelected:function(){return i},extractError:function(e){return 404===Number(jpath(e,".error.http_status")[0])?(ns.events.trigger("disk-resources.not-found",e.error),e.data={},null):e.error},preprocessData:function(e){var t=jpath(e,".resource.resource")[0];if(Array.isArray(t)){if(t.forEach(o),this.params.hasOwnProperty("offset")){var n=$.extend({},this.params);delete n.offset;var s=ns.Model.get(this.id,n),i=s.getData();if(i){var a=no.jpath(".resource",i)[0];a&&(Array.prototype.push.apply(a.resource,t),s.__offset=t.length+(s.__offset||0))}else s.setData(e),s.__offset=t.length;return s.__complete=0===t.length,e}this.__offset=t.length,this.__complete=0===t.length}return e},getPreview:function(e){var t=$.Deferred(),o={private_hash:e,meta:"preview"};return ns.request("do-disk-get-public-preview",o).then((function(e){var o=jpath(e[0].getData(),".resource.meta.preview")[0];o?t.resolve(o):t.reject()}),(function(){t.reject()})),t.promise()},attach:function(e){var t=$.Deferred(),o=this;return (function(e,n){ns.forcedRequest("do-disk-attach-file",{src:e,dst:n}).then((function(n){var s=n[0];if(s.getError())ns.Model.invalidate(o.id),t.reject(s.getError());else{var i=s.getData();if(i&&i.oid){var a={oid:i.oid,meta:"short_url,public,size,public_hash"};o.poll(a,e).done((function(e){var o=e.file||e.folder;o.type=e.file?"file":"dir",t.resolve({url:o.meta&&o.meta.short_url,name:o.name,type:o.type,size:o.meta&&o.meta.size,hash:o.meta&&o.meta.public_hash})})).fail((function(e){t.reject(e)}))}else t.reject()}}),(function(e){ns.Model.invalidate(o.id),t.reject(e.data||e)}))})(e),t.promise()},poll:function(e,t){function o(){ns.forcedRequest("do-attach-file-status",e).then((function(e){var a=e[0],r=jpath(a.getData(),".operation")[0];if(!r)return n.reject();if(-1!==i.cancelledAttachPaths.indexOf(t))return _.remove(i.cancelledAttachPaths,t),n.reject();var c=r.status;"EXECUTING"===c||"WAITING"===c?window.setTimeout(o,s):"FAILED"===c?n.reject(c.error):"DONE"===c&&n.resolve(r)}),(function(){n.reject()}))}var n=$.Deferred(),s=1500,i=this;return o(),n.promise()},loadMore:function(e){var t=$.Deferred(),o=$.extend({},e);delete o.offset;var n=ns.Model.get(this.id,o);return n.__complete?t.reject():(ns.forcedRequest("disk-resources",$.extend({offset:n.__offset},o)).then((function(e){var o=e[0],n=no.jpath(".resource.resource",o.getData())[0];if(n){var s=n[0];if(s)return t.resolve(s)}t.reject()}),(function(){t.reject()})),t.promise())},find:function(e){var o=t.utils.dirname(e)+"/",n=ns.Model.get(this.id,{path:o,sort:this.getDefaultSort(o),order:this.getDefaultOrder(o)});if(!n.getData()||!n.get(".resource")||!n.get(".resource")[0])return!1;for(var s=n.get(".resource")[0],i=0,a=s.resource.length;i<a;i+=1)if(s.resource[i].id===e)return s.resource[i];return!1}}});var a=new RegExp("("+t.Config.domainZonesForReg+"|([^\\.]+)$)"),r=/^(https?:)/})(Jane,Daria)},1245:function(e,t){!(function(){ns.Model.define("do-disk-attach-file",{params:{dst:null,src:null}})})()},1246:function(e,t){!(function(){ns.Model.define("do-disk-get-public-preview",{params:{private_hash:null,meta:null}})})()},1247:function(e,t){!(function(){var e={IS_OPTION_SET:"no_reply_notify",TIME_DELTA:"no_reply_notify_time",WAS_FIRST_VISIT_POPUP_SHOWN:"noreply_popup_shown",IS_SAVE_SENT_SET:"save_sent"},t=[{time:{hours:1}},{time:{hours:12}},{time:{days:1}},{time:{days:2}},{time:{days:3}},{time:{days:5},default:!0},{time:{weeks:1}},{time:{weeks:2}}];ns.Model.define("compose-notify-noreply-options",{params:{ids:null,oper:null},methods:{request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"}]},_initFromModels:function(e){this.mSettings=e[0],this.setData({enabledNotify:!1,alwaysNotify:!1,currentTimeDelta:null,timeDeltaItems:this._generateTimeDeltaItems(t)}),this.initData()},_getTimeDeltasUnitToStore:function(){return"seconds"},_generateTimeDeltaItems:function(e){var t=this.mSettings.getSetting("no_reply_notify_time"),o=this._getTimeDeltasUnitToStore(),n=Boolean(this.isSetInSettings()&&t);return t=t?parseInt(t,10):0,e=_.clone(e,!0),_.map(e,(function(e){var s=!1,i=Daria.timify(e.time,o);return n?s=i===t:e.default&&(s=!0),_.extend(e,{value:Daria.timify(e.time,o),text:Jane.Date.daysIntervalLocalization(e.time,!0),selected:s})}))},getCurrentTimeDelta:function(){return this.get(".currentTimeDelta")},setCurrentTimeDelta:function(e){e=this.findTimeDeltaItem(e),e||(e=this.getDefaultTimeDeltaItem()),this.set(".currentTimeDelta",e),this.set(".enabledNotify",!0)},getCurrentTimeDeltaLocalizedText:function(){var e=Jane.Date.daysIntervalLocalization(this.getCurrentTimeDelta().time);return i18n("%Compose_Checkbox_No_Reply_Active_Text_3",e)},findTimeDeltaItem:function(e){var t=e;return e&&e.value&&(t={value:Number(e.value)}),_.find(this.get(".timeDeltaItems"),t)},getSelectedTimeDeltaItem:function(){return this.findTimeDeltaItem({selected:!0})},getDefaultTimeDeltaItem:function(){return this.findTimeDeltaItem({default:!0})},isSetInSettings:function(){return Boolean(this.mSettings.isSet(e.IS_OPTION_SET)&&this.mSettings.isSet(e.IS_SAVE_SENT_SET))},setAlwaysNotifyOption:function(t){var o={};t?(o[e.IS_OPTION_SET]=!0,o[e.TIME_DELTA]=this.getCurrentTimeDelta().value,o[e.IS_SAVE_SENT_SET]=!0,this.set(".alwaysNotify",!0),this.set(".enabledNotify",!0)):(o[e.IS_OPTION_SET]=!1,this.set(".alwaysNotify",!1)),this.mSettings.setSettings(o)},wasFirstVisitPopupShown:function(){return this.mSettings.isSet(e.WAS_FIRST_VISIT_POPUP_SHOWN)},setFirstVisitPopupWasShown:function(){this.mSettings.setSettingOn(e.WAS_FIRST_VISIT_POPUP_SHOWN)},initData:function(){this.set(".currentTimeDelta",this.getSelectedTimeDeltaItem()),this.set(".enabledNotify",this.isSetInSettings()),this.set(".alwaysNotify",this.isSetInSettings())}}})})()},1248:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(725);!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Vow.resolve();ns.Model.define("compose-predefined-data",{events:{"ns-model-init":"_onInit"},params:{},methods:{request:function(){return t},_replaceParams:{mailto:"to",body:"send",subject:"subj"},_pickableParams:["to","cc","bcc","save_symbol","send","subj"],_normalizableParams:["to","cc","bcc"],_onInit:function(){var e=this._createDataFromUrl();this.setData(e),_.isEmpty(e)||this._cleanUrl()},_replaceParamsCallback:function(e,t){this.hasOwnProperty(t)&&(this[e]=this[t],delete this[t])},_createDataFromUrl:function(){var t={};return Daria.isComposePage()&&(t=_.clone(ns.page.current.params),_.forEach(this._replaceParams,this._replaceParamsCallback,t),_.forEach(this._normalizableParams,(function(o){t[o]&&(t[o]=_.map(Jane.FormValidation.splitContacts(t[o]),"email").join(e))})),t=_.pick(t,this._pickableParams),t.send&&(t.send=this._getBody(t.send))),t},_getBody:function(e){return this._shouldReturnPlainText()?this._isHtml(e)?Daria.Html2Text.html2text(e):e:this._isHtml(e)?n.a.sanitize(e):n.a.sanitize(_.escape(e).replace(/(?:\r\n|\r|\n)/g,"<br>"))},_isHtml:function(e){var t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.childNodes).some((function(e){return 1===e.nodeType}))},_shouldReturnPlainText:function(){return Boolean(Daria.UA.isMobile||!ns.Model.get("settings").isSet("enable_richedit"))},_cleanUrl:function(){var e=this._pickableParams.concat(Object.keys(this._replaceParams)),t=_.omit(ns.page.current.params,e);ns.page.replacePage(ns.page.current.page,t)}}})})()},1249:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1250);!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t={att_ids:null,bcc:"",captcha_entered:null,captcha_key:null,cc:"",charset:null,compose_check:null,confirm_limit:null,current_folder:null,doit:null,errors:{to:"",cc:"",bcc:"",phone:""},fid:null,from_mailbox:null,from_name:null,get_abook:null,html:null,idcs:null,ids:[],ign_overwrite:null,initial_cc:"",initial_to:"",inreplyto:null,lids:[],mark_as:null,mark_ids:[],narod_att:null,nosave:null,nosend:null,notify_on_send:null,overwrite:null,parts:null,phone:null,references:null,remind_period:null,"recipients-diff":{added:[],removed:[]},retpath:null,returl:null,saveDraft:null,save_symbol:"draft",send:"",send_time:null,store_fid:null,store_name:null,strict_charset:null,style:null,subj:null,to:"",ttype:null,where:null},o=["to","cc","bcc","phone","subj","send","from_mailbox","from_name","ttype","att_ids","parts","narod_att","save_symbol","lids"],s=_.map(o,(function(e){return"."+e})),i=ns.Model;ns.Model.define("compose-message",{params:{ids:null,tids:null,oper:null},events:{"ns-model-destroyed":"_onDestroyed","ns-model-changed.to":"_onRecipientsChanged","ns-model-changed.cc":"_onRecipientsChanged","ns-model-changed.bcc":"_onRecipientsChanged"},ctor:function(){this._attachments={},this.mSettings=null,this.mComposePredefinedData=null,this.mMessage=null,this.mMessageBody=null,this.mComposeState=null,this._saveDraftPromise=null,this._cancelled=!1,this._cancelSendCallback=null,this._hasSendWithUndoFailed=!1},methods:{_onDestroyed:function(){this._isDirty=!1,this._cancelled=!1,this._cancelSendCallback=null,this._hasSendWithUndoFailed=!1},setIfChanged:function(e,t){if(this.isValid()&&this.data){var o=!0;if(-1!==[".to",".cc",".bcc"].indexOf(e)){var n=/,\s*$/;o=this.get(e).replace(n,"")!==t.replace(n,"")}o&&ns.Model.prototype.setIfChanged.apply(this,arguments)}},_dataPathToActionLogName:{".to":"редактирование письма/получатель (To:)",".subj":"редактирование письма/тема",".send":"редактирование письма/текст",".parts":"редактирование письма/аттачи",".narod_att":"редактирование письма/аттачи",".parts_json":"редактирование письма/аттачи"},set:function(e,t){if(!_.isEqual(t,this.get(e))){_.contains(s,e)&&(this._isDirty=!0);var o=Daria.SendMail.getUndoSendLogger(),n=this._dataPathToActionLogName[e];return n&&o.logActionOnceAfterCancel(n),i.prototype.set.apply(this,arguments)}},setData:function(){return this._isDirty=!0,i.prototype.setData.apply(this,arguments)},setPhoneIfExist:function(e,t){if(!this.get(".phone")||t){var o=ns.Model.get("abook-contacts").getContactDataByEmail(e);if(o&&o.cid){var n=ns.Model.get("abook-contact",{cid:o.cid}),s=n.isValid()&&n.getPhone();return s&&this.setIfChanged(".phone",s),vow.Promise.resolve()}return ns.request("abook-contact",{email:e}).then((function(e){var t=e[0],o=t.getPhone();o&&this.setIfChanged(".phone",o)}),this)}},setSingleRecipient:function(e){this.setIfChanged(".to",e),this.setIfChanged(".cc",""),this.setIfChanged(".bcc","")},canRequest:function(){var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params),t=ns.Model.get("message-body",e);return t.canRequest()&&!t.get(".error")},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},isDraft:function(){return!this.isTemplate()&&(!("no"!==this.get(".ign_overwrite")||!this.get(".overwrite"))||!(this.params.oper||!this.mMessage||!this.mMessage.isDraftLike()))},getDraftMid:function(){var e=this.get(".overwrite");if(this.isDraft()&&e)return e},getTemplateMid:function(){var e=this.get(".overwrite");if(this.isTemplate()&&e)return e},_constructModelRequest:function(){var e=[{id:"settings"},{id:"compose-predefined-data"}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message",params:{ids:this.params.ids}},{id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_prepareDataForSet:function(e){var o=_.extend(_.cloneDeep(t),this.mComposePredefinedData.getData(),e,this._customizerPrepareData);return this.mComposePredefinedData.destroy(),o},_customizerPrepareData:function(e,t,o){return"send"===o?e+t:t},_setDefaultData:function(){var e=this._getFromEmail()||ns.Model.get("account-information").getFromDefaultEmail(),t=this.mSettings.getSetting("from_name"),o=this._getMessageType(),n=this._prepareDataForSet({from_mailbox:e,from_name:t,ttype:o,send:""});n.send=Daria.signs.appendToBody(n.send,o,!0),this.setData(n)},_setDraftData:function(){var e=this._getMessageType(),t=this.mMessage.isTemplate()?"template":"draft",o=_.clone(this.mMessage.get(".lid")),n=this.mMessage.getDelayedTime();if(!n){var s=ns.Model.get("labels").getDelayedMessageLabel();s&&(o=_.pull(o,s.lid))}var i=this._prepareDataForSet({overwrite:this.params.ids,ign_overwrite:"no",save_symbol:t,to:this.mMessageBody.getAddressField("to"),cc:this.mMessageBody.getAddressField("cc"),bcc:this.mMessageBody.getAddressField("bcc"),phone:this.mMessageBody.getAddressField("phone"),lids:o,from_name:this.mMessage.getFromName(),from_mailbox:this.mMessage.getFromEmail(),subj:this.mMessage.getSubject(),send:this.mMessageBody.getDraftBody(e),ttype:e,inreplyto:this.mMessageBody.getInReplyTo(),references:this.mMessageBody.getReferences(),current_folder:this.mMessage.getFolderId(),send_time:n});this.setData(i)},_setReplyData:function(){var e=this._getMessageType(),t=this.mMessageBody.getRecipients(this.isReplyAll()),o=this.mMessageBody.getMessageId(),n=this.mMessageBody.getReferences(),s=this.mMessageBody.getInReplyTo(),i=this.mMessageBody.getInfo("delivered-to")[0],a=this._getFromEmail(),r=this.needCollapsedQuotedMessage(),c="";r||(c=this.mMessageBody.getReplyBody(e,a));var l=this._prepareDataForSet({from:{receiver:i},from_mailbox:a,from_name:this.mSettings.getSetting("from_name"),overwrite:this.params.ids,ign_overwrite:"yes",mark_as:"replied",mark_ids:[this.params.ids],to:t.to,cc:t.cc,bcc:"",subj:"Re: "+this.mMessage.getSubject(!0),send:c,collapsedMessage:r,ttype:e,inreplyto:o,references:_.trim((n||s||"")+" "+o)});this.setData(l)},_getForwardMarkIds:function(){return this.mMessage?this.mMessage.isThread()&&1===this.mMessage.get(".count")?[this.mMessage.get(".last_mid")]:this.mMessage.isThread()?[]:[this.mMessage.get(".mid")]:[]},_setForwardData:function(){var e=this._getMessageType(),t=this._getFromEmail(),o="",n=null,s="",i=null;this.mMessage&&(o="Fwd: "+this.mMessage.getSubject(!0),n=this.mMessage.getFolderId()),this.mMessageBody&&(s=this.mMessageBody.getForwardBody(e,t),i=this.mMessageBody.getMessageId());var a=this._prepareDataForSet({ttype:e,from_mailbox:t,from_name:this.mSettings.getSetting("from_name"),cc:"",bcc:"",subj:o,send:s,inreplyto:i,current_folder:n,overwrite:this.params.ids,ign_overwrite:"yes",references:"",mark_ids:this._getForwardMarkIds(),mark_as:"forwarded"});this.setData(a)},_setRecipients:function(){var e="",t="";if(this.isDraft())e=this.mMessageBody.getAddressField("to"),t=this.mMessageBody.getAddressField("cc");else if(this.isReplyAny()){var o=this.mMessageBody.getRecipients(this.isReplyAll());e=o.to,t=o.cc}this.set(".initial_to",e,{silent:!0}),this.set(".initial_cc",t,{silent:!0})},_initFromModels:function(e){this.mMessage=_.find(e,"id","message"),this.mSettings=_.find(e,"id","settings"),this.mMessageBody=_.find(e,"id","message-body"),this.mComposePredefinedData=_.find(e,"id","compose-predefined-data"),this.mComposeState=ns.Model.get("compose-state",this.params),this.isTemplate()||this.isDraft()?this._setDraftData():this.isReplyAny()?this._setReplyData():this.isForward()?this._setForwardData():this._setDefaultData(),this._setRecipients(),this.markSaved()},isMessageCollapsed:function(){return Boolean(this.get(".collapsedMessage"))},needCollapsedQuotedMessage:function(){return!Daria.isComposePage()},expandMessage:function(){this.isMessageCollapsed()&&(this.isReplyAny()&&this.set(".send",this.getSendMessage()),this.set(".collapsedMessage",!1))},getSendMessage:function(){var e=this.get(".send");if(this.isMessageCollapsed()&&this.isReplyAny()){var t=this.get(".ttype"),o=this.get(".from_mailbox");e+=this.mMessageBody.getReplyBody(t,o)}return e},_getMessageType:function(){var e;return Daria.UA.isMobile?e="plain":this.mSettings.isSet("enable_richedit")?e="html":this.mMessageBody&&(e=this.mMessageBody.getSubtype()),e||"plain"},_getFromEmail:function(){return this.mMessage&&this.mMessage.getToEmail()||this.mSettings.getSetting("default_email")},isTypeDefined:function(){return _.isString(this.get(".ttype"))},isHtmlType:function(){return"html"===this.get(".ttype")},isDirty:function(){return this._isDirty},wasSendCancelled:function(){return this._cancelled},setDirty:function(e){this._isDirty=e},setSendWithUndoFailed:function(){this._hasSendWithUndoFailed=!0},markSaved:function(){this._isDirty=!1},changeRecipientsToOpposite:function(){var e=this.isReplyAll(),t={to:this.get(".to"),cc:this.get(".cc")},o=this.mMessageBody.getRecipients(e),n=this.mMessageBody.getRecipients(!e);this.set(".to",this._calculateOppositeRecipients(t.to,o.to,n.to)),this.set(".cc",this._calculateOppositeRecipients(t.cc,o.cc,n.cc))},_extractEmailsFromContacts:function(e){return _(e).pluck("email").compact().value()},_calculateOppositeRecipients:function(e,t,o){e=Jane.FormValidation.splitContacts(e),t=Jane.FormValidation.splitContacts(t),o=Jane.FormValidation.splitContacts(o);var n=this._extractEmailsFromContacts(t),s=_.filter(e,(function(e){return!_.contains(n,e.email)})),i=this._extractEmailsFromContacts(s),a=_.filter(o,(function(e){return!_.contains(i,e.email)}));return Daria.formatContacts([].concat(s,a))},_checkData:function(){return n.a.validate(this)},storeErrors:function(e){_.each(e,(function(e,t){this.setIfChanged(".errors."+t,e)}),this),this.triggerFieldErrors(e)},triggerFieldErrors:function(e){this.trigger("ns-model:validation-error",e)},cleanErrors:function(){_.each(["to","cc","bcc","phone","att_ids"],(function(e){this.setIfChanged(".errors."+e,"")}),this)},getFieldError:function(e){return this.get(".errors."+e)},confirmations:Daria.ComposeComponents.confirmations.getConfirmations(),checkConfirmations:function(){var e=!1,t={};return _.each(this.confirmations,(function(o){return!(e=o(this,t))}),this),e&&this.trigger("ns-model:need-to-confirm:"+e,t),e},hasAttach:function(){return!_.isEmpty(this._attachments)||this.get(".ids").length},_getAttributeFromData:function(e,t){return _(e).pluck(t).compact().value()},_excludeFromProperty:function(e,t){return _.without(this.get("."+e),t)},addAttachment:function(e,t){this._attachments[e.getId()]=e,this._saveAttachmentData(),t&&this._savePartsJsonAttachmentData()},removeAttachment:function(e){delete this._attachments[e],this._saveAttachmentData()},addTextFromMessageBody:function(e){var t=this.get(".ttype"),o=e.getComposeHTML();"html"===t?o+="<br>":o=Daria.Html2Text.html2text(o)+"\n";var n=this.get(".send");this.set(".send",o+n)},addAttachmentsFromTemplateMessageBody:function(e){var t=ns.Model.get("compose-attachments",this.params);e.getAttachments().forEach((function(o){if(!o.inline){o=_.extend({},o,{from_template:!0,template_mid:e.params.ids,template_hid:o.hid}),delete o.hid;var n=t.addAttachData(o,{mMessageBody:e,mComposeMessage:this});n.mComposeMessage.addAttachment(n,!0),t.appendAttach(n,!0)}}),this)},setRecepientsFromMessageBody:function(e){var t=this;["to","cc","bcc"].forEach((function(o){var n=e.getAddressField(o);n&&t.set("."+o,n)})),this.mComposeState.set(".isCcVisible",Boolean(this.get(".cc"))),this.mComposeState.set(".isBccVisible",Boolean(this.get(".bcc")))},addForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.uniq(this.get(".mark_ids").concat(e));this.set(".mark_ids",t);var o=_.uniq(this.get(".ids").concat(e));this.set(".ids",o)}},removeForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.difference(this.get(".mark_ids"),e);this.set(".mark_ids",t);var o=_.difference(this.get(".ids"),e);this.set(".ids",o)}},_saveAttachmentData:function(){var e=_.map(this._attachments,(function(e){return e.getDataToSend()}));this.set(".att_ids",this._getAttributeFromData(e,"att_id")),this.set(".parts",this._getAttributeFromData(e,"hid")),this.set(".narod_att",this._getAttributeFromData(e,"disk").join(""))},_savePartsJsonAttachmentData:function(){var e=_.map(this._attachments,(function(e){return e.getDataToSend()}));this.set(".parts_json",this._getPartsJsonFromAttachmentData(e))},_getPartsJsonFromAttachmentData:function(e){var t=_.filter(e,"from_template").map((function(e){return{mid:e.template_mid,hid:e.template_hid}}));return t.length>0?JSON.stringify(t):""},_getCommonSendParams:function(){var e={compose_check:ns.Model.get("account-information").getDataKey("compose-check")};return ns.request.addRequestParams(e),e},_updateDataAfterSave:function(e){this.set(".ign_overwrite","no"),this.set(".overwrite",e.storedmid),e.store_fid&&this.set(".current_folder",e.store_fid)},_updateDraftAfterAction:function(e,t){if(t=t||this.getDraftMid()){var o=ns.Model.get("message",{ids:t});if(!e){ns.Model.traverse("messages",(function(e){e.remove(o)}));var n=o.getThreadMessage();n&&n.hasRealData()&&n.updateThreadCount(-1)}var s=function(e){return e.isValid()&&e.params.ids===t};ns.Model.invalidate("message",s),ns.Model.invalidate("message-body",s),this._updateFolders(["draft","outbox"])}},_updateTemplateAfterAction:function(){this._updateFolders(["draft","template"]);var e=this.getTemplateMid();if(e){var t=ns.Model.get("folders"),o=t.getFidBySymbol("template"),n=ns.Model.get("message",{ids:e});n.get(".fid")!==o&&n.set(".fid",o);var s=function(t){return t.isValid()&&t.params.ids===e};ns.Model.invalidate("message",s),ns.Model.invalidate("message-body",s)}},_updateFolders:function(e){e=Array.isArray(e)?e:[e];var t=ns.Model.get("folders");e.forEach((function(e){var o=t.getFidBySymbol(e);Daria.messages.clearCacheByFID(o)})),ns.forcedRequest(["folders","labels"])},_updateMessageFlagsAfterSend:function(){var e=this.get(".mark_ids");e&&e.length&&(this.isForward()&&e.forEach((function(e){ns.Model.get("message",{ids:e}).markForwarded()})),this.isReplyAny()&&e.forEach((function(e){ns.Model.get("message",{ids:e}).markAnswered()})))},_processSaveResponse:function(e){var t,o=e.storedmid||this.getDraftMid();if(o&&this.mMessage){t=this.mMessage.get(".mid");var n=ns.Model.get("message-draft",{ids:this.mMessage.params.ids});n.isValid()&&n.setIfChanged(".mid",o)}if(!e.storedmid||this.inNotInitedState())return this.isDraft()?e.storedmid?this._updateDraftAfterAction(!0,e.storedmid):this._updateFolders(["draft","outbox"]):this.isTemplate()&&this._updateFolders(["draft","template"]),vow.Promise.reject();if(this._updateDataAfterSave(e),this.isDraft())this._updateDraftAfterAction(!0);else if(this.isTemplate()){this._updateTemplateAfterAction();var s=this.getTemplateMid();ns.events.trigger("daria:mComposeMessage:template-saved",{oldMid:t,mid:s})}return this.markSaved(),this.trigger("ns-model:draft-saved",{mid:e.storedmid,attachments:e.attachment}),e},_processSendResponse:function(e){var t=no.jpath(".limited.recipient",e);t&&this.set(".limited",this._parseLimited(t));var o=no.jpath(".message_id",e);o&&this.set(".sentMessageId",o);var n=no.jpath(".storedmid",e);n&&this.set(".sentMid",n),this._updateDraftAfterAction(),this._updateMessageFlagsAfterSend()},_parseLimited:function(t){var o=[],n=[],s={},i=function(e,t){o.push(t.limit),n.push("<"+t.login+"@"+t.$t+">")};return $.isArray(t)?($.each(t,i),o.sort(),s.recipients=n.join(e)):(i(0,t),s.recipient=n[0]),s.limit=Jane.getHumanSize(o[0]),s},isTemplate:function(){var e=!1;return this.mMessage&&this.mMessage.isTemplate()?e=!0:"template"===this.get(".save_symbol")&&(e=!0),e},isNewMessage:function(){return!this.params.ids},isForward:function(){return Boolean("forward"===this.params.oper)},isReplyAll:function(){return Boolean(this.mMessageBody&&"reply-all"===this.params.oper)},isReply:function(){return Boolean(this.mMessageBody&&"reply"===this.params.oper)},isReplyAny:function(){return this.isReply()||this.isReplyAll()},isNewTemplate:function(){var e=!1;return this.mMessage||"template"!==this.get(".save_symbol")||(e=!0),e},isAutosaveEnabled:function(){return this.mSettings.isSet("enable_autosave")&&!this.isTemplate()},_isSendWithUndo:function(){var e=this._hasSendWithUndoFailed,t=Daria.SendMail.getUndoSendTime();return!e&&t>0},_prepareDataForMailSend:function(e,t){if(e=_.omit(e,["errors","recipients-diff"]),t?(e.lids=_.filter(e.lids,_.negate(this._systemLabelFilter),this),e.remind_period=null,e.send_time=null):(this.isTemplate()&&(e.ign_overwrite="yes"),ns.Model.get("settings").isSet("save_sent")||(e.nosave="yes"),this._isSendWithUndo()&&!this.isDelayed()&&(e.send_time=Daria.SendMail.getUndoSendTime(),e.relative=!0)),Daria.IS_CORP&&!this.mComposeState.get(".recipients-diff-pane-close")){var o="",n=this._getRecipientsDiffStr();n.length>0&&(o=this.isHtmlType()?Daria.Html2Text.text2html(n)+"<div>&nbsp;</div>":n+"\n\n",e.send=o+e.send)}return e},createTemplateFolder:function(){var e=ns.Model.get("folders"),t=e.getFidBySymbol("template"),o=vow.Promise.resolve();return t?this.set(".templates_fid",t):o=e.createTemplateFolder().then((function(e){return this.set(".templates_fid",e.fid),e}),this),o},save:function(e){var t=this;return this._saveDraftPromise=this._save(e).always((function(e){return t._saveDraftPromise=null,e})),this._saveDraftPromise},_save:function(e){e=e||{};var t=vow.Promise.resolve();if(!e.force&&!this.isDirty())return t;this.isTemplate()&&(t=this.createTemplateFolder());var o=this.getData(),n=this._getCommonSendParams(),s={nosend:"yes"},i=_.extend({},o,n,s);i=this._prepareDataForMailSend(i,!0),i.send=this.getSendMessage();var a=t.then(this.makeRequest.bind(this,i,"_save=true","save")),r=a.then(this._processSaveResponse,this);return e.httpResponse?a:r},waitForDraftSave:function(){return this._saveDraftPromise?this._saveDraftPromise.always((function(){return vow.resolve()})):vow.resolve()},makeRequest:function(e,t,o){var n=this;if(this._cancelled)return vow.reject("send-cancelled");var s=this;return this.isTemplate()&&!e.templates_fid&&(e.templates_fid=this.get(".templates_fid")),new vow.Promise(function(i,a){n._cancelSendCallback=function(){Jane.ErrorLog.send({errorType:"cancel_send_while_sending",overwriteMid:e.overwrite}),Daria.SendMail.showMessageSentCancelling()},$.ajax({url:Daria.api["do-send"]+"?"+t,method:"POST",dataType:"json",cache:!1,data:e,success:function(t,n,r){if(Daria.parseLoginInfo(t)){s.onXHRSuccess(t,i,a,o);var c=s.isDelayed()&&!e.relative;s._cancelIfNeeded(t,c)}else s.onXHRError(r,"no_auth",a,o)},error:function(e,t){s.onXHRError(e,t,a,o)},complete:function(){s._cancelSendCallback=null}})})},_cancelIfNeeded:function(e,t){var o=no.jpath(".storedmid",e);o&&this._cancelled&&Daria.SendMail.cancelSendMessage(o,"sending_message",t)},_waitForAttachmentsUploaded:function(){var e=this;return this._cancelled?vow.reject("send-cancelled"):new vow.Promise(function(t,o){e._cancelSendCallback=o;var n=ns.Model.get("compose-attachments",e.params);n.isValid()&&n.isUploading()?(ns.events.once("attachments.all-uploaded",t),n.once("ns-model:attachments.failed",(function(){e._checkData().fail((function(t){e.storeErrors(t),o("attachments-failed")}))}))):t()})},_preSend:function(e){var t=this;return this._cancelled=!1,this.cleanErrors(),new vow.Promise(function(o,n){t._cancelSendCallback=n,t._checkData().fail((function(e){return t.storeErrors(e),vow.reject("message-not-valid")})).then((function(){if(t._cancelled)return vow.reject("send-cancelled");if(!e.force&&t.checkConfirmations())return vow.reject("need-confirm");var o={};if(t._isSendWithUndo()){var n=Daria.SendMail.getUndoSendLogger();n.logShow(),o.onClose=function(){n.logClose()},o.onCancel=function(){n.logCancel(),t._cancelled=!0,t._cancelSendCallback&&(t._cancelSendCallback("send-cancelled"),t._cancelSendCallback=null)}}return Daria.SendMail.showSendingMessage(o),t.trigger("ns-model:store-subject-for-autocomplete"),t._waitForAttachmentsUploaded()})).then(o,n)})},_send:function(){var e=this;if(this._cancelled)return vow.reject("send-cancelled");var t=this.getData(),o=this._getCommonSendParams(),n=_.extend({},t,o);return n.send=this.getSendMessage(),n=this._prepareDataForMailSend(n,!1),this._draftMid=this.getDraftMid(),ns.Model.get("message-failed").setMid(this._draftMid),new vow.Promise(function(t,o){e._cancelSendCallback=o,e.makeRequest(n,"_send=true","send").then(e._processSendResponse,e).then(t,o)})},send:function(e){var t=this;e=e||{};var o=Daria.SendMail.getUndoSendLogger();return o.logActionOnceAfterCancel("Клик в Отправить"),o.setCancelled(!1),o.setStartTime(),Daria.SendMail.clearLastCancelledMid(),this._preSend(e).then(this._send,this).always((function(e){return t._cancelled&&t._draftMid&&(ns.Model.get("message-failed").removeMid(t._draftMid),t._draftMid=null),t._cancelSendCallback=null,e}))},onXHRError:function(e,t,o,n){var s,i,a=e&&e.status;"parsererror"===t?(i="bad_json",s="no_data"):"no_auth"===t?(i="NoAuth",s="no_auth"):s="cannot_save"===t?"cannot_save":413===a?"attachment_too_big":a>0?"no_data":"http_status_0",i=i||s,Jane.ErrorLog.send({errorType:"compose.http",status:i,ckey:ns.Model.get("account-information").get(".ckey")},e.responseText),"NoAuth"!==i&&this.onSendError(s,o,n)},onXHRSuccess:function(e,t,o,n){var s=jpath(e,".status")[0];switch(s){case"ok":t(e);break;case"captcha_request":e.captcha_key&&ns.Model.get("captcha").setData({key:e.captcha_key,url:e.captcha_url,_:e.captcha_key}),this.trigger("ns-model:captcha-request"),this.onSendError(s,o,n);break;case"compose_check_failed":this.onSendError(s,o,n);break;default:this.onSendError(s,o,n)}},onSendError:function(e,t,o){e=e||"internal_error",Jane.ErrorLog.send({errorType:"compose."+o+".failed",status:e,ckey:ns.Model.get("account-information").get(".ckey")}),ns.Model.get("message-failed").removeMid(this.getDraftMid()),t(e)},isSystemLabel:function(e){var t=ns.Model.get("labels"),o=t.getLabelById(e);if(!o)return!1;if(o.user)return!1;var n=t.getWaitingForReplyLabel(),s=t.getDelayedMessageLabel();return _.contains([n,s],o)},getLabelsHash:function(){var e=ns.Model.get("labels").getLabelsHash(),t=this.get(".lids")||[];return _.each(t,(function(t){e[t]=1})),e},addLid:function(e){e=$.makeArray(e);var t=this.get(".lids")||[];if(e=_.difference(e,t),e.length){t=t.concat(e);var o=_.all(e,this._systemLabelFilter,this);this.set(".lids",t,{silent:o})}},removeLid:function(e){e=$.makeArray(e);var t=this.get(".lids");t&&t.length&&(t=_.difference(t,e),t.length?this.set(".lids",t,{silent:this.isSystemLabel(e)}):(this.set(".lids",[]),delete this.getData().lids))},hasUserLabels:function(){return!_(this.get(".lids")).filter(this._userLabelFilter,this).isEmpty()},getUserLabels:function(){return _(this.get(".lids")).filter(this._userLabelFilter,this).value()},_userLabelFilter:function(e){var t=ns.Model.get("labels"),o=t.getLabelById(e),n=t.getImportantLID();return o&&(o.user||e===n)&&!this.isSystemLabel(e)},_systemLabelFilter:function(e){return this.isSystemLabel(e)},getFromEmails:function(){var e=String(this.get(".from_mailbox")||"");return _.map(ns.Model.get("account-information").getFromEmails(),(function(t){return{text:t,value:t,selected:e.toLowerCase()===t.toLowerCase()}}))},getLanguage:function(){var e="ru";if(this.isReply()){var t=this.params.ids;if(!(e=Daria.Translate.getLangByMid(t))){var o=this.mMessageBody.getComposeHTML();e=Daria.Translate.defineLanguage(o)}}else{var n=this.get(".send");_.trim(n.replace(/\&nbsp;/gi,"")).length?e=Daria.Translate.defineLanguage(n):_.contains(Daria.Translate.langs.all.s,Daria.Config.locale)&&(e=Daria.Config.locale)}return e},formatContacts:function(e,t){var o=this.get("."+e);return Jane.FormValidation.splitContacts(o).map((function(o){return o.type=e,o.ref=t.getEmailRef(o.email),o}),this)},getContacts:function(e){var t=this.get("."+e);return"phone"===e?Jane.FormValidation.splitPhones(t):Jane.FormValidation.splitContacts(t)},getAllRecepients:function(){var e=this.getContacts("to"),t=this.getContacts("cc"),o=this.getContacts("bcc");return Array.prototype.concat.call(e,t,o)},getAllRecepientEmails:function(){return{to:this._extractEmailsFromContacts(this.getContacts("to")),cc:this._extractEmailsFromContacts(this.getContacts("cc")),bcc:this._extractEmailsFromContacts(this.getContacts("bcc"))}},setContacts:function(t,o){var n="."+t;this.set(n,_.map(o,(function(e){return Jane.FormValidation.obj2contact(e)})).join(e)+",")},appendContact:function(e,t){t&&this.setContacts(e,this.getContacts(e).concat(t))},isDelayed:function(){return Boolean(this.get(".send_time"))},getPassportSendDate:function(){var e=Jane.Date.parseCalendarDate(this.get(".send_time"));return e?Daria.getPassportDate(e):void 0},_getArrayOfEmails:function(e){return e.map((function(e){return e.email}))},_onRecipientsChanged:function(){if(!Daria.IS_CORP)return vow.resolve();if(this.isTemplate()||this.isNewMessage()||this.isForward())return vow.resolve();var e=this;return vow.resolve().then((function(){var t=_.union(Jane.FormValidation.splitContacts(e.get(".initial_to")||""),Jane.FormValidation.splitContacts(e.get(".initial_cc")||"")),o=_.union(Jane.FormValidation.splitContacts(e.get(".to")||""),Jane.FormValidation.splitContacts(e.get(".cc")||"")),n=_.uniq(e._getArrayOfEmails(t)),s=_.uniq(e._getArrayOfEmails(o)),i=_.difference(s,n).sort(),a=_.difference(n,s);return n.length-a.length<2&&a.length>0?n.length-a.length==1?ns.Model.get("get-maillists-static").getMaillists(s).then((function(e){return 0===e.length&&(a=[i18n("%All")]),{removed:a,added:i}})).fail((function(e){throw e})):(a=[i18n("%All")],{removed:a,added:i}):{removed:a,added:i}})).then((function(t){e.set(".recipients-diff",{added:t.added,removed:t.removed})})).fail((function(e){throw e}))},_getRecipientsDiffStr:function(){var t=this.get(".recipients-diff"),o=[];return 0===t.added.length&&0===t.removed.length?o=[]:(t.added.length>0&&o.push("+ "+t.added.join(e)),t.removed.length>0&&o.push("- "+t.removed.join(e))),o.join("\n")},hasOnlyOneValidRecipient:function(e){e=["to","cc","bcc"].indexOf(e)>-1?e:"";var t=e?this.getContacts(e):this.getAllRecepients();return Array.isArray(t)&&1===t.length&&Jane.FormValidation.checkEmail(t[0].email||"")}}})})()},1250:function(e,t,o){"use strict";var n=function(e){var t=Jane.FormValidation.splitContacts(e);return Daria.Recipients.requestContacts(t).always((function(){return t.filter((function(e){return!Jane.FormValidation.checkEmail(e.email)}))}))},s=function(e,t){return new vow.Promise(function(o,n){e||t.get(".cc")||t.get(".bcc")?o():n(i18n("%Compose_Email_Required"))})},i=function(e){return n(e).then((function(e){if(!e.length)return vow.resolve();var t=e.map((function(e){return e.name?"".concat(e.email," (").concat(e.name,")"):e.email})).join(", ");return vow.reject("".concat(i18n("%Compose_Error_Invalid_Emails")," ").concat(t))}))},a=function(e){return new vow.Promise(function(t,o){e&&!Jane.FormValidation.checkPhoneNumber(e)?o(i18n("%ValidatePhoneError_badnumformat")):t()})},r=function(e,t){return new vow.Promise(function(e,o){var n=ns.Model.get("compose-attachments",t.params);n.isValid()&&n.isFailed()?o(i18n("%Compose_Attachment_Failed")):e()})},c={to:[s,i],phone:[a],cc:[i],bcc:[i],att_ids:[r]};t.a={validate:function(e){return new vow.Promise(function(t,o){var n=e.getData(),s={},i=!0;vow.all(Object.keys(n).map((function(t){var o=n[t];return vow.all((c[t]||[]).map((function(n){return n(o,e).fail((function(e){s[t]=s[t]||e,i=!1}))})))}))).always((function(){i?t():o(s)}))})}}},1251:function(e,t){!(function(){var e={editorMode:"",editorMaximize:2,messageHeight:190,bodyPos:0,editorBookmark:null,isCcVisible:!1,isBccVisible:!1,isReplyAllNoticeVisible:!1,isPhoneVisible:!1,isPhoneEnabled:!0,isOpenedWithToolbarAttachPopup:!1,saveTemplateAndLeave:!1,saveTemplateAndReset:!1,submitButtonText:i18n("%Отправить"),activeActionButtonView:"compose-send-link",focusField:"to",waitSuggest:!1,formRect:null,"recipients-diff-pane-close":!1,visibleNotices:{to:[],phone:[],cc:[],bcc:[]},translationEnabled:!1},t=ns.Model.prototype;ns.Model.define("compose-state",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null,tids:null,oper:null},ctor:function(){this._onComposeMessageFieldChanged=this._onComposeMessageFieldChanged.bind(this),this._refreshSubmitButtonText=this._refreshSubmitButtonText.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){var e=[{id:"compose-message",params:this.params}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_initFromModels:function(t){this.mComposeMessage=_.find(t,"id","compose-message"),this.mMessageBody=_.find(t,"id","message-body"),this._bindModelEvents();var o="reply"===this.params.oper&&this.mMessageBody&&this.mMessageBody.allowedReplyAll();this.mComposeMessage.on("ns-model-changed.to",this.refreshIsPhoneEnabled.bind(this)),this.mComposeMessage.on("ns-model-changed.cc",this.refreshIsPhoneEnabled.bind(this)),this.mComposeMessage.on("ns-model-changed.bcc",this.refreshIsPhoneEnabled.bind(this)),ns.Model.get("userphones").on("ns-model-changed",this.refreshIsPhoneEnabled.bind(this)),this.setData(_.extend({},e,{isReplyAllNoticeVisible:o,isCcVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".cc")),isBccVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".bcc")),isPhoneVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".phone")),focusField:this.mComposeMessage.isReplyAny()?"send":e.focusField,quickReplyAttaches:[]})),this.refreshIsPhoneEnabled(),this._refreshSubmitButtonText()},refreshIsPhoneEnabled:function(){var e=ns.Model.get("userphones").hasActiveNumber();this.set(".userHasValidatedPhone",e);var t=Daria.Config.MAY_HAVE_SMS_COPY,o=this.mComposeMessage.getAllRecepients(),n=o.some((function(e){return ns.Model.get("account-information").isMyEmail(e.email)})),s=t&&e&&!n&&o.length<=1;this.set(".isPhoneEnabled",s,{force:!0})},onBeforeDestroyed:function(){this._unbindModelEvents()},_bindModelEvents:function(){this.on("ns-model-changed.translationEnabled",this._refreshSubmitButtonText),this.mComposeMessage&&(this.mComposeMessage.on("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],(function(e){this.mComposeMessage.on("ns-model-changed."+e,this._onComposeMessageFieldChanged)}),this))},_unbindModelEvents:function(){this.mComposeMessage&&(this.mComposeMessage.off("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],(function(e){this.mComposeMessage.off("ns-model-changed."+e,this._onComposeMessageFieldChanged)}),this))},_isNdaNoticeNeeded:function(e){if(Daria.IS_CORP)return!1;var t=this.mComposeMessage.getContacts(e),o=!1,n=!1;return _(t).pluck("email").each((function(e){Jane.FormValidation.checkExternalEmail(e)?n=!0:o=!0})).value(),o&&n},_onComposeMessageFieldChanged:function(e,t){var o=t.substr(1),n={nda:this._isNdaNoticeNeeded.bind(this,o)},s=this.get(".visibleNotices."+o);_.each(n,(function(e,t){s=e()?_.uniq(s.concat(t)):_.without(s,t)})),this.setIfChanged(".visibleNotices."+o,s)},setFocusField:function(e,t){this.set(".focusField",e,t)},getFocusField:function(){return this.get(".focusField")},setWaitSuggest:function(e,t){this.set(".waitSuggest",e,t)},getWaitSuggest:function(){return this.get(".waitSuggest")},set:function(e,o,n){n||(n={});var s=this.get(e);_.isEqual(s,o)&&!n.force||t.set.call(this,e,o,n)},setMessageHeight:function(e){e<190&&(e=190),this.set(".messageHeight",e)},hasSpellingCheck:function(){return"TUR"!==Daria.Config.product&&!_.contains(["ka","hy","ro"],Daria.Config.locale)},hasEnSpellingCheckIcon:function(){return!_.contains(["ru","uk","be"],Daria.Config.locale)},hasDisk:function(){return _.contains(Daria.SIDS,"59")},isFieldEnabled:function(e){return!_.contains(["phone"],e)||this.get(".is"+_.capitalize(e)+"Enabled")},isFieldVisible:function(e){return!_.contains(["phone","cc","bcc"],e)||this.get(".is"+_.capitalize(e)+"Visible")},isCcVisible:function(){return this.get(".isCcVisible")},isBccVisible:function(){return this.get(".isBccVisible")},isPhoneVisible:function(){return this.get(".isPhoneVisible")},isReplyAllNoticeVisible:function(e){return"to"===e&&this.get(".isReplyAllNoticeVisible")},isNdaNoticeVisible:function(e){return Daria.IS_CORP&&_.contains(this.get(".visibleNotices."+e),"nda")},setLastSaveTime:function(){this.set(".lastSaveTime",Jane.Date.format("%R",Daria.now()))},isMinWidth:function(){var e=ns.Model.get("settings"),t=Number(e.getSetting("size-view-app")),o=Number(e.getSetting("size-layout-left")),n=Daria.resize.elements.layout.params.minWidth,s=Daria.resize.elements.leftPane.params.maxWidth;return t===n&&o===s},getSubmitButtonText:function(){var e=this.get(".translationEnabled"),t=this.mComposeMessage.getPassportSendDate();if(t){var o=Jane.Date.toHumanFormat(t),n=Jane.Date.format("%Date_HM__colon",t);return e?i18n("%Compose_Translate_Send_With_Deferred_Option",o,n):i18n("%Compose_Send_With_Deferred_Option",o,n)}return e?i18n("%Compose_Translate_Send"):i18n("%Отправить")},_refreshSubmitButtonText:function(){this.setIfChanged(".submitButtonText",this.getSubmitButtonText())}}})})()},1252:function(e,t){!(function(){ns.Model.define("compose-forwarded-messages",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){return this.mComposeMessage=ns.Model.get("compose-message",_.clone(this.params)),ns.request([this.mComposeMessage]).then((function(){this.setData([]),ns.request(this._constructModelRequest()).then(this._initFromModels,this)}),null,this)},_constructModelRequest:function(){var e=[];if("forward"!==this.params.oper)return e;var t=$.makeArray(this.params.tids),o=$.makeArray(this.params.ids);return e=e.concat(_.map(t,(function(e){return{id:"messages",params:{thread_id:e,first:0,count:ns.Model.get("message",{ids:e}).getThreadCount()||500}}}))),e=e.concat(_.map(o,(function(e){return{id:"message",params:{ids:e}}})))},_initFromModels:function(e){var t=[];_.each(e,(function(e){switch(e.id){case"messages":t.push.apply(t,e.models);break;case"message":t.push(e)}})),this._setMessages(t)},_setMessages:function(e){var t=!1;e.length>1&&(t=!0);var o=_.map(e,(function(e){return{mid:e.get(".mid"),subject:e.get(".subject"),checked:t,link:e.getMessageLink()}}));this.setData(o),t&&this.mComposeMessage.addForwardedMessages(_.pluck(o,"mid"))},checkMessage:function(e){_.find(this.getData(),{mid:e}).checked=!0,this.mComposeMessage.addForwardedMessages(e)},uncheckMessage:function(e){_.find(this.getData(),{mid:e}).checked=!1,this.mComposeMessage.removeForwardedMessages(e)}}})})()},1253:function(e,t){!(function(){ns.Model.define("compose-fsm",{params:{ids:null,oper:null},methods:{start:"edit",transitions:{save:["edit","sending","cancel"],edit:["save","sending","cancel"],sending:["edit","sent"],cancel:["edit"]},canAutosave:function(){return this._checkTransitionToState("save")}}},ns.ModelFsm)})()},1254:function(e,t){ns.Model.define("compose-signature",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"},{id:"compose-message",params:_.clone(this.params)}]},_initFromModels:function(e){this.mSettings=e[0],this.mComposeMessage=e[1],this.setData({signature:""})},getSignatureList:function(){var e=this.mComposeMessage.get(".from_mailbox"),t=this.mComposeMessage.getLanguage(),o={mode:this.mComposeMessage.get(".ttype"),signs:[]};switch(o.mode){case"html":o.signs=Daria.signs.getHtml();break;case"plain":o.signs=Daria.signs.getPlain()}var n=Daria.signs.getFilteredSigns(o.signs,e);return 0===n.length?o.noSuitableSignature=!0:n.sort(Daria.signs.sort(e,t)),o.signs=_.uniq([].concat(n,o.signs)),o},hasSignatureControl:function(){return!Daria.Config.NO_SETTINGS&&(!Modernizr.ios&&!this.mSettings.isSet("no_signature_select"))}}})},1255:function(e,t){ns.Model.define("quick-reply-state",{events:{"ns-model-init":"_onInit"},params:{qrIds:null},methods:{_onInit:function(){this.setData({show:!1,forceShow:!1,formIsShown:!1,showFieldPlaceholder:!0,verboseFieldPlaceholder:!1,sentMessageId:void 0,showDone:!1,needPlaceInViewport:!1,isReplyAll:!0,tmpEditorId:void 0,fixed:!1})},showForm:function(e){this.get(".formIsShown")||(this.set(".show",!0,e),this._tmpEditorInit())},toShowForm:function(){return this.get(".show")},isVisible:function(){return this.get(".formIsShown")},hideForm:function(e){this.setIfChanged(".show",!1,e),this.setIfChanged(".showFieldPlaceholder",!0,e),this._tmpEditorDestroy()},showDone:function(e){this.hideForm(e),this.setIfChanged(".showDone",!0,e)},isShowDone:function(){return this.get(".showDone")},existOpenQR:function(){var e=!1;return ns.Model.traverse("quick-reply-state",(function(t){!e&&t.isVisible()&&(e=!0)})),e},placeInViewport:function(){this.set(".needPlaceInViewport",!0)},isReplyAll:function(){return this.get(".isReplyAll")},setReplyAllState:function(e){return this.set(".isReplyAll",e)},_tmpEditorInit:function(){this._tmpEditorDestroy();var e=_.uniqueId("tmpeditor_");this.set(".tmpEditorId",e,{silent:!0});var t={position:"fixed",width:"1px",height:$(window).height(),overflow:"hidden",top:0,left:0,margin:0,padding:0,"user-select":"text",opacity:0};$('<div id="'+e+'" contenteditable="true" />').css(t).appendTo("body").focus()},_tmpEditorDestroy:function(){var e=this.get(".tmpEditorId");e&&(this.set(".tmpEditorId",void 0,{silent:!0}),$("#"+e).remove())},getTmpContentAndRemove:function(){var e=this.get(".tmpEditorId"),t=e&&$("#"+e),o="";return t&&t.length&&(o=t.html(),o&&(Modernizr.mozilla||Modernizr.msie||Modernizr.edge)&&(o=o.replace(/<br\/?>$/i,"").replace(/\s$/,"&nbsp;")),t.remove()),o}}},ns.ModelStatic)},1256:function(e,t){ns.Model.define("do-cancel-send-delayed",{params:{ids:null}})},1257:function(e,t){ns.Model.define("do-cancel-send-undo",{params:{ids:null}})},1258:function(e,t){function o(e){return i(e)||s(e)||n()}function n(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function s(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function i(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}!(function(){ns.Model.define("compose-popular-contacts",{events:{},params:{ids:null,oper:null,count:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=ns.Model.get("compose-message",this.params),o=!t||t.canRequest();return e&&o},request:function(){var e=this._constructModelRequest();return ns.request(e).then((function(e){var t=_.zipObject(_.pluck(e,"id"),e);this._initFromModels(t)}),this)},_constructModelRequest:function(){return[{id:"abook-suggest",params:{q:"",popular:!0,climit:this.params.count}},{id:"compose-message",params:this.params},{id:"index-data"}]},_initFromModels:function(e){var t=e["abook-suggest"],n=e["compose-message"],s=e["index-data"].get(".email"),i=n.getAllRecepients(),a=_.filter(t.get(".contacts"),(function(e){return e.email!==s})),r={name:i18n("%Compose_Send_it_to_me"),email:s},c=_.map([r].concat(o(a)),(function(e){return e.name||(e.name=e.email),e.phone=_.get(e,["phones",0]),_.extend({},e,{used:_.any(i,{email:e.email})})}),this);this.setData(c)},getContact:function(e){return _.find(this.getData(),e)},actualizeUsedContacts:function(e){_.each(this.getData(),(function(t){t.used=_.any(e,{email:t.email})}))},isAnyUnusedContact:function(){return!this.isValid()||_.any(this.getData(),(function(e){return!e.used}))},getUnusedContacts:function(){return _.filter(this.getData(),(function(e){return!e.used}))},clean:function(){_.each(this.getData(),(function(e){e.used=!1}))}}})})()},1259:function(e,t){ns.Model.define("compose-field-notice",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic),ns.Model.define("compose-field-extras",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic)},1260:function(e,t){ns.Model.define("compose-field-notices",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic),ns.Model.define("compose-field-extras-collection",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic)},1261:function(e,t){ns.Model.define("compose-emoticons",{events:{"ns-model-init":"_onInit"},params:{},methods:{_onInit:function(){this.setData({items:[{suid:21,name:"Улыбается"},{suid:22,name:"Подмигивает"},{suid:23,name:"Показывает язык"},{suid:24,name:"Благодарит"},{suid:25,name:"Крутой"},{suid:26,name:"Удивляется"},{suid:27,name:"Огорчается"},{suid:28,name:"Обижается"},{suid:29,name:"Плачет"},{suid:30,name:"Зевает"},{suid:31,name:"Смущается"},{suid:32,name:"Не может сказать вслух"},{suid:33,name:"Не в себе"},{suid:34,name:"Сумасшедший"},{suid:35,name:"Ехидный"},{suid:36,name:"Ангелочек"},{suid:37,name:"Влюбленный"},{suid:38,name:"Сердце разбито"},{suid:45,name:"Отдых"},{suid:51,name:"Подарок"},{suid:40,name:"Мокро"},{suid:43,name:"Дождь"},{suid:46,name:"Солнечно"},{suid:47,name:"Холодно"},{suid:50,name:"Планета"},{suid:42,name:"Не одобряю"},{suid:41,name:"Одобряю"},{suid:48,name:"Бомба"},{suid:49,name:"Идея!"},{suid:44,name:"Музыка"}]})}}},ns.ModelStatic)},1262:function(e,t,o){o(1263),o(1264),o(1265),o(1266),o(1267),o(1268),o(1269),o(1270),o(1271),o(1272),o(1273),o(1274),o(1275),o(1277),o(1278),o(1279),o(1280),o(1281),o(1282),o(1283),o(1284),o(1285),o(1286),o(1287),o(1288),o(1289),o(1290),o(1291),o(1292),o(1293),o(1294),o(1295),o(1296),o(1297),o(1298),o(1299),o(1300),o(1301),o(1302),o(1303),o(1304),o(1305),o(1306),o(1307),o(1308),o(1309),o(1310),o(1311),o(1312),o(1313),o(1314),o(1315),o(1316),o(1317),o(1318),o(1319),o(1320),o(1321),o(1322),o(1323),o(1324),o(1325),o(1326),o(1327),o(1328),o(1329),o(1330),o(1331),o(1332),o(1333),o(1334),o(1335),o(1336),o(1337),o(1338),o(1339),o(1340),o(1341),o(1342),o(1343),o(1344),o(1345),o(1346),o(1347),o(1348),o(1349),o(1350),o(1353),o(1354),o(1355),o(1356),o(1357),o(1358),o(1359),o(1360),o(1361),o(1362),o(1363),o(1364),o(1365),o(1366),o(1367),o(1368),o(1369),o(1370),o(1371),o(1372),o(1373),o(1374),o(1375),o(1376),o(1377),o(1378),o(1379),o(1380),o(1381),o(1382),o(1383),o(1384),o(1385),o(1386),o(1387),o(1388),o(1389)},1263:function(e,t){!(function(){ns.View.edefine("labels-actions-compose",{models:{labels:!1,settings:!1,"compose-message":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{_yateModule:"mail"})},yateModule:"toolbar",methods:{onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByComposeMessage()},filterByComposeMessage:function(){var e=this.getModel("compose-message").getLabelsHash();this._filterByLabelsHash(e,{showReadLabel:!1,showUnreadLabel:!1,messagesCount:1})},_onLabelClick:function(e){var t=this._getDataFromClickedLabel(e),o=this.getModel("compose-message");switch(t.action){case"label":o.addLid(t.lid);break;case"unlabel":o.removeLid(t.lid)}this.nbPopup.close()},getLabelCreatedCallback:function(){return this.getModel("compose-message").addLid.bind(this.getModel("compose-message"))}}},"labels-actions")})()},1264:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(325),s=o(882),i=o(337),a=o(726);!(function(){function e(e,t){Jane.ErrorLog.send(_.assign({},t,{event:"after_send_failed",loadingHash:e})),Daria.Dialog.notice({title:i18n("%Произошла_ошибка"),body:"<p>"+i18n("%Compose_after_sent_leave_failed")+"</p>"})}ns.View.define("compose-leave-mixin",{yateModule:"compose2",events:{"beforeunload@show window":"onBeforeUnloadPage"},methods:{onBeforeUnloadPage:function(){this._areThereAnyUnsavedChanges()&&Daria.addUnloadText(i18n("%Setup_beforeunload"))},leaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeFsm в зависимостях"),ns.assert(this.getModel("compose-state"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeState в зависимостях"),this.leaveComposeController=new a.a,this.leaveComposeController.pageGoUrl=null,_.bindAll(this,["_leaveOnPageGo","_leaveOnSent","_leaveOnCancel","_nbSaveChangesPopupResolve","_nbSaveChangesPopupReject","_onExternalComposeButtonClick"])},leaveStart:function(){ns.page.block.add(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.on("# sent",this._leaveOnSent),e.on("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.on("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.on("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.on("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},leaveStop:function(){ns.page.block.remove(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.off("# sent",this._leaveOnSent),e.off("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.off("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.off("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.off("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},checkSameUrlParams:function(e){if(!e)return!1;var t=ns.router(ns.page.currentUrl),o=ns.router(e);if(Daria.composeEqualRoutes(t,o))return!0;var n=_.get(o,"params._cuid");return!("compose2"!==o.page&&!Daria.composeHasParams(n))},_onExternalComposeButtonClick:function(){var e=ns.router.generateUrl("compose2");this._leaveOnPageGo(e,!0)},_leaveOnPageGo:function(e,t){var o=this.getModel("compose-state"),a=o.get(".nbSaveChangesPopup");return(!a||!a.isOpen())&&(!t&&e===ns.page.currentUrl||(!(t||!e||!this.checkSameUrlParams(e))||(this.leaveComposeController.pageGoUrl=e,this._areThereAnyUnsavedChanges()?!this._showSaveChangesPopup(t):(t&&this.hardResetCompose(),this.isQuickReply()||i.a.finishScenario(n.a,s.b),!0))))},_areThereAnyUnsavedChanges:function(){var e=this.getModel("compose-message").isDirty(),t=!this.getModel("compose-fsm").isCurrentState(["save","sent"]);return e&&t},_showSaveChangesPopup:function(e){var t=this,o=this.getModel("compose-state");if(o.get(".nbSaveChangesPopup"))return!1;this.autosaveStop(),nb.trigger("popup-close"),Daria.Dropdown.closeAll(),Daria.Dialog.close();var n=this.params,s=ns.View.create("compose-unsaved-popup");return s.on("resolve",(function(t,o){ns.Model.get("compose-state",n).trigger("nbSaveChangesPopup:resolve",o,e)})),s.on("reject",(function(){ns.Model.get("compose-state",n).trigger("nbSaveChangesPopup:reject"),t.autosaveStart()})),o.set(".nbSaveChangesPopup",s,{silent:!0}),s.open(),!0},_nbSaveChangesPopupResolve:function(e,t,o){var a=this.getModel("compose-state");a.set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.isQuickReply()||this.getModel("compose-fsm").switchOff(),"save"===t?(o&&a.set(".saveTemplateAndReset",!0),this.isQuickReply()?this.getModel("compose-message").save({force:!0}):this.getModel("compose-message").save({force:!0,httpResponse:!0}).then((function(){i.a.finishScenario(n.a,s.d)}),(function(){i.a.finishScenario(n.a,s.c)}))):o&&this.hardResetCompose(),this.isQuickReply()||"save"===t||i.a.finishScenario(n.a,s.a),this.leaveComposeController.leaveCompose({clearPageBlock:!0}))},_nbSaveChangesPopupReject:function(){this.getModel("compose-state").set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").setState("edit"),ns.Model.get("focus").setLastActionFocus(),ns.page.refresh())},_showMessageSentNotification:function(e){var t=this.getModel("compose-message");this.leaveComposeController.showMessageSentNotification({fromQR:e,sentMid:t.get(".sentMid"),wasSendCancelled:t.wasSendCancelled(),isDelayed:t.isDelayed(),sendTime:t.getPassportSendDate()})},_onAfterSent:function(){var t=this;this._showMessageSentNotification(!1);var o=this.getModel("compose-message"),n=this.leaveComposeController.pageGoUrl=this.leaveComposeController.whereToGoAfterSend();return vow.resolve().then((function(){if("#done"===n)return Jane.Services.run("#done").then((function(){ns.Model.get("done").fromComposeMessage(o)}))})).fail(_.noop).then((function(){return t.leaveComposeController.leaveCompose({clearPageBlock:!0,neverReturn:!0})})).fail((function(t){return e(n,t)})).always((function(){return vow.resolve()}))},_leaveOnSent:function(){return this.leaveComposeController.sendMetrika(),this._onAfterSent()},_leaveOnCancel:function(){return this.leaveComposeController.leaveCompose()},shouldGoToDonePage:function(){return"done"===this.leaveComposeController.getPageAfterSent()}}})})()},1265:function(e,t){ns.View.define("compose-autosave-mixin",{yateModule:"compose2",methods:{AUTOSAVE_PERIOD:Daria.timify({seconds:10}),autosaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeFsm в зависимостях"),this._autosaveSaveMessageModel=this._autosaveSaveMessageModel.bind(this),this._autosaveTimerAction=this._autosaveTimerAction.bind(this),this._autosaveTimer=0},autosaveStart:function(){this.getModel("compose-fsm").on("# save",this._autosaveSaveMessageModel),this._setAutosaveTimeout()},autosaveStop:function(){this._clearAutosaveTimeout(),this.getModel("compose-fsm").off("# save",this._autosaveSaveMessageModel)},_isAutosaveEnabled:function(){return this.isValid()&&this.getModel("compose-message").isAutosaveEnabled()},_autosaveSaveMessageModel:function(){this._clearAutosaveTimeout(),this.getModel("compose-message").save().always(this._onAutosave,this)},_onAutosave:function(){var e=this.getModel("compose-fsm");e.isCurrentState("save")&&!e.inTransition()&&(e.setState("edit"),this._setAutosaveTimeout())},_clearAutosaveTimeout:function(){this._autosaveTimer&&(window.clearTimeout(this._autosaveTimer),this._autosaveTimer=0)},_setAutosaveTimeout:function(){this._isAutosaveEnabled()&&(this._clearAutosaveTimeout(),this._autosaveTimer=window.setTimeout(this._autosaveTimerAction,this.AUTOSAVE_PERIOD))},_autosaveTimerAction:function(){var e=this.getModel("compose-fsm");e.canAutosave()?e.setState("save"):this._setAutosaveTimeout()}}})},1266:function(e,t){!(function(){ns.View.define("compose-disable-on-sending-mixin",{yateModule:"compose2",methods:{disableOnSendingInit:function(){ns.assert(this.getModel("compose-fsm"),"vComposeDisableOnSendingMixin","должен иметь mComposeFsm в зависимостях"),this.onToggleControl=this.onToggleControl.bind(this)},disableOnSendingStart:function(){var e=this.getModel("compose-fsm");e.on("# *",this.onToggleControl),e.on("* > *",this.onToggleControl)},disableOnSendingStop:function(){var e=this.getModel("compose-fsm");e.off("# *",this.onToggleControl),e.off("* > *",this.onToggleControl)},onToggleControl:function(e,t){var o=!0,n=this.getModel("compose-fsm");if(n.isCurrentState(["edit","save"])){if(n.inTransition()){var s=_([t.from,t.to]).difference(["save","edit"]).isEmpty();s||(o=!1)}}else o=!1;this.$node.toggleClass("is-disabled",!o)}}})})()},1267:function(e,t){!(function(){ns.View.define("compose-field-base-hotkeys",{yateModule:"compose2",events:{"keydown@show":"_onKeydown"},methods:{_onKeydown:function(e){var t=ns.Model.get("settings"),o=t.getSetting("enable_hotkeys");if("compose2"!==ns.page.current.page&&o){Boolean(Modernizr.mac?e.metaKey:e.ctrlKey)&&e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.getModel("compose-fsm").setState("sending"))}}}})})()},1268:function(e,t){!(function(){ns.View.define("compose-attach-quick-reply-mixin",{yateModule:"compose2",methods:{_openComposePage:function(){var e=_.omit(this.params,"qrIds"),t=ns.router.generateUrl("compose2",e);ns.page.go(t).then((function(){ns.Model.get("compose-fsm",e).setInitialState("edit"),ns.Model.get("compose-message",e).expandMessage()}))},addQuickReplyAttach:function(e){ns.Model.get("compose-state",this.params).get(".quickReplyAttaches").push(e)},inQuickReply:function(){return ns.Model.get("quick-reply-state",this.params).toShowForm()}}})})()},1269:function(e,t){!(function(){ns.View.edefine("compose-attach-open-disk-mixin",{yateModule:"compose2",methods:_.extend({openDiskInit:function(){this.openDiskOnClick=this.openDiskOnClick.bind(this),this.$node.on("click",this.openDiskOnClick)},openDiskDestroy:function(){this.$node.off("click",this.openDiskOnClick)},openDiskOnClick:function(e){e.inQuickReply=this.inQuickReply(),this._openDiskOnClick(e)},_popup:null,PATH:null},Daria.AttachDiskPopupMixin)},"compose-attach-quick-reply-mixin",ns.View)})()},1270:function(e,t){!(function(){ns.View.define("compose-field-phone-error-mixin",{yateModule:"compose2",methods:{getErrorMessage:function(){var e=this.getModel("compose-message"),t=e.getAllRecepients();return t.length>1?i18n("%Compose_Phone_Error_Manymail"):t.some((function(e){return ns.Model.get("account-information").isMyEmail(e.email)}))?i18n("%Compose_Phone_Error_Usermail"):""}}})})()},1271:function(e,t){!(function(){ns.View.define("compose-template-list-popup-mixin",{yateModule:"compose2",methods:{openTemplateListInit:function(){this._openTemplateListOnClick=this._openTemplateListOnClick.bind(this),this.$node.on("click",this._openTemplateListOnClick)},openTemplateListDestroy:function(){this.$node.off("click",this._openTemplateListOnClick),this.popup&&this.popup.close()},_openTemplateListOnClick:function(){this.popup=ns.View.create("compose-template-list",this.params),this.popup.open({where:this.node,autofocus:!0}),Jane.c("Написание письма","Шапка письма",'Клик в "Шаблон"')}}})})()},1272:function(e,t){ns.View.edefine("message-quick-reply",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:action-start@show":"onActionStart","daria:MOPS:action-complete":"onHtmlInit"},models:{"module-compose":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onChangedShow"},message:!1,"scroller-message":!1,dimensions:{"ns-model-changed":!1,resize:"onResize"}},params:function(e){return{ids:e.ids,qrIds:e.ids}},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state");return e.toShowForm()?"layout-quick-reply":e.isShowDone()?"layout-quick-reply-done":this.isMessageInDrafts()?"layout-quick-reply-empty":"layout-quick-reply-placeholder"},isMessageInDrafts:function(){return ns.Model.get("folders").isFolder(this.getModel("message").get(".fid"),["draft","template"])},onHtmlInit:function(){this.$node.toggleClass("is-hidden",this.isMessageInDrafts())},onShow:function(){this.fixedInit(),this.toggleStickyMode()},onHide:function(){this.fixedDestroy(),this.invalidate()},onChangedShow:function(){this.isVisible()&&this.forceUpdate()},onPageBeforeLoad:function(e,t,o){o!==ns.page.currentUrl&&(Daria.composeEqualRoutes(t[0],t[1])||this.getModel("quick-reply-state").hideForm({silent:!0}))},onActionStart:function(e,t){"delete"===t.action&&this.getModel("quick-reply-state").hideForm()}}},"fixed-quick-reply-mixin",ns.View)},1273:function(e,t){ns.View.define("thread-quick-reply",{events:{"ns-view-hide":"invalidate","ns-page-before-load@show":"onPageBeforeLoad"},models:{"module-compose":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onChangedShow"}},params:function(e){var t=e.ids,o=e.thread_id,n={qrIds:o||t,thread_id:o};return t&&t!==o&&(n.ids=t),n},yateModule:"compose2",methods:{patchLayout:function(){var e=this.params,t=e.ids,o=e.thread_id,n="layout-thread-quick-reply-empty";if(o?Boolean(ns.Model.get("messages",{thread_id:o}).getLastReplyMessageQR()):ns.Model.get("message",{ids:t}).canReplyQR()){n=this.getModel("quick-reply-state").toShowForm()?"layout-thread-quick-reply":"layout-thread-quick-reply-placeholder"}return n},onPageBeforeLoad:function(e,t,o){o!==ns.page.currentUrl&&(Daria.composeEqualRoutes(t[0],t[1])||this.getModel("quick-reply-state").hideForm({silent:!0}))},onChangedShow:function(){this.isVisible()&&this.forceUpdate()}}})},1274:function(e,t){ns.View.define("quick-reply-message",{events:{"xiva.mail.insert@show":"onXivaMailInsert"},models:{message:!1,"message-body":!1},params:{ids:null},yateModule:"compose2",methods:{onXivaMailInsert:function(e,t){if(Daria.utils.checkReplaceFakeMessage(t)){var o=no.jpath(".message.hdr_message_id",t),n=no.jpath(".message.mid",t);this.getModel("message-body").get(".info.message-id")===o&&(ns.Model.get("state-message-thread-item",{ids:n}).setOpen(!0),ns.Model.get("message",{ids:n}).isValid()&&this.destroy())}}}})},1275:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(325),s=o(353),i=o(1276),a=o(882),r=o(337);!(function(){var e={compose_check_failed:i18n("%Compose_compose_check_failed"),virus_found:i18n("%Compose_virus_found"),strongspam_found:i18n("%Compose_strongspam_found"),incorrect_to:i18n("%Compose_incorrect_to"),incorrect_cc:i18n("%Compose_incorrect_cc"),incorrect_bcc:i18n("%Compose_incorrect_bcc"),msg_too_big:i18n("%Compose_msg_too_big"),no_recipients:i18n("%Compose_no_recipients"),fail_limit:i18n("%Compose_fail_limit"),too_many_emails:i18n("%Compose_too_many_emails"),max_email_addr_reached:i18n("%Compose_exceeded_limit_of_N_recipients",Daria.Constants.MAX_MESSAGES_TO_SEND),no_data:i18n("%Compose_no_data"),http_status_0:i18n("%Нет_доступа_к_интернету"),attachment_too_big:i18n("%_Compose_attachment_too_big_custom",Daria.Constants.MAX_MESSAGES_TO_FORWARD,Daria.Constants.MAX_TOTAL_SIZE_OF_ATTACHMENTS),internal_error:i18n("%Compose_internal_error"),access_denied:i18n("%Compose_access_denied_error"),illegal_params:i18n("%Compose_illegal_params_error"),cannot_save:i18n("%Compose_cannot_save_error")},t=[void 0,"","message-not-valid","captcha_request","need-confirm","attachments-failed","send-cancelled"],o=["compose-forwarded-messages","compose-state","compose-fsm","compose-attachments","compose-notify-noreply-options","compose-signature","compose-message"],c=["to","cc","bcc"];Daria.composeKey=function(e){return e&&e._cuid||"compose"};var l=_.memoize((function(e){return _.pick(e,["ids","tids","oper","qrIds","_cuid"])}),Daria.composeKey);Daria.getPageComposeIds=function(){var e=ns.page.current.params,t=Daria.composeKey(e);if(Daria.composeHasParams(t))return t},Daria.getRealComposeIds=function(e){var t=e.ids,o=ns.page.current.params;return!t&&l.cache.has(Daria.composeKey(o))&&Daria.isComposePage()&&o._cuid&&o.ids&&(t=o.ids),t},Daria.composeHasParams=function(e){var t=l.cache.get(e);return!_.isUndefined(t)&&ns.Model.get("compose-message",t).isValid()},Daria.composeKeyParams=function(e){return{_cuid:Daria.composeKey(e)}},ns.View.edefine("compose2",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroyed":"onDestroyed","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:delete":"onMessageRemoved","daria:vCompose2:send@show":"onSend","daria:vCompose2:save@show":"onSave"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"onLidsChange","ns-model:validation-error":"onValidationError","ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"showForgottenAttachmentsDialog"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"quick-reply-state":!1,"compose-fsm":{"ns-model-changed":!1,"# sending":"onSending","# cancel":"onCancel","# sent":"onSent","save > sending":"onSaveToSending","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:function(e){return l(e)},ctor:function(){this._forgottenAttachView=null,this._popup=null,this._composeUpdate=_.debounce(this._composeUpdate.bind(this),50)},yateModule:"compose2",methods:{ERROR_CODES:e,VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON:8,_composeUpdate:function(){this.isVisible()&&this.update()},onInit:function(){this.autosaveInit()},onMessageRemoved:function(e,t){if(t.originalAction&&"remove.draft"===t.originalAction&&t.messageInfo&&t.messageInfo.data){var o=ns.router.generateUrl("messages",{current_folder:t.messageInfo.data.fid});ns.page.go(o),Jane.c("Написание письма","Шапка письма",'Клик в "Удалить черновик"')}},isQuickReply:function(){return this.getModel("quick-reply-state").toShowForm()},isQuickReplyOnSeparatePage:function(){return this.isQuickReply()&&Daria.isMessagePage()},onHtmlInit:function(){if(this.leaveInit(),Daria.isComposePage()&&ns.Model.get("focus").resetFocus(!0),!this.isQuickReply()){var e=this.getModel("compose-message");if((e.isTemplate()||e.isDraft())&&e.mMessage){var t=ns.Model.get("messages-checked");t.resetChecked(),t.check(e.mMessage,!0)}}this.scrollToComposeTop()},onShow:function(){this.isDestroyed=!1,this.getModel("compose-fsm").switchOn(),this.autosaveStart(),this.leaveStart(),this.isQuickReply()||(ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}),this.attachFilesFromQuickReply(),this._logComposeOpen(r.a));var e=ns.Model.get("settings").isSet("liza_minified_header");Daria.isComposePage()&&($(".js-mail-Layout-Panes").addClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!0,"mail-Page_compose-minified":e})),this._preloadDonePage();var t=Daria.SendMail.getUndoSendLogger();t.setComposeLoaded(!0),t.setCancelled(Daria.SendMail.wasCancelledRecently(this.params.ids))},_logComposeOpen:function(e){if(e.hasActiveScenario(n.a)){var t=e.getActiveScenario(n.a),o=t.getTimeFromStart();t.logStep(i.b,{duration:o})}else if(ns.page.history.getPrevious())e.startScenario(n.a,s.c);else{var a=_.get(window,"performance.timing.navigationStart");if(a){var r=Date.now()-a,c=Daria.now()-r,l=e.startScenario(n.a,s.d,{startTime:c});l.logStep(i.b,{duration:r})}else e.startScenario(n.a,s.d)}},onHide:function(){Daria.SendMail.getUndoSendLogger().setComposeLoaded(!1),this.autosaveStop(),this.leaveStop(),_.defer((function(){"message"!==ns.page.current.page&&(ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}))})),$(".js-mail-Layout-Panes").removeClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!1,"mail-Page_compose-minified":!1})},onDestroyed:function(){this._destroy()},onPageBeforeLoad:function(e,t,o){if(o!==ns.page.currentUrl){var n=t[0],s=t[1];if(!Daria.composeEqualRoutes(n,s)){var i=s.params._cuid,a="template"===s.params.save_symbol&&!n.params.save_symbol,r=this.getModel("compose-message").wasSendCancelled();if(!a&&s.params.ids&&(!n.params.ids||n.params.ids!==s.params.ids)){a=ns.Model.get("message",{ids:s.params.ids}).isTemplate()}if(("compose2"!==n.page||a||r||"compose2"!==s.page&&!Daria.composeHasParams(i))&&("compose2"===n.page||"compose2"!==s.page||!Daria.composeHasParams(i))){if("compose2"!==s.page){Daria.SendMail.getUndoSendLogger().setComposeLoaded(!1)}this.shouldClearModel=!0,this._destroy()}}}},attachFilesFromQuickReply:function(){var e=this.getModel("compose-state"),t=e.get(".quickReplyAttaches"),o=this.getModel("compose-attachments");_.isArray(t)&&t.length>0&&(t.forEach((function(e){o.addAttach(e)})),e.set(".quickReplyAttaches",[]))},onDraftSaved:function(e,t){if(this.isVisible()){var o=this.getModel("compose-state");if(o.get(".saveTemplateAndLeave"))return void o.set(".saveTemplateAndLeave",!1);if(o.get(".saveTemplateAndReset"))return o.set(".saveTemplateAndReset",!1),void this.hardResetCompose();var n=_(ns.page.current.params).pick("_cuid").assign({ids:t.mid}).value(),s=ns.router.generateUrl("compose2",n);ns.page.go(s,"replace")}},hardResetCompose:function(){this.clean(),ns.page.go(ns.router.generateUrl("compose2"))},_destroy:function(){this.isDestroyed||(this.isDestroyed=!0,this.shouldClearModel&&(delete this.shouldClearModel,this.clean()))},setState:function(e,t){return this.getModel("compose-fsm").setState(e,t)},onSending:function(e,t){this.isVisible()&&(this.setState("sent",t.data),r.a.hasActiveScenario(n.a)&&r.a.getActiveScenario(n.a).logStep(i.d))},onCancel:function(){this.isVisible()&&(this.shouldClearModel=!0)},onSent:function(){if(this.isVisible()&&(this.shouldClearModel=!0,!this.isQuickReply())){var e=this.getModel("compose-message"),t=e.isDelayed()?a.e:a.f;r.a.finishScenario(n.a,t)}},onSaveToSending:function(){return Daria.Statusline.show({name:"before_sending_message",hideOnTimeout:!1,isCloseButtonVisible:!1,hideOnClick:!1}),this.getModel("compose-message").waitForDraftSave()},onSendingToSent:function(e,t){if(this.isVisible())return this.closePopup(),this.send(t.data)},onSendingToSentFailed:function(e,t){if(this.isVisible()){if(this.setState("edit"),!_.contains(this.silentStatuses,t.error)&&(this.showErrorPopup(t.error),!this.isQuickReply()&&r.a.hasActiveScenario(n.a))){var o=this.getModel("compose-message"),s=o.isDelayed()?i.c:i.e,a={error:t.error};r.a.getActiveScenario(n.a).logStep(s,a)}Daria.Statusline.hide()}},send:function(e){return e=_.extend({},{force:this.params.sendWithForce},e),this.getModel("compose-message").send(e)},silentStatuses:t,showErrorPopup:function(e){var t=this,o=this.getErrorMessageByCode(e);"cannot_save"===e?Daria.SendMail.showTryAgainPopup({title:i18n("%Произошла_ошибка"),message:o,onRetry:function(){t.getModel("compose-message").setSendWithUndoFailed(),t.onSend()},onCancel:null}):Daria.Dialog.notice({title:i18n("%Произошла_ошибка"),body:"<p>"+o+"</p>"})},getErrorMessageByCode:function(e){var t=this.ERROR_CODES[e];return t||(t=i18n("%Compose_send_failed")),t},showCaptcha:function(){if(this.isVisible()){var e=ns.View.create("compose-captcha");e.update().then((function(){Daria.Dialog.open({title:e.popupData.title,body:e.$node,width:e.popupData.width,onopen:function(){e.focusInput()},onclose:function(){e.invalidate(),e.destroy()}})})),!this.isQuickReply()&&r.a.hasActiveScenario(n.a)&&r.a.getActiveScenario(n.a).logStep(i.a)}},showForgottenAttachmentsDialog:function(e,t){if(this.isVisible()){var o=_.clone(this.params),n=this._forgottenAttachView=ns.View.create("compose-forgotten-attach",o);n.data=t,n.updateByLayout("forgotten-attach",o).then(this.onForgottenAttachUpdated.bind(this)),n.once("ns-view:close",this.onForgottenAttachClose.bind(this))}},onForgottenAttachUpdated:function(){var e=this._forgottenAttachView;this.closePopup(),this._popup=Daria.Dialog.open({width:e.popupData.width,body:e.$node})},onForgottenAttachClose:function(){this.closePopup();var e=this._forgottenAttachView;setTimeout((function(){e.destroy(),e=null}),0)},closePopup:function(){this._popup&&this._popup.isOpen()&&(this._popup.close(),this._popup=null)},showConfirmPopup:function(){this.isVisible()&&Daria.Dialog.confirm({body:'<div class="b-popup__p">'+i18n("%Compose_Empty_To")+"</div>",width:360,okValue:i18n("%Отправить"),okHandler:function(){this.setState("sending",{force:!0})}.bind(this),oncancel:function(){}})},onLidsChange:function(){this.isVisible()&&this._composeUpdate()},onValidationError:function(e,t){if(this.isVisible()){var o=_.find(c,(function(e){return t.hasOwnProperty(e)}));this.scrollToComposeTop(),this.getModel("compose-state").setFocusField(o,{force:!0})}},scrollToComposeTop:function(){var e=this.node.getBoundingClientRect(),t=e.top;window.scrollTo(0,window.pageYOffset+t-this.VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON)},clean:function(){_.each(o,(function(e){this.getModel(e).destroy()}),this);var e=ns.View.infoLite("compose-popular-contacts").params(this.params);ns.Model.get("compose-popular-contacts",e).clean(),this.invalidate(),l.cache.delete(Daria.composeKey(this.params))},onSend:function(){this.setState("sending")},onSave:function(){this.setState("save")},_preloadDonePage:function(){Daria.isComposePage()&&this.shouldGoToDonePage()&&Jane.Services.runModules(["done.js"],(function(){ns.forcedRequest("done-promos")}))}}},"compose-autosave-mixin","compose-leave-mixin",ns.View)})()},1276:function(e,t,o){"use strict";o.d(t,"b",(function(){return n})),o.d(t,"a",(function(){return s})),o.d(t,"d",(function(){return i})),o.d(t,"e",(function(){return a})),o.d(t,"c",(function(){return r}));var n="compose-have-opened",s="captcha-have-shown",i="sending-has-been-triggered",a="sending-have-failed",r="delayed-sending-have-failed"},1277:function(e,t){!(function(){var e=ns.View.infoLite("compose2");ns.View.edefine("quick-reply",{models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onQuickReplyStateShow","ns-model:delete-draft":"onDeleteDraft"},"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"onAttachmentsForgotten"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# edit":"onEdit","# sent":"onSent","# sending":"onSending","# cancel":"onCancel","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:e.params,ctor:function(){this._xivaInsertMessages={},e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{_parentApply:function(t,o){e.methods[t]&&e.methods[t].apply(this,o)},onShow:function(){this._parentApply("onShow",arguments),this.getModel("compose-state").setFocusField("send"),this._countMetrika("Показ")},onEdit:function(){var e=ns.Model.get("message-draft",{ids:this.params.qrIds});if(e.isValid()){var t=this.getModel("compose-message").getDraftMid();e.setIfChanged(".mid",t)}},onSent:function(){this._parentApply("onSent",arguments);var e=ns.Model.get("message-draft",{ids:this.params.qrIds});e.isValid()&&e.setIfChanged(".mid",void 0),this._countMetrika('Клик на "Отправить"')},onQuickReplyStateShow:function(){this.getModel("quick-reply-state").toShowForm()||(this.shouldClearModel=!0)},onDeleteDraft:function(){this.isVisible()&&(this.shouldClearModel=!0)},onDraftSaved:_.noop,scrollToComposeTop:_.noop,_onAfterSent:function(){return Daria.Statusline.hide("sending_message"),this._showMessageSentNotification(!0),this.getModel("quick-reply-state").showDone(),vow.Promise.resolve()},onAttachmentsForgotten:function(){this.getModel("compose-fsm").once("# edit",(function(){this.setState("sending",{force:!0})}))},_countMetrika:function(e){Daria.isMessagePage()?Jane.c("Quick Reply","Письмо на отдельной странице",e):Jane.c("Quick Reply",e)}}},"compose2")})()},1278:function(e,t){ns.View.define("compose-send-loader",{models:{"compose-fsm":{"sending > sent":"showLoader","# *":"hideLoader"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{CLASS_HIDDEN:"is-hidden",showLoader:function(){this.$node.removeClass(this.CLASS_HIDDEN)},hideLoader:function(){this.$node.addClass(this.CLASS_HIDDEN)}}})},1279:function(e,t){ns.View.define("compose-head",{params:ns.View.info("compose2").params,yateModule:"compose2"})},1280:function(e,t){ns.View.define("compose2019",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":!1,"module-editor":!1},yateModule:"compose2",methods:{onShow:function(){Daria.React.Compose.create(this.node,this.params)},onHide:function(){Daria.React.Compose.remove(this.node)}}})},1281:function(e,t){ns.View.define("compose-template-list",{models:{messages:!1,"compose-message":!1,"compose-state":!1,"compose-fsm":!1},events:{"click@show":"_onClick","click@show .js-template-item":"onTemplateClick","click@show .js-new-template":"onCreateTemplateClick","click@show .js-create-template":"onCreateTemplateClick","click@show .js-save-template":"onSaveTemplateClick"},ctor:function(){this._defaultOptions={withoutTail:!1,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",params:function(e){var t=ns.Model.get("folders").getFidBySymbol("template");return _.extend({},ns.View.info("compose2").params(e),{current_folder:t,allow_empty:!0})},methods:{onTemplateClick:function(e){var t=$(e.currentTarget).data("mid");if(t){Jane.c("Шаблоны:","Шаблоны дропдаун","Выбор шаблона");var o=this.getModel("compose-message");o.isDraft()||o.isReplyAny()||o.isForward()?ns.request(["message","message-body"],{ids:t,draft:!0}).then(this.onMessageBodyRequestSuccess.bind(this,o)):ns.page.go(ns.router.generateUrl("compose2",{ids:t}))}},onMessageBodyRequestSuccess:function(e,t){var o=t[0],n=t[1];if(e.addTextFromMessageBody(n),0===e.getAllRecepients().length&&e.setRecepientsFromMessageBody(n),!e.get(".subj")){var s=o.get(".subject");s&&e.set(".subj",s)}e.addAttachmentsFromTemplateMessageBody(n)},onCreateTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Новый шаблон");var e=ns.Model.get("compose-message"),t={save_symbol:"template"},o=ns.Model.get("compose-predefined-data"),n=e.getData(),s=e.isDirty()||e.isDraft(),i=Object.assign({},n,t);o.setData(i),ns.page.go(ns.router.generateUrl("compose2",t)).then((function(){ns.Model.get("compose-message",t).setDirty(s)}))},onSaveTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Сохранить шаблон");var e=this.getModel("compose-message"),t=this.getModel("compose-fsm");e.set(".save_symbol","template"),t.setState("save")},open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.updateByLayout("compose-template-list",this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onClick:function(){this.close()},_onAfterRender:function(){this._popup=nb.block(Jane.tt("compose2:js-compose-template-list")),this._popup.setContent(this.node),this._popup.on("nb-closed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onDestroyed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.destroy()}}})},1282:function(e,t){!(function(){ns.View.edefine("compose-template-list-button",{models:{},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){this.openTemplateListInit()},onHide:function(){this.openTemplateListDestroy()}}},"compose-template-list-popup-mixin")})()},1283:function(e,t){ns.View.define("compose-field-message-resize",{yateModule:"compose2",methods:{messageResizeInit:function(){ns.assert(this.getModel("compose-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-state"),ns.assert(this.getModel("quick-reply-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель quick-reply-state"),this._messageResizeInitShow=this._messageResizeInitShow.bind(this),this._onChangeMessageHeight=this._onChangeMessageHeight.bind(this)},messageResizeStart:function(){this.getModel("compose-state").on("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").on("ns-model-changed.timelineHeight",this._messageResizeInitShow),this._messageResizeInitShow()},messageResizeStop:function(){this.getModel("compose-state").off("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").off("ns-model-changed.timelineHeight",this._messageResizeInitShow)},getHeight:function(){return this._getHeight()},onChangeHeight:function(){ns.assert(!1,"Daria.vComposeFieldMessageResize",'"onChangeHeight" must be implemented by subclass')},_onChangeMessageHeight:function(){this.onChangeHeight()},_getHeight:function(){return this.getModel("compose-state").get(".messageHeight")},_messageResizeInitShow:function(){if(!this.getModel("quick-reply-state").toShowForm()){var e=this.$node.closest(".js-form").children(":last-child");if(e.length){var t=e[0].getBoundingClientRect();if(t&&(t.width||t.height)){var o=this._$window.height(),n=ns.Model.get("app-state").get(".timelineHeight");if(o&&!(o<t.bottom)){var s=this.$node.outerHeight(!1)-10,i=Math.floor(s+o-t.bottom-n);this.getModel("compose-state").setMessageHeight(i)}}}}}}})},1284:function(e,t){ns.View.define("compose-field-base-abook",{models:{"compose-message":!1},events:{"click .js-field-caption":"onCaptionClick"},yateModule:"compose2",methods:{abookInit:function(){this._loadModulesOnce()},isAbookPopupAvailable:!0,onCaptionClick:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.showAbookContactsPopup("compose-field-caption")},showAbookContactsPopup:function(e){Jane.Services.runModules(["abook.css","abook.js","abook.yate"],this._showPopupWhenReady.bind(this,e))},_showPopupWhenReady:function(e){var t={};t[this.FIELD_NAME]=this.getModel("compose-message").getContacts(this.FIELD_NAME);var o=new vow.Deferred;o.promise().then(this.onAbookContactsSelected.bind(this),this.onAbookPopupClosed.bind(this)),ns.action.run("mail-common.abook-popup",{popupType:"select",emails:t,resultDeferred:o}),this._countAbookPopupShow(e)},onAbookContactsSelected:function(e){this.getModel("compose-message").setContacts(this.FIELD_NAME,e),this.onAbookPopupClosed()},onAbookPopupClosed:function(){this.focus()},_countInfo:{sourceType:{"compose-field-caption":"через клик на подпись поля композа","compose-field-suggest":'через клик на "Все контакты" в саджесте'},fieldName:{to:"Кому",cc:"Копия",bcc:"Скрытая копия"}},_countAbookPopupShow:function(e){Jane.c(["АК в саджесте композа","показ попапа",this._countInfo.sourceType[e],this._countInfo.fieldName[this.FIELD_NAME]])},_loadModulesOnce:(function(){var e=!1;return function(){e||(e=!0,Jane.Services.load("#abook"))}})()}})},1285:function(e,t){ns.View.define("compose-field-base-suggest",{yateModule:"compose2",methods:{suggestInit:function(e,t){this._suggestItemSelect=this._suggestItemSelect.bind(this),this._suggestValueSet=this._suggestValueSet.bind(this),this._suggestGetPositionNode=this._suggestGetPositionNode.bind(this);var o=$.extend({getPositionNode:this._suggestGetPositionNode,fieldType:this.FIELD_NAME,multiple:this.areYabblesDisabled(),position:{my:"left top",at:"left+9px bottom-1px",collision:"none"},showAbookPopupButton:this.isAbookPopupAvailable},t);"phone"===e?this.suggestInstance=new Daria.Suggest.Phones(null,o):(o.exclude=function(){var e=this.getModel("compose-message").getAllRecepientEmails();return this.areYabblesDisabled()&&e[this.FIELD_NAME].pop(),e}.bind(this),this.suggestInstance=new Daria.Suggest.Contacts(null,o))},suggestStart:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.on("select",this._suggestItemSelect),this.suggestInstance.on("value-set",this._suggestValueSet),this.suggestInstance.changeInputField(this.getControllerNode()),!0)},suggestStop:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.off("select",this._suggestItemSelect),this.suggestInstance.off("value-set",this._suggestValueSet),this.suggestInstance.destroy(),!0)},_suggestGetPositionNode:function(){return this.node},_suggestValueSet:function(e,t,o,n){this.setFieldData(n)},_suggestItemSelect:function(e,t,o){switch(o.item.type){case"abook-popup-button":t.preventDefault(),this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}}}})},1286:function(e,t){!(function(){function e(e,t){return t.reduce((function(t,o){var n=_.isPlainObject(o),s=n?o.from:o,i="yabble-"+(n?o.to:o),a=e[s];return a&&(t[i]=a),t}),{})}var t=Daria.Constants.CONTACTS.DELIMITER;ns.View.define("compose-field-base-yabble-ng",{models:{"compose-state":!1,"compose-message":!1},yateModule:"compose2",methods:{CLASS_YABBLE_FOCUS:"mail-Bubbles-FocusArea",_bindMethods:function(){_.bindAll(this,["_bubbleSuggestItemSelect","_bubbleSuggestOpen","_bubbleSuggestClose","_yabbleSyncViewToData","_bubbleDragStart","_bubbleDragEnter","_bubbleDragLeave","_bubbleDragEnd","_bubbleEdit","_bubbleInput","_bubblesetFocus","_bubblesetBlur","_bubblesetKeydown","_bubblesetClick","_bubbleClick","_bubblesUpdate","_onBubbleDropdownDestroy","_onBubbleDropdownOpened","_onBubbleDropdownClosed","_onBubbleFieldValueChanged"])},yabbleInit:function(){this._bindMethods(),this._BubbleClass=this._BubbleClass||Daria.BaseBubble,this.CLASS_CUSTOM_BUBBLE=this._BubbleClass.BUBBLE_CLASS,this._bubblesUpdateDebounce=_.debounce(this._bubblesUpdate,100),this._bubbleClickDebounce=_.debounce(this._bubbleClick,200),this._onBubbleFieldValueChangedDebounce=_.debounce(this._onBubbleFieldValueChanged,50)},getCustomBubbleClass:function(){return this.CLASS_CUSTOM_BUBBLE},yabbleStart:function(){return!this.areYabblesDisabled()&&(this.getControllerNode().on({blur:this._bubblesetBlur,"bubble-input":this._bubbleInput,"bubble-edit":this._bubbleEdit,change:this._yabbleSyncViewToData,click:this._bubblesetClick,dragstart:this._bubbleDragStart,dragenter:this._bubbleDragEnter,dragleave:this._bubbleDragLeave,dragend:this._bubbleDragEnd,focus:this._bubblesetFocus,keydown:this._bubblesetKeydown}),this.suggestInstance&&(this.$suggestProxy=this.$node.find(".js-suggest-proxy"),this.suggestInstance.on("select",this._bubbleSuggestItemSelect).on("open",this._bubbleSuggestOpen).on("close",this._bubbleSuggestClose)),this._customSyncDataToView=this._yabbleSyncDataToView,this._customSyncViewToData=this._yabbleSyncViewToData,this._customOnInput=_.noop,this._bubblesUpdateDebounce(),this._onBubbleFieldValueChanged(),!0)},yabbleStop:function(){return!this.areYabblesDisabled()&&(this.getControllerNode().off(),this.suggestInstance&&(this.$suggestProxy=null,this.suggestInstance.off("select",this._bubbleSuggestItemSelect).off("open",this._bubbleSuggestOpen).off("close",this._bubbleSuggestClose),this.suggestInstance.destroy()),this._customSyncDataToView=null,this._customSyncViewToData=null,this._customOnInput=null,!0)},_getBubbleset:function(){return this.getControllerNode()[0]},_bubbleSuggestOpen:function(){this._getBubbleset().options("disableControls",!0)},_bubbleSuggestClose:function(){this._getBubbleset().options("disableControls",!1)},_bubbleInput:function(e){this.$suggestProxy.val(e.originalEvent.detail.data).trigger("keydown")},_bubbleEdit:function(){this._bubbleClickDebounce.cancel(),this._bubbleDropdownDestroy()},_bubblesetFocus:function(){this.suggestInstance.changeInputField(this.$suggestProxy)},_bubblesetBlur:function(){this.suggestInstance&&this.suggestInstance.hide()},_bubblesetKeydown:function(e){if(this.suggestInstance){var t=e.charCode||e.keyCode,o=Jane.Common.keyCode;switch(t){case o.TAB:this.suggestInstance.isOpen()&&this.suggestInstance.focusedSelect();break;case o.ENTER:case o.ESC:case o.UP:case o.DOWN:this.suggestInstance.isOpen()&&this.suggestInstance.$inputField.trigger(e)}}},onWaitSuggestChanged:function(){var e=this.getModel("compose-state"),t=e.getFocusField(),o=e.getWaitSuggest();this.isVisible()&&this.FIELD_NAME===t&&o&&(this.getControllerNode().focus(),e.setWaitSuggest(!1))},_onBubbleFieldValueChanged:function(){},_bubbleSuggestItemSelect:function(t,o,n){o.preventDefault();var s=n.item,i=this._getBubbleset();i.focus();var a;switch(s.type){case"group":i.addBubble(s.name,e(s,[{from:"id",to:"tid"},"value","email","name","type"]));break;case"contact":case"wsContainer":i.addBubble(s.value,e(s,[{from:"id",to:"cid"},"type","phone","email","name"]));break;case"popdom":a=Object.assign({},s),a.id<0&&delete a.id,i.addBubble(a.value,e(a,[{from:"id",to:"cid"},"type"]));break;case"abook-popup-button":this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}this._yabbleSyncViewToData()},_bubblesetChange:function(){var e=this.getControllerNode().prop("items"),o=e.map(this._BubbleClass.toString).join(t);this.setFieldData(o),this._bubblesUpdateDebounce()},_bubbleDragStart:function(e){this.suggestInstance&&this.suggestInstance.hide();var t=_.get(e,"detail.target")||e.target;this._toggleGlobalDragData(t)},_bubbleDragEnter:function(){this._getDragClasses().indexOf(this.CLASS_CUSTOM_BUBBLE)>-1&&this.$node.addClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragLeave:function(){this.$node.removeClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragEnd:function(e){this._bubbleDragLeave(e),this._toggleGlobalDragData()},_toggleGlobalDragData:function(e){var t=document.documentElement;e?(t.setAttribute("data-dragged-yabbles-class-names",e.className),t.classList.add("yabbles-drag")):(t.removeAttribute("data-dragged-yabbles-class-names"),t.classList.remove("yabbles-drag"))},_getDragClasses:function(){var e=document.documentElement,t=e.getAttribute("data-dragged-yabbles-class-names");return t?t.split(" "):[]},_yabbleSyncDataToView:function(){var e=this.getModel("compose-message").getContacts(this.FIELD_NAME);this._getBubbleset().setContent(this._syncDataToViewFormatContacts(e).join(t))},_syncDataToViewFormatContacts:function(e){return e},_yabbleSyncViewToData:function(){this.suggestInstance&&(this.suggestInstance.hide(),(this.suggestInstance.currentTerm||this.suggestInstance.prevTerm)&&this.suggestInstance.log({suggest_used:"no"})),this._bubbleDropdown&&this._bubbleDropdown.destroy(),this._bubblesetChange()},_bubblesUpdate:function(){},_onBubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.$node&&this._unsetBubbleDropdownEventHandlers(this._bubbleDropdown.$node),this._bubbleDropdown=null},_onBubbleDropdownOpened:function(e,t){if(!_.get(t,"where.parentNode"))return void t.destroy();var o=this;_.defer((function(){var e=t.$node&&t.$node.find(".js-bubble-copy");if(e.length){var n=new Daria.Clipboard(e);n.on("ready",(function(){if(t.where){var n=new o._BubbleClass(t.where).getHeadEmail();this.setText(n),e.removeClass("is-disabled")}})),n.on("complete",(function(){t.destroy()})),t.on("nb-closed",_.debounce((function(){n.destroy()}),50))}})),this._onBubbleDropdownDestroy=t.destroy.bind(t),this._$window.one("scroll",this._onBubbleDropdownDestroy),this._$document.one("keydown",this._onBubbleDropdownDestroy),ns.events.once("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.once("daria:layout-changed",this._onBubbleDropdownDestroy)},_onBubbleDropdownClosed:function(e,t){this._onBubbleDropdownDestroy&&(this._$window.off("scroll",this._onBubbleDropdownDestroy),this._$document.off("keydown",this._onBubbleDropdownDestroy),ns.events.off("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.off("daria:layout-changed",this._onBubbleDropdownDestroy),delete this._onBubbleDropdownDestroy),t.destroy()},_bubblesetClick:function(e){var t=$(e.target).closest("[bubble]")[0];if(t){var o=!0;this._bubbleDropdown&&(o=this._bubbleDropdown.where!==t,this._bubbleDropdown.close()),this._bubbleClickDebounce(e,t,o)}else this.suggestInstance.show()},_bubbleClick:function(e,t,o){if(o){var n=new this._BubbleClass(t);t.parentNode&&this._bubbleOpenDropdown(n,t)}},_getBubbleDropdownData:function(){return{}},_setBubbleDropdownEventHandlers:function(){},_unsetBubbleDropdownEventHandlers:function(){},_bubbleOpenDropdown:function(e,t){this._bubbleDropdown=nb.block(ns.renderNode(this._getBubbleDropdownData(e),"js-bubble-dropdown","compose2")),this._bubbleDropdown.on("nb-destroyed",this._onBubbleDropdownDestroy),this._bubbleDropdown.on("nb-opened",this._onBubbleDropdownOpened),this._bubbleDropdown.on("nb-closed",this._onBubbleDropdownClosed),this._setBubbleDropdownEventHandlers(this._bubbleDropdown.$node,e,t),this._updateItemsGroupBubble(),this._bubbleDropdown.open({withoutTail:!1,autofocus:!1,animation:!1,where:t})},_bubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.destroy()},_onClickRemoveBubble:function(e){this._bubbleDropdownDestroy(),this._getBubbleset().removeBubble(e)},_onClickSingleTargetBubble:function(e){this._bubbleDropdownDestroy();var t=new this._BubbleClass(e),o=this._getBubbleset();o.items.forEach((function(t){t!==e&&o.removeBubble(t)})),this.getModel("compose-message").setSingleRecipient(t.toString())},_onClickEditBubble:function(e){this._bubbleDropdownDestroy();var t=this._getBubbleset();t.focus(),t.editBubble(e)},_onClickAddAbookBubble:function(e){this._bubbleDropdownDestroy(),this._onSuccessAddAbookBubble&&(ns.events.off("yabble.add-to-abook",this._onSuccessAddAbookBubble),this._onSuccessAddAbookBubble=null);var t=_.uniqueId(),o=new this._BubbleClass(e);ns.action.run("yabble.add-to-abook",{id:t,name:o.get("name"),email:o.getHeadEmail()}),this._onSuccessAddAbookBubble=_.bind((function(o,n){this._onSuccessAddAbookBubble=null,n.id===t&&e.parentNode&&this._bubblesUpdate()}),this),ns.events.once("yabble.add-to-abook",this._onSuccessAddAbookBubble)},_onClickChangeEmailBubble:function(e,t){this._bubbleDropdownDestroy();var o=$(t.currentTarget).data("email"),n=new this._BubbleClass(e);n.setEmail(o),n.applyTo(e),this._bubblesetChange()},_onChangeGroupBubble:function(e,t){var o=$(t.currentTarget),n=o.find("input"),s=n.prop("checked"),i=n.val(),a=new this._BubbleClass(e);s?a.appendEmail(i,o.data("name")):a.removeEmail(i),a.applyTo(e),this._updateItemsGroupBubble(),this._bubblesetChange()},_updateItemsGroupBubble:function(){if(this._bubbleDropdown){var e=this._bubbleDropdown.$node.find("input:checked");e.closest(".js-bubble-change-group").toggleClass("is-disabled",1===e.length)}}}})})()},1287:function(e,t){!(function(){var e=ns.View.info("compose-field-base-yabble-ng");ns.View.edefine("compose-field-contact-yabble-ng",{yateModule:"compose2",methods:{CLASS_YABBLE_SMS_LINK:"mail-Bubbles-Sms",_BubbleClass:Daria.ContactBubble,_bindMethods:function(){e.methods._bindMethods.call(this),this._onBubbleSmsLinkToggle=this._onBubbleSmsLinkToggle.bind(this)},yabbleStart:function(){var t=e.methods.yabbleStart.call(this);return t&&(this.getModel("compose-state").on("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").on("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},yabbleStop:function(){var t=e.methods.yabbleStop.call(this);return t&&(this.getModel("compose-state").off("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").off("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},_bubblesUpdate:function(){for(var e=this.getControllerNode(),t=e.prop("items"),o=t.length,n=[];o--;){var s=t[o];if(!s.hasAttribute("lock")){var i=new this._BubbleClass(s);i.needUpdate()&&(n.push(i.getHeadEmail()),s.setAttribute("lock","lock"))}}if(n.length){var a,r=1/0,c=this;n.reduce((function(e,t){return t.length<c._BubbleClass.EMAIL_LEN_REQUEST&&(r+=t.length+1,r>c._BubbleClass.EMAIL_LEN_REQUEST&&(r=0,a=[],e.push(a)),a.push(t)),e}),[]).forEach((function(t){var o=[],n=t.join(",");o.push({id:"abook-contacts",params:{emails:n}}),Daria.Config.workspace&&o.push({id:"abook-contacts",params:{emails:n,shared:1}}),ns.request(o).then((function(o){for(var n=o[0].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0}),s=o[1]?o[1].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0,shared:!0}):[],i=s.concat(n).reduce((function(e,t){return e[t.email]=!0,e}),{}),a=e.prop("items"),r=a.length;r--;){var l=a[r],u=new c._BubbleClass(l);i[u.getHeadEmail()]&&u.applyTo(l)}c._bubblesetChange()}))}))}},_bubbleClick:function(e,t,o){var n,s,i=Boolean($(e.target).closest(".js-sms-open-link").length),a=new this._BubbleClass(t);if(i)return n=a.getPhone(),s={phone:n.value,email:a.getHeadEmail(),name:a.getText(),canRequest:n.status!==this._BubbleClass.PHONE.NOT_FOUND},void this.getModel("compose-state").trigger("sms-link-click",s);if(o){this._bubbleDropdownPromise&&!this._bubbleDropdownPromise.isResolved()&&this._bubbleDropdownPromise.reject();var r=vow.resolve();a.isGroup()?r=ns.request("abook-contacts",{tid:a.get("tid")}):a.isContact()&&(r=ns.request("abook-contact",{cid:a.get("cid")})),r.then((function(){t.parentNode&&this._bubbleOpenDropdown(a,t)}),this),this._bubbleDropdownPromise=r}},_onBubbleFieldValueChanged:function(){this._toggleSmsLink(this._canShowSmsLink())},_bubbleDragStart:function(){e.methods._bubbleDragStart.apply(this,arguments);var t=this.getModel("compose-state");t.setIfChanged(".isCcVisible",!0),t.setIfChanged(".isBccVisible",!0)},_canShowSmsLink:function(){var e=this.getModel("compose-state");if(!e.get(".isPhoneEnabled")||e.get(".isPhoneVisible"))return!1;var t=this.getModel("compose-message"),o=t.getAllRecepients(),n=t.getContacts(this.FIELD_NAME);return 1===o.length&&1===n.length},_toggleSmsLink:function(e){this.getControllerNode().toggleClass(this.CLASS_YABBLE_SMS_LINK,e)},_onBubbleSmsLinkToggle:function(e,t){this._toggleSmsLink(this._canShowSmsLink()&&t)},_syncDataToViewFormatContacts:function(e){return e.map(Jane.FormValidation.obj2contact)},_getBubbleDropdownData:function(e){var t={canCopy:Daria.Clipboard.canUse,contact:{isContact:e.isContact(),isGroup:e.isGroup(),email:e.getHeadEmail()},emails:e.get("email")};if(e.isGroup())t.contacts=ns.Model.get("abook-contacts",{tid:e.get("tid")}).get(".contact"),t.contacts=_(t.contacts).chain().reduce((function(e,o){return _.forEach(o.email,(function(n){e.push({name:_.get(o,"name.full"),email:n.value,checked:-1!==t.emails.indexOf(n.value)})})),e}),[]).value();else if(e.isContact()){var o=ns.Model.get("abook-contact",{cid:e.get("cid")}).get(".email");t.emails=_(o).chain().map("value").concat(t.emails).compact().uniq().value()}return t},_setBubbleDropdownEventHandlers:function(e,t,o){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,o)).on("click",".js-bubble-single-target",this._onClickSingleTargetBubble.bind(this,o)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,o)).on("click",".js-bubble-add-to-abook",this._onClickAddAbookBubble.bind(this,o)).on("click",".js-bubble-change-email",this._onClickChangeEmailBubble.bind(this,o)).on("change",".js-bubble-change-group",this._onChangeGroupBubble.bind(this,o))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-single-target").off("click",".js-bubble-edit").off("click",".js-bubble-add-to-abook").off("click",".js-bubble-change-email").off("change",".js-bubble-change-group")}}},"compose-field-base-yabble-ng",ns.View)})()},1288:function(e,t){!(function(){ns.View.edefine("compose-field-phone-yabble-ng",{yateModule:"compose2",methods:{_BubbleClass:Daria.PhoneBubble,_getBubbleDropdownData:function(){return{canCopy:Daria.Clipboard.canUse,contact:{isPhone:!0}}},_setBubbleDropdownEventHandlers:function(e,t,o){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,o)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,o))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-edit")}}},"compose-field-base-yabble-ng",ns.View)})()},1289:function(e,t){ns.View.define("compose-field-base-sms-controls",{yateModule:"compose2",methods:{smsControlsInit:function(){this.suggestItemButtonClick=this.suggestItemButtonClick.bind(this),this.onFieldValueChanged=this.onFieldValueChanged.bind(this),this.onPhoneFieldStateChanged=this.onPhoneFieldStateChanged.bind(this),this.smsLinkClick=this.smsLinkClick.bind(this)},smsControlsStart:function(){this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.on("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.on("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.on("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.on("button-click",this.suggestItemButtonClick),this.onPhoneFieldStateChanged(),!0},smsControlsStop:function(){this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.off("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.off("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.off("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.off("button-click",this.suggestItemButtonClick),!0},onFieldValueChanged:function(){var e=this.getModel("compose-state").get(".isPhoneEnabled"),t=this.getModel("compose-state").get(".isPhoneVisible");if(e&&t){var o=this.getModel("compose-message");if(o.hasOnlyOneValidRecipient(this.FIELD_NAME)){var n=o.getContacts(this.FIELD_NAME);o.setPhoneIfExist(n[0].email)}}},onPhoneFieldStateChanged:function(){var e=this.getModel("compose-state"),t=e.get(".isPhoneEnabled"),o=e.get(".isPhoneVisible"),n=e.get(".userHasValidatedPhone");this.suggestInstance&&Daria.Config.MAY_HAVE_SMS_COPY&&(this.suggestInstance.options.noSmsButton=!n),this.refreshSmsYabbles(t,o)},refreshSmsYabbles:function(e,t){this.getModel("compose-state").atrigger("sms-link-toggle",e&&!t)},suggestItemButtonClick:function(e,t,o){var n=o.item,s=n.email,i=n.phone;o.button.hasClass("js-compose-add-phone")&&i&&this.setPhoneValue({email:s,phone:i,canRequest:!0})},smsLinkClick:function(e,t){t=t||{},this.setPhoneValue(t)},setPhoneValue:function(e){var t=this.getModel("compose-state"),o=this.getModel("compose-message"),n=e.email,s=e.canRequest;if(t.get(".isPhoneEnabled"))return t.setIfChanged(".isPhoneVisible",!0),s?o.setPhoneIfExist(n,!0).then((function(){t.setFocusField("phone")})):void t.setFocusField("phone")}}})},1290:function(e,t){ns.View.define("compose-field-base-resize",{yateModule:"compose2",methods:{resizeInit:function(){this._$resizeInputController=null,this._$resizeMeasurer=null,this._resizeMeasurerHeight=0,this._resizeKeypressPrevent=this._resizeKeypressPrevent.bind(this),this._resizeCheck=this._resizeCheck.bind(this),this._resizeCheckDebounce=_.debounce(this._resizeCheck,50)},resizeStart:function(){return!!this.areYabblesDisabled()&&(this._$resizeInputController=this.getControllerNode(),this._resizeMeasurerInit(),this._resizeBindEvents(),!0)},resizeStop:function(){return!!this.areYabblesDisabled()&&(this._resizeUnbindEvents(),this._resizeMeasurerDestroy(),this._$resizeInputController=null,!0)},_resizeBindEvents:function(){this._$resizeInputController.on("keypress",this._resizeKeypressPrevent),this.on("ns-view-show",this._resizeCheck),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeUnbindEvents:function(){this._$resizeInputController.off("keypress",this._resizeKeypressPrevent),this.off("ns-view-show",this._resizeCheck),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeKeypressPrevent:function(e){e.which===Jane.Common.keyCode.ENTER&&e.preventDefault()},_resizeMeasurerInit:function(){this._$resizeMeasurer=$('<div class="is-vhidden">measurer</div>').insertAfter(this._$resizeInputController),this._resizeMeasurerHeight=this._$resizeMeasurer.height()},_resizeMeasurerDestroy:function(){this._$resizeMeasurer.remove(),this._$resizeMeasurer=null,this._resizeMeasurerHeight=0},_resizeCheck:function(){var e=1,t="auto";if(this._resizeMeasurerHeight){this._$resizeMeasurer.text(this.getFieldData()),this._$resizeMeasurer.width(this._$resizeInputController.width()),e=Math.ceil(this._$resizeMeasurer.height()/this._resizeMeasurerHeight);var o=e;e<1?o=1:e>3&&(o=3),t=o*this._resizeMeasurerHeight}this._$resizeInputController.height(t).toggleClass("is-multiline",e>3)}}})},1291:function(e,t){ns.View.define("compose-field-base-focus",{events:{"focusin@show .js-compose-field":"onFocus","focusout@show .js-compose-field":"onBlur"},yateModule:"compose2",methods:{FIELD_NAME:null,CLASS_FOCUSED:"is-focused",_customFocus:null,_customIsFocused:null,focusInit:function(){this.onFocusFieldChanged()},focusDestroy:function(){},onFocusFieldChanged:function(){var e=this.getModel("compose-state").getFocusField();this.isVisible()&&this.FIELD_NAME===e&&this.focus()},onFocus:function(){this.toggleFocus(!0)},onBlur:function(){this.toggleFocus(!1)},toggleFocus:function(e){this.getModel("compose-state").setFocusField(e?this.FIELD_NAME:null,{silent:!0}),this.$node.toggleClass(this.CLASS_FOCUSED,e),this.$node.find(".js-compose-field-wrapper").toggleClass(this.CLASS_FOCUSED,e)},focus:function(){this._customFocus?this._customFocus():this.$node.find(".js-compose-field").focus(0)},isFocused:function(){return this._customIsFocused?this._customIsFocused():this.$node.find(".js-compose-field").is(":focus")}}})},1292:function(e,t){!(function(){ns.View.edefine("compose-field-base",{models:{"compose-message":!1,"compose-state":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","input@show .js-compose-field":"onInput"},params:{},ctor:function(){this.onFieldDataChanged=this.onFieldDataChanged.bind(this)},yateModule:"compose2",methods:{NEED_TO_EMULATE:Modernizr.ie9&&Modernizr.opera<15,_customSyncDataToView:null,_customSyncViewToData:null,getContextNode:function(){return this.$node.closest(".js-form")},getControllerNode:function(){return this.$node.find(".js-compose-field")},setFieldData:function(e){var t={data:{needUpdate:!1}};this.getModel("compose-message").setIfChanged("."+this.FIELD_NAME,e,t)},getFieldData:function(){return this.getModel("compose-message").get("."+this.FIELD_NAME)},onFieldDataChanged:function(e,t,o,n){n=n||{},!1!==n.needUpdate&&this.syncDataToView()},syncDataToView:function(){this.isVisible()&&(this._customSyncDataToView?this._customSyncDataToView():this.getControllerNode().val(this.getFieldData()))},syncViewToData:function(){if(this.isVisible())if(this._customSyncViewToData)this._customSyncViewToData();else{var e=this.getControllerNode().val();this.setFieldData(e)}},onInit:function(){},onShow:function(){this.startEmulateInputEvent(),this.focusInit(),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},onHide:function(){this.stopEmulateInputEvent(),this.focusDestroy(),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},startEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.startEmulateInputEvent(".js-compose-field")},stopEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.stopEmulateInputEvent()},onInput:function(e){if(e.target===e.currentTarget)if(this._customOnInput)this._customOnInput();else{var t=$(e.currentTarget);this.setFieldData(t.val())}},areYabblesDisabled:function(){return ns.Model.get("settings").isSet("disable_yabbles")}}},"compose-field-base-focus")})()},1293:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-to",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":ns.View.defineModelEvents({"ns-model-changed.to":"onFieldValueChanged"}),"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"to",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},1294:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-cc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"cc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},1295:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-bcc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"bcc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},1296:function(e,t){ns.View.define("compose-field-phone",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".isPhoneEnabled")?"layout-compose-field-phone-input":"layout-compose-field-phone-input-error"}}})},1297:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-phone-input",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged"}),"compose-message":!1},mixins:["compose-field-phone-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"phone",onInit:function(){this.resizeInit(),this.suggestInit("phone",{multiple:!1}),this.yabbleInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base")})()},1298:function(e,t){!(function(){ns.View.define("compose-field-phone-input-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{}},"compose-field-phone-error-mixin")})()},1299:function(e,t){!(function(){ns.View.edefine("compose-field-subject",{models:{"compose-message":{"ns-model-changed":!1,"ns-model:store-subject-for-autocomplete":"_storeSubjectForAutocomplete"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){ns.View.info("compose-field-base").ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"subj",_storeSubjectForAutocomplete:function(){var e=this.$node.find(".js-compose-field");if(e.length){var t="subj-".concat(Daria.getRandomString()),o="/monitoring_liza.txt?ffs=".concat(t),n=$('<iframe name="'.concat(t,'" class="is-hidden">')).appendTo(document.body),s=$('<form target="'.concat(t,'" class="is-hidden">')).attr("action",o).appendTo(document.body);e.clone().appendTo(s),$('<button type="submit"></button>').appendTo(s).click(),s.remove(),n.remove()}}}},"compose-field-base-hotkeys","compose-field-base")})()},1300:function(e,t){ns.View.define("compose-field-placeholder",{events:{"click@show":"onClick","click@show .js-recipient":"onClickRecipient","mouseenter@show .js-recipient":"onMouseEnterLeaveRecipient","mouseleave@show .js-recipient":"onMouseEnterLeaveRecipient","click@show .js-recipients-edit":"onClickEditButton","click@show .js-recipients-expand":"onClickYetButton"},models:{"quick-reply-state":{"ns-model-changed":"keepValid","ns-model-changed.formIsShown":"updateYetField"},"compose-state":!1,"compose-message":{"ns-model-changed":"keepValid","ns-model-changed.to":"invalidate","ns-model-changed.cc":"invalidate","ns-model-changed.bcc":"invalidate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onMouseEnterLeaveRecipient:function(e){var t=$(e.target).closest(".js-recipients"),o="mouseenter"===e.type;t.toggleClass("has-inner-target",o)},updateYetField:function(){if(!this.getModel("quick-reply-state").get(".formIsShown"))return void this._setVerboseState(!1);var e=this.$node.find(".js-recipients-expand-to"),t=this.$node.find(".js-recipients"),o=t.width(),n=t.find(".js-recipient"),s=[],i=!1;n.each((function(e,t){var n=$(t).position().left,a=n+$(t).width();n>o&&s.push(t),a>o&&(i=!0)}));var a=s.length>0,r="...";a&&(r+=" "+i18n("%N_More",s.length+this.getCopyCount())),e.text(r),e.toggleClass("is-visible",a||i)},onClickYetButton:function(e){e.preventDefault(),e.stopPropagation(),this._setVerboseState(!0)},_setVerboseState:function(e){this.getModel("quick-reply-state").setIfChanged(".verboseFieldPlaceholder",e)},onClick:function(){this.getModel("quick-reply-state").setIfChanged(".showFieldPlaceholder",!1)},onClickRecipient:function(e){var t=this.getModel("compose-message"),o=t.get(".to"),n=t.get(".cc"),s=t.get(".bcc"),i=Jane.FormValidation.obj2contact({name:e.target.dataset.name,email:e.target.dataset.email});(n||s||o!==i)&&(e.preventDefault(),e.stopPropagation(),t.setSingleRecipient(i))},onClickEditButton:function(e){e.preventDefault(),e.stopPropagation(),this.getModel("quick-reply-state").setIfChanged(".showFieldPlaceholder",!1);var t=this.getModel("compose-state"),o=$(e.target).data("field");t.setFocusField(o),t.setWaitSuggest(!0)},_getFieldItems:function(e){var t=this.getModel("compose-message"),o=t.get("."+e);return o?Jane.FormValidation.splitContacts(o):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},1301:function(e,t){ns.View.define("compose-field-to-extras",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"quick-reply-state":!1,"compose-field-extras-collection":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state"),t=this.getModel("compose-state"),o=this.getModel("compose-field-extras-collection"),n=ns.Model.get("userphones").hasActiveNumber(),s=n&&Daria.Config.MAY_HAVE_SMS_COPY;return o.clear(),e.toShowForm()?(e.get(".showFieldPlaceholder")||(s&&!t.isFieldVisible("phone")&&o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-phone"},this.params)).setData({type:"extras-phone"})),t.isFieldVisible("cc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),t.isFieldVisible("bcc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"}))),o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-go-to-compose"},this.params)).setData({type:"extras-go-to-compose"})),o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-qr-close"},this.params)).setData({type:"extras-qr-close"}))):(s&&!t.isFieldVisible("phone")&&o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-phone"},this.params)).setData({type:"extras-phone"})),t.isFieldVisible("cc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),t.isFieldVisible("bcc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"}))),"layout-compose-field-to-extras"}}})},1302:function(e,t){ns.View.define("compose-field-to-extras-cc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-cc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isCcVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Копия"')}}})},1303:function(e,t){ns.View.define("compose-field-to-extras-bcc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-bcc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isBccVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Скрытая копия"')}}})},1304:function(e,t){ns.View.edefine("compose-field-to-extras-qr-close",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick"},models:{"quick-reply-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},onClick:function(){this.getModel("quick-reply-state").hideForm(),Daria.isMessagePage()&&Jane.c("Quick Reply","Письмо на отдельной странице","Клик на крестик")}}},"compose-disable-on-sending-mixin",ns.View)},1305:function(e,t){ns.View.define("compose-field-to-extras-go-to-compose",{events:{"click@show":"onClick"},models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{onClick:function(){this._openComposePage(),this._countMetrika()},_openComposePage:function(){var e=_.omit(this.params,"qrIds"),t=ns.router.generateUrl("compose2",e);ns.page.go(t).then((function(){ns.Model.get("compose-fsm",e).setInitialState("edit"),ns.Model.get("compose-message",e).expandMessage()}))},_countMetrika:function(){var e={"compose-attach-fake":"Клик на скрепку","compose-go-to-compose":'Клик на "Перейти в полную форму"'}[this.id];Daria.isMessagePage()&&e&&Jane.c("Quick Reply","Письмо на отдельной странице",e)}}})},1306:function(e,t){ns.View.edefine("compose-go-to-compose",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2"},"compose-field-to-extras-go-to-compose")},1307:function(e,t){ns.View.define("compose-field-to-extras-phone",{events:{"click@show":"onClick"},models:{"compose-message":!1,"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-phone-input").methods.FIELD_NAME;if(t.get(".isPhoneEnabled")){t.setFocusField(o),t.setIfChanged(".isPhoneVisible",!0);var n=this.getModel("compose-message");if(n.hasOnlyOneValidRecipient()){var s=n.getAllRecepients();n.setPhoneIfExist(s[0].email,!0)}}else{var i=nb.block(Jane.tt("common:js-hint",{content:this.getErrorMessage()}));i.on("nb-closed",(function(){this.destroy()})),i.open({where:this.$node,how:{autoclose:!0,at:"center bottom",my:"center top"}}),$(window).one("scroll",(function(){i.close()}))}Jane.c("Написание письма","Шапка письма",'Клик в "СМС"')}}},"compose-field-phone-error-mixin")},1308:function(e,t){ns.View.define("compose-field-to-notice-replyall",{events:{"click@show .js-reply-all-link":"onReplyAllLinkClick"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onReplyAllLinkClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=this.getModel("compose-message");o.changeRecipientsToOpposite(),t.set(".isReplyAllNoticeVisible",!1),t.set(".isCcVisible",Boolean(o.get(".cc")),{force:t.isCcVisible()}),t.set(".isBccVisible",Boolean(o.get(".bcc")),{force:t.isBccVisible()})}}})},1309:function(e,t){!(function(){ns.View.define("compose-field-to-notice-nda",{yateModule:"compose2"})})()},1310:function(e,t){!(function(){ns.View.define("compose-field-cc-notice-nda",{yateModule:"compose2"})})()},1311:function(e,t){!(function(){ns.View.define("compose-field-bcc-notice-nda",{yateModule:"compose2"})})()},1312:function(e,t){!(function(){ns.View.define("compose-field-phone-notice-help",{yateModule:"compose2"})})()},1313:function(e,t){ns.View.edefine("compose-recipients",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_getFieldItems:function(e){var t=this.getModel("compose-message").get("."+e);return t?Jane.FormValidation.splitContacts(t):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},1314:function(e,t){!(function(){ns.View.define("compose-field-error-mixin",{yateModule:"compose2",methods:{FIELD_NAME:null,getErrorMessage:function(){return this.getModel("compose-message").getFieldError(this.FIELD_NAME)}}})})()},1315:function(e,t){!(function(){ns.View.define("compose-field-to-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"to"}},"compose-field-error-mixin")})()},1316:function(e,t){!(function(){ns.View.define("compose-field-phone-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"phone"}},"compose-field-error-mixin")})()},1317:function(e,t){!(function(){ns.View.define("compose-field-cc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"cc"}},"compose-field-error-mixin")})()},1318:function(e,t){!(function(){ns.View.define("compose-field-bcc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"bcc"}},"compose-field-error-mixin")})()},1319:function(e,t){ns.View.define("compose-field-att_ids-error",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"att_ids"}},"compose-field-error-mixin")},1320:function(e,t){ns.View.define("compose-field-to-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.to":"composeUpdate","ns-model-changed.isReplyAllNoticeVisible":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onFieldChanged","ns-model-changed.errors.to":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("to")&&t.isNdaNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-to"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.to","")}}})},1321:function(e,t){!(function(){ns.View.define("compose-field-cc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.cc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.cc":"onFieldChanged","ns-model-changed.errors.cc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"cc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("cc")&&t.isNdaNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-cc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.cc","")}}})})()},1322:function(e,t){!(function(){ns.View.define("compose-field-bcc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.bcc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.bcc":"onFieldChanged","ns-model-changed.errors.bcc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"bcc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("bcc")&&t.isNdaNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-bcc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.bcc","")}}})})()},1323:function(e,t){ns.View.define("compose-field-phone-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.phone":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.phone":"onFieldChanged","ns-model-changed.errors.phone":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"phone"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("phone")?o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})):t.isFieldVisible("phone")&&t.isFieldEnabled("phone")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"help"},this.params)).setData({type:"help"})),"layout-compose-field-notices-phone"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.phone","")}}})},1324:function(e,t){ns.View.define("compose-field-att_ids-notices-wrapper",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.att_ids":"onFieldChanged","ns-model-changed.errors.att_ids":"onErrorChanged"},"compose-field-notices":!1,"compose-state":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"att_ids"})},ctor:function(){this._autoHide=!1,this.autoHideDebounce=_.debounce(this.autoHide.bind(this),5e3)},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-field-notices");return t.clear(),!this._autoHide&&e.getFieldError("att_ids")&&t.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),"layout-compose-field-notices-att_ids"},onShow:function(){this.getModel("compose-field-notices").models.length&&this.autoHideDebounce()},onHide:function(){this.autoHideDebounce.cancel()},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.att_ids","")},onErrorChanged:function(){this._autoHide=!1,this.composeUpdate()},autoHide:function(){this._autoHide=!0,this.getModel("compose-field-notices").clear(),this.composeUpdate()}}})},1325:function(e,t){ns.View.define("compose-fields-wrapper",{models:{"compose-state":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.showFieldPlaceholder":"composeUpdate","ns-model-changed.verboseFieldPlaceholder":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state");return e.toShowForm()&&e.get(".showFieldPlaceholder")?"layout-compose-fields-placeholder":"layout-compose-fields"}}})},1326:function(e,t,o){"use strict";function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}Object.defineProperty(t,"__esModule",{value:!0});var s=o(544);!(function(){var e={show:Daria.hasExperiment("77088")};ns.View.define("compose-popular-contacts",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","ns-view-init":"onInit","click .js-contact":"onContactClick","click .js-close":"onCloseClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},models:{"index-data":"keepValid","compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onRecipientFieldChanged","ns-model-changed.cc":"onRecipientFieldChanged","ns-model-changed.bcc":"onRecipientFieldChanged"},"compose-popular-contacts":!1},params:function(e){return _.extend({},ns.View.info("compose2").params(e),{count:10})},ctor:function(){this.onMouseEnter=this.onHover.bind(this,!0),this.onMouseLeave=this.onHover.bind(this,!1),this._$closeButton=null},yateModule:"compose2",methods:{onHtmlInit:function(){this._$closeButton=this.$node.find(".js-close")},onHtmlDestroy:function(){this._$closeButton=null},onInit:function(){if(e.show){if(ns.Model.get("settings").getSetting("popular-contacts_s"))return void(e.show=!1);this.on("ns-view-show",this.showPromo.bind(this)),this.on("ns-view-hide",this.hidePromo.bind(this))}},onContactClick:function(e){var t=$(e.currentTarget),o=["email","name"],n=_.zipObject(o,_.map(o,(function(e){return t.data(e)})));this.log({email:n.email,position:t.data("position")});var s=_.clone(this.getModel("compose-popular-contacts").getContact(n)),i=this.getModel("index-data").get(".email");s.email===i&&s.name===i18n("%Compose_Send_it_to_me")&&delete s.name,this.getModel("compose-message").appendContact("to",s),this.updateContacts()},onCloseClick:function(){var e=ns.Model.get("settings"),t=e.getSign(e.POPULAR_CONTACTS_SETTING_NAME);if(void 0===e.getSetting(e.POPULAR_CONTACTS_SETTING_NAME)){var o={};o[e.POPULAR_CONTACTS_SETTING_NAME]=t,e.setSettings(o)}e.setSettingOff(e.POPULAR_CONTACTS_SETTING_NAME),this.getModel("compose-state").trigger("ns-model:contacts:redraw"),Jane.c("Написание письма","Шапка письма",'Клик в крестик "Скрыть favorites"')},onHover:function(e){this._$closeButton.toggleClass("is-hidden",!e)},onRecipientFieldChanged:function(){this.updateContacts(),this.composeUpdate()},updateContacts:function(){var e=this.getModel("compose-message").getAllRecepients();this.getModel("compose-popular-contacts").actualizeUsedContacts(e)},log:function(e){var t=e.email,o=e.position,n={project:"search_mail",action:"suggest-compose",product:s.b,uid:Daria.uid,filed:"to",suggest_used:"yes",suggest_show:"yes",pos:o,count:Math.min(this.getModel("compose-popular-contacts").getUnusedContacts().length,6),search_text:encodeURIComponent(t)};1===o&&this.getModel("index-data").get(".email")===t?(n.self="yes",Jane.c("Написание письма","Шапка письма",'Клик в саджест контакта "себе"')):Jane.c("Написание письма","Шапка письма","Клик в саджест другого контакта"),Daria.searchClickCounter(_.pairs(n).map((function(e){return e.join("=")})))},showPromo:function(){var t=e;if(t.show){var o=this.$node.find(".js-contact").get(0);if(!o)return void(t.show=!1);t.setAnchor||Object.assign(t,Daria.React.promoPopularContacts.create((function(){ns.Model.get("settings").setSettings(n({},"popular-contacts_s",Date.now())),t.show=!1}))),t.timer&&(clearTimeout(t.timer),t.timer=null),t.setAnchor(o)}},hidePromo:function(){var t=e;t.timer||(t.timer=setTimeout((function(){return t.close()}),150))}}})})()},1327:function(e,t){!(function(){ns.View.define("compose-popular-contacts-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model:contacts:redraw":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=ns.Model.get("settings");return e.getSign(e.POPULAR_CONTACTS_SETTING_NAME)?"layout-compose-popular-contacts":"layout-compose-popular-contacts-empty"}}})})()},1328:function(e,t){!(function(){ns.View.define("compose-popup-button",{yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposePopupButton",onHtmlInit:function(){this.initNbs()},onHtmlDestroy:function(){this.destroyNbs()},initNbs:function(){this.nbs={},this.nanoislands&&(_.each(this.nanoislands.blocks,(function(e,t){this.nbs[t]=nb.$block(e,this.$node)}),this),this._nbsInited=!0,this.bindNbs())},destroyNbs:function(){this.unbindNbs(),this._nbsInited=!1,nb.destroy(this.node)},bindNbs:function(){this.handleBinding("on")},unbindNbs:function(){this.handleBinding("off")},handleBinding:function(e){this._nbsInited&&this.nanoislands&&_.each(this.nanoislands.events,(function(t,o){var n;o=o.split(" ");var s=o[0],i=o[1],a=o[2];if(!this.nbs[i])return void ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist nanoblock with name of "+i);switch(n=3===o.length?this.nbs[i].$node.find(a):this.nbs[i],e){case"on":n.on(s,this[t].bind(this));break;default:n.off(s)}}),this)},showBubble:function(){this.containerSelector||ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist selector of container for popup");var e=this.nbs.popup;return e.isOpen()?vow.reject():(e.open({where:this.$node.find(this.containerSelector),how:{at:"top",my:"bottom"}}),vow.resolve(e))},setCheckboxState:function(e,t){var o=this.nbs[e];if(!o)return void ns.assert(!1,this.ASSERT_CLASS_NAME,"Can't find nbCheckbox with name of "+e);o.isChecked()!==t&&(t?o.check():o.uncheck())}}})})()},1329:function(e,t){ns.View.define("compose-action-buttons",{models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e,t,o=this.getModel("compose-message"),n=this.getModel("compose-state");return o.isTemplate()?o.isNewTemplate()?(e="compose-save-link",t="layout-compose-action-buttons-new-template"):(e="compose-send-link",t="layout-compose-action-buttons-template"):(e="compose-send-link",t="layout-compose-action-buttons"),n.set(".activeActionButtonView",e),t}}})},1330:function(e,t){!(function(){ns.View.define("compose-save-link",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-save-button":"onSave"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSave:function(){this.getModel("compose-state").set(".saveTemplateAndLeave",!0),this.getModel("compose-message").once("ns-model:draft-saved",(function(){var e=ns.Model.get("folders").getFidBySymbol("template"),t=ns.router.generateUrl("messages",{current_folder:e});ns.page.go(t)})),this.setState("save")}}},"compose-disable-on-sending-mixin")})()},1331:function(e,t){!(function(){var e={size:"m",text:i18n("%Отправить"),highlight:!0,class:["js-send-button"],type:"submit",attrs:{tabindex:"10",title:i18n("%Compose_send_letter")+Daria.Shortcuts.getShortcutLabelFor("Send","compose2",!0)}};ns.View.define("compose-send-link",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroy":"onHtmlDestroy","click .js-send-button":"onSendingToSent"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText","ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1,"quick-reply-state":!1},ctor:function(){this._nbButton=null},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onHtmlInit:function(){nb.init(this.node),this._nbButton=nb.$block(".js-send-button",this.node)},onHtmlDestroy:function(){nb.destroy(this.node),this._nbButton=null},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSendingToSent:function(){this.onSendingToSentWithMetricSource()},onSendingToSentWithMetricSource:function(e){this.composeMetrics(e),this.setState("sending")},getButtonSpec:function(){var t=this.getModel("compose-state"),o=t.get(".submitButtonText"),n=t.get(".activeActionButtonView");return e.highlight="compose-send-link"===n,o&&(e.text=o),e},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this._nbButton.setContent(e)},composeMetrics:function(e){var t="";this.getModel("quick-reply-state").toShowForm()?t="QR":(t="compose",Jane.c("Написание письма",e||"Шапка письма",'Клик в "Отправить"')),Jane.c("Отправка письма",t)}}},"compose-disable-on-sending-mixin")})()},1332:function(e,t){!(function(){ns.View.define("compose-cancel-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick"},models:{"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},onClick:function(){this.getModel("compose-fsm").setState("cancel"),Jane.c("Написание письма","Шапка письма","Клик в крестик")}}},"compose-disable-on-sending-mixin")})()},1333:function(e,t){ns.View.define("compose-delete-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide",click:"onClick"},models:{"compose-message":!1,"compose-fsm":{"ns-model-changed":!1,"# save":"onSaving","# edit":"onSaveComplete"}},params:ns.View.info("compose2").params,ctor:function(){this._isSaving=!1,this._isRemovePending=!1},yateModule:"compose2",methods:{_getMessage:function(e){return ns.Model.get("message",{ids:e})},onInit:function(){this.disableOnSendingInit()},onShow:function(){if(this.disableOnSendingStart(),this.params.ids){this._getMessage(this.params.ids).isDraftLike()||this.$node.addClass("is-hidden")}},onHide:function(){this.disableOnSendingStop()},_closeCompose:function(){this.getModel("compose-fsm").setState("cancel")},_removeDraft:function(){var e=this.getModel("compose-message").getDraftMid(),t=Boolean(this.params.ids);if(!e)return void this._closeCompose();Daria.MOPS["remove.draft"](this._getMessage(e).getMessagesCheckedModel()),t||this._closeCompose()},onClick:function(){return this._isSaving?void(this._isRemovePending=!0):this.getModel("compose-message").isDirty()?(this._isRemovePending=!0,void this.getModel("compose-fsm").setState("save")):void this._removeDraft()},onSaveComplete:function(){this._isSaving=!1,this._isRemovePending&&(this._isRemovePending=!1,this._removeDraft())},onSaving:function(){this._isSaving=!0}}},"compose-disable-on-sending-mixin")},1334:function(e,t){ns.View.define("compose-label-button",{events:{click:"onClick"},yateModule:"compose2",methods:{onClick:function(e,t){t=t||ns.action.getParams(e.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(e,t,"label",this.getCurrentMessageIfSingle()),this.vLabelsActions&&this.vLabelsActions._isOpen||(this.vLabelsActions=ns.View.create.apply(null,["labels-actions-compose",ns.page.current.params]),this.vLabelsActions.open(e.currentTarget,ns.Model.get("messages-checked"),t))},getCurrentMessageIfSingle:function(){var e=ns.Model.get("messages-checked");if(!e)return null;var t=e.getIds();if(t&&0===t.tids.length&&1===t.ids.length){return ns.Model.get("messages",ns.page.current.params).getMessageByMid(t.ids[0])}return null}}})},1335:function(e,t){!(function(){var e=ns.View.infoLite("compose-send-link");ns.View.edefine("compose-send-button-complex",{models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.send_time":"onChangedSendTime"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendingMessage"},"quick-reply-state":!1},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-send":"onSendingToSentWithMetricSource"},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.onSendingToSentWithMetricSource=this.onSendingToSentWithMetricSource.bind(this,"Подвал письма"),_.bindAll(this,["onClickSendtime","onClosedSendtimePopup"])},methods:{onShow:function(){e.methods.onShow.apply(this,arguments),this.nbSendtime=nb.$block(".js-sendtime",this.node),this.nbSendtime.on("click",this.onClickSendtime),this.nbSend=nb.$block(".js-send",this.node)},onHide:function(){e.methods.onHide.apply(this,arguments),nb.destroy(this.node)},onClickSendtime:function(e){e.preventDefault(),this._sendtimePopup?this._sendtimePopup.close():(this._sendtimePopup=ns.View.create("compose-send-button-complex-popup",_.clone(this.params)),this._sendtimePopup.on("closed",this.onClosedSendtimePopup),this._sendtimePopup.open({where:e.currentTarget})),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."')},onClosedSendtimePopup:function(){delete this._sendtimePopup},onChangedSendTime:function(){this.getModel("compose-message").get(".send_time")?this.nbSendtime.check():this.nbSendtime.uncheck()},onSendingMessage:function(){this.getModel("compose-message").get(".send_time")&&Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Отправка письма с настройкой")},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this.nbSend.setContent(e)}}},"compose-send-link")})()},1336:function(e,t){ns.View.define("compose-send-button-complex-popup",{events:{"ns-view-show":"_onShow","click@show .send_time-date":"_onClickSendDateTime","click@show .js-help":"_onClickShowHelp","click@show .js-close":"_onClickClose","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll","daria:layout-changed@show":"_onScroll"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!0,autoclose:!0,how:{my:"center bottom",at:"center top"}},this._options={},this._popup=null,this._date=null},yateModule:"compose2",methods:{open:function(e){return this._date=this.getModel("compose-message").getPassportSendDate(),this._options=_.extend({},this._defaultOptions,e),this._dateValidation(),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},close:function(){_.method("close")(this._popup)},_onClickClose:function(){this.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Клик в крестик")},_onScroll:function(){var e=_.get(this._popup,"node.widget");_.method("_position")(e)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-send-button-complex-popup","compose2"));var e=this,t=this._popup._move;this._popup._move=function(){var o=Array.prototype.slice.call(arguments);t.apply(this,o),e._popupMove()},this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_popupMove:function(){var e=this,t=this._popup.$node.data("nbContextDialog").close;this._popup.$node.data("nbContextDialog").close=function(o){e._nbContextDialogClose.call(this,e,t,o)}},_nbContextDialogClose:function(e,t,o){var n=e._nbTime&&e._nbTime.$dropdown&&e._nbTime.$dropdown[0],s=o&&o.target;if(s&&n&&n.contains(s))return void(this.options.closedByOuterClick=!1);t.call(this,o)},_onOpened:function(){this.trigger("opened")},_onClosed:function(e,t){t.destroy(),this.trigger("closed")},_onDestroyed:function(){delete this._popup,this._options={},this.destroy()},_onShow:function(){this._nbTime=nb.$block(".js-time",this.node),this._nbTime.on("nb-changed",this._onChangedTime.bind(this)),this._nbActivate=nb.$block(".js-activate",this.node),this._nbActivate.on("nb-checked",this._onCheckedActivate.bind(this)),this._nbActivate.on("nb-unchecked",this._onUncheckedActivate.bind(this));var e=Daria.passportNow(),t=new Date(e),o=new Date(e);o.setFullYear(o.getFullYear()+1),this.$node.find(".send_time-date").date_input({action:"click",zIndex:105,container:this.$node,usePosition:!0,autoOrientation:!0,minDate:t,maxDate:o,dateToString:this._dateToString,stringToDate:this._stringToDate,keydownHandler:!1,setInputVal:this._onSetInputVal.bind(this),getInputVal:this._onGetInputVal.bind(this)}),this._updateDisplay()},_onGetInputVal:function(){return this._dateToString(this._date)},_onSetInputVal:function(e){var t=this._stringToDate(e);if(t){var o=t.getFullYear(),n=t.getMonth(),s=t.getDate();this._date.getFullYear()===o&&this._date.getMonth()===n&&this._date.getDate()===s||(this._date.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),this._updateDisplay())}},_onClickSendDateTime:function(e){e.stopPropagation(),e.preventDefault(),this._nbActivate.isChecked()||this._nbActivate.check()},_onCheckedActivate:function(){Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Простановка чекбокса"),this._nbTime.enable(),this._updateData()},_onUncheckedActivate:function(){this._nbTime.disable(),this._updateData()},_onChangedTime:function(){var e=this._nbTime.getState(),t=e.value&&e.value.match(/^(\d{2}):(\d{2})$/);if(t){var o=parseInt(t[1],10);o!==this._date.getHours()&&(this._date.setHours(o,0,0,0),this._updateDisplay()),this.close()}},_updateDisplay:function(){if(this._dateValidation())this._updateDisplay();else{this.$node.find(".send_time-date").text(Jane.Date.toHumanFormat(this._date));var e=new Date(Daria.passportNow());e.setHours(e.getHours(),0,0,0);var t=new Date(this._date),o=_.times(24).filter((function(o){return t.setHours(o,0,0,0),t>e})).map(this._dateItemGenerate);this._nbTime.setSource(o),this._nbTime.setState(this._dateItemGenerate(this._date.getHours())),this._updateData()}},_dateItemGenerate:function(e){var t=Jane.Common.n(e)+":00";return{text:t,value:t}},_dateToString:function(e){return Jane.Date.format("%F",e)},_stringToDate:function(e){var t=String(e||"").match(/^(\d{2,4})\-(\d{2})\-(\d{2})$/);return t?new Date(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)):null},_dateValidation:function(){var e=new Date(Daria.passportNow());return e.setHours(e.getHours()+1,0,0,0),(!this._date||this._date<e)&&(this._date=e,!0)},_onClickShowHelp:function(){this.$node.find(".js-compose-sendtime-help-text").toggleClass("is-hidden")},_updateData:function(){var e=this.getModel("compose-message"),t=null;this._nbActivate.isChecked()&&this._date&&(t=Daria.convertPassportDateToTimestamp(this._date)),e.setIfChanged(".send_time",t)}}})},1337:function(e,t){ns.View.edefine("compose-button-translate-apply",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1,"quick-reply-state":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-edit"),Jane.c("Написание письма","Подвал письма","Переводчик","Редактировать")}}},"compose-send-link")},1338:function(e,t){ns.View.edefine("compose-button-translate-close",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1,"quick-reply-state":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-cancel"),Jane.c("Написание письма","Подвал письма","Переводчик","Отмена")}}},"compose-send-link")},1339:function(e,t){ns.View.define("compose-message-toolbar-button-common",{events:{"ns-view-show":"_onNsViewShow"},yateModule:"compose2",methods:{_onNsViewShow:function(){this.rect=this.node.getBoundingClientRect()},checkShortlink:function(){return this.$node.hasClass("is-shortlink")},isShortlink:function(){return this._isShortlink},setShortlink:function(){this._isShortlink=!0,this.$node.addClass("is-shortlink")},removeShortlink:function(){this._isShortlink=!1,this.$node.removeClass("is-shortlink")}}})},1340:function(e,t){ns.View.edefine("compose-message-toolbar-spellcheck",{models:{"compose-state":!1},yateModule:"compose2"},"compose-message-toolbar-button-common")},1341:function(e,t){!(function(){ns.View.defineNg("compose-attach-area",{events:{"ns-view-show":"onShow","click@show .js-eml-preview":"previewEml","daria:vComposeAttachArea:retryAttach@show":"onRetryAttach"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){var e=this.getModel("compose-attachments"),t=this.getModel("compose-message"),o=this.getModel("compose-state");e.init({node:this.node,ids:this.params.ids,operation:this.params.oper,mComposeMessage:t,mComposeState:o}),(this.params.ids||e.hasFiles())&&(e.drawAttaches(),t.markSaved())},onDraftSaved:function(e,t){if(!this.isVisible())return void this.invalidate();this.getModel("compose-attachments").updateAfterSave(t.attachments,t.mid),this.getModel("compose-message").markSaved()},onRetryAttach:function(e,t){this.getModel("compose-attachments").retryAttach(t.id)}}},"count-attachments-ops-mixin","preview-eml-mixin")})()},1342:function(e,t){!(function(){ns.View.define("compose-footer",{models:{"compose-message":!1,"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.appended":"onAttachmentsAppended"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onAttachmentsAppended:function(){this.isVisible()&&Jane.DOM.placeInViewport(this.node)}}})})()},1343:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.edefine("compose-from",{events:{"ns-view-htmlinit":"onHtmlInit","keydown@show .js-compose-field":"onInputKeydown"},models:{"account-information":!1,"index-data":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"forceUpdate"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"from_name",onHtmlInit:function(){this._nbEmailSelect=nb.$block(".js-compose-changemail",this.$node),this._nbEmailSelect.on("nb-changed",this.onEmailChange.bind(this)),this._$input=this.$node.find(".js-compose-field"),this.shouldResizeByFakeField()&&(this.resizeField=this.resizeFieldIE,this._$inputFakeDiv=this.$node.find(".js-compose-field-fake")),this.resizeField()},resizeField:function(){this.isVisible()&&(this._$input.width(0),this._$input.width(this._$input[0].scrollWidth))},setValueToFakeDivInput:function(){this._$inputFakeDiv.text(this._$input.val())},resizeFieldIE:function(){this.isVisible()&&(this._$input.width(0),this.setValueToFakeDivInput(),this._$input.width(this._$inputFakeDiv.width()+2))},onInputKeydown:function(e){e.keyCode!==Jane.Common.keyCode.ENTER&&e.keyCode!==Jane.Common.keyCode.ESC||(e.preventDefault(),this._$input.blur())},onInput:function(){this.resizeField(),e.methods.onInput.apply(this,arguments)},onEmailChange:function(e,t){this.getModel("compose-message").set(".from_mailbox",t.value)},shouldResizeByFakeField:function(){return Boolean(Modernizr.ie11||Modernizr.edge)}}},"compose-field-base")})()},1344:function(e,t){!(function(){ns.View.define("compose-signature-list-popup",{events:{"click@show .js-signature-add-button":"_onClickAddSignature","click@show .js-signature-list-item":"_onClickSelectFromList"},models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0,how:{at:"center+60px bottom"}},this._options={},this._popup=null},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-list-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Показ")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._signatureIsSelected||Jane.c("Подписи","Окно выбора","Закрыто без выбора")},_getSignatureList:function(){return this.getModel("compose-signature").getSignatureList()},_onClickSelectFromList:function(e){this._signatureIsSelected=!0;var t=$(e.currentTarget),o=parseInt(t.attr("data-signature-index"),10);0===o&&Jane.c("Подписи","Окно выбора","Выбор первой"),Jane.c("Подписи","Окно выбора","Выбор подписи");var n=this.getModel("compose-signature"),s=n.getSignatureList(),i=s.signs[o].convert;this.trigger("select",i),this._popup.close()},_onClickAddSignature:function(){this._signatureIsSelected=!0,ns.View.create("compose-signature-add-popup",this.params).open(),this._popup.close()}}})})()},1345:function(e,t){!(function(){ns.View.define("compose-signature-add-popup",{models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-add-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Окно добавления","Показ"),this._popup.$node.on("click",".js-save",this._onSave.bind(this)),this._popup.$node.on("click",".js-cancel",this._onClosed.bind(this))},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._clickSave||Jane.c("Подписи","Окно выбора","Окно добавления","Закрыть без добавления")},_onSave:function(){this._clickSave=!0,Jane.c("Подписи","Окно выбора","Окно добавления","Добавление");var e=$.trim(this._popup.$node.find(".js-signature-new").val());if(e){var t=Daria.signs.getHtml();if(_.any(t,(function(t){return Daria.signs.compare(t.convert,e)})))return void this._popup.close();Daria.signs.addSignature({text:_.escape(e)},this._onSaveSuccess.bind(this))}},_onSaveSuccess:function(e,t){this._popup.close(),e?Daria.Statusline.show({name:"signature_appended",text:i18n("%Signature_append_success")}):_.contains(t,"signs.maxcount")?Daria.Statusline.show({name:"max_signature_count_limit_exceeded"}):_.contains(t,"signs.maxlen")?Daria.Statusline.show({name:"max_signature_length_limit_exceeded"}):Daria.Statusline.show({name:"signature_appending_failed",text:i18n("%Signature_append_error")})}}})})()},1346:function(e,t){ns.View.define("compose-message-editor-bottom-buttons",{params:ns.View.info("compose2").params,yateModule:"compose2"})},1347:function(e,t){ns.View.define("compose-message-editor-top",{params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-message-editor-top"}}})},1348:function(e,t){ns.View.define("compose-message-editor-bottom",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.editorMaximize":"editorViewUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".editorMaximize")===CKEDITOR.TRISTATE_ON?"layout-compose-message-editor-bottom":"layout-compose-message-editor-bottom-buttons-empty"},editorViewUpdate:function(){this.getEditor().execCommand("viewUpdate")}}})},1349:function(e,t){!(function(){var e={attachmentcomputer:'Клик на "Прикрепить файл с компьютера"',attachmentdisk:'Клик на "Прикрепить файл из Диска"',attachmentmail:'Клик на "Прикрепить файлы из Почты"',undo:'Клик на "Отменить"',redo:'Клик на "Повторить"',bold:'Клик на "Полужирный"',italic:'Клик на "Курсив"',underline:'Клик на "Подчёркнутый"',strike:'Клик на "Перечёркнутый"',link:'Клик на "Вставить/изменить ссылку"',unlink:'Клик на "Удалить ссылку"',addimage:'Клик на "Добавить изображение"',blockquote:'Клик на "Цитата"',mailtextcolor:'Клик на "Цвет текста"',mailbgcolor:'Клик на "Цвет фона"',mailfont:'Клик на "Шрифт"',mailfontsize:'Клик на "Размер шрифта"',emoticons:'Клик на "Смайлик"',numberedlist:'Клик на "Нумерованный список"',bulletedlist:'Клик на "Маркированный список"',justifyleft:'Клик на "Выравнивание по левому краю"',justifycenter:'Клик на "Выравнивание по центру"',justifyright:'Клик на "Выравнивание по правому краю"',maximize:'Клик на "Развернуть на весь экран"',removeformat:'Клик на "Убрать форматирование"',translate:'Клик на "Переводчик"',switchmode:'Клик на "Без оформления"'};ns.View.define("compose-metrics-mixin",{methods:{saveMetricOfTheToolbarButtonKeypress:function(t){var o=t.currentTarget.className.split(/\s+/),n=_.find(o,(function(e){return 0===e.indexOf("cke_button__")}));if(n){var s=n.slice("cke_button__".length),i=e[s];i&&Jane.c("Написание письма","Визивиг в композе",i)}}}})})()},1350:function(e,t,o){"use strict";function n(e){return a(e)||i(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function a(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}Object.defineProperty(t,"__esModule",{value:!0});var c=o(1351),l=o(883),u=o(83),d=o.n(u),h="blockquote";!(function(){var e,t=ns.View.infoLite("compose-field-base"),o=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onChangeHeight","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorPastefile","onEditorSwitchedMode","onEditorMaximize","_applyTmpContent"];ns.View.edefine("compose-message-editor",{models:{"module-editor":!1,"quick-reply-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"onFromMailboxChanged"},"compose-attachments":!1,"compose-signature":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged","daria:mComposeState:translate-edit":"onTranslateEdit","daria:mComposeState:translate-cancel":"onTranslateCancel"}},events:(e={"click@show .cke_button__translate":"onClickShowTranslator","click@show .cke_toolbox .cke_button":"saveMetricOfTheToolbarButtonKeypress","mouseup@show .cke_button__attachmentcomputer":"saveMetricOfTheToolbarButtonKeypress"},r(e,"click@show .".concat("js-compose-Quote-Toggler"),"showQuote"),r(e,"click@show .".concat("js-compose-All-Quotes-Toggler"),"showAllQuotes"),e),params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments),_.bindAll(this,o),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,l.a.DEBOUNCES.EDITOR_CHANGE),this.onChangeHeightDebounce=_.debounce(this.onChangeHeight,l.a.DEBOUNCES.HEIGHT_CHANGE)},yateModule:"compose2",methods:{TOOLBAR_HEIGHT:47,FIELD_NAME:"send",getConfig:function(){var e,t,o=this,n={},s=/^([a-z]{2,3})\-([a-z]{2,3})$/,i=_.get(ns.page.current,"params.translate","").match(s);return i?(e=i[1],t=i[2]):this.params.ids&&(e=this.getModel("compose-message").getLanguage(),t=Daria.Translate.getDefaultLangTo(e)),CKEDITOR.editorConfig(n),_.extend(n,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,maximize:this.onEditorMaximize,"pastefile:dropfile":this.onEditorPastefile,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark,"translate:enabled":function(){o.onChangeHeight(),o.$node.addClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!0)},"translate:disabled":function(){o.onChangeHeight(),o.$node.removeClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!1)}},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),translateInfo:Daria.Config["help-url"]+"/web/letter/translation.html#translation-outgoing",translateAutoEnable:i,translateFrom:e,translateTo:t,pastefileGetPlaceholderContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document.body),new CKEDITOR.dom.element(e)},pastefileGetDropContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document),e},translate:function(e,t,n,s){s||(s=Daria.Translate.getDefaultLangTo(o.getModel("compose-message").getLanguage()));var i="wysiwyg"===e.mode?"html":"plain",a={text:t,format:i,lang:s};return n&&s&&(a.lang=n+"-"+s),new vow.Promise(function(e,t){ns.request("do-translate",a).then((function(t){var o=_.find(t,"id","do-translate"),i=(o.get(".text")||[]).join(""),a=o.get(".detected.lang");e({data:i,langFrom:n||a,langTo:s})}),t)})},translateLangSelect:function(e,t,n,s){return new vow.Promise(function(e,i){var a="_popupTranslateSelectLang_"+s,r=o[a];if(r)return r.close(),void i();var c=_.assign({},o.params,{currentLang:t});r=ns.View.create("translate-select-lang",c),r.on("selected",(function(t,o){e({lang:o,direction:s}),this.close()})),r.on("closed",(function(){delete o[a],i()})),r.open({where:n.$}),o[a]=r})}},this)),n},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onInit:function(){this.messageResizeInit(),t.methods.onInit.apply(this,arguments),this.fpsCounter=new c.a("compose",c.a.defaultConfig),Daria.hasFeature("web-compose-collapse-quotes")&&(this.togglerReplacer=document.createElement("div"),this.togglerPlaceholder=document.createElement("div"),this.togglerPlaceholder.setAttribute("data-cke-role","placeholder"),this.togglerPlaceholder.innerHTML="&nbsp;<br>&nbsp;",this.onBeforeModeChange=this.onBeforeModeChange.bind(this))},onShow:function(e,t,o){this._timings=o,this._timings.showEditor=Date.now(),this._timings.versionEditor=CKEDITOR.version,this.messageResizeStart();var n=this.getModel("compose-message"),s=this.getConfig();s.height=this.getHeight()-this.TOOLBAR_HEIGHT,s.startupMode=n.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),s.firstSignature=ns.Model.get("settings").isSet("signature_top"),s.firstSignatureMatch=Daria.signs.getSignatureMatch(),s.hasSignature=this.getModel("compose-signature").hasSignatureControl(),s.fileInputMultiple=Daria.Config["input-multiple"],s.canShowDisk=this.getModel("compose-state").hasDisk()&&!Daria.Config["is-corp"],this._timeoutEditorCreate=setTimeout(function(){this.getControllerNode().width()<795&&(s.toolbar="Min"),CKEDITOR.replace(this.getEditorId(),s)}.bind(this),0),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),n.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode),this.fpsCounter.start()},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.onChangeHeightDebounce.cancel(),this.messageResizeStop(),this.destroyEditor(),this.fpsCounter.finish()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark();var e=this.getModel("quick-reply-state").getTmpContentAndRemove();e&&(this._timeoutApplyTmpContent=_.defer(this._applyTmpContent,e))},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&(e.removeListener("beforeSetMode",this.onBeforeModeChange),e.destroy(!0))},onChangeHeight:function(){var e=this.getHeight();this.getControllerNode().height(e).css("min-height",e);var t=this.getEditor();t&&t.resize("100%",e)},_applyTranslate:function(){var e=this.getEditor();e._.translateData=this._insertQuoteBackIntoMessage(e._.translateData),e.execCommand("translate_apply")},syncViewToData:function(e){if(this.isVisible()){var t=this.getEditor();if(t&&("edit > sending"===e&&this.getModel("compose-state").get(".translationEnabled")&&(this._applyTranslate(),Jane.c("Написание письма","Подвал письма","Переводчик","Ответить с переводом")),t.checkDirty())){var o=t.getData();void 0!==o&&(o=this._insertQuoteBackIntoMessage(o),this.setFieldData(o),t.resetDirty())}}},onBeforeModeChange:function(e){"source"===e.data&&this.showAllQuotes()},showAllQuotes:function(){var e=this._getQuoteContainer();this._insertQuote(e,-1)},showQuote:function(){var e=this._getQuoteContainer();if(e){var t=Number(e.getAttribute("data-level"));this._insertQuote(e,t)}},_detachNode:function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},_getQuoteContainer:function(){var e=this.getEditor();if(!e||!this.quoteNode)return null;var t=e.container.$.getElementsByClassName("js-compose-Quote-Container");return t.length?t[0]:null},_insertQuote:function(e,t){if(e){var o=this.getEditor();"MSIE"===Daria.UA.BrowserName&&o.focusManager.blur(!0);var n=this._prepareQuoteNode(e,t),s=n.node,i=n.toggler,a=this._processQuoteNode(s,i);this._insertQuoteIntoSnapshots(a),o.fire("lockSnapshot"),this._replaceNode(e,a),o.fire("change"),o.fire("unlockSnapshot")}},_insertQuoteIntoSnapshots:function(e){var t=this,o=this.getEditor();o.undoManager&&o.undoManager.snapshots.forEach((function(o){t.togglerReplacer.innerHTML=o.contents;var n=t.togglerReplacer.getElementsByClassName("js-compose-Quote-Container");if(n.length){var s=n[0];t._replaceNode(s,e),o.contents=t.togglerReplacer.innerHTML,t._detachNode(e),t.togglerReplacer.innerHTML="",o.bookmarks=[]}}))},_prepareQuoteNode:function(e,t){var o,n=t<0,s=this.quoteNode;if(n)this.quoteNode=null;else{var i=Number(e.getAttribute("data-levels-count"))||this._calcQuoteLevelsCount(s);o=this._generateQuoteTogglerNode({totalCount:i-1,level:t+1});var a=this._extractQuotes(s,this.togglerPlaceholder);this.quoteNode=a}return{node:s,toggler:o}},_processQuoteNode:function(e,t){var o=this.getEditor();this.togglerReplacer.appendChild(e);var n=o.dataProcessor.toHtml(this.togglerReplacer.innerHTML);this._detachNode(e),this.togglerReplacer.innerHTML=n;var s=this.togglerReplacer.children[0];return this._detachNode(s),this.togglerReplacer.innerHTML="",t&&this._replaceQuotePlaceholder(s,t),s},_calcQuoteLevelsCount:function(e){if(!e)return 0;var t=Array.prototype.slice.call(e.getElementsByTagName(h)),o=t.map((function(e){return e.parentNode})),s=n(new Set(o)).length;return e.tagName.toLowerCase()===h.toLowerCase()?s+1:s},_extractQuotes:function(e,t){var o=Array.prototype.slice.call(e.getElementsByTagName(h)).filter((function(t){var o=$(t.parentNode).closest(h);return 0===o.length||o[0]===e})),n=null;return o.length&&(n=o[o.length-1],this._replaceNode(n,t)),n},_generateQuoteTogglerNode:function(e){var t=e.totalCount,o=e.level,n=void 0===o?0:o;return t>0?Jane.tt("compose2:quote-toggler",{containerClass:"js-compose-Quote-Container",togglerClass:"js-compose-Quote-Toggler",allTogglerClass:"js-compose-All-Quotes-Toggler",level:n,totalCount:t}):null},_insertQuoteBackIntoMessage:function(e){if(!this.quoteNode)return e;this.togglerReplacer.innerHTML=e,this._replaceNode(this.togglerReplacer.querySelector(".".concat("js-compose-Quote-Container")),this.quoteNode);var t=this.togglerReplacer.innerHTML;return this._detachNode(this.quoteNode),this.togglerReplacer.innerHTML="",t},_replaceQuotePlaceholder:function(e,t){this._replaceNode(e.querySelector("[".concat("data-cke-role",'="').concat("placeholder",'"]')),t)},_replaceNode:function(e,t){e&&e.parentNode&&t&&e.parentNode.replaceChild(t,e)},_replaceInitalQuotesInMessage:function(e){this.togglerReplacer.innerHTML=e;var t,o=this._calcQuoteLevelsCount(this.togglerReplacer);if(o>0){t=this._generateQuoteTogglerNode({totalCount:o,level:0});for(var n=0,s=this._extractQuotes(this.togglerReplacer,t),i=0;i<Math.min(o,10)&&s;++i){var a=s,r=this._generateQuoteTogglerNode({totalCount:o,level:i+1});if(s=this._extractQuotes(s,r),!((n+=a.innerText.length-r.innerText.length)<1e4)){this._replaceNode(r,s),s=a;break}this._replaceNode(t,a),t=r}this._replaceNode(t,this.togglerPlaceholder),this.quoteNode=s,e=this.togglerReplacer.innerHTML,this._detachNode(this.quoteNode)}return this.togglerReplacer.innerHTML="",{message:e,toggler:t}},syncDataToView:function(){var e=this,t=this.getEditor();if(t&&!t.undoManager.locked){t.fire("saveSnapshot"),t.fire("lockSnapshot");var o=this.getFieldData();this.quoteNode=null;var n=null;if(Daria.hasFeature("web-compose-collapse-quotes")&&"wysiwyg"===t.mode){var s=this._replaceInitalQuotesInMessage(o);o=s.message,n=s.toggler}t.setData(o,(function(){t.updateElement(),e.quoteNode&&e._replaceQuotePlaceholder(t.container.$,n),t.resetDirty(),t.fire("unlockSnapshot")}))}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[d.a.write,d.a.message]),this.syncDataToView(),this.onFocusFieldChanged(),this.onChangeHeightDebounce(),Daria.hasFeature("web-compose-collapse-quotes")&&this.getEditor().on("beforeSetMode",this.onBeforeModeChange,void 0,void 0,0)},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorPastefile:function(e){this.getModel("compose-attachments").addAttach({input:null,files:e.data.files})},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",n=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",o),this.setFieldData(n),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},onEditorMaximize:function(e){var t=this.getModel("compose-state");t.setIfChanged(".editorMaximize",e.data),e.data===CKEDITOR.TRISTATE_OFF&&(this.$node.toggleClass("mail-Compose-Field-Translate",t.get(".translationEnabled")),this.onChangeHeightDebounce()),_.defer(function(){this.getModel("compose-message").expandMessage()}.bind(this))},onFromMailboxChanged:function(){var e=this.getEditor(),t="wysiwyg"===e.mode;if(e){var o,n=this.getModel("compose-signature").getSignatureList();o=n.noSuitableSignature?Daria.signs.setEmptySign(t):_.first(n.signs),e.fire("signature:set",o.convert)}},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var n=e.getSelection(),s=n&&!n.isLocked&&n.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");Daria.setSelection(e.editable().$,o)}else{var n=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(n)&&n.length){var s=e.getSelection();s&&s.selectRanges(n)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}},onTranslateEdit:function(){if(this.isVisible()){this.getEditor()&&this._applyTranslate()}},onTranslateCancel:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_toggle",!1)}},onClickShowTranslator:function(){var e=this.getEditor();if(e){var t=e.getCommand("show_translator");if(t)switch(t.state){case CKEDITOR.TRISTATE_ON:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Translate");break;case CKEDITOR.TRISTATE_OFF:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Cancel")}}}}},"compose-metrics-mixin","compose-field-message-resize","compose-field-base")})()},1351:function(e,t,o){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),e}o.d(t,"a",(function(){return a}));var a=(function(){function e(t,o){var s=this;n(this,e),this.isOn=!1,this.wasPageHidden=!1,this.prevTime=null,this.fpsLevels=[],this.counters={},this._onPageVisibilityChanged=function(e,t){s.wasPageHidden=s.wasPageHidden||!t.value},this.area=t,this.fpsLevels=Object.keys(o).map((function(e){return{key:e,value:o[e]}})).sort((function(e,t){return t.value<e.value})),this._resetCounters()}return i(e,[{key:"_hasPerformance",value:function(){return Boolean(window.performance&&window.performance.now)}},{key:"_resetCounters",value:function(){var e=this;this.counters={total:0},this.fpsLevels.forEach((function(t){return e.counters[t.key]=0}))}},{key:"processFrame",value:function(){var e=performance.now();if(this.prevTime&&!this.wasPageHidden){var t=e-this.prevTime,o=Math.round(1e3/t),n="";if(this.fpsLevels.some((function(e){return n=e.key,e.value>=o}))&&this.counters.hasOwnProperty(n)){var s=Math.floor(t/(1e3/30));this.counters[n]+=s}this.counters.total++}this.prevTime=e,this.wasPageHidden=!1}},{key:"start",value:function(){var e=this;this.stop(),this._resetCounters(),this.isOn=this._hasPerformance(),this.prevTime=null;!(function t(){e.isOn&&(e.processFrame(),requestAnimationFrame(t))})(),ns.events.on("pageVisible.change",this._onPageVisibilityChanged)}},{key:"stop",value:function(){this.isOn=!1,ns.events.off("pageVisible.change",this._onPageVisibilityChanged)}},{key:"logCounters",value:function(){this._hasPerformance()&&Daria.monitoring.performance.fps(this.area,this.counters)}},{key:"finish",value:function(){this.stop(),this.logCounters()}}]),e})();a.defaultConfig={slow:30,freeze:5}},1352:function(e,t,o){"use strict";t.a={EDITOR_CHANGE:50,HEIGHT_CHANGE:50}},1353:function(e,t){!(function(){ns.View.define("compose-autosave-status",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","click .mail-ui-Link":"togglePopup"},models:{"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){this._nbPopup=null},yateModule:"compose2",methods:{onHtmlInit:function(){nb.init(this.node),this._nbPopup=nb.$block(".js-template-popup",this.node),this.bindEvents()},onHtmlDestroy:function(){this.unbindEvents(),nb.destroy(this.node)},bindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.on("click",".js-template-link",this.onClickTemplateLink.bind(this))},unbindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.off("click")},onClickTemplateLink:function(e){e.preventDefault(),this._nbPopup.close(),this.getModel("compose-message").set(".save_symbol","template"),this.getModel("compose-fsm").setState("save"),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"','Клик на "Шаблон"')},togglePopup:function(e){this._nbPopup.isOpen()?this._nbPopup.close():this._nbPopup.open({where:e.target,how:{at:"top",my:"bottom"},autoclose:!0}),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"')},onDraftSaved:function(){this.getModel("compose-state").setLastSaveTime(),this.composeUpdate()}}})})()},1354:function(e,t){!(function(){ns.View.edefine("compose-attach-buttons-wrapper",{models:{"compose-state":!1,"compose-fsm":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},patchLayout:function(){return"layout-compose-attach-buttons-wrapper"}}},"compose-disable-on-sending-mixin","compose-attach-quick-reply-mixin",ns.View)})()},1355:function(e,t){ns.View.define("compose-attach-button-mail",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"mail",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файлы из Почты"')}}},"compose-attach-open-disk-mixin")},1356:function(e,t){ns.View.define("compose-attach-button-disk",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"disk",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл из Диска"')}}},"compose-attach-open-disk-mixin")},1357:function(e,t){ns.View.define("compose-attach-button-computer",{events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-htmldestroy":"_onNsViewHtmldestroy","click@show .js-controller":"_onClickController","change@show .js-controller":"_onChangeController"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_$controllerNode:null,_onNsViewHtmlinit:function(){this._$controllerNode=this._getControllerNode().clone()},_onNsViewHtmldestroy:function(){this._$controllerNode=null},_onClickController:function(){this.inQuickReply()?Jane.c("Quick Reply","Кнопка Прикрепить","Клик по Прикрепить с компьютера"):Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл с компьютера"')},_onChangeController:function(e){var t={input:e.target,files:e.target.files};this.inQuickReply()?(this.addQuickReplyAttach(t),this._openComposePage()):this.getModel("compose-attachments").addAttach(t)},_getControllerNode:function(){return this.$node.find(".js-controller")},_onNsModelAttachmentsAdded:function(){this._$controllerNode.clone().replaceAll(this._getControllerNode())}}},"compose-attach-quick-reply-mixin")},1358:function(e,t){!(function(){var e=i18n("%Compose_Captcha_title");ns.View.define("compose-captcha",{events:{"ns-view-show":"onShow","click .js-captcha-submit":"send","keydown .js-captcha-input":"onInputKeydown","click .js-captcha-another-image":"showAnotherImage"},models:{captcha:!1,"compose-message":!1,"compose-fsm":!1},yateModule:"compose2",params:ns.View.info("compose2").params,methods:{popupData:{title:e,width:550},onShow:function(){this.focusInput()},showAnotherImage:function(){this.getModel("captcha").invalidate(),this.update()},onInputKeydown:function(e){e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.send())},getInputValue:function(){return $.trim(this.$node.find(".js-captcha-input").val())},focusInput:function(){this.$node.find(".js-captcha-input").focus()},send:function(){var e=this.getModel("compose-message"),t=this.getInputValue();if(!t)return this.focusInput(),!1;e.set(".captcha_entered",t),e.set(".captcha_key",this.getModel("captcha").get(".key")),this.getModel("compose-fsm").setState("sending",{force:!0}),Daria.Dialog.close()}}})})()},1359:function(e,t){!(function(){ns.View.define("compose-forgotten-attach",{events:{"click .js-close":"onClose","click .js-forgotten-attach-send":"onSend"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"onAttachAdded"},"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{popupData:{width:440},data:{},onSend:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!0}),this.getModel("compose-fsm").setState("sending",{force:!0}),this.triggerCloseEvent()},onAttachAdded:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},onClose:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},triggerCloseEvent:function(){this.trigger("ns-view:close")}}})})()},1360:function(e,t){ns.View.edefine("compose-forgotten-attach-button",{models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:function(e){return _.extend({},ns.View.info("compose2").params(e),e)},yateModule:"compose2"},"compose-attach-button-computer")},1361:function(e,t){!(function(){ns.View.define("compose-forwarded-messages",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":!1,"compose-message":!1,"compose-forwarded-messages":{"ns-model-changed":"composeUpdate"}},params:ns.View.info("compose2").params,ctor:function(){this.onCheckboxChanged=this.onCheckboxChanged.bind(this)},yateModule:"compose2",methods:{onHtmlInit:function(){var e=this;nb.init(this.node),this.$node.find(".js-message-checkbox").each((function(t,o){nb.block(o).on("nb-changed",e.onCheckboxChanged)}))},onHtmlDestroy:function(){nb.destroy(this.node)},onCheckboxChanged:function(e,t){var o=t.isChecked()?"checkMessage":"uncheckMessage";this.getModel("compose-forwarded-messages")[o](t.getValue())}}})})()},1362:function(e,t){ns.View.define("compose-labels-wrapper",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-message").hasUserLabels()?"layout-compose-labels":"layout-compose-labels-empty"}}})},1363:function(e,t){!(function(){ns.View.define("compose-labels",{events:{"click@show .js-compose-label-unlabel":"onClickRemoveLabel"},models:{labels:!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"invalidate"}},params:ns.View.infoLite("compose2").params,ctor:function(){this.getDataForLabel=this.getDataForLabel.bind(this)},yateModule:"compose2",methods:{getDataForLabel:function(e){return this.getModel("labels").getLabelById(e)},getDataForLabels:function(){var e=this.getModel("compose-message").getUserLabels();return e?_.map(e,this.getDataForLabel):[]},onClickRemoveLabel:function(e){var t=e.currentTarget.dataset.lid;this.getModel("compose-message").removeLid(t)}}})})()},1364:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(883);!(function(){ns.View.define("compose-notify-noreply-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-destroy":"onHtmlDestroy"},models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.messageHeight":"showFirstVisitPopup","ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"},"compose-notify-noreply-options":{"ns-model-changed":!1,"ns-model-changed.currentTimeDelta":"onChangedCurrentTimeDelta","ns-model-changed.alwaysNotify":"onChangedAlwaysNotify","ns-model-changed.enabledNotify":"onChangedEnabledNotify"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyNoreplyButton",nanoislands:{blocks:{notifyCheckbox:".js-compose-notify-noreply-button",popup:".js-compose-noreply-notify-popup",firstVisitPopup:".js-noreply-first-visit-popup",toggleCheckbox:".js-compose-noreply-toggle-checkbox",alwaysCheckbox:".js-compose-noreply-always-notify-checkbox",daysSelect:".js-compose-noreply-days-select"},events:{"click notifyCheckbox":"onNotifyCheckboxClick","nb-checked notifyCheckbox":"onNotifyCheckboxChecked","nb-unchecked notifyCheckbox":"onNotifyCheckboxUnchecked","nb-checked toggleCheckbox":"onToggleCheckboxChecked","nb-unchecked toggleCheckbox":"onToggleCheckboxUnchecked","nb-checked alwaysCheckbox":"onAlwaysCheckboxChecked","nb-unchecked alwaysCheckbox":"onAlwaysCheckboxUnchecked","nb-changed daysSelect":"onDaysSelectChanged","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-notify-noreply-button",onShow:function(){this.isEnabledNotify()?this.addNotifyToMessage():this.removeNotifyFromMessage()},isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},isSaveSentEnabled:function(){return ns.Model.get("settings").isSet("save_sent")},isEnabledNotify:function(){return this.getModel("compose-notify-noreply-options").get(".enabledNotify")},isAlwaysNotify:function(){return Boolean(this.getModel("compose-notify-noreply-options").get(".alwaysNotify"))},_showFirstVisitPopup:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options");if(!e.wasFirstVisitPopupShown()){var t=this.nbs.firstVisitPopup,o={where:this.containerSelector,how:{at:"top",my:"bottom"}};t.isOpen()?t.onposition(null,o):t.open(o),e.setFirstVisitPopupWasShown()}}},showFirstVisitPopup:_.debounce((function(){this._showFirstVisitPopup()}),n.a.DEBOUNCES.HEIGHT_CHANGE),hasCurrentTimeDelta:function(){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta(),o=this.nbs.daysSelect.getState(),n=Number(o.value);return t.value===n},replaceTextInWaitForReply:function(e,t){e.$node.find(".js-nb-icon-wait-for-reply").text(t)},resetTextInWaitForReply:function(){this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,i18n("%Compose_Checkbox_No_Reply_Normal_Text"))},onChangedCurrentTimeDelta:function(){if(this.isVisible()&&!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta();this.nbs.daysSelect.setState(t)}},onChangedAlwaysNotify:function(){this.isVisible()&&this.setCheckboxState("alwaysCheckbox",this.isAlwaysNotify())},onChangedEnabledNotify:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options"),t=this.isEnabledNotify();if(this.setCheckboxState("notifyCheckbox",t),this.setCheckboxState("toggleCheckbox",t),t){var o=e.getCurrentTimeDeltaLocalizedText();this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,o),this.addNotifyToMessage()}else this.resetTextInWaitForReply(),this.removeNotifyFromMessage()}},onNotifyCheckboxClick:function(){this.isSaveSentEnabled()?this.showBubble():Daria.Dialog.confirm({body:"<p>"+i18n("%Compose_noreply_notify_confirm")+"</p>",okValue:i18n("%Включить"),cancelValue:i18n("%Не_включать"),okHandler:function(){var e=ns.Model.get("settings");e.setSettingOn("save_sent"),e.setSettingOn("no_reply_notify"),this.getModel("compose-notify-noreply-options").initData()}.bind(this)})},onNotifyCheckboxChecked:function(){this.isSaveSentEnabled()&&this.isEnabledNotify()||this.nbs.notifyCheckbox.uncheck()},onNotifyCheckboxUnchecked:function(){this.isSaveSentEnabled()&&this.isEnabledNotify()&&this.nbs.notifyCheckbox.check()},getNotifyLabelId:function(){var e=ns.Model.get("labels");return jpath(e.getWaitingForReplyLabel(),".lid")[0]},addNotifyToMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message"),o=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta().value;t.addLid(e),t.setIfChanged(".remind_period",o)}},removeNotifyFromMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message");t.removeLid(e),t.setIfChanged(".remind_period",null)}},onToggleCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напомнить через 5 дней"')},onToggleCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!1)},onAlwaysCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напоминать всегда"')},onAlwaysCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!1)},onDaysSelectChanged:function(){if(!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=this.nbs.daysSelect.getState();e.setCurrentTimeDelta(t),this.nbs.popup.close()}},onClosePopupClick:function(){this.nbs.popup.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"',"Клик в крестик")},onSendEmail:function(){this.isVisible()&&(this.isEnabledNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напомнить через 5 дней"'),this.isAlwaysNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напоминать всегда"'))}}},"compose-popup-button")})()},1365:function(e,t){!(function(){ns.View.define("compose-notify-on-send-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.notify_on_send":"onChangedNotifyOnSend"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"}},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.closeBubble=this.closeBubble.bind(this)},methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyOnSend",nanoislands:{blocks:{checkbox:".js-compose-remind-button",popup:".js-compose-remind-popup"},events:{"nb-checked checkbox":"onChecked","nb-unchecked checkbox":"onUnchecked","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-remind-button",isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},onChangedNotifyOnSend:function(){if(this.isVisible()){switch(this.getModel("compose-message").get(".notify_on_send")){case"yes":this.showBubble(),this.setCheckboxState("checkbox",!0);break;default:this.setCheckboxState("checkbox",!1),clearTimeout(this._popupTimeout)}}},onChecked:function(){this.getModel("compose-message").set(".notify_on_send","yes")},onUnchecked:function(){this.getModel("compose-message").set(".notify_on_send",null)},onClosePopupClick:function(){this.closeBubble(),Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Клик на крестик")},closeBubble:function(){clearTimeout(this._popupTimeout),this._$window.off("scroll",this.closeBubble),ns.events.off("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.off("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.off("daria:layout-changed",this.closeBubble),this.nbs.popup.close()},showBubble:function(){this.super_.showBubble.call(this).then(this._activateClosingTimeout.bind(this))},_activateClosingTimeout:function(){var e=Daria.timify({seconds:3});this._popupTimeout=setTimeout(this.closeBubble,e),this._$window.one("scroll",this.closeBubble),ns.events.once("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.once("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.once("daria:layout-changed",this.closeBubble)},onSendEmail:function(){this.isVisible()&&this.isNotifyOnSend()&&Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Отправка письма с настройкой")},isNotifyOnSend:function(){return"yes"===this.getModel("compose-message").get(".notify_on_send")}}},"compose-popup-button")})()},1366:function(e,t){!(function(){ns.View.define("browse-disk",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","daria:vBrowseDisk:close@show":"_onClose","click .js-browse-disk-close":"_onClose","click .js-browse-disk-attach":"attachSelected","click .js-finder-crumb":"onCrumbClick","dblclick .js-finder-resource":"onResourceDblClick"},ctor:function(){this.LAYOUT_PULL_Z_INDEX_CLASS="b-layout__inner_pull"},models:{"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onHtmlInit:function(){this.$dialog=this.$node.find(".js-browse-disk-dialog"),this.$paranja=this.$node.find(".b-paranja"),this.onNotFound=this.onNotFound.bind(this),this.onSelected=this.onSelected.bind(this),this.openFolderDebounce=_.debounce(this.openFolder.bind(this),0)},onShow:function(){this.nbButtonAttach=nb.$block(".js-browse-disk-attach",this.$dialog),nb.init(this.node),ns.events.on("disk-resources.not-found",this.onNotFound),ns.events.on("disk-resources.selected",this.onSelected)},onHide:function(){nb.destroy(this.node),this._diskResourcesDeselect(),delete this.nbButtonAttach,ns.events.off("disk-resources.not-found",this.onNotFound),ns.events.off("disk-resources.selected",this.onSelected)},_onClose:function(e,t){Jane.c("Аттачи из Диска","Отмена прикрепления"),this.close(t)},open:function(e){e=e||"/disk/",Daria.Dialog.close();var t=ns.Model.get("disk-resources"),o=_.extend({},this.params,{path:e,sort:t.getDefaultSort(e),order:t.getDefaultOrder(e)});return this.updateByLayout("browse-disk",o).then(this._showDialog,this)},close:function(e){this._diskResourcesDeselect(),this._hideDialog(),e&&this.reset(),this.invalidate(),this.trigger("close")},_diskResourcesDeselect:function(){ns.Model.get("disk-resources").deselect()},_hideDialog:function(){this.$dialog.addClass("g-invisible"),this.$paranja.addClass("g-hidden"),this.$dialog.closest(".b-layout__inner").removeClass(this.LAYOUT_PULL_Z_INDEX_CLASS),$.Shortcuts.modalListOff("finder")},_showDialog:function(){this.$dialog.removeClass("g-invisible"),this.$paranja.removeClass("g-hidden"),this.$dialog.closest(".b-layout__inner").addClass(this.LAYOUT_PULL_Z_INDEX_CLASS),$.Shortcuts.modalListOn("finder"),Jane.c("Аттачи из Диска","Открытие диалога")},openFolder:function(e){if(!this._running){this._running=!0,this.openFolderDebounce.cancel();var t=ns.Model.get("disk-resources"),o=_.extend({},this.params,{path:e,sort:t.getDefaultSort(e),order:t.getDefaultOrder(e)});this.update(o).then((function(e){var t=e.async;return t.length?Vow.all(t):Vow.fulfill()})).then(this.__openFolder,this)}},__openFolder:function(){this.$node.find(".b-finder__resource_selected").removeClass("b-finder__resource_selected"),this._running=!1},attach:function(e){var t=this._getFileResourceById(e);t&&(this.getModel("compose-attachments").addAttach({id:e,resource:t}),this.close())},quickReplyAttach:function(e){var t=this._getFileResourceById(e);if(t){this.addQuickReplyAttach({id:e,resource:t});var o=this.params;this.close(),this.params=o,this._openComposePage()}},attachAction:function(e){return this.inQuickReply()?this.quickReplyAttach(e):this.attach(e)},attachSelected:function(){var e=ns.Model.get("disk-resources"),t=e.getSelected();if(t)return this.attachAction(t)},_getFileResourceById:function(e){return ns.Model.get("disk-resources").find(e)},reset:function(){delete this.params.path},onSelected:function(e,t){this.canAttachResource(t.now)?this.nbButtonAttach.enable():this.nbButtonAttach.disable()},canAttachResource:function(e){if(!e)return!1;var t=ns.Model.get("disk-resources"),o=t.find(e);return!!o&&!(0===e.indexOf("/mail/")&&"dir"===o.type)},onCrumbClick:function(e){var t=$(e.currentTarget);this.openFolder(decodeURIComponent(t.data("id")))},onResourceDblClick:function(e){var t=$(e.currentTarget),o=decodeURIComponent(t.data("id")),n=t.data("type");"dir"===n?this.openFolder(o):"file"===n&&this.attachAction(o)},onNotFound:function(e,t){if(404===t.http_status){var o=Daria.utils.dirname(this.params.path)+"/";ns.Model.get("disk-resources").clearCacheByParams({path:o}),this.openFolderDebounce(o)}}}},"compose-attach-quick-reply-mixin")})()},1367:function(e,t){ns.View.define("browse-disk-crumbs",{models:{"disk-default-folders":!0,"disk-resources":!0},"params-":["sort","order","offset"],yateModule:"compose2"})},1368:function(e,t){ns.View.define("browse-disk-listing",{models:{"disk-resources":!0,"disk-default-folders":!0},"params-":["offset"],events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-hide":"_onNsViewHide","ns-view-show":"_onNsViewShow","mousedown@show .js-finder-resource":"select","scroll@show .js-finder-listing":"loadMoreDebounce","disk-resources.selected@show":"onselect"},ctor:function(){this.SELECTED_CLASS="b-finder__resource_selected",this.LOADING_CLASS="b-finder__listing_portion",this.COMPLETE_CLASS="b-finder__listing_complete",this.PRELOAD_OFFSET=50,this.loadMoreDebounce=_.debounce(this.loadMore.bind(this),200),this.__update=this.__update.bind(this),this.__loadMore=this.__loadMore.bind(this)},yateModule:"compose2",methods:{_onNsViewHtmlinit:function(){this.$listing=this.$node.find(".js-finder-listing"),this.$listing.toggleClass(this.COMPLETE_CLASS,this.models["disk-resources"].__complete)},_onNsViewShow:function(){this.listingHeight=this.$listing.children(".js-finder-loader").position().top,this.onselect(null,{now:ns.Model.get("disk-resources").getSelected()})},_onNsViewHide:function(){this.loadMoreDebounce.cancel(),ns.Model.get("disk-resources").deselect()},select:function(e){ns.Model.get("disk-resources").select(decodeURIComponent($(e.currentTarget).data("id")))},onselect:function(e,t){t.before&&this.$node.find('[data-id="'+encodeURIComponent(t.before)+'"]').removeClass(this.SELECTED_CLASS),t.now&&this.$node.find('[data-id="'+encodeURIComponent(t.now)+'"]').addClass(this.SELECTED_CLASS)},loadMore:function(){this.loading||this.$listing.scrollTop()+this.$listing.outerHeight()>=this.listingHeight-this.PRELOAD_OFFSET&&(this.loading=!0,this.$listing.addClass(this.LOADING_CLASS),ns.Model.get("disk-resources").loadMore(this.params).then(this.__update).always(this.__loadMore))},__loadMore:function(){this.loading=!1,this.$listing.removeClass(this.LOADING_CLASS)},__update:function(){this.isVisible()&&(this._scrollTop=this.$listing.scrollTop(),this.invalidate(),this.update(this.params).then(this.restoreScroll,this))},restoreScroll:function(){this.isVisible()&&this.$listing&&this._scrollTop&&(this.$listing.scrollTop(this._scrollTop),delete this._scrollTop)}}})},1369:function(e,t){ns.View.edefine("quick-reply-already-answered-hint",{models:{message:!1},params:{ids:null},yateModule:"compose2"},"go-to-replied-message-mixin",ns.View)},1370:function(e,t){ns.View.define("quick-reply-done",{events:{"ns-view-show":"onShow"},models:{"quick-reply-state":"keepValid"},params:function(e){return{qrIds:e.ids}},yateModule:"compose2",methods:{onShow:function(){this.getModel("quick-reply-state").set(".showDone",!1)}}})},1371:function(e,t){ns.View.define("quick-reply-done-success",{yateModule:"compose2"})},1372:function(e,t){ns.View.define("quick-reply-form",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","daria:shortcuts:replyall@show":"focusQuickReply"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.needPlaceInViewport":"placeInViewport"},"message-draft":!1},params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2",methods:{onShow:function(){this.$node.find(".js-loader").removeClass("is-hidden"),this.getComposeParams().then(this.onLoadComposeParams,this.onLoadErrorComposeParams,this)},onHide:function(){this.vCompose.destroy(),this.vCompose=null,this.getModel("quick-reply-state").setIfChanged(".formIsShown",!1),this.invalidate(),HTMLElement.xEditorRestoreNodeActions()},onLoadErrorComposeParams:function(){this.getModel("quick-reply-state").hideForm()},onLoadComposeParams:function(e){if(this.isVisible()){var t=this.node.appendChild(this.node.ownerDocument.createElement("div"));this.vCompose=ns.View.create("quick-reply",e),this.vCompose._setNode(t),this.vCompose.invalidate(),this.vCompose.updateByLayout("layout-quick-reply-form",e,{execFlag:ns.U.EXEC.PARALLEL}).done(this.onAfterRender,this)}},onAfterRender:function(){this.isVisible()&&(this.$node.find(".js-loader").addClass("is-hidden"),this.node.appendChild(this.vCompose.node),this.getModel("quick-reply-state").setIfChanged(".formIsShown",!0),this.placeInViewport(),HTMLElement.xEditorOverrideNodeActions())},getComposeParams:function(){var e=this.getModel("quick-reply-state").isReplyAll(),t={ids:this.params.ids,qrIds:this.params.qrIds,oper:e?"reply-all":"reply",_cuid:_.uniqueId("compose")};return vow.Promise.resolve(t)},placeInViewport:function(){var e=Daria.is3pane(),t=ns.Model.get(e?"scroller-message":"scroller-messages");t.init(),t.scrollIntoView(this.node,{alignToTop:!1,relative:t.isRelativeOffset(),viewBottomOffset:e?0:-ns.Model.get("app-state").get(".timelineHeight")}),ns.events.trigger("daria:vApp:changeRightColumSize")},focusQuickReply:function(){this.isVisible()&&this.vCompose&&(this.vCompose.getModel("compose-state").setFocusField("send"),this.placeInViewport())}}})},1373:function(e,t){ns.View.define("quick-reply-placeholder",{events:{"click@show":"openQuickReply","click .js-quick-reply-placeholder-single-reply":"onSingleReplyClick","click .js-quick-reply-placeholder-forward":"onForwardClick","click .js-quick-reply-placeholder-reply-all":"onReplyAllClick","daria:shortcuts:replyall@show":"openQuickReply"},models:{"message-body":!1,"quick-reply-state":!1,"index-data":!1},params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2",methods:{openQuickReply:function(){var e=this.getModel("message-body").allowedReplyAll(),t=this.getModel("quick-reply-state");t.setReplyAllState(e),t.showForm(),e?this._countMetrika('Клик на "Ответить всем"'):this._countMetrika('Клик на "Ответить"')},onSingleReplyClick:function(e){var t=this.getModel("quick-reply-state");t.setReplyAllState(!1),t.showForm(),e.stopPropagation(),this._countMetrika('Клик на "Ответить"')},onReplyAllClick:function(e){this.openQuickReply(),e.stopPropagation()},onForwardClick:function(e){var t=ns.Model.get("messages-checked",{mid:this.params.ids});ns.action.run("forward",{mMessagesChecked:t}),e.stopPropagation(),this._countMetrika('Клик на "Переслать"')},_countMetrika:function(e){Daria.isMessagePage()&&Jane.c("Quick Reply","Письмо на отдельной странице",e)}}})},1374:function(e,t){ns.View.define("quick-reply-form-wrap",{models:{"index-data":!1},params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2"})},1375:function(e,t){ns.View.define("compose-message-show-hidden-parts",{events:{"click@show":"onClick"},params:ns.View.info("compose2").params,models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.collapsedMessage":"onChangeCollapsed"}},yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-message").expandMessage()},onChangeCollapsed:function(){this.$node.toggleClass("is-hidden",!this.isCollapsed()),this.getModel("compose-state").trigger("editor-update")},isCollapsed:function(){return this.getModel("compose-message").isMessageCollapsed()}}})},1376:function(e,t){ns.View.define("compose-quick-reply-delete",{events:{"click@show":"onClick"},models:{"quick-reply-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){var e=this.getModel("compose-message"),t=this.getModel("quick-reply-state"),o=e.getDraftMid();t.trigger("ns-model:delete-draft",o)},onDraftSaved:function(){this.$node.toggleClass("is-hidden",!this.toShow())},toShow:function(){return this.getModel("compose-message").isDraft()}}})},1377:function(e,t){!(function(){var e={split:{byModel:"compose-field-notices",intoViews:function(e){var t=e.get(".type"),o=e.params.field;switch(t){case"error":return"compose-field-"+o+"-error";case"nda":return"compose-field-"+o+"-notice-nda";case"help":return"compose-field-"+o+"-notice-help";case"replyall":return"compose-field-"+o+"-notice-replyall"}return null}}};["phone","to","cc","bcc","att_ids"].forEach((function(t){var o="compose-field-notices-"+t;ns.ViewCollection.define(o,{models:{"compose-field-notices":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:t})},split:_.clone(e.split),yateModule:"compose2"})}))})()},1378:function(e,t){ns.ViewCollection.define("compose-field-extras-to",{models:{"compose-field-extras-collection":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},split:{byModel:"compose-field-extras-collection",intoViews:function(e){switch(e.get(".type")){case"extras-phone":return"compose-field-to-extras-phone";case"extras-cc":return"compose-field-to-extras-cc";case"extras-bcc":return"compose-field-to-extras-bcc";case"extras-go-to-compose":return"compose-field-to-extras-go-to-compose";case"extras-qr-close":return"compose-field-to-extras-qr-close"}return null}},yateModule:"compose2"})},1379:function(e,t){ns.View.define("compose-recipients-diff",{events:{"click@show .js-compose-recipients-diff-close":"onSelectorClick"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.recipients-diff":"selfUpdate"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.recipients-diff-pane-close":"selfUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{selfUpdate:function(){this.invalidate(),this.update()},onSelectorClick:function(){this.getModel("compose-state").set(".recipients-diff-pane-close",!0)},hasRecipients:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added.length||t.removed.length},getRecipientsEmails:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added=t.added.map(this.recipientsMapIterator),t.removed=t.removed.map(this.recipientsMapIterator),t},recipientsMapIterator:function(e){var t=e.indexOf("@");return-1===t&&(t=e.length-1),e.substring(0,t+1)}}})},1380:function(e,t){ns.View.define("compose-switchmode-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-switchmode-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},_onOpened:function(){this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._promise.fulfill(),this._popup.close()},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject(),this.destroy()}}})},1381:function(e,t){ns.View.define("compose-emoticons-select",{models:{"compose-emoticons":!1},events:{"click@show .js-click":"_onClick","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll"},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",methods:{open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-emoticons-select","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(e,t){t.$node.on("mousedown",(function(e){e.preventDefault()})),this.trigger("opened")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.trigger("closed")},_onDestroyed:function(){this.destroy()},_onClick:function(e){e.preventDefault(),this.trigger("select",$(e.currentTarget).data("suid")),this._popup.close()},_onScroll:function(){var e=this._popup&&this._popup.node&&this._popup.node.widget;e&&e._position()}}})},1382:function(e,t){ns.View.define("compose-maillink-dialog",{events:{"click@show .js-update":"_onClickUpdate","click@show .js-cancel":"_onClickCancel"},params:ns.View.info("compose2").params,ctor:function(){this._onKeyup=this._onKeyup.bind(this),this._popup=null,this._data={}},yateModule:"compose2",methods:{REG_CHECK_EMAIL:/^(http(s?):\/\/|ftp:\/\/|mailto:)/,getData:function(e,t){return this._data[e]||t||""},open:function(e){this._data=_.isObject(e)?_.clone(e):{},this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},isEdit:function(){return Boolean(this.getData("href"))},getHrefView:function(){return this.getData("href")},getTextView:function(){var e=this.getData("text");return e===this.getData("href")?"":e},isDisableText:function(){return this.getData("isDisableText")},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-maillink-dialog","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({autofocus:!0,autoclose:!1,animation:!1})},_onOpened:function(){this._nbInputText=nb.$block(".js-text",this.node),this._nbInputHref=nb.$block(".js-href",this.node),this.$node.on("keyup",this._onKeyup),this.trigger("opened"),this._nbInputHref.focus(),this.getData("href")||Daria.setSelection(this._nbInputHref.$control[0],this.getHrefView().length),this.isDisableText()&&this._nbInputText.disable()},_onClosed:function(){this.$node.off("keyup",this._onKeyup),nb.destroy(this.node),this._popup&&(this._popup.destroy(),this._popup=null),this.trigger("closed"),this._data=null},_onDestroyed:function(){this.destroy()},_onClickCancel:function(){this._popup.close()},_onKeyup:function(e){13===e.keyCode&&this._onClickUpdate()},_onClickUpdate:function(){var e=this._nbInputHref.getValue().trim();if(!e)return void this._nbInputHref.showError({autoclose:!0});this.REG_CHECK_EMAIL.test(e)||(e="http://"+e);var t=this._nbInputText.getValue().trim()||e,o=this.getData("href"),n=this.getData("text");this._popup.close(),e===o&&t===n||this.trigger("update",{text:t,href:e})}}})},1383:function(e,t){ns.View.define("compose-unsaved-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-unsaved-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},isOpen:function(){return!!this._popup&&this._popup.isOpen()},_onOpened:function(){this._popup.$node.on("keydown click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("keydown click",".js-reject",this._onClosed.bind(this))},_onResolve:function(e){if(!(e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER)){var t=$(e.currentTarget).data("action");this._promise.fulfill(t),this._popup.close()}},_onClosed:function(e){e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER||this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject(),this.destroy()}}})},1384:function(e,t){ns.View.define("thread-quick-reply-placeholder",{events:{"click@show":"openQuickReply","daria:vMessageThreadReplyAll:replyAll@show":"openQuickReply"},models:{"quick-reply-state":!1,"index-data":!1},params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2",methods:{openQuickReply:function(){this.getModel("quick-reply-state").showForm()}}})},1385:function(e,t){ns.View.define("thread-quick-reply-form-wrap",{models:{"index-data":!1},params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2"})},1386:function(e,t){ns.View.define("thread-quick-reply-form",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.needPlaceInViewport":"placeInViewport"}},params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2",methods:{onShow:function(){this.$node.find(".js-loader").removeClass("is-hidden"),this.mMessages=this.getReplyMessagesModel(),this.getComposeParams().then(this.onLoadComposeParams,this.onLoadErrorComposeParams,this)},onHide:function(){this.mMessages&&(this.mMessages.off("ns-model-remove",this.onMessageReplyRemoveBind),this.mMessages=null),this.vCompose.destroy(),this.vCompose=null,this.getModel("quick-reply-state").setIfChanged(".formIsShown",!1),this.invalidate(),HTMLElement.xEditorRestoreNodeActions()},onLoadErrorComposeParams:function(){this.getModel("quick-reply-state").hideForm()},onLoadComposeParams:function(e){if(this.isVisible()){var t=this.node.appendChild(this.node.ownerDocument.createElement("div"));this.vCompose=ns.View.create("quick-reply-plain",e),this.vCompose._setNode(t),this.vCompose.invalidate(),this.vCompose.updateByLayout("layout-thread-quick-reply-form",e,{execFlag:ns.U.EXEC.PARALLEL}).done(this.onAfterRender,this)}},onMessageReplyRemove:function(e,t,o){_.some(o,(function(t){return t.params.ids===e}))&&this.onLoadErrorComposeParams()},onAfterRender:function(){this.isVisible()&&(this.$node.find(".js-loader").addClass("is-hidden"),this.node.appendChild(this.vCompose.node),this.getModel("quick-reply-state").setIfChanged(".formIsShown",!0),this.placeInViewport(),HTMLElement.xEditorOverrideNodeActions())},getComposeParams:function(){var e=this.getReplyMessageMid();if(!e)return vow.reject();var t=this.getModel("quick-reply-state").isReplyAll(),o={ids:e,qrIds:this.params.qrIds,oper:t?"reply-all":"reply",_cuid:_.uniqueId("compose")};return this.onMessageReplyRemoveBind=this.onMessageReplyRemove.bind(this,e),this.mMessages&&this.mMessages.on("ns-model-remove",this.onMessageReplyRemoveBind),new vow.Promise(function(e){e(o)})},placeInViewport:function(){var e=this.$node.closest(".js-thread-quick-reply")[0],t=Daria.is3pane(),o=ns.Model.get(t?"scroller-message":"scroller-messages");o.init(),o.scrollIntoView(e,{alignToTop:!1,relative:o.isRelativeOffset(),viewBottomOffset:t?0:-ns.Model.get("app-state").get(".timelineHeight")}),ns.events.trigger("daria:vApp:changeRightColumSize")},getReplyMessageMid:function(){var e=this.params.ids,t=this.mMessages?this.mMessages.getLastReplyMessageQR():ns.Model.getValid("message",{ids:e});return t&&t.get(".mid")},getReplyMessagesModel:function(){var e=this.params.thread_id;return ns.Model.getValid("messages",{thread_id:e})}}})},1387:function(e,t){!(function(){var e=ns.View.infoLite("compose2");ns.View.edefine("quick-reply-plain",{events:{"xiva.mail.insert@show":"onXivaMailInsert","daria:vMessageThreadReplyAll:replyAll@show":"focusSendField"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onQuickReplyStateShow","ns-model:delete-draft":"onDeleteDraft"},"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":function(){this.getModel("compose-fsm").once("# edit",(function(){this.setState("sending",{force:!0})}))}},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# edit":"onEdit","# sent":"onSent","# sending":"onSending","# cancel":"onCancel","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:e.params,ctor:function(){this._xivaInsertMessages={},e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{_parentApply:function(t,o){e.methods[t]&&e.methods[t].apply(this,o)},onShow:function(){this._parentApply("onShow",arguments),this.focusSendField(),Jane.c("Треды","Quick Reply",Daria.is2pane()?"2pane":"3pane","Показ")},onEdit:function(){var e=ns.Model.get("message-draft",{ids:this.params.qrIds});if(e.isValid()){var t=this.getModel("compose-message").getDraftMid();e.setIfChanged(".mid",t)}},onSent:function(){this._parentApply("onSent",arguments);var e=ns.Model.get("message-draft",{ids:this.params.qrIds});e.isValid()&&e.setIfChanged(".mid",void 0),Jane.c("Треды","Quick Reply",Daria.is2pane()?"2pane":"3pane",'Клик на "Ответить"')},onQuickReplyStateShow:function(){this.getModel("quick-reply-state").toShowForm()||(this.shouldClearModel=!0)},onDeleteDraft:function(){this.isVisible()&&(this.shouldClearModel=!0)},onDraftSaved:_.noop,scrollToComposeTop:_.noop,onXivaMailInsert:function(e,t){if(Daria.utils.checkReplaceFakeMessage(t)){var o=no.jpath(".message.hdr_message_id",t),n=no.jpath(".message.mid",t);this._xivaInsertMessages[o]=n}},_getContainer:function(e){return $('[data-key*="ids='+e+'"]')[0]},_openSentMessage:function(e){ns.Model.get("state-message-thread-item",{ids:e}).setOpen(!0)},_onMessageRenderSuccess:function(e,t,o){var n=this._xivaInsertMessages[t],s=this._getContainer(o);!n&&s.length?(e.node._nsView=e,s.append(e.node),this.scrollToSentMessage(e.params.ids)):(e.destroy(),n&&(this._openSentMessage(n),this.scrollToSentMessage(n))),this._xivaInsertMessages={}},_onAfterSent:function(){Daria.Statusline.hide("sending_message"),this._showMessageSentNotification(!0);var e=this.getModel("quick-reply-state");return(!ns.Model.get("settings").isThreaded()||Daria.is3pane()&&ns.page.current.params.ids||"message"===ns.page.current.page||ns.page.current.params.search)&&this.showSentInList(),e.hideForm(),vow.Promise.resolve()},showSentInList:function(){var e=this.getModel("compose-message"),t=e.get(".sentMessageId"),o=this._xivaInsertMessages[t],n=e.mMessage.getThreadId();if(t&&!o){var s=this._getContainer(n);if(s&&s.length){var i={ids:_.uniqueId("666")};ns.Model.get("message",i).fromComposeMessage(e,this.params.qrIds),ns.Model.get("message-body",i).fromComposeMessage(e,this.params.qrIds);var a=ns.View.create("quick-reply-message",i);a.updateByLayout("layout-quick-reply-message",i,{execFlag:ns.U.EXEC.PARALLEL}).done(this._onMessageRenderSuccess.bind(this,a,t,n))}}else o&&(this._openSentMessage(o),this.scrollToSentMessage(o))},scrollToSentMessage:function(e){ns.Model.get("state-message-thread-item",{ids:e}).set(".shouldBeInViewport",!0)},focusSendField:function(){this.getModel("compose-state").setFocusField("send")}}},"compose2")})()},1388:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(83),s=o.n(n);!(function(){var e=ns.View.infoLite("compose-field-base"),t=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorSwitchedMode","_applyTmpContent"];ns.View.edefine("compose-message-editor-tiny",{models:{"module-editor":!1,"quick-reply-state":!1,"compose-message":!1,"compose-attachments":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments),_.bindAll(this,t),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,50)},yateModule:"compose2",methods:{FIELD_NAME:"send",getConfig:function(){var e=this,t={};return CKEDITOR.editorConfig(t),_.extend(t,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE_TINY,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),pastefileGetPlaceholderContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document.body),new CKEDITOR.dom.element(t)},pastefileGetDropContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document),t}},this)),t},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onShow:function(e,t,o){this._timings=o,this._timings.showEditor=Date.now();var n=this.getModel("compose-message"),s=this.getConfig();s.height=60,s.startupMode=n.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),this._timeoutEditorCreate=setTimeout(function(){CKEDITOR.replace(this.getEditorId(),s)}.bind(this),50),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),n.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode)},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.destroyEditor()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark();var e=this.getModel("quick-reply-state").getTmpContentAndRemove();e&&(this._timeoutApplyTmpContent=_.defer(this._applyTmpContent,e))},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},syncViewToData:function(){if(this.isVisible()){var e=this.getEditor();if(e&&e.checkDirty()){var t=e.getData();void 0!==t&&(this.setFieldData(t),e.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,{callback:function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[s.a.write,s.a.message,s.a.tiny]),this.syncDataToView(),this.onFocusFieldChanged()},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",n=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",o),this.setFieldData(n),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var n=e.getSelection(),s=n&&!n.isLocked&&n.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");o&&Daria.setSelection(e.editable().$,o)}else{var n=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(n)&&n.length){var s=e.getSelection();s&&s.selectRanges(n)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}}}},"compose-field-base")})()},1389:function(e,t){ns.View.define("compose-addimage-popup",{yateModule:"compose2",events:{"wheel window":"onWheel"},methods:{_popup:null,_input:null,open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then((function(){this._popup=nb.block(this.node),this._popup.on("nb-opened",this._onOpened.bind(this,e)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})}),this)},_hideError:function(e){e.data.error&&(e.$node.removeClass("_nb-is-wrong"),e.error.close())},_onOpened:function(e){this._input=nb.$block(".js-imageurl-input",this.node),e&&e.defaultValue&&"string"==typeof e.defaultValue&&this._input.setValue(e.defaultValue),e&&e.showError&&this._input.showError(),this._input.on("nb-changed",(function(){Jane.FormValidation.isUrl(this.getValue())||this.showError()}));var t=function(){this._hideError(this._input)}.bind(this);this._input.$control.on("keydown",t),this._input.$control.on("click",t),this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._input&&this._input.getValue&&Jane.FormValidation.isUrl(this._input.getValue())?(this.trigger("resolve",this._input.getValue()),this._popup.close()):this._input.showError()},_onClosed:function(){var e=this;_.defer((function(){e._popup.$node.off("click"),e._input&&(e._input.$control&&e._input.$control.off(),e._input.destroy(),e._input=null),e._popup&&(e._popup.destroy(),e._popup=null),e.trigger("reject"),e.destroy()}))},getScrollContent:function(){return null}}},"prevent-scroll-propagation-mixin",ns.View)},1390:function(e,t){!(function(){var e=ns.Model.get("all-toolbar-buttons"),t={compose2:{scroll:!1,buttons:[{id:Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_GO,_enable:function(){return!Jane.watcher.get("compose.open")}},Daria.Constants.TOOLBAR_BUTTONS.CHECK_MAIL,Daria.Constants.TOOLBAR_BUTTONS.DELETE_DRAFT,Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_REPLY,Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_REPLY_ALL,Daria.Constants.TOOLBAR_BUTTONS.LABELS_ACTIONS]},done:{buttons:[Daria.Constants.TOOLBAR_BUTTONS.COMPOSE_GO,Daria.Constants.TOOLBAR_BUTTONS.CHECK_MAIL]}};_.each(t,(function(t,o){t.buttons=e.getButtonsByDeclarations(t.buttons),ns.Model.get("toolbar",{layout:o}).setData(t)}))})()},1391:function(e,t){!(function(){function e(){var e={"compose-attach-buttons-wrapper":{},"compose-send-button-complex":{},"compose-button-translate-apply":{},"compose-button-translate-close":{},"compose-autosave-status":{},"compose-notify-noreply-button-box@":{}};return"TUR"!==Daria.Config.product&&(e["compose-notify-on-send-button"]={},ns.Model.get("labels").getWaitingForReplyLabel()&&(e["compose-notify-noreply-button-box@"]={"compose-notify-noreply-button":{}})),e}var t=_.extend({"compose-head":{"compose-action-buttons":{},"compose-from":{},"compose-cancel-button":{}},"compose-footer":e},(function(){return{"compose-fields-wrapper":{},"compose-attach-area":{},"compose-field-att_ids-notices-wrapper":{},"compose-forwarded-messages":{},"compose-message-editor":{}}})());t["compose-head"]["compose-delete-button"]={},t["compose-head"]["compose-label-button"]={},ns.layout.define("layout-compose-action-buttons",{"compose-action-buttons-box@":{"compose-send-link":{}}}),ns.layout.define("layout-compose-action-buttons-template",{"compose-action-buttons-box@":{"compose-send-link":{},"compose-save-link":{}}}),ns.layout.define("layout-compose-action-buttons-new-template",{"compose-action-buttons-box@":{"compose-save-link":{},"compose-send-link":{}}});var o={compose2:t};Daria.is2pane()&&(o.footer={"footer-help-link":{}});var n={"app right-box@":{"compose-box@":Daria.hasFeature("web-compose-2019")?{compose2019:{}}:o},"app toolbar-box@":{},"app fake-head-background-box@":function(){return Daria.CompactMode.isCompactHeader()?{"fake-head-background":{}}:{}}};n["app "+Daria.getDirectBlockLayoutInfo("messages-direct").name]={},ns.layout.define("compose2",n,"common+left+toolbar"),ns.layout.define("browse-disk",{"browse-disk":{"browse-disk-crumbs-box@":function(e){return e.path?"browse-disk-crumbs":null},"browse-disk-listing-box@":function(e){return e.path?"browse-disk-listing&":null}}}),ns.layout.define("forgotten-attach",{"compose-forgotten-attach":{"compose-forgotten-attach-button":{}}}),ns.layout.define("compose-attach-select-location",{"compose-attach-select-location":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&!Daria.Config["is-corp"]&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("layout-compose-attach-buttons-wrapper",{"compose-attach-buttons-box@":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("compose-template-list",{"compose-template-list":{}}),ns.layout.define("layout-compose-labels",{"compose-labels-box@":{"compose-labels":{}}}),ns.layout.define("layout-compose-labels-empty",{"compose-labels-box@":{}}),ns.layout.define("layout-compose-popular-contacts",{"compose-popular-contacts-box@":{"compose-popular-contacts":{}}}),ns.layout.define("layout-compose-popular-contacts-empty",{"compose-popular-contacts-box@":{}}),ns.layout.define("layout-compose-field-to-extras",{"compose-field-to-extras-box@":{"compose-field-extras-to":{}}}),ns.layout.define("layout-compose-message-editor-bottom",{"compose-message-editor-bottom-box@":{"compose-message-show-hidden-parts":{},"compose-message-editor-bottom-buttons":{"compose-action-buttons":{}}}}),ns.layout.define("layout-compose-message-editor-bottom-buttons-empty",{"compose-message-editor-bottom-box@":{"compose-message-show-hidden-parts":{}}}),ns.layout.define("layout-compose-message-editor-top",{"compose-message-editor-top-box@":{"compose-recipients-diff":{}}}),ns.layout.define("layout-compose-field-notices-att_ids",{"compose-field-notices-box@":{"compose-field-notices-att_ids":{}}}),ns.layout.define("layout-compose-field-notices-to",{"compose-field-notices-box@":{"compose-field-notices-to":{}}}),ns.layout.define("layout-compose-field-notices-phone",{"compose-field-notices-box@":{"compose-field-notices-phone":{}}}),ns.layout.define("layout-compose-field-notices-cc",{"compose-field-notices-box@":{"compose-field-notices-cc":{}}}),ns.layout.define("layout-compose-field-notices-bcc",{"compose-field-notices-box@":{"compose-field-notices-bcc":{}}}),ns.layout.define("layout-compose-fields",{"compose-fields-box@":{"compose-field-to":{"compose-field-to-extras":{}},"compose-field-to-notices-wrapper":{},"compose-popular-contacts-wrapper":{},"compose-field-cc":{},"compose-field-cc-notices-wrapper":{},"compose-field-bcc":{},"compose-field-bcc-notices-wrapper":{},"compose-field-phone":{},"compose-field-phone-notices-wrapper":{},"compose-field-subject":{"compose-template-list-button":{}},"compose-labels-wrapper":{}}}),ns.layout.define("layout-compose-fields-placeholder",{"compose-fields-box@":{"compose-field-placeholder":{"compose-field-to-extras":{}}}}),ns.layout.define("layout-compose-field-phone-input",{"compose-field-phone-input-box@":{"compose-field-phone-input":{}}}),ns.layout.define("layout-compose-field-phone-input-error",{"compose-field-phone-input-box@":{"compose-field-phone-input-error":{}}}),ns.layout.define("layout-quick-reply",{"quick-reply-box@":{"quick-reply-form-wrap":{"quick-reply-already-answered-hint":{},"quick-reply-form":{}}}}),ns.layout.define("layout-quick-reply-placeholder",{"quick-reply-box@":{"quick-reply-placeholder":{"quick-reply-already-answered-hint":{}}}}),ns.layout.define("layout-quick-reply-empty",{"quick-reply-box@":{}}),ns.layout.define("layout-quick-reply-done",{"quick-reply-box@":{"quick-reply-done":{"quick-reply-done-box@":{"quick-reply-done-success":{}}}}}),ns.layout.define("layout-quick-reply-form",{"quick-reply":{"compose-recipients":{},"compose-send-loader":{},"compose-attach-buttons-wrapper":{},"compose-go-to-compose":{},"compose-field-to-extras-qr-close":{},"compose-message-editor-tiny":{},"compose-send-link":{}}}),ns.layout.define("layout-thread-quick-reply-form",{"quick-reply-plain":{"compose-recipients":{},"compose-send-loader":{},"compose-attach-buttons-wrapper":{},"compose-go-to-compose":{},"compose-field-to-extras-qr-close":{},"compose-message-editor-tiny":{},"compose-send-link":{}}}),ns.layout.define("layout-thread-quick-reply",{"thread-quick-reply-box@":{"thread-quick-reply-form-wrap":{"thread-quick-reply-form":{}}}}),ns.layout.define("layout-thread-quick-reply-empty",{"thread-quick-reply-box@":{}}),ns.layout.define("layout-thread-quick-reply-placeholder",{"thread-quick-reply-box@":{"thread-quick-reply-placeholder":{}}})})()},1392:function(e,t){!(function(e){function t(n){if(o[n])return o[n].exports;var s=o[n]={exports:{},id:n,loaded:!1};return e[n].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var o={};t.m=e,t.c=o,t.p="",t(0)})([(function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,o){return t&&r(e.prototype,t),o&&r(e,o),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}function u(e){var t="function"==typeof Map?new Map:void 0;return(u=function(e){function o(){return h(e,arguments,f(this).constructor)}if(null===e||!p(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,o)}return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),m(o,e)})(e)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function h(e,t,o){return h=d()?Reflect.construct:function(e,t,o){var n=[null];n.push.apply(n,t);var s=Function.bind.apply(e,n),i=new s;return o&&m(i,o.prototype),i},h.apply(null,arguments)}function p(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e){e.editor||Object.defineProperty(e,"editor",{configurable:!0,value:v.init(e)})}function b(e){e.editor&&(v.destroy(e),delete e.editor)}var _=o(1),v=o(2),y=o(6),C=o(37),S=(function(e){function t(){var e,o;s(this,t);for(var n=arguments.length,a=new Array(n),r=0;r<n;r++)a[r]=arguments[r];var c=o=i(this,(e=f(t)).call.apply(e,[this].concat(a)));return g(c),y.ready(c),i(o,c)}return l(t,e),c(t,null,[{key:"observedAttributes",get:function(){return C.attributes}}]),c(t,[{key:"connectedCallback",value:function(){g(this),this.editor.bubbling()}},{key:"disconnectedCallback",value:function(){b(this)}},{key:"attributeChangedCallback",value:function(){C(this)}},{key:"options",value:function(e,t){return C(this,e,t)}},{key:"setContent",value:function(e){return this.editor.setContent(e)}},{key:"canAddBubble",value:function(){return this.editor.canAddBubble()}},{key:"addBubble",value:function(e,t){return this.editor.addBubble(e,t)}},{key:"removeBubble",value:function(e){return this.editor.removeBubble(e)}},{key:"editBubble",value:function(e){return this.editor.editBubble(e)}},{key:"bubbling",value:function(){return this.editor.bubbling()}},{key:"items",get:function(){return this.editor.getItems()}},{key:"inputValue",get:function(){return this.editor.inputValue()}}]),t})(u(HTMLDivElement));_.customElements.define("x-bubbles",S,{extends:"div"}),e.exports=S}),(function(e,t){e.exports=(function(){return this||(0,eval)("this")})()}),(function(e,t,o){function n(){return g.canAddBubble(this)}function s(){return g.getBubbles(this)}function i(e){var t=f.getSelection();t&&t.removeAllRanges();var o=k.get(this);for(o.length&&(g.removeBubbles(this,o),this.fireChange());this.firstChild;)this.removeChild(this.firstChild);return e=S.html2text(e),this.appendChild(this.ownerDocument.createTextNode(e)),b.bubbling(this),_.restore(this),!0}function a(e,t){var o=b.create(this,e,t);return!(!this.canAddBubble()||!o)&&(!!S.text2bubble(this,o)&&(this.fireInput(),this.fireChange(),_.restore(this),!0))}function r(e){return!!this.contains(e)&&(g.removeBubbles(this,[e]),this.fireChange(),!0)}function c(e){return!!this.contains(e)&&b.edit(this,e)}function l(){var e=S.currentTextRange(this);return e&&S.textClean(e.toString())||""}function u(){b.bubbling(this)}function d(e){w.dispatch(this,y.BUBBLE_EDIT,{bubbles:!1,cancelable:!1,detail:{data:e}})}function h(){w.dispatch(this,y.CHANGE,{bubbles:!1,cancelable:!1})}function p(){var e=l.call(this);this[C.BUBBLE_VALUE]!==e&&(this[C.BUBBLE_VALUE]=e,w.dispatch(this,y.BUBBLE_INPUT,{bubbles:!1,cancelable:!1,detail:{data:e}}))}function m(e){w.dispatch(this,y.BEFORE_REMOVE,{bubbles:!1,cancelable:!1,detail:{data:e}})}var f=o(1),g=o(3),b=o(4),_=o(13),v=o(12),y=v.EV,C=v.PROPS,S=o(5),w=o(10),D=o(6),M=o(15),k=o(14),E={blur:o(21),click:o(22),focus:o(23),keydown:o(24)},A={blur:o(25),click:o(26),mousedown:o(27),focus:o(28),keydown:o(29),keypress:o(30),keyup:o(31),paste:o(32)},T={blur:o(33),click:o(34),keydown:o(35),keypress:o(36)},F={blur:w.proxyLocal,click:w.proxyLocal,mousedown:w.proxyLocal,focus:w.proxyLocal,keydown:w.proxyLocal,keypress:w.proxyLocal,keyup:w.proxyLocal,mscontrolselect:w.prevent,paste:w.proxyLocal,resize:w.prevent,resizestart:w.prevent};t.init=function(e){var t=e;return t.setAttribute("contenteditable","true"),t.setAttribute("spellcheck","false"),w.onLocal(t,E),w.onLocal(t,A),t.options("selection")&&(w.onLocal(t,T),M.init(t)),w.on(t,F),t.fireChange=D.throttle(h,t),t.fireEdit=D.throttle(d,t),t.fireInput=D.throttle(p,t),t.fireBeforeRemove=m.bind(t),{canAddBubble:n.bind(t),addBubble:a.bind(t),bubbling:u.bind(t),editBubble:c.bind(t),getItems:s.bind(t),inputValue:l.bind(t),removeBubble:r.bind(t),setContent:i.bind(t)}},t.destroy=function(e){var t=e;w.off(t,F),w.offLocal(t,E),w.offLocal(t,A),t.options("selection")&&(w.offLocal(t,T),M.destroy(t))}}),(function(e,t,o){function n(e){return e.querySelector("[bubble]:last-child")}function s(e){return e.querySelector("[bubble]:first-child")}function i(e){return Array.prototype.slice.call(e.querySelectorAll("[bubble]"))}function a(e){return i(e).length}function r(e){return Boolean(e.querySelector("[bubble]"))}function c(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.previousSibling;for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.previousSibling);t;){if(v.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&y.textClean(t.nodeValue))return;t=t.previousSibling}}}function l(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.nextSibling;for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.nextSibling);t;){if(v.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&y.textClean(t.nodeValue))return;t=t.nextSibling}}}function u(e){for(;e;){if(m(e))return e;e=e.parentNode}}function d(e){for(;e;){if(v.isBubbleNode(e))return e;if(m(e))return;e=e.parentNode}}function h(e){for(var t=e&&e.previousSibling;t;){if(v.isBubbleNode(t))return t;t=t.previousSibling}}function p(e){for(var t=e&&e.nextSibling;t;){if(v.isBubbleNode(t))return t;t=t.nextSibling}}function m(e){return e.nodeType===Node.ELEMENT_NODE&&"x-bubbles"===e.getAttribute("is")}function f(e,t){e.fireBeforeRemove(t),t.forEach((function(t){return e.removeChild(t)}))}function g(e,t,o){var n=_(t);if(!(n<=0)){var s=o.slice(0,n);e.fireBeforeRemove(s),s.forEach((function(e){return t.appendChild(e)}))}}function b(e){var t=e.options("limit");return!t||a(e)<t}function _(e){var t=e.options("limit");return t?t-a(e):Number.POSITIVE_INFINITY}var v=o(4),y=o(5);t.closestNodeBubble=d,t.closestNodeSet=u,t.findBubbleLeft=c,t.findBubbleRight=l,t.getBubbles=i,t.bubblesCount=a,t.hasBubbles=r,t.headBubble=s,t.lastBubble=n,t.nextBubble=p,t.prevBubble=h,t.removeBubbles=f,t.moveBubbles=g,t.canAddBubble=b,t.getRemainingCapacity=_}),(function(e,t,o){function n(e){return!(!e||e.nodeType!==Node.ELEMENT_NODE)&&e.hasAttribute("bubble")}function s(e,t){if(t.hasAttribute("readonly"))return!1;var o=h.getSelection();if(!o)return!1;var n=e.options("bubbleDeformation"),s=n(t);if(!s){var i=p.textClean(t.innerText);s={text:i,startOffset:0,endOffset:i.length}}var a=p.createZws(),r=h.document.createTextNode(s.text);e.fireEdit(t),e.replaceChild(r,t),e.insertBefore(a,r);var c=h.document.createRange();return c.setStart(r,s.startOffset),c.setEnd(r,s.endOffset),o.removeAllRanges(),o.addRange(c),!0}function i(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(t=p.textClean(t)){var n=e.options("bubbleFormation"),s=e.options("classBubble"),i=b&&e.options("draggable")&&e.options("selection"),a=e.ownerDocument.createElement("span");a.innerText=t;for(var r in o)o[r]&&a.setAttribute("data-".concat(r),g(o[r]));if(n(a),s)for(var c=String(s).trim().split(/\s+/),l=c.length;l--;)a.classList.add(c[l]);return a.setAttribute("bubble",""),a.setAttribute("contenteditable","false"),i&&a.setAttribute("draggable","true"),a}}function a(e){var t=e.options("begining"),o=e.options("ending"),n=e.options("separator"),s=e.options("tokenizer"),a=r(e),f=[],g=m.getRemainingCapacity(e);return a.forEach((function(a){var r=p.textClean(a.toString());if(!r)return void a.deleteContents();var m=[r];if(s?m=s(r):(n&&(m=r.split(n).map(c).filter(l)),o?m=m.reduce((function(e,t){return e.concat(u(t,o))}),[]).map(c).filter(l):t&&(m=m.reduce((function(e,o){return e.concat(d(o,t))}),[]).map(c).filter(l))),!Array.isArray(m)||!m.length)return void a.deleteContents();var b=h.document.createDocumentFragment();m.forEach((function(t){if(!(f.length>=g)){var o=i(e,t);o&&(b.appendChild(o),f.push(o))}})),a.deleteContents(),a.insertNode(b)})),e.fireInput(),f.length&&e.fireChange(),f}function r(e){for(var t,o,s=[],i=e.childNodes,a=0;a<i.length;a++)o=i[a],n(o)?t&&(t.setEndBefore(o),s.push(t),t=void 0):t||(t=h.document.createRange(),t.setStartBefore(o));return t&&(t.setEndAfter(o),s.push(t)),s}function c(e){return e.trim()}function l(e){return Boolean(e)}function u(e,t){var o=[],n=0,s=999;for(t.lastIndex=0;null!==t.exec(e)&&s;)s--,o.push(e.substring(n,t.lastIndex)),n=t.lastIndex;return o}function d(e,t){var o,n=[],s=0,i=999;for(t.lastIndex=0;null!==(o=t.exec(e))&&i;)i--,s!==o.index&&(n.push(e.substring(s,o.index)),s=o.index);return n.push(e.substring(s,e.length)),n}var h=o(1),p=o(5),m=o(3),f=o(6),g=f.escape,b=f.canUseDrag;t.isBubbleNode=n,t.bubbling=a,t.create=i,t.edit=s}),(function(e,t,o){function n(e){for(var t=M(e),o=t.startNode,n=t.startOffset,s=!0,i=o;i&&i.nodeType===Node.TEXT_NODE;){if(y(n>0?i.nodeValue.substring(0,n):i.nodeValue)){s=!1;break}n=0,i=i.previousSibling}return s}function s(e){for(var t=M(e),o=t.endNode,n=t.endOffset,s=o;s;){if(s.nodeType!==Node.TEXT_NODE)return!1;if(y(n>-1&&n<s.nodeValue.length?s.nodeValue.substring(n):s.nodeValue))return!1;n=-1,s=s.nextSibling}return!0}function i(e,t){var o=D(e),n=o&&a(e,o);return n?(o.removeAllRanges(),o.addRange(n),c(o,t)):e.appendChild(t),!0}function a(e,t){if(t=t||D(e)){var o=t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE?t.focusNode:t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode:void 0;if(o){for(var n=o,s=o,i=o;i&&i.nodeType===Node.TEXT_NODE;)n=i,i=i.previousSibling;for(i=o;i&&i.nodeType===Node.TEXT_NODE;)s=i,i=i.nextSibling;var a=e.ownerDocument.createRange();return a.setStartBefore(n),a.setEndAfter(s),a}}}function r(e){return c(e,_())}function c(e,t){if(!e||!e.rangeCount)return!1;var o=C.document.createElement("span");if(e.getRangeAt(0).surroundContents(o),o.parentNode.replaceChild(t,o),e.removeAllRanges(),t.nodeType===Node.TEXT_NODE){var n=C.document.createRange();n.setStart(t,t.nodeValue.length),n.collapse(!1),e.addRange(n)}else e.collapse(t,0);return!0}function l(e,t){if(!(e=y(e)))return!1;t=t||C.getSelection();var o=C.document.createTextNode(e);return!!c(t,o)&&(t.collapse(o,o.nodeValue.length),!0)}function u(e,t){if(!(e=e||C.getSelection())||!e.anchorNode||e.anchorNode.nodeType!==Node.TEXT_NODE)return!1;var o=M(e),n=o.startNode,s=o.endNode,i=o.startOffset,a=o.endOffset,r=o.revert;if(!e.isCollapsed&&!t)return e.collapse(n,i),!0;var c=Boolean(e.extend);r=c?r:!r;for(var l=r?n:s,u=r?i:a;l;){if(l.nodeType!==Node.TEXT_NODE)return!1;if(null===u&&(u=l.nodeValue.length),u-1<0)l=l.previousSibling,u=null;else{if(!v(l.nodeValue.substring(u-1,u)))break;u-=1}}if(!l||null===u)return!1;if(t)if(c)e.extend(l,u-1);else{var d=C.document.createRange();r?(d.setStart(l,u-1),d.setEnd(s,a)):(d.setStart(n,i),d.setEnd(l,u-1)),e.removeAllRanges(),e.addRange(d)}else e.collapse(l,u-1);return!0}function d(e,t){if(!(e=e||C.getSelection())||!e.focusNode||e.focusNode.nodeType!==Node.TEXT_NODE)return!1;var o=M(e),n=o.startNode,s=o.endNode,i=o.startOffset,a=o.endOffset,r=o.revert;if(!e.isCollapsed&&!t)return e.collapse(s,a),!0;for(var c=r?n:s,l=r?i:a;c;){if(c.nodeType!==Node.TEXT_NODE)return!1;if(l+1>c.nodeValue.length)c=c.nextSibling,l=0;else{if(!v(c.nodeValue.substring(l,l+1)))break;l+=1}}if(!c)return!1;if(t){if(Boolean(e.extend))e.extend(c,l+1);else{var u=C.document.createRange();r?(u.setStart(c,l+1),u.setEnd(s,a)):(u.setStart(n,i),u.setEnd(c,l+1)),e.removeAllRanges(),e.addRange(u)}}else e.collapse(c,l+1);return!0}function h(e){if(!e)return"";var t=C.document.implementation.createHTMLDocument("").body;return t.innerText=e,t.innerText.replace(/^[\u0020\u00a0]+$/gm,"").replace(/\n/gm," ").trim()}function p(e,t){for(var o=e,n=null,s="begin"===t?"previousSibling":"nextSibling";o&&o.nodeType===Node.TEXT_NODE;)n=o,o=o[s];return n}function m(e,t,o,n){var s=S.hasBubbles(n),i=C.document.createRange();i.setStart(t.node,t.offset),i.setEnd(o.node,o.offset);var a=y(i.toString());return!(!a&&(a||s))&&(a||i.collapse(),e.removeAllRanges(),e.addRange(i),!0)}function f(e,t){e=e||C.getSelection();var o=e&&e.anchorNode;if(!o||o.nodeType!==Node.TEXT_NODE)return!1;var n=e.anchorOffset;return m(e,{node:p(o,"begin"),offset:0},{node:o,offset:n},t)}function g(e,t){e=e||C.getSelection();var o=e&&e.anchorNode;if(!o||o.nodeType!==Node.TEXT_NODE)return!1;var n=p(o,"begin"),s=p(o,"end");return m(e,{node:n,offset:0},{node:s,offset:s.nodeValue?s.nodeValue.length:0},t)}function b(e){e=e||C.getSelection();var t=e&&e.anchorNode;if(!t||t.nodeType!==Node.TEXT_NODE)return!1;var o=p(t,"begin"),n=p(t,"end"),s=C.document.createRange();s.setStart(o,0),s.setEnd(n,n.nodeValue?n.nodeValue.length:0);var i=y(s.toString());return Boolean(i)}function _(){return C.document.createTextNode(A)}function v(e){return E.test(e)}function y(e){return String(e||"").trim().replace(k,"")}var C=o(1),S=o(3),w=o(6),D=w.getSelection,M=w.correctSelection,k=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,E=/\u200B/,A="​";t.isEmptyLeft=n,t.isEmptyRight=s,t.arrowRight=d,t.arrowLeft=u,t.remove=r,t.html2text=h,t.currentTextRange=a,t.text2bubble=i,t.replaceString=l,t.findTextBorderNode=p,t.selectFromCursorToStrBegin=f,t.selectAll=g,t.textClean=y,t.checkZws=v,t.createZws=_,t.hasNear=b}),(function(e,t,o){function n(e){return h[e]}function s(e){return d[e]}var i=o(7),a=o(1),r=o(10),c=r.dispatch,l=o(12),u=l.EV,d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},h={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},p=/&(?:amp|lt|gt|quot|#39|#96);/g,m=/[&<>"'`]/g,f=RegExp(p.source),g=RegExp(m.source),b=/Trident|Edge/,_=/IEMobile/;t.getSelection=function(e){var t=a.getSelection();if(t&&t.anchorNode&&e.compareDocumentPosition(t.anchorNode)&Node.DOCUMENT_POSITION_CONTAINED_BY)return t},t.correctSelection=function(e){var t=e.focusNode,o=e.focusOffset,n=e.anchorNode,s=e.anchorOffset,i=!1;if(n===t)s=Math.min(e.anchorOffset,e.focusOffset),o=Math.max(e.anchorOffset,e.focusOffset),i=e.anchorOffset>e.focusOffset;else{e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_PRECEDING&&(n=e.focusNode,s=e.focusOffset,t=e.anchorNode,o=e.anchorOffset,i=!0)}return{startNode:n,endNode:t,startOffset:s,endOffset:o,revert:i}},t.throttle=function(e,t){var o=0,n=function(){o=0};return function(){o||(o=i(n),e.apply(t||this,arguments))}},t.escape=function(e){return e=String(e),e&&g.test(e)?e.replace(m,s):e},t.unescape=function(e){return e=String(e),e&&f.test(e)?e.replace(p,n):e},t.canUseDrag=(function(){return!b.test(a.navigator.userAgent)})(),t.isIE=(function(){return b.test(a.navigator.userAgent)})(),t.isMobileIE=(function(){return _.test(a.navigator.userAgent)})(),t.ready=(function(){function e(){i((function(){a.setTimeout((function(){o.length&&c(a,u.READY,{detail:{data:o.splice(0)}}),n=!0}))}))}function t(){n&&!s&&(s=!0,i((function(){c(a,u.READY,{detail:{data:o.splice(0)}}),s=!1})))}var o=[],n=!1,s=!1;return"complete"===a.document.readyState?e():"interactive"!==a.document.readyState||a.attachEvent||a.HTMLImports&&!a.HTMLImports.ready?a.addEventListener(a.HTMLImports&&!a.HTMLImports.ready?"HTMLImportsLoaded":"DOMContentLoaded",e):e(),function(e){o.push(e),t()}})()}),(function(e,t,o){(function(t){for(var n=o(8),s="undefined"==typeof window?t:window,i=["moz","webkit"],a="AnimationFrame",r=s["request"+a],c=s["cancel"+a]||s["cancelRequest"+a],l=0;!r&&l<i.length;l++)r=s[i[l]+"Request"+a],c=s[i[l]+"Cancel"+a]||s[i[l]+"CancelRequest"+a];if(!r||!c){var u=0,d=0,h=[];r=function(e){if(0===h.length){var t=n(),o=Math.max(0,1e3/60-(t-u));u=o+t,setTimeout((function(){var e=h.slice(0);h.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(u)}catch(e){setTimeout((function(){throw e}),0)}}),Math.round(o))}return h.push({handle:++d,callback:e,cancelled:!1}),d},c=function(e){for(var t=0;t<h.length;t++)h[t].handle===e&&(h[t].cancelled=!0)}}e.exports=function(e){return r.call(s,e)},e.exports.cancel=function(){c.apply(s,arguments)},e.exports.polyfill=function(){s.requestAnimationFrame=r,s.cancelAnimationFrame=c}}).call(t,(function(){return this})())}),(function(e,t,o){(function(t){(function(){var o,n,s;"undefined"!=typeof performance&&null!==performance&&performance.now?e.exports=function(){return performance.now()}:void 0!==t&&null!==t&&t.hrtime?(e.exports=function(){return(o()-s)/1e6},n=t.hrtime,o=function(){var e;return e=n(),1e9*e[0]+e[1]},s=o()):Date.now?(e.exports=function(){return Date.now()-s},s=Date.now()):(e.exports=function(){return(new Date).getTime()-s},s=(new Date).getTime())}).call(this)}).call(t,o(9))}),(function(e,t){function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function s(e){if(u===setTimeout)return setTimeout(e,0);if((u===o||!u)&&setTimeout)return u=setTimeout,setTimeout(e,0);try{return u(e,0)}catch(t){try{return u.call(null,e,0)}catch(t){return u.call(this,e,0)}}}function i(e){if(d===clearTimeout)return clearTimeout(e);if((d===n||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function a(){f&&p&&(f=!1,p.length?m=p.concat(m):g=-1,m.length&&r())}function r(){if(!f){var e=s(a);f=!0;for(var t=m.length;t;){for(p=m,m=[];++g<t;)p&&p[g].run();g=-1,t=m.length}p=null,f=!1,i(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var u,d,h=e.exports={};!(function(){try{u="function"==typeof setTimeout?setTimeout:o}catch(e){u=o}try{d="function"==typeof clearTimeout?clearTimeout:n}catch(e){d=n}})();var p,m=[],f=!1,g=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)t[o-1]=arguments[o];m.push(new c(e,t)),1!==m.length||f||s(r)},c.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=l,h.addListener=l,h.once=l,h.off=l,h.removeListener=l,h.removeAllListeners=l,h.emit=l,h.prependListener=l,h.prependOnceListener=l,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}}),(function(e,t,o){function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function s(){var e=d.document.documentElement,t=d.document.body;return(e&&e.scrollLeft||t&&t.scrollLeft||0)-(e.clientLeft||0)}function i(){var e=d.document.documentElement,t=d.document.body;return(e&&e.scrollTop||t&&t.scrollTop||0)-(e.clientTop||0)}function a(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new f(t,o))}function r(e,t){for(var o=e[m.LOCAL_EVENTS]&&e[m.LOCAL_EVENTS][t.type]||[],n={},s=0;s<o.length&&!t.immediatePropagationStopped;s++)o[s](t,n)}function c(e,t,o){return function n(s){e.removeEventListener(t,n),o(s)}}function l(e,t){return e[m.LOCAL_EVENTS]||(e[m.LOCAL_EVENTS]={}),e[m.LOCAL_EVENTS][t]||(e[m.LOCAL_EVENTS][t]=[]),e[m.LOCAL_EVENTS][t]}function u(e,t,o){var s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],r=o?n({},t,o):t,l="".concat(s?"add":"remove").concat(i?"Local":"","EventListener");for(var u in r){var d=a?c(e,u,r[u]):r[u];g[l](e,u,d)}}var d=o(1),h=o(11),p=o(12),m=p.PROPS;t.scrollX=s,t.scrollY=i,t.dispatch=a,t.keyCode=function(e){return e.charCode||e.keyCode},t.metaKey=function(e){return e.ctrlKey||e.metaKey},t.pageX=function(e){return null===e.pageX&&null!==e.clientX?e.clientX+s():e.pageX},t.pageY=function(e){return null===e.pageY&&null!==e.clientY?e.clientY+i():e.pageY},t.one=function(e,t,o){u(e,t,o,!0,!1,!0)},t.on=function(e,t,o){u(e,t,o)},t.off=function(e,t,o){u(e,t,o,!1)},t.oneLocal=function(e,t,o){u(e,t,o,!0,!0,!0)},t.onLocal=function(e,t,o){u(e,t,o,!0,!0)},t.offLocal=function(e,t,o){u(e,t,o,!1,!0)},t.prevent=function(e){return e.cancelBubble=!0,e.returnValue=!1,e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1},t.proxyLocal=function(e){r(e.currentTarget,e)};var f=(function(){return"function"==typeof d.CustomEvent?d.CustomEvent:h})(),g={addLocalEventListener:function(e,t,o){l(e,t).push(o)},removeLocalEventListener:function(e,t,o){for(var n=e[m.LOCAL_EVENTS]&&e[m.LOCAL_EVENTS][t]||[],s=0;s<n.length;)n[s]===o?n.splice(s,1):s++},addEventListener:function(e,t,o){e.addEventListener(t,o)},removeEventListener:function(e,t,o){e.removeEventListener(t,o)}}}),(function(e,t,o){var n=o(1),s=n.document,i=n.Event.prototype,a=!1;try{a=Boolean(s.createEvent("CustomEvent"))}catch(e){}var r=i.stopImmediatePropagation;i.stopImmediatePropagation=function(){this.immediatePropagationStopped=!0,r?r.call(this):this.stopPropagation()};var c=(function(){return a?function(e,t){t=t||{};var o=Boolean(t.bubbles),n=Boolean(t.cancelable),i=s.createEvent("CustomEvent");return i.initCustomEvent(e,o,n,t.detail),i}:function(e,t){t=t||{};var o=Boolean(t.bubbles),n=Boolean(t.cancelable),i=s.createEvent("Event");return i.initEvent(e,o,n),i.detail=t.detail,i}})();c.prototype=i,e.exports=c}),(function(e,t){t.KEY={a:65,Backspace:8,Bottom:40,c:67,Cmd:91,Comma:44,Delete:46,Enter:13,Esc:27,Home:36,Left:37,Right:39,Semicolon:59,Space:32,Tab:9,Top:38,x:88},t.CLS={DRAGSTART:"drag",DROPZONE:"dropzone"},t.EV={BEFORE_REMOVE:"before-remove",BUBBLE_EDIT:"bubble-edit",BUBBLE_INPUT:"bubble-input",CHANGE:"change",DRAGEND:"dragend",DRAGENTER:"dragenter",DRAGLEAVE:"dragleave",DRAGSTART:"dragstart",DROP:"drop",READY:"x-bubbles-ready"},t.PROPS={BUBBLE_VALUE:"__bubble_value__",CLICK_TIME:"__click_time__",LOCAL_EVENTS:"__events__",LOCK_COPY:"__lock_copy__",OPTIONS:"__options__"}}),(function(e,t,o){function n(e){if(!c.isMobileIE){if(!e.canAddBubble())return void r.setLast(e);r.clear(e);var t=s(e),o=i.getSelection();o.removeAllRanges(),o.collapse(t,1)}}function s(e){var t=a.createZws();if(e.hasChildNodes()){var o=e.childNodes[e.childNodes.length-1];o.isEqualNode(t)?t=o:e.appendChild(t)}else e.appendChild(t);return t}var i=o(1),a=o(5),r=o(14),c=o(6);t.restore=n,t.restoreBasis=s}),(function(e,t,o){function n(e){if(C.isBubbleNode(e)){var t=e.parentNode,o=l(t);if(!o.length)return void p(e);d(t);var n=o[0];n!==o[o.length-1]&&t.startRangeSelect||(t.startRangeSelect=n);var s,i;if(e.compareDocumentPosition(t.startRangeSelect)&Node.DOCUMENT_POSITION_PRECEDING?(s=t.startRangeSelect,i=e):(s=e,i=t.startRangeSelect),s&&i){for(var a=s;a&&b(a)&&a!==i;)a=a.nextSibling;C.bubbling(t)}}}function s(e){w.call(e.querySelectorAll(M)).forEach((function(e){return b(e)})),e.startRangeSelect=e.querySelector(D),C.bubbling(e);var t=v.getSelection();t&&t.removeAllRanges()}function i(e){var t=c(e);if(t){for(var o=S.prevBubble(t);o;o=S.prevBubble(o))b(o);e.startRangeSelect=e.querySelector(D),C.bubbling(e);var n=v.getSelection();n&&n.removeAllRanges()}}function a(e){return Boolean(e.querySelector(D))}function r(e){return l(e)[0]}function c(e){var t=l(e);return t[t.length-1]}function l(e){return w.call(e.querySelectorAll(D))}function u(e){if(!e.options("selection"))return!1;var t=y.getSelection(e);if(t&&t.rangeCount)return!1;var o=l(e);return 1===o.length&&o[0]}function d(e){l(e).forEach((function(e){return e.removeAttribute("selected")}))}function h(e){if(b(e)){var t=S.closestNodeSet(e);return t.startRangeSelect=e,C.bubbling(t),!0}return!1}function p(e){if(!C.isBubbleNode(e))return!1;var t=S.closestNodeSet(e),o=v.getSelection();return o&&o.removeAllRanges(),d(t),h(e)}function m(e){return p(S.lastBubble(e))}function f(e){if(g(e)){if(1===l(S.closestNodeSet(e)).length)return _(e)}return p(e)}function g(e){return C.isBubbleNode(e)&&e.hasAttribute("selected")||!1}function b(e){return!!C.isBubbleNode(e)&&(e.setAttribute("selected",""),!0)}function _(e){return!!C.isBubbleNode(e)&&(e.removeAttribute("selected"),!0)}var v=o(1),y=o(6),C=o(4),S=o(3),w=Array.prototype.slice,D="[bubble][selected]",M="[bubble]:not([selected])";t.all=s,t.allLeft=i,t.add=h,t.clear=d,t.get=l,t.uniq=p,t.head=r,t.last=c,t.has=a,t.range=n,t.toggleUniq=f,t.setLast=m,t.getEditable=u}),(function(e,t,o){var n=o(16),s=o(19),i=o(6),a=i.canUseDrag;t.init=function(e){return a?n.init(e):s.init(e)},t.destroy=function(e){return a?n.destroy(e):s.destroy(e)}}),(function(e,t,o){function n(e){e.stopPropagation();var t=d.closestNodeSet(e.target),o=d.closestNodeBubble(e.target);if(!t||!o)return void e.preventDefault();var n=l.getSelection();n&&n.removeAllRanges(),y=t,t.classList.add(m.DRAGSTART),u.add(o),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""),u.get(y).length>1&&e.dataTransfer.setDragImage(g(),_.w,_.h)}function s(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);if(t&&t!==y){var o=t.options("checkBubbleDrop"),n=u.get(y);n.length&&o(n)&&(d.moveBubbles(y,t,n),l.setTimeout(b,0,y,t))}}}function i(e){e.stopPropagation(),e.preventDefault(),y&&(e.dataTransfer.dropEffect="move")}function a(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.add(m.DROPZONE)}}function r(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.remove(m.DROPZONE)}}function c(e){if(e.stopPropagation(),e.preventDefault(),y){y.classList.remove(m.DRAGSTART);var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.remove(m.DROPZONE),y=null}}var l=o(1),u=o(14),d=o(3),h=o(10),p=o(12),m=p.CLS,f=o(17),g=f.getDragImage,b=f.onDropSuccess,_=f.DRAG_IMG,v={dragend:c,dragenter:a,dragleave:r,dragover:i,dragstart:n,drop:s},y=null;t.init=function(e){h.on(e,v)},t.destroy=function(e){h.off(e,v)}}),(function(e,t,o){var n={w:16,h:16},s=null;t.DRAG_IMG=n,t.getDragImage=function(){return s||(s=new Image,s.src=o(18)),s},t.onDropSuccess=function(e,t){e.fireChange(),t.focus(),t.fireChange()}}),(function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAAAVCAMAAAAw/0MlAAABblBMVEUAAABOXIZJWIKCkbeNnMKMmsJNW4VNW4VWZY57ibFHV4KVpMxRYImCkLh9jbpgcJ1fcJ1JWoaZqdNUZpaHmMaVpdJIWolTZJKHmMZEV4iXqNdkdqhjdal2iLx2ib2Knc6PodNJXpJJXpNOYpdpfLKCk8JPYpdofLNugblugrqUptdZdLdZd8Nfeb93js1+ksuGm9SGm9VHaLhJarxKZqxKbL9La7pNbr9Pb71Ucr1Wbag/XqU/X6pAVopffMdjf8ZphMpwicx2js9BW51CWZN/ldCBl9KCmNNFYKRFZbGJndWOodVKX5RKX5ZKYJdWdcNXbKJYdL1KYJtAVYpaeMVJXpJKbMBgebpjeLBjf8VLYp5kd65kgMlofLRog8log8tJYqBth8xugrpviMtNabBxi851jc8/X6t3i8BOaK56kdB9lNFOaa5Ob8FPY5qBl9NGXJODmNOEmdNQbrpRcsJUb7RGXJSTptmUptiUp9kfFguNAAAAK3RSTlMAJCQkJDw8P0JCRUVubpaWlpmZwMDAw8nJzMzV29vb7e3t7fDw+Pn5+fn8jndhZAAAAQhJREFUeF6tz2VXwgAYBtBnhBKKkgoGKPY2urvT7u7ujn/vtsM5fN/e+w8uJEaLa+HvR7Zfl8WILo293Qq8vykQaLXtGnRoPcH6i1L1oEcLidpde6BQc6shslXvaVSHIdD7S9c0Sv5+ACbfFRXftBoYuzijUry1AXPHJ1QK5349pvYOqeSPfCaM8Dkq/EFxHAMst0mDY3cL89Clkis0kqmd/CxgvUt8Ukg8rub4UYCZicTiT0rFY5HnNY4dBNC32GiGwtFt+aLhULOx9CWMdRAMbVXK6cyNfJl0ubL8IYytEDHe0/XX7IZ82e/9S3HsZSDpmSQZT/SiQ+UgGDtU6DKYnYrGTrMBon97+TS1J80efgAAAABJRU5ErkJggg=="}),(function(e,t,o){function n(e){var t=d.closestNodeBubble(e.target);if(t){var o=d.closestNodeSet(e.target);if(o){e.preventDefault(),o.focus();var n=o.__drag__={nodeBubble:t,nodeOffsetX:e.offsetX,nodeOffsetY:e.offsetY,onMousemove:l.throttle(i.bind(this,o)),onMouseup:s.bind(this,o),onScroll:l.throttle(a.bind(this,o)),x:0,y:0};y=null,C=null,S=null,c.one(document,"mouseup",n.onMouseup),c.on(document,"mousemove",n.onMousemove),c.on(document,"scroll",n.onScroll)}}}function s(e,t){var o=e.__drag__;if(o){if(c.off(document,"mousemove",o.onMousemove),c.off(document,"scroll",o.onScroll),delete e.__drag__,S&&(S.parentNode&&S.parentNode.removeChild(S),S=null),C){var n=C;C=null,n.classList.remove(m.DROPZONE),c.dispatch(n,f.DRAGLEAVE,{bubbles:!1,cancelable:!1})}if(y){var s=d.closestNodeSet(t.target);if(s&&s!==y){var i=u.get(y),a=s.options("checkBubbleDrop");i.length&&a(i)&&(d.moveBubbles(y,s,i),r.setTimeout(_,0,y,s))}var l=y;y=null,l.classList.remove(m.DRAGSTART),c.dispatch(l,f.DROP,{bubbles:!1,cancelable:!1}),c.dispatch(l,f.DRAGEND,{bubbles:!1,cancelable:!1,detail:{target:u.head(l)}})}}}function i(e){var t=e.__drag__;if(t){if(!y){var o=r.getSelection();o&&o.removeAllRanges(),y=e,y.classList.add(m.DRAGSTART),u.add(t.nodeBubble);var n;1===u.get(y).length&&(n=t.nodeBubble.cloneNode(!0)),n||(n=b(),t.nodeOffsetX=v.w,t.nodeOffsetY=v.h),S=document.body.appendChild(document.createElement("div")),S.style.cssText="position:absolute;z-index:9999;pointer-events:none;top:0;left:0;",S.appendChild(n),c.dispatch(y,f.DRAGSTART,{bubbles:!1,cancelable:!1,detail:{target:u.head(y)}})}t.x=event.clientX,t.y=event.clientY,a(e);var s=d.closestNodeSet(event.target);if(s&&s!==y)C&&C!==s?(C.classList.remove(m.DROPZONE),s.classList.add(m.DROPZONE),C=s,c.dispatch(C,f.DRAGENTER,{bubbles:!1,cancelable:!1})):C||(s.classList.add(m.DROPZONE),C=s,c.dispatch(C,f.DRAGENTER,{bubbles:!1,cancelable:!1}));else if(C){var i=C;C=null,i.classList.remove(m.DROPZONE),c.dispatch(i,f.DRAGLEAVE,{bubbles:!1,cancelable:!1})}}}function a(e){var t=e.__drag__;if(t&&S){var o=t.x-t.nodeOffsetX+c.scrollX(),n=t.y-t.nodeOffsetY+c.scrollY();h.csstransforms3d?S.style.transform="translate3d(".concat(o,"px, ").concat(n,"px, 0px)"):h.csstransforms?S.style.transform="translate(".concat(o,"px, ").concat(n,"px)"):(S.style.top="".concat(n,"px"),S.style.left="".concat(o,"px"))}}var r=o(1),c=o(10),l=o(6),u=o(14),d=o(3),h=o(20),p=o(12),m=p.CLS,f=p.EV,g=o(17),b=g.getDragImage,_=g.onDropSuccess,v=g.DRAG_IMG,y=null,C=null,S=null;t.init=function(e){c.on(e,"mousedown",n)},t.destroy=function(e){c.off(e,"mousedown",n)}}),(function(e,t){e.exports=Modernizr}),(function(e,t,o){var n=o(10),s=o(12),i=s.PROPS;e.exports=function(e){if(e.currentTarget[i.LOCK_COPY])return n.prevent(e)}}),(function(e,t,o){var n=o(10),s=o(3),i=o(12),a=i.PROPS;e.exports=function(e,t){var o=s.closestNodeSet(e.target);if(!o)return n.prevent(e);if(t.nodeEditor=o,t.nodeBubble=s.closestNodeBubble(e.target),t.isDblclick=!1,t.canAddBubble=o.canAddBubble(),t.nodeBubble){var i=Date.now();t.isDblclick=o[a.CLICK_TIME]&&i-o[a.CLICK_TIME]<200,o[a.CLICK_TIME]=i}}}),(function(e,t,o){var n=o(7),s=o(1),i=o(10),a=o(12),r=a.PROPS;e.exports=function(e){var t=e.currentTarget;if(t[r.LOCK_COPY])return i.prevent(e),delete t[r.LOCK_COPY],n((function(){var e=s.getSelection();e&&e.removeAllRanges()})),!1}}),(function(e,t,o){var n=o(6),s=o(10),i=o(12),a=i.KEY;e.exports=function(e,t){var o=s.keyCode(e);switch(t.nodeEditor=e.currentTarget,o){case a.Left:case a.Right:case a.Delete:case a.Backspace:e.preventDefault(),t.selection=n.getSelection(e.currentTarget)}}}),(function(e,t,o){var n=o(4);e.exports=function(e){n.bubbling(e.currentTarget)}}),(function(e,t,o){var n=o(10),s=o(4),i=o(13),a=o(6);e.exports=function(e,t){var o=t.nodeEditor,r=t.nodeBubble,c=t.isDblclick;if(r)c?e.shiftKey||n.metaKey(e)||s.edit(o,r):o.options("selection")||(s.bubbling(o),i.restore(o));else{var l=a.getSelection(o);l&&l.anchorNode.nodeType===Node.TEXT_NODE||i.restore(o)}}}),(function(e,t,o){var n=o(3);e.exports=function(e){var t=n.closestNodeSet(e.target);if(t){n.closestNodeBubble(e.target)||t.canAddBubble()||(t.focus(),e.preventDefault())}}}),(function(e,t,o){var n=o(7),s=o(13),i=o(1);e.exports=function(e){var t=e.currentTarget;t.canAddBubble()||n((function(){var e=i.getSelection();e&&e.removeAllRanges()})),s.restore(t)}}),(function(e,t,o){function n(e,t){var o=t.selection;if(o){var n=t.nodeEditor;if(!o.isCollapsed||u.arrowLeft(o,!0))u.remove(o),n.fireInput(),u.hasNear(o)||n.fireChange();else if(n.options("selection"))t.isEmptyLeft=!0;else{var s=d.findBubbleLeft(o);s&&(d.removeBubbles(n,[s]),n.fireChange())}}}function s(e,t){var o=t.selection;if(o){var n=t.nodeEditor;if(!o.isCollapsed||u.arrowRight(o,!0))u.remove(o),n.fireInput(),u.hasNear(o)||n.fireChange();else if(n.options("selection"))t.isEmptyRight=!0;else{var s=d.findBubbleRight(o);s&&(d.removeBubbles(n,[s]),n.fireChange())}}}function i(e,t){t.isEmptyLeft=!u.arrowLeft(t.selection,e.shiftKey)}function a(e,t){t.isEmptyRight=!u.arrowRight(t.selection,e.shiftKey)}var r=o(10),c=o(4),l=o(13),u=o(5),d=o(3),h=o(12),p=h.KEY;e.exports=function(e,t){var o=r.keyCode(e),d=r.metaKey(e);switch(o){case p.Esc:e.preventDefault(),c.bubbling(t.nodeEditor),l.restore(t.nodeEditor);break;case p.Backspace:n(e,t);break;case p.Delete:s(e,t);break;case p.Left:i(e,t);break;case p.Right:a(e,t);break;case p.Home:e.shiftKey&&(e.preventDefault(),t.isTextSelectedFromBeginToCursor=u.selectFromCursorToStrBegin(null,t.nodeEditor));break;case p.a:d&&(e.preventDefault(),t.isTextSelectAll=u.selectAll(null,t.nodeEditor))}}}),(function(e,t,o){var n=o(10),s=o(4),i=o(13),a=o(14),r=o(12),c=r.KEY;e.exports=function(e,t){var o=n.keyCode(e),r=e.currentTarget;if(t.enterBubbling=!1,o===c.Enter)e.preventDefault(),r.options("disableControls")||a.getEditable(r)||(s.bubbling(r),i.restore(r),t.enterBubbling=!0);else if(r.canAddBubble()){var l=r.options("separator");if(l&&l.test(String.fromCharCode(o))){var u=r.options("separatorCond");u&&!u(r.inputValue)||(e.preventDefault(),s.bubbling(r),i.restore(r))}}else e.preventDefault()}}),(function(e,t,o){var n=o(10),s=o(12),i=s.KEY;e.exports=function(e){var t=e.currentTarget,o=n.keyCode(e);(e.key?1===e.key.length:(o>47||o===i.Space||o===i.Backspace)&&o!==i.Cmd)&&t.canAddBubble()&&t.fireInput()}}),(function(e,t,o){function n(e,t){var o=e.options("checkBubblePaste"),n=a.getSelection(),r=!(!t||!n.isCollapsed||e.inputValue)&&o(t);return!!l.replaceString(t,n)&&(r?d?i((function(){return s(e)})):s(e):e.fireInput(),!0)}function s(e){r.bubbling(e),e.focus(),i((function(){return c.restore(e)}))}var i=o(7),a=o(1),r=o(4),c=o(13),l=o(5),u=o(6),d=u.isIE;e.exports=function(e){e.preventDefault();var t=e.currentTarget;if(t.canAddBubble())if(a.clipboardData&&a.clipboardData.getData)n(t,a.clipboardData.getData("Text"));else if(e.clipboardData){var o=e.clipboardData,s=o.getData&&o.getData("text/plain");!n(t,s)&&o.items&&Array.prototype.slice.call(o.items).filter((function(e){return"string"===e.kind&&"text/plain"===e.type})).some((function(e){return e.getAsString((function(e){n(t,e)})),!0}))}}}),(function(e,t,o){var n=o(14);e.exports=function(e){n.clear(e.currentTarget)}}),(function(e,t,o){var n=o(10),s=o(14);e.exports=function(e,t){var o=t.nodeEditor,i=t.nodeBubble,a=t.isDblclick,r=t.canAddBubble;i?n.metaKey(e)?s.add(i):e.shiftKey?o.startRangeSelect?s.range(i):s.uniq(i):a||(r?s.toggleUniq(i):s.uniq(i)):r&&s.clear(o)}}),(function(e,t,o){function n(e,t){var o=t.nodeEditor;if(!o.options("disableControls")){var n=g.headBubble(o);n&&f.uniq(n)}}function s(e,t){var o=t.nodeEditor;o.options("disableControls")||f.has(o)&&b.restore(o)}function i(e,t){var o=t.nodeEditor,n=t.selection;if(n){if(t.isEmptyLeft){var s=g.findBubbleLeft(n);s&&f.uniq(s)}}else l(o)||(o.focus(),d((function(){return b.restore(o)})))}function a(e,t){var o=t.nodeEditor,n=t.selection;if(n){if(t.isEmptyRight){var s=g.findBubbleRight(n);s&&f.uniq(s)}}else l(o,!0)||(o.focus(),d((function(){return b.restore(o)})))}function r(e,t){var o=t.selection;if(o){if(t.isEmptyLeft){var n=g.findBubbleLeft(o);n&&f.uniq(n)}}else{var s=t.nodeEditor,i=f.get(s),a=i.length>1&&i[0]===s.startRangeSelect?i[i.length-1]:i[0],r=g.prevBubble(a);r&&(e.shiftKey?f.range(r):f.uniq(r))}}function c(e,t){var o=t.selection;if(o){if(t.isEmptyRight){var n=g.findBubbleRight(o);n&&f.uniq(n)}}else{var s=t.nodeEditor,i=f.get(s),a=i.length>1&&i[i.length-1]===s.startRangeSelect?i[0]:i[i.length-1],r=g.nextBubble(a);r?e.shiftKey?f.range(r):f.uniq(r):b.restore(s)}}function l(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=f.get(e);if(!o.length)return!1;var n=o[0].previousSibling,s=o[o.length-1].nextSibling;if(t){var i=n;n=s,s=i}return g.removeBubbles(e,o),m.isBubbleNode(n)?f.uniq(n):m.isBubbleNode(s)?f.uniq(s):(e.focus(),d((function(){return b.restore(e)}))),e.fireChange(),!0}function u(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(p.getSelection(e))return!1;var o=f.get(e);if(!o.length)return!1;var n=e.options("bubbleCopy"),s=n(o);if(!s)return!1;e[y.LOCK_COPY]=!0;var i=e.ownerDocument.createElement("input");return i.value=s,i.style.cssText="\n        position: absolute;\n        left: -9999px;\n        width: 1px;\n        height: 1px;\n        margin: 0;\n        padding: 0;\n        border: none;",e.parentNode.appendChild(i),h.one(i,{keyup:function(){return e.focus()},blur:function(){i&&i.parentNode&&i.parentNode.removeChild(i),d(t)}}),i.select(),!0}var d=o(7),h=o(10),p=o(6),m=o(4),f=o(14),g=o(3),b=o(13),_=o(12),v=_.KEY,y=_.PROPS;e.exports=function(e,t){var o=h.keyCode(e),l=h.metaKey(e);switch(o){case v.Backspace:i(e,t);break;case v.Delete:a(e,t);break;case v.Left:r(e,t);break;case v.Right:c(e,t);break;case v.Top:e.preventDefault(),n(e,t);break;case v.Bottom:e.preventDefault(),s(e,t);break;case v.Home:e.shiftKey&&!t.isTextSelectedFromBeginToCursor&&f.has(t.nodeEditor)&&(e.preventDefault(),f.allLeft(t.nodeEditor));break;case v.a:l&&!t.isTextSelectAll&&(e.preventDefault(),f.all(t.nodeEditor));break;case v.c:l&&u(t.nodeEditor);break;case v.x:l&&u(t.nodeEditor,(function(){return a(e,t)}))}}}),(function(e,t,o){function n(e){var t=a.getEditable(e);return!!t&&i.edit(e,t)}var s=o(10),i=o(4),a=o(14),r=o(12),c=r.KEY;e.exports=function(e,t){var o=s.keyCode(e),i=e.currentTarget;o===c.Enter?(e.preventDefault(),i.options("disableControls")||t.enterBubbling||n(i)):o===c.Space&&n(i)&&e.preventDefault()}}),(function(e,t,o){function n(e,t){return a(e)||i(e,t)||s()}function s(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function i(e,t){var o=[],n=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done)&&(o.push(a.value),!t||o.length!==t);n=!0);}catch(e){s=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw i}}return o}function a(e){if(Array.isArray(e))return e}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e){var t=arguments.length<=1?void 0:arguments[1];if(t){if(e[p.OPTIONS]||l(e),"object"===r(t)&&null!==t){var o=t;return Object.keys(o).forEach((function(t){e[p.OPTIONS][t]=o[t]})),void u(e[p.OPTIONS])}var n=t,s=arguments.length<=2?void 0:arguments[2];if(void 0===s)return e[p.OPTIONS][n];e[p.OPTIONS][n]=s,u(e[p.OPTIONS])}else l(e)}function l(e){var t=e[p.OPTIONS]=e[p.OPTIONS]||{};for(var o in f){var n="data-".concat(f[o][2]);e.hasAttribute(n)&&(t[o]=e.getAttribute(n))}u(t)}function u(e){for(var t in f){var o=n(f[t],2),s=o[0],i=o[1];e[t]=g[s](e[t]),void 0===e[t]&&(e[t]=i)}}var d=o(1),h=o(12),p=h.PROPS,m=/\/(.+)\/([gimy]{0,3})/i,f={begining:["reg",null,"begining"],bubbleCopy:["func",function(e){return e.map((function(e){return e.innerHTML})).join(", ")},"bubble-copy"],bubbleDeformation:["func",function(){},"bubble-deformation"],bubbleFormation:["func",function(){},"bubble-formation"],checkBubblePaste:["func",function(){return!0},"check-bubble-paste"],checkBubbleDrop:["func",function(){return!0},"check-bubble-drop"],classBubble:["str","bubble","class-bubble"],disableControls:["bool",!1,"disable-controls"],draggable:["bool",!0,"draggable"],ending:["reg",null,"ending"],limit:["uint",0,"limit"],selection:["bool",!0,"selection"],separator:["reg",/[,;]/,"separator"],separatorCond:["func",null,"separator-cond"],tokenizer:["func",null,"tokenizer"]},g={func:function(e){switch(r(e)){case"string":return new Function("context","return context.".concat(e,";"))(d);case"function":return e}},bool:function(e){switch(r(e)){case"string":return"true"===e||"on"===e;case"boolean":return e}},noop:function(e){return e},reg:function(e){switch(r(e)){case"string":if(e){var t=e.match(m);if(t)return new RegExp(t[1],t[2])}return null;case"object":if(e instanceof d.RegExp||null===e)return e}},str:function(e){if(void 0!==e)return e?String(e):""},uint:function(e){if(e=Number(e),!isNaN(e)&&e>0)return e}};c.attributes=Object.keys(f).map((function(e){return"data-".concat(f[e][2])})),e.exports=c})])},1393:function(e,t){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),e}function a(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?r(e):t}function r(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function l(e){var t="function"==typeof Map?new Map:void 0;return(l=function(e){function o(){return d(e,arguments,m(this).constructor)}if(null===e||!h(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,o)}return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),p(o,e)})(e)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,o){return d=u()?Reflect.construct:function(e,t,o){var n=[null];n.push.apply(n,t);var s=Function.bind.apply(e,n),i=new s;return o&&p(i,o.prototype),i},d.apply(null,arguments)}function h(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var f=(function(e){function t(){var e,o;n(this,t);for(var s=arguments.length,i=new Array(s),r=0;r<s;r++)i[r]=arguments[r];var c=o=a(this,(e=m(t)).call.apply(e,[this].concat(i)));return c._isDetached=!1,c._detachedDispatchEvent=_.debounce(c._detachedDispatchEvent.bind(c),20,{leading:!0,trailing:!1}),c._attachedDispatchEvent=_.debounce(c._attachedDispatchEvent.bind(c),20,{leading:!0,trailing:!0}),c.addEventListener("DOMNodeRemoved",c._detachedDispatchEvent),c.addEventListener("DOMNodeRemovedFromDocument",c._detachedDispatchEvent),c.addEventListener("DOMNodeInserted",c._attachedDispatchEvent),c.addEventListener("DOMNodeInsertedIntoDocument",c._attachedDispatchEvent),a(o,c)}return c(t,e),i(t,[{key:"connectedCallback",value:function(){this._attachedDispatchEvent()}},{key:"disconnectedCallback",value:function(){this._detachedDispatchEvent()}},{key:"_attachedDispatchEvent",value:function(){if(this._isDetached){this._isDetached=!1;var e=document.createEvent("Event");e.initEvent("x-attached",!1,!1),this.dispatchEvent(e)}}},{key:"_detachedDispatchEvent",value:function(){if(!this._isDetached){this._isDetached=!0;var e=document.createEvent("Event");e.initEvent("x-detached",!1,!1),this.dispatchEvent(e)}}}]),t})(l(HTMLTextAreaElement));window.customElements.define("x-editor",f,{extends:"textarea"})},1394:function(e,t){!(function(){var e=!1,t=HTMLElement.prototype.removeChild,o=HTMLElement.prototype.replaceChild,n=HTMLElement.prototype.insertBefore,s=function(e){if(1===e.nodeType&&"DIV"===e.tagName&&e.hasAttribute("data-key")){if(ns.Model.get("quick-reply-state").existOpenQR()){var t=e.querySelector("textarea[is='x-editor']");t&&t.detachedDispatchEvent()}}};HTMLElement.xEditorOverrideNodeActions=function(){if(!e){ns.Model.get("quick-reply-state").existOpenQR()&&(t=HTMLElement.prototype.removeChild,o=HTMLElement.prototype.replaceChild,n=HTMLElement.prototype.insertBefore,HTMLElement.prototype.removeChild=function(e){return s(e),t.apply(this,arguments)},HTMLElement.prototype.replaceChild=function(e,t){return s(t),o.apply(this,arguments)},HTMLElement.prototype.insertBefore=function(e){return s(e),n.apply(this,arguments)},e=!0)}},HTMLElement.xEditorRestoreNodeActions=function(){if(e){ns.Model.get("quick-reply-state").existOpenQR()||(HTMLElement.prototype.removeChild=t,HTMLElement.prototype.replaceChild=o,HTMLElement.prototype.insertBefore=n,e=!1)}}})()},185:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1213);o.n(n);Jane.module("compose2.js",(function(){ns.View.prototype.composeUpdate=function(){this.info&&!this.info.isCollection&&this.invalidate(),this.isVisible()&&this.getModel("compose-state").trigger("ns-model:compose:update")},Daria.composeEqualRoutes=function(e,t){var o=_.omit(t.params,["_cuid"]),n=_.omit(e.params,["_cuid"]);return!(e.page!==t.page||!_.isEqual(n,o))},o(1214),o(1215),o(1216),o(1239),o(1262),o(1390),o(1391),o(1392),o(1393),o(1394),Daria.hasFeature("web-compose-2019")&&Jane.Services.runModules(["compose2019.js","compose2019.css"])}))},325:function(e,t,o){"use strict";function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}o.d(t,"a",(function(){return i})),o.d(t,"e",(function(){return a})),o.d(t,"c",(function(){return r})),o.d(t,"d",(function(){return c})),o.d(t,"f",(function(){return l})),o.d(t,"b",(function(){return u}));var s,i="compose-scenario",a="message-view-scenario",r="mark-as-read",c="mark-as-unread",l="search-scenario",u=(s={},n(s,i,"web_quality_metrics_log"),n(s,r,"web_quality_metrics_for_mark_mops"),n(s,c,"web_quality_metrics_for_mark_mops"),n(s,a,"web_quality_message_reading"),n(s,l,"web_quality_search"),s)},337:function(e,t,o){"use strict";var n=o(359);t.a=new n.a},339:function(e,t,o){"use strict";function n(){return Daria.isDevEnv()}function s(){return Boolean(Daria.Config.pddDomain)}function i(){return Daria.IS_CORP}function a(e){return Daria.hasFeature(e)}function r(e){return Daria.Page.isParamsForSearch(e)}function c(){return Daria.Config.NO_SETTINGS}function l(){return Daria.Config.locale}function u(){return Daria.suid}function d(){return Daria.uid}function h(){return Daria.urlParams}function p(){return Daria.UISettings.shouldShowCheckboxInsideUserpic()}function m(e){return e?Jane.Common.keyCode[e]:Jane.Common.keyCode}function f(){return Daria.shouldShowContextToolbar()}function g(e){Daria.toggleSearchAppMode(e)}function b(e){Daria.toggleVerticalScrollBar(e)}function _(){ns.events.trigger("head-tabs-recalculate")}function v(){ns.events.trigger("daria:vToolbarButton:restruct")}function y(){return Daria.hasRocksSuggest()}t.k=n,t.l=s,t.j=i,t.g=a,t.m=r,t.a=c,t.c=l,t.d=u,t.e=d,t.f=h,t.n=p,t.b=m,t.o=f,t.p=g,t.q=b,t.i=_,t.r=v,t.h=y},345:function(e,t,o){"use strict";function n(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter((function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})))),n.forEach((function(t){s(e,t,o[t])}))}return e}function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,o){return t&&a(e.prototype,t),o&&a(e,o),e}o.d(t,"a",(function(){return l})),o.d(t,"b",(function(){return u}));var c=o(325),l="Quality metrics log: ",u=(function(){function e(){i(this,e)}return r(e,null,[{key:"logStep",value:function(e,t,o){this.log(e,n({step:t},o))}},{key:"log",value:function(e,t){this.isLogDisabled(e.type)||(t=this._addSessionLifetime(t),Daria.debug.log(l,e,t),Daria.monitoring.scenario({scenario:e,params:t}))}},{key:"isLogDisabled",value:function(e){var t=c.b[e];return Boolean(t&&!Daria.hasFeature(t))}},{key:"_addSessionLifetime",value:function(e){var t=window.performance&&window.performance.now&&window.performance.now();return n({sessionLifetime:t?Math.floor(t):void 0},e)}}]),e})()},346:function(e,t,o){"use strict";o.d(t,"c",(function(){return n})),o.d(t,"b",(function(){return s})),o.d(t,"a",(function(){return i}));var n="start",s="finish",i="error"},353:function(e,t,o){"use strict";o.d(t,"c",(function(){return n})),o.d(t,"d",(function(){return s})),o.d(t,"b",(function(){return i})),o.d(t,"n",(function(){return a})),o.d(t,"k",(function(){return r})),o.d(t,"e",(function(){return c})),o.d(t,"h",(function(){return l})),o.d(t,"m",(function(){return u})),o.d(t,"j",(function(){return d})),o.d(t,"f",(function(){return h})),o.d(t,"g",(function(){return p})),o.d(t,"l",(function(){return m})),o.d(t,"i",(function(){return f})),o.d(t,"a",(function(){return g}));var n="default",s="direct-url",i="button-from-left-column",a="shortcut",r="reply-button-from-context-menu",c="forward-from-context-menu",l="forward-button-from-message-toolbar",u="reply-button-from-message-toolbar",d="reply-all-button-from-message-toolbar",h="forward-button-from-messages-toolbar",p="forward-button-from-message-body-toolbar",m="reply-button-from-message-body-toolbar",f="reply-all-button-from-message-body-toolbar",g="button-from-abook-popup"},359:function(e,t,o){"use strict";function n(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter((function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})))),n.forEach((function(t){s(e,t,o[t])}))}return e}function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function i(e,t){if(null==e)return{};var o,n,s=a(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(s[o]=e[o])}return s}function a(e,t){if(null==e)return{};var o,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||(s[o]=e[o]);return s}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,o){return t&&c(e.prototype,t),o&&c(e,o),e}o.d(t,"a",(function(){return p}));var u=o(345),d=o(346),h=o(360),p=(function(){function e(){r(this,e),this._logger=u.b,this._activeScenarios={}}return l(e,[{key:"startScenario",value:function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.hasActiveScenario(e)&&Daria.debug.warn(u.a,'Scenario "',this.getActiveScenario(e),'" already started. ',t,o);var n=new h.a(e);return this._activateScenarioAndLogStart(n,e,t,o)}},{key:"startParallelScenario",value:function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=new h.a(e);return this._activateScenarioAndLogStart(n,n.id,t,o)}},{key:"_activateScenarioAndLogStart",value:function(e,t,o,s){var a,r=s;return a=r.startTime,s=i(r,["startTime"]),e.setStartTime(a),this._setActiveScenario(t,e),this._logger.logStep(e,d.c,n({initiator:o},s)),e}},{key:"finishScenarioIfActive",value:function(e,t,o){if(this.hasActiveScenario(e)){var s=this.getActiveScenario(e).setFinishTime();this._removeActiveScenario(e),this._logger.logStep(s,d.b,n({finalizer:t},o))}}},{key:"finishScenario",value:function(e,t,o){if(!this.hasActiveScenario(e))return void Daria.debug.warn(u.a,'There is no active "'.concat(e,'" scenario. '),t,o);this.finishScenarioIfActive(e,t,o)}},{key:"hasActiveScenario",value:function(e){return Boolean(this.getActiveScenario(e))}},{key:"getActiveScenario",value:function(e){return this._activeScenarios[e]}},{key:"_setActiveScenario",value:function(e,t){return this._activeScenarios[e]=t}},{key:"_removeActiveScenario",value:function(e){delete this._activeScenarios[e]}}]),e})()},360:function(e,t,o){"use strict";function n(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter((function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})))),n.forEach((function(t){s(e,t,o[t])}))}return e}function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,o){return t&&a(e.prototype,t),o&&a(e,o),e}o.d(t,"a",(function(){return d}));var c=o(123),l=(o.n(c),o(345)),u=o(346),d=(function(){function e(t){i(this,e),this.id=Object(c.uniqueId)(Daria.Config.connection_id+"_"),this.type=t}return r(e,[{key:"setStartTime",value:function(e){return this.startTime=Math.floor(e||Daria.now()),this}},{key:"getTimeFromStart",value:function(){return Math.floor(Daria.now()-this.startTime)}},{key:"setFinishTime",value:function(){return this.finishTime=Math.floor(Daria.now()),this}},{key:"logStep",value:function(e,t){l.b.log(this,n({step:e},t))}},{key:"logError",value:function(e,t){var o=e.type,s=e.severity;l.b.log(this,n({step:u.a,type:o,severity:s},t))}}]),e})()},390:function(e,t,o){"use strict";function n(e,t,o){if(Object(i.k)()&&!e.errorType)throw new Error("Необходимо указать errorType при логировании ошибки");if(Object(i.k)()&&e.failIfPossible)throw e;Jane.ErrorLog.send(e,t,o)}function s(e){Object(i.k)()&&console.warn(e)}t.b=n,t.a=s;var i=o(339)},543:function(e,t){function o(e,t){for(var o=999,i=1,a=[];e&&o;)i>0?(e=s(e,a,t),i=-1):(e=n(e,a,t),i=1),o--;return a}function n(e,t,o){for(var n=!1,s=0;s<e.length;++s){var i=e[s];if(l(e,s)&&(n=!n),!n&&o[i]){var r=e.substring(0,s).trim();r&&t.push(r),e=a(e,0,s+1),s=-1}}return e&&(t.push(e.trim()),e=""),e}function s(e,t,o){for(var n=0;n<e.length;++n){if(">"===e.charAt(n)){var s=e.substring(0,n+1).trim();if(s&&u.test(s)){var r=[];s=i(s,t,o),r.length&&t.push.apply(t,r),t.push(s),e=a(e,0,n+1),n=-1}}}return e.trim()}function i(e,t,o){for(var n=!1,s=0;s<e.length;++s){var i=e[s];if(l(e,s)&&(n=!n),!n&&o[i]){var r=e.substring(0,s).trim();r&&!c(r,i)||(r&&t.push(r),e=a(e,0,s+1),s=-1)}}return e.trim()}function a(e,t,o){return e.substr(0,t)+(o>0?e.substr(o):"")}function r(e){return'"'===e[0]&&'"'===e[e.length-1]}function c(e,t){return(" "!==t||!r(e))&&Jane.FormValidation.checkEmail(e)}function l(e,t){return'"'===e[t]&&(0===t||"\\"!==e[t-1])}var u=/^(.*)<[^<>]*>$/,d={",":!0,";":!0," ":!0};e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d;return function(t){return o(t,e)}},e.exports.SEPARATORS=d},544:function(e,t,o){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),e}function a(){return Object(l.l)()?"pdd":Object(l.j)()?"corp":"big"}function r(e){return["project=search_mail","product="+f,"reqid="+e.getSearchSessionId()]}function c(e){var t=[];return d.forEach((function(o){e.hasOwnProperty(o)&&t.push(o+":"+e[o])})),t.join(",")}o.d(t,"a",(function(){return m})),o.d(t,"b",(function(){return f}));var l=o(339),u=o(390),d=["scope","fid","lid","unread","attaches","from","to","type"],h=Object.freeze({history:'Выбор "прошлый запрос"',subject:'Выбор "тема"',important:'Выбор "важные"',unread:'Выбор "непрочитанное письмо"',folder:'Выбор "папки"',ql:'Выбор "язык запросов"',contact:'Выбор "контакты"',mail:'Выбор "письма"',label:'Выбор "метки"',"show-all-results":'Выбор "показать все результаты по запросу"'}),p=Object.freeze({button:"Клик по Найти",enter:"Нажатие Enter",advanced:"Расширенные настройки",suggest:"Саджест"}),m=(function(){function e(t,o){n(this,e),this._suggestWasLogged=!1,this._stores=t,this._services=o}return i(e,[{key:"logMessageClick",value:function(e,t,o,n,s){var i=this._stores,a=i.searchStore,u=i.routerStore,d=u.currentPage.params;if(Object(l.m)(d)){var h=a.showSearchResultsTimestamp,p=Date.now()-h,m=[].concat(r(a),["r="+encodeURIComponent(s.request),"pos="+o,"user="+Object(l.e)(),"mid="+t,"time="+p,"clicktype="+e]);n&&m.push("tophits=yes");var f=c(s);f&&m.push("filter="+f);var g=(Daria.Config["exp-test-ids"]||[]).join(",");g&&m.push("exp="+g),Daria.searchClickCounter(m)}}},{key:"logSearchSuggest",value:function(e){var t=this._stores.searchStore,o=t.suggestItems.length;if(!e.suggestWithEmptyRequest||0!==o){var n=[].concat(r(t),["action=suggest","uid="+Object(l.e)(),"user_text="+encodeURIComponent(e.text||""),"count="+o]);if(e.suggestUsed){var s=e.target||"";n.push("pos="+e.itemPos,"target="+s,"show_text="+encodeURIComponent(e.show_text||""),"search_text="+encodeURIComponent(e.search_text||""),"suggest_used=yes"),this._metrikaCountSuggestItemClick(s)}else e.suggestWithEmptyRequest||n.push("suggest_used=no");Daria.searchClickCounter(n)}}},{key:"_metrikaCountSuggestItemClick",value:function(e){var t=h[e];if(!t)return void Object(u.b)({errorType:"search-log-service:unknown-target",failIfPossible:!0});this.countSuggestAction(t)}},{key:"countSuggestAction",value:function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];Jane.c.apply(Jane,["Поиск","Cаджест"].concat(t))}},{key:"countSearchActivation",value:function(){Jane.c("Поиск","Активация поисковой строки")}},{key:"countLogoClick",value:function(e){Jane.c("Поиск","Клик в логотип",e?"Почта":"Яндекс/компания")}},{key:"countTextCleared",value:function(){Jane.c("Поиск","Клик в крест (очистка)")}},{key:"countSuggestClose",value:function(){Jane.c("Поиск","Клик в крест (закрытие)")}},{key:"countFolderBubble",value:function(e){Jane.c("Поиск","Баллун папки",e)}},{key:"logSearch",value:function(e){var t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3?arguments[3]:void 0,i=this._stores.searchStore;if(o.from){var r=o.from.substr(0,6);t=r!==(o.to||"").substr(0,6)?r.substr(0,4):r}var c={type:"search.start-search",suid:Object(l.d)(),advanced:s,action:n.metrika,text:e||"",message_type:o.type||"",folder:o.fid||"",label:o.lid||"",date:t||"",mail_type:a(),searchid:i.getSearchId(),reqid:i.getSearchSessionId()};Jane.ErrorLog.send(c),Jane.c("Поиск","Переход к результатам поиска",p[n.metrika])}},{key:"countAdvancedSearch",value:function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];Jane.c.apply(Jane,["Поиск","Расширенный поиск"].concat(t))}},{key:"logToggleAdvanced",value:function(e,t){Jane.ErrorLog.send({type:"search.toggle-advanced",suid:Object(l.d)(),text:e,action:t?"open":"close",mail_type:a()}),t&&this.countAdvancedSearch("Клик в иконку/открытие дропдауна")}},{key:"suggestWasLogged",get:function(){return this._suggestWasLogged},set:function(e){this._suggestWasLogged=e}}]),e})(),f=(function(){return Object(l.l)()?"webpdd":Object(l.j)()?"YT":"web"})()},724:function(e,t,o){function n(e){return"string"!=typeof e?[]:e.split(d).filter((function(e){return Boolean(e)}))}function s(e){new(this||Daria.BaseBubble)(e).applyTo(e)}function i(e){return _.unescape(e.getAttribute("data-yabble-value"))||e.innerText}function a(e){var t=this||Daria.BaseBubble,o=t.toString(e),n=o.indexOf('"');n=-1!==n?n+1:0;var s=o.lastIndexOf('"');return s=s>n?s:o.length,{text:o,startOffset:n,endOffset:s}}function r(e){var t=Daria.Constants.CONTACTS.DELIMITER,o=this||Daria.BaseBubble;return e.map(o.toString,o).join(t)}function c(){return!0}function l(e){var t=this||Daria.BaseBubble;return Array.isArray(e)&&e.every((function(e){return e.className.split(" ").indexOf(t.BUBBLE_CLASS)>-1}))}var u=o(543).SEPARATORS,d=new RegExp("["+Object.keys(u).join("")+"]","g"),h={tokenizer:n,update:s,node2object:a,getCopyString:r,checkPaste:c,checkDrop:l,toString:i};e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){var o=Object.assign({},h,e);return Object.keys(o).forEach((function(e){t[e]=o[e].bind(t)})),t}}},725:function(e,t,o){"use strict";function n(e,t){for(var o=t.length;o--;)"string"==typeof t[o]&&(t[o]=t[o].toLowerCase()),e[t[o]]=!0;return e}function s(e){var t={},o=void 0;for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}function i(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:D(),t=function(e){return a(e)};if(t.version="1.0.3",t.removed=[],!e||!e.document||9!==e.document.nodeType)return t.isSupported=!1,t;var o=e.document,M=!1,k=!1,E=e.document,A=e.DocumentFragment,T=e.HTMLTemplateElement,F=e.Node,I=e.NodeFilter,x=e.NamedNodeMap,B=void 0===x?e.NamedNodeMap||e.MozNamedAttrMap:x,N=e.Text,R=e.Comment,L=e.DOMParser,O=e.XMLHttpRequest,V=void 0===O?e.XMLHttpRequest:O,P=e.encodeURI,j=void 0===P?e.encodeURI:P;if("function"==typeof T){var $=E.createElement("template");$.content&&$.content.ownerDocument&&(E=$.content.ownerDocument)}var H=E,U=H.implementation,q=H.createNodeIterator,z=H.getElementsByTagName,Y=H.createDocumentFragment,J=o.importNode,G={};t.isSupported=U&&void 0!==U.createHTMLDocument&&9!==E.documentMode;var K=g,Q=b,W=_,X=v,Z=C,ee=S,te=y,oe=null,ne=n({},[].concat(i(r),i(c),i(l),i(u),i(d))),se=null,ie=n({},[].concat(i(h),i(p),i(m),i(f))),ae=null,re=null,ce=!0,le=!0,ue=!1,de=!1,he=!1,pe=!1,me=!1,fe=!1,ge=!1,be=!1,_e=!1,ve=!0,ye=!0,Ce={},Se=n({},["audio","head","math","script","style","template","svg","video"]),we=n({},["audio","video","img","source","image"]),De=n({},["alt","class","for","id","label","name","pattern","placeholder","summary","title","value","style","xmlns"]),Me=null,ke=E.createElement("form"),Ee=function(e){"object"!==(void 0===e?"undefined":w(e))&&(e={}),oe="ALLOWED_TAGS"in e?n({},e.ALLOWED_TAGS):ne,se="ALLOWED_ATTR"in e?n({},e.ALLOWED_ATTR):ie,ae="FORBID_TAGS"in e?n({},e.FORBID_TAGS):{},re="FORBID_ATTR"in e?n({},e.FORBID_ATTR):{},Ce="USE_PROFILES"in e&&e.USE_PROFILES,ce=!1!==e.ALLOW_ARIA_ATTR,le=!1!==e.ALLOW_DATA_ATTR,ue=e.ALLOW_UNKNOWN_PROTOCOLS||!1,de=e.SAFE_FOR_JQUERY||!1,he=e.SAFE_FOR_TEMPLATES||!1,pe=e.WHOLE_DOCUMENT||!1,ge=e.RETURN_DOM||!1,be=e.RETURN_DOM_FRAGMENT||!1,_e=e.RETURN_DOM_IMPORT||!1,fe=e.FORCE_BODY||!1,ve=!1!==e.SANITIZE_DOM,ye=!1!==e.KEEP_CONTENT,te=e.ALLOWED_URI_REGEXP||te,he&&(le=!1),be&&(ge=!0),Ce&&(oe=n({},[].concat(i(d))),se=[],!0===Ce.html&&(n(oe,r),n(se,h)),!0===Ce.svg&&(n(oe,c),n(se,p),n(se,f)),!0===Ce.svgFilters&&(n(oe,l),n(se,p),n(se,f)),!0===Ce.mathMl&&(n(oe,u),n(se,m),n(se,f))),e.ADD_TAGS&&(oe===ne&&(oe=s(oe)),n(oe,e.ADD_TAGS)),e.ADD_ATTR&&(se===ie&&(se=s(se)),n(se,e.ADD_ATTR)),e.ADD_URI_SAFE_ATTR&&n(De,e.ADD_URI_SAFE_ATTR),ye&&(oe["#text"]=!0),Object&&"freeze"in Object&&Object.freeze(e),Me=e},Ae=function(e){t.removed.push({element:e});try{e.parentNode.removeChild(e)}catch(t){e.outerHTML=""}},Te=function(e,o){t.removed.push({attribute:o.getAttributeNode(e),from:o}),o.removeAttribute(e)},Fe=function(e){var t=void 0,o=void 0;if(fe&&(e="<remove></remove>"+e),k){try{e=j(e)}catch(e){}var n=new V;n.responseType="document",n.open("GET","data:text/html;charset=utf-8,"+e,!1),n.send(null),t=n.response}if(M)try{t=(new L).parseFromString(e,"text/html")}catch(e){}return t&&t.documentElement||(t=U.createHTMLDocument(""),o=t.body,o.parentNode.removeChild(o.parentNode.firstElementChild),o.outerHTML=e),z.call(t,pe?"html":"body")[0]};t.isSupported&&(function(){var e=Fe('<svg><g onload="this.parentNode.remove()"></g></svg>');e.querySelector("svg")||(k=!0);try{e=Fe('<svg><p><style><img src="</style><img src=x onerror=alert(1)//">'),e.querySelector("svg img")&&(M=!0)}catch(e){}})();var Ie=function(e){return q.call(e.ownerDocument||e,e,I.SHOW_ELEMENT|I.SHOW_COMMENT|I.SHOW_TEXT,(function(){return I.FILTER_ACCEPT}),!1)},xe=function(e){return!(e instanceof N||e instanceof R)&&!("string"==typeof e.nodeName&&"string"==typeof e.textContent&&"function"==typeof e.removeChild&&e.attributes instanceof B&&"function"==typeof e.removeAttribute&&"function"==typeof e.setAttribute)},Be=function(e){return"object"===(void 0===F?"undefined":w(F))?e instanceof F:e&&"object"===(void 0===e?"undefined":w(e))&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},Ne=function(e,o,n){G[e]&&G[e].forEach((function(e){e.call(t,o,n,Me)}))},Re=function(e){var o=void 0;if(Ne("beforeSanitizeElements",e,null),xe(e))return Ae(e),!0;var n=e.nodeName.toLowerCase();if(Ne("uponSanitizeElement",e,{tagName:n,allowedTags:oe}),!oe[n]||ae[n]){if(ye&&!Se[n]&&"function"==typeof e.insertAdjacentHTML)try{e.insertAdjacentHTML("AfterEnd",e.innerHTML)}catch(e){}return Ae(e),!0}return!de||e.firstElementChild||e.content&&e.content.firstElementChild||!/</g.test(e.textContent)||(t.removed.push({element:e.cloneNode()}),e.innerHTML=e.textContent.replace(/</g,"&lt;")),he&&3===e.nodeType&&(o=e.textContent,o=o.replace(K," "),o=o.replace(Q," "),e.textContent!==o&&(t.removed.push({element:e.cloneNode()}),e.textContent=o)),Ne("afterSanitizeElements",e,null),!1},Le=function(e){var o=void 0,n=void 0,s=void 0,i=void 0,a=void 0,r=void 0,c=void 0;if(Ne("beforeSanitizeAttributes",e,null),r=e.attributes){var l={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:se};for(c=r.length;c--;){if(o=r[c],n=o.name,s=o.value.trim(),i=n.toLowerCase(),l.attrName=i,l.attrValue=s,l.keepAttr=!0,Ne("uponSanitizeAttribute",e,l),s=l.attrValue,"name"===i&&"IMG"===e.nodeName&&r.id)a=r.id,r=Array.prototype.slice.apply(r),Te("id",e),Te(n,e),r.indexOf(a)>c&&e.setAttribute("id",a.value);else{if("INPUT"===e.nodeName&&"type"===i&&"file"===s&&(se[i]||!re[i]))continue;"id"===n&&e.setAttribute(n,""),Te(n,e)}if(l.keepAttr&&(!ve||"id"!==i&&"name"!==i||!(s in E||s in ke))){if(he&&(s=s.replace(K," "),s=s.replace(Q," ")),le&&W.test(i));else if(ce&&X.test(i));else{if(!se[i]||re[i])continue;if(De[i]);else if(te.test(s.replace(ee,"")));else if("src"!==i&&"xlink:href"!==i||0!==s.indexOf("data:")||!we[e.nodeName.toLowerCase()]){if(ue&&!Z.test(s.replace(ee,"")));else if(s)continue}else;}try{e.setAttribute(n,s),t.removed.pop()}catch(e){}}}Ne("afterSanitizeAttributes",e,null)}},Oe=function e(t){var o=void 0,n=Ie(t);for(Ne("beforeSanitizeShadowDOM",t,null);o=n.nextNode();)Ne("uponSanitizeShadowNode",o,null),Re(o)||(o.content instanceof A&&e(o.content),Le(o));Ne("afterSanitizeShadowDOM",t,null)};return t.sanitize=function(n,s){var i=void 0,a=void 0,r=void 0,c=void 0,l=void 0;if(n||(n="\x3c!--\x3e"),"string"!=typeof n&&!Be(n)){if("function"!=typeof n.toString)throw new TypeError("toString is not a function");if("string"!=typeof(n=n.toString()))throw new TypeError("dirty is not a string, aborting")}if(!t.isSupported){if("object"===w(e.toStaticHTML)||"function"==typeof e.toStaticHTML){if("string"==typeof n)return e.toStaticHTML(n);if(Be(n))return e.toStaticHTML(n.outerHTML)}return n}if(me||Ee(s),t.removed=[],n instanceof F)i=Fe("\x3c!--\x3e"),a=i.ownerDocument.importNode(n,!0),1===a.nodeType&&"BODY"===a.nodeName?i=a:i.appendChild(a);else{if(!ge&&!pe&&-1===n.indexOf("<"))return n;if(!(i=Fe(n)))return ge?null:""}fe&&Ae(i.firstChild);for(var u=Ie(i);r=u.nextNode();)3===r.nodeType&&r===c||Re(r)||(r.content instanceof A&&Oe(r.content),Le(r),c=r);if(ge){if(be)for(l=Y.call(i.ownerDocument);i.firstChild;)l.appendChild(i.firstChild);else l=i;return _e&&(l=J.call(o,l,!0)),l}return pe?i.outerHTML:i.innerHTML},t.setConfig=function(e){Ee(e),me=!0},t.clearConfig=function(){Me=null,me=!1},t.addHook=function(e,t){"function"==typeof t&&(G[e]=G[e]||[],G[e].push(t))},t.removeHook=function(e){G[e]&&G[e].pop()},t.removeHooks=function(e){G[e]&&(G[e]=[])},t.removeAllHooks=function(){G={}},t}var r=["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"],c=["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","audio","canvas","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","video","view","vkern"],l=["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feMerge","feMergeNode","feMorphology","feOffset","feSpecularLighting","feTile","feTurbulence"],u=["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmuliscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mpspace","msqrt","mystyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"],d=["#text"],h=["accept","action","align","alt","autocomplete","background","bgcolor","border","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","coords","crossorigin","datetime","default","dir","disabled","download","enctype","face","for","headers","height","hidden","high","href","hreflang","id","integrity","ismap","label","lang","list","loop","low","max","maxlength","media","method","min","multiple","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","type","usemap","valign","value","width","xmlns"],p=["accent-height","accumulate","additivive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"],m=["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"],f=["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"],g=/\{\{[\s\S]*|[\s\S]*\}\}/gm,b=/<%[\s\S]*|[\s\S]*%>/gm,_=/^data-[\-\w.\u00B7-\uFFFF]/,v=/^aria-[\-\w]+$/,y=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,C=/^(?:\w+script|data):/i,S=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g,w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},D=function(){return"undefined"==typeof window?null:window},M=a();t.a=M},726:function(e,t,o){"use strict";function n(e){return a(e)||i(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function a(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}function r(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter((function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})))),n.forEach((function(t){c(e,t,o[t])}))}return e}function c(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,o){return t&&u(e.prototype,t),o&&u(e,o),e}o.d(t,"a",(function(){return h}));var h=(function(){function e(){l(this,e)}return d(e,[{key:"getPageAfterSent",value:function(){return Daria.is3pane()||Daria.hasFeature("web-compose-2019")?"prev":ns.Model.get("settings").getSetting("page_after_send")}},{key:"whereToGoAfterSend",value:function(){var e,t=ns.Model.get("folders");switch(this.getPageAfterSent()){case"done":e=ns.router.generateUrl("done");break;case"sent_list":e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol("sent")});break;case"current_list":e=ns.page.history.getPreviousPageUrl({match:"messages"});break;case"prev":e=ns.page.history.getPreviousPageUrl({mismatch:"compose2"})}if(!e){e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol("inbox")})}return e}},{key:"showMessageSentNotification",value:function(e){var t=e.fromQR,o=e.sentMid,n=e.wasSendCancelled,s=e.isDelayed,i=e.sendTime;if(n)return!1;var a=Daria.SendMail.shouldShowUndoSend(),r={};if(a){var c=Daria.SendMail.getUndoSendLogger();r.onClose=function(){c.logClose()},r.onCancel=function(){c.logCancel()}}if(s)return Daria.SendMail.showMessageSentDelayed(o,i,r),!0;var l=!1;if(t)l=a;else{var u=ns.Model.get("settings"),d="done"===u.getSetting("page_after_send");l=Daria.is3pane()||!d||a}return!!l&&(Daria.SendMail.showMessageSent(o,r),!0)}},{key:"sendMetrika",value:function(){Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("SEND")}},{key:"leaveCompose",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.clearPageBlock,n=t.neverReturn;o&&ns.page.block.clear();var s=this.pageGoUrl||ns.page.history.getPreviousPageUrl({mismatch:"compose2"})||ns.page.HOME_HASH,i=ns.router(s);i.page===ns.R.REDIRECT&&(i=ns.router(i.redirect)),i.params=_.omit(i.params,"_cuid");var a=_.delay((function(){Jane.ErrorLog.send({event:"after_send_wait_10_sec"})}),1e4),r=_.delay((function(){Jane.ErrorLog.send({event:"after_send_wait_20_sec"}),ns.page.go(ns.page.HOME_HASH)}),2e4),c=ns.router.generateUrl(i.page,i.params);return ns.page.go(c,n?"replace":null).fail((function(t){return e.handleLeaveComposeFail(c,t)})).always((function(e){return window.clearTimeout(a),window.clearTimeout(r),e}))}},{key:"handleLeaveComposeFail",value:function(e,t){var o=this,n=r({},t,{event:"compose_leave_failed",loadingHash:e});return Jane.ErrorLog.send(n),this.handleTransitionFail(t,(function(e,t){return ns.page.go(t).fail(o.handleTransitionFail)}),[ns.page.HOME_HASH])}},{key:"handleTransitionFail",value:function(e,t,o){if(t=t||Vow.reject,o=Array.isArray(o)?o:[],"expired"!==(e&&e.error)){var s=t.apply(null,[e].concat(n(o)));return s instanceof Vow.Promise?s:Vow.reject(s)}return Vow.resolve(e)}}]),e})()},882:function(e,t,o){"use strict";o.d(t,"b",(function(){return n})),o.d(t,"a",(function(){return s})),o.d(t,"d",(function(){return i})),o.d(t,"c",(function(){return a})),o.d(t,"f",(function(){return r})),o.d(t,"e",(function(){return c}));var n="exit-without-saving-draft-popup",s="exit-without-saving-draft",i="exit-with-successful-draft-save",a="exit-with-failed-draft-save",r="successful-sending",c="successful-delayed-sending"},883:function(e,t,o){"use strict";var n=o(1352);t.a={DEBOUNCES:n.a}}});