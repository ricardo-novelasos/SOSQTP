webpackJsonp([4],{198:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(3050);t.n(a);Jane.module("messages.js",(function(){t(3051),t(3054),t(3061),t(3069),t(3137),t(3138)}))},3050:function(e,s){},3051:function(e,s,t){t(3052),t(3053)},3052:function(e,s){!(function(){ns.action.define("shortcuts.switch-tab",(function(e,s,t,a){var i={event:a,params:s};Daria.Shortcuts.switchTab(i)}))})()},3053:function(e,s){ns.action.define("messages.deselect",(function(){$(document).trigger("b-mail-dropdown-closeall"),ns.events.trigger("daria:vMessages:deselect")}))},3054:function(e,s,t){!(function(){var e={messages:{},"messages-notification-box@":function(e){return e.search?"messages-notification-search":"messages-notification"},"messages-empty-wrap":{}},s={"messages-list":{"messages-list-box@":{"messages-wrap":e}}};Daria.is3pane()&&(s["messages-box@"]=function(e){var s={};return e.thread_id?s["message-thread&"]=function(){var e={"important-toggleable":{},"read-toggleable-thread":{},"message-thread-head-subject":{"message-thread-messages-count":{}},"message-thread-pager":{},"message-thread-list":{},"message-fake-list":{},"thread-quick-reply":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),e}:e.ids?(s.message={"message-head":function(){var e={"message-head-subject":{"message-head-go-to-thread-box@":function(){return Daria.showGoToThreadControl()?{"message-head-go-to-thread":{}}:{}},"message-head-labels":{}},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"important-toggleable-head":{},"read-toggleable-head":{},"message-head-sender-wrap":{},"message-head-date":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={}),e},"message-widget&":{},"message-toolbar&":{},"message-body&":{},"attachments-widget-body&":{},"3pane-scroller":{}},s["message-fake-list"]={},s["thread-quick-reply"]={}):s["message-empty"]={},s}),Daria.is2pane()&&(s["messages-date-pager-float-box@"]=function(e){if(e.datePager&&"messages"===ns.page.current.page)return{"messages-date-pager-float":!0}},s.footer={"footer-journal-link&":{},"footer-help-link":{}},e["messages-pager-box@"]=function(){var e={"messages-pager-load-more":{}};return e["messages-pager-date-box@"]=function(){return Daria.isFoldersTabPage()?{}:{"messages-pager-date&":{}}},e["messages-pager-nav&"]={},e["themes-messages-list-control@"]=function(){return"tanks"===ns.Model.get("settings").getSetting("color_scheme")?{"tanks-button-to-news-widget":{}}:{}},{"messages-pager":e}}),ns.layout.define("messages",{"app right-box@":function(e){if(e.search){var t=_.cloneDeep(s);return t["messages-search-session"]={},t}return s}},"common+left+toolbar"),t(3055),t(3056),t(3057),t(3058),t(3059),t(3060)})()},3055:function(e,s){ns.layout.define("layout-messages-item-thread",{"messages-item-inner-box@":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}}),ns.layout.define("layout-messages-item-thread-empty",{"messages-item-inner-box@":{}})},3056:function(e,s){ns.layout.define("layout-message-thread-item",{"message-thread-item-box@":{"message-thread-item":function(){var e={"read-toggleable":{},"message-thread-item-userpic":{},"messages-item-labels":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),Daria.shouldShowContextToolbar()?e["important-toggler"]={}:e["important-toggleable"]={},e}}})},3057:function(e,s){ns.layout.define("layout-message-thread-message",{"message-thread-item-box@":{message:{"message-head":function(){var e={"message-head-date":{},"message-head-labels":{},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"read-toggleable-head":{},"message-head-sender-wrap":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={}),Daria.shouldShowContextToolbar()?e["important-toggler"]={}:e["important-toggleable-head"]={},e},"message-toolbar":{},"message-widget&":{},"message-body&":{},"attachments-widget-body&":{}}}})},3058:function(e,s){ns.layout.define("layout-messages-empty",{"messages-empty-box@":{}}),ns.layout.define("layout-messages-empty-view",{"messages-empty-box@":{"messages-empty":{}}})},3059:function(e,s){ns.layout.define("layout-messages-item-checkbox",{"messages-item-checkbox-box@":{"messages-item-checkbox":{}}}),ns.layout.define("layout-messages-item-thread-checkbox",{"messages-item-checkbox-box@":{"messages-item-thread-checkbox":{}}}),ns.layout.define("layout-messages-item-checkbox-nb",{"messages-item-checkbox-box@":{"messages-item-checkbox-nb":{}}}),ns.layout.define("layout-messages-item-thread-checkbox-nb",{"messages-item-checkbox-box@":{"messages-item-thread-checkbox-nb":{}}})},3060:function(e,s){function t(e){for(var s=1;s<arguments.length;s++){var t=null!=arguments[s]?arguments[s]:{},i=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),i.forEach((function(s){a(e,s,t[s])}))}return e}function a(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}ns.layout.define("layout-message-opened",{"messages-item-box@":{message:{"message-head":function(){var e=ns.Model.get("message",ns.page.current.params),s={"message-head-labels":{},"message-thread-prev-next":{},"message-close-button":{}};"yes"!==ns.page.current.params.threaded||Daria.Widgets.shouldShowEvents(e)||delete s["message-thread-prev-next"],s["message-head-go-to-thread-box@"]=function(){return Daria.showGoToThreadControl()?{"message-head-go-to-thread":{}}:{}},Daria.showPriorityLabel()&&(s["priority-toggleable-head"]={});var t={"message-head-subject":s,"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"read-toggleable-head":{},"message-head-sender-wrap":{},"message-head-date":{}};return Daria.shouldShowContextToolbar()?t["important-toggler"]={}:t["important-toggleable-head"]={},t},"message-widget&":{},"message-toolbar&":{},"message-body&":{},"attachments-widget-body&":{}},"message-fake-list":{}}}),(function(){ns.layout.define(Daria.messages.createMessagesItemLayout(),{"messages-item-box@":{"messages-item":{}}}),ns.layout.define(Daria.messages.createMessagesItemLayout({threadInner:!0}),{"messages-item-box@":{"messages-item":{},"messages-item-inner":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}}})})(),ns.layout.define(Daria.messages.createMessagesItemLayout({threadFull:!0}),{"messages-item-box@":{"message-thread&":function(){var e={"read-toggleable-thread":{},"message-thread-head-subject":{"message-thread-messages-count":{}},"message-thread-prev-next":{},"message-thread-pager":{},"message-thread-more-button":{},"message-close-button":{},"message-thread-list":{},"message-fake-list":{},"thread-quick-reply":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),Daria.shouldShowContextToolbar()?e["important-toggler"]={}:e["important-toggleable"]={},e}}}),(function(){["attachments","events","ticket","widget"].forEach((function(e){var s={},a={};"attachments"===e&&(a["attachments-widget-box@"]=function(){return Daria.isAttachmentsLineDesign()?{"attachments-tab-widget&":{}}:{"attachments-widget&":{}}}),s["messages-item-"+e]=function(){var s=t({},a);return"ticket"===e&&Daria.isAttachmentsLineDesign()&&(s["attachments-widget-box@"]={"attachments-tab-widget&":{}}),s};var i=_.extend({},s,{"messages-item-inner":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}});ns.layout.define(Daria.messages.createMessagesItemLayout({widget:e}),{"messages-item-box@":s}),ns.layout.define(Daria.messages.createMessagesItemLayout({widget:e,threadInner:!0}),{"messages-item-box@":i})}))})()},3061:function(e,s,t){t(3062),t(3063),t(3064),t(3065),t(3066),t(3067),t(3068)},3062:function(e,s){ns.Model.define("save-event-by-ics",{params:{ids:null,hid:null,stid:null,decision:null}},"base-calendar-event")},3063:function(e,s){ns.Model.define("message-type-labels",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){for(var e=[{type:2,label:i18n("%Messages_Title_By_Type_2")},{type:4,label:i18n("%Messages_Title_By_Type_4")},{type:5,label:i18n("%Messages_Title_By_Type_5")},{type:6,label:i18n("%Messages_Title_By_Type_6")},{type:7,label:i18n("%Messages_Title_By_Type_7")},{type:8,label:i18n("%Messages_Title_By_Type_8")},{type:12,label:i18n("%Messages_Title_By_Type_12")},{type:13,label:i18n("%Messages_Title_By_Type_13")},{type:14,label:i18n("%Messages_Title_By_Type_14")},{type:15,label:i18n("%Messages_Title_By_Type_15")},{type:16,label:i18n("%Messages_Title_By_Type_16")},{type:17,label:i18n("%Messages_Title_By_Type_17")},{type:18,label:i18n("%Messages_Title_By_Type_18")},{type:19,label:i18n("%Messages_Title_By_Type_19")},{type:20,label:i18n("%Messages_Title_By_Type_20")},{type:21,label:i18n("%Messages_Title_By_Type_21")},{type:22,label:i18n("%Messages_Title_By_Type_22")},{type:23,label:i18n("%Messages_Title_By_Type_23")},{type:25,label:i18n("%Messages_Title_By_Type_25")},{type:26,label:i18n("%Messages_Title_By_Type_26")},{type:30,label:i18n("%Messages_Title_By_Type_30")},{type:35,label:i18n("%Messages_Title_By_Type_35")}],s=[],t=0,a=e.length;t<a;t++)s.push(e[t].type);this.setData({labels:e,knownTypes:s})}}},ns.ModelStatic)},3064:function(e,s){!(function(){var e={};ns.Model.define("get-link-app",{params:{app:"mail-wpv",phone_full:null,phone_id:null},methods:e})})()},3065:function(e,s){ns.Model.define("message-in-reply-to",{params:{mid:null,message_id:null}})},3066:function(e,s){ns.Model.define("message-thread-toolbar",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null},ctor:function(){this.recalculateButtons=this.recalculateButtons.bind(this)},methods:{onBeforeDestroyed:function(){this._unbindModelEvents()},request:function(){return ns.request(["message"],{ids:this.params.ids}).then(this._bindModelEvents,this)},_bindModelEvents:function(e){this.mMessage=_.find(e,"id","message"),this.mMessage.on("ns-model-changed",this.recalculateButtons),this.recalculateButtons()},_unbindModelEvents:function(){this.mMessage.off("ns-model-changed",this.recalculateButtons)},recalculateButtons:function(){var e=this.mMessage,s=e.inFolderBySymbol("archive"),t=e.isSpam(),a=e.isPinned(),i=e.isImportant(),n=_.contains(e.getSOLabels(),"12"),o=e.isNew(),r=e.isValidForPin(),d=Daria.Constants.TOOLBAR_BUTTONS,l=[{id:d.MARK_AS_READ,condition:o},{id:d.MARK_AS_UNREAD,condition:!o},{id:d.DELETE,condition:!0},{id:d.SPAM,condition:!t&&!n},{id:d.NOT_SPAM,condition:t},{id:d.FORWARD,condition:!n},{id:d.ARCHIVE,condition:!s}];Daria.shouldShowContextToolbar()&&(l=l.concat([{id:d.MARK_IMPORTANT,condition:!i},{id:d.MARK_UNIMPORTANT,condition:i}])),l=l.concat([{id:d.FOLDERS_ACTIONS,condition:!0},{id:d.LABELS_ACTIONS,condition:!0},{id:d.PIN,condition:r&&!a},{id:d.UNPIN,condition:r&&a}]);var g=ns.Model.get("all-toolbar-buttons"),c=l.filter((function(e){return e.condition})).map((function(e){return g.getButtonById(e.id)})).filter((function(e){return Boolean(e)}));this.setData({buttons:c})}}})},3067:function(e,s){ns.Model.define("messages-item-state",{events:{"ns-model-init":"_onInit"},params:function(e){var s=_.extend({},ns.page.current.params,e),t=ns.Model.getKeyAndParams("messages",s).params;return t.ids=e.ids,t},methods:{STATE:{CLOSE:"close",MESSAGE:"message",THREAD_SHORT:"thread_short",THREAD_FULL:"thread_list"},_onInit:function(){this.setData({state:this.STATE.CLOSE})},destroy:function(){this.close()},setState:function(e){this.setIfChanged(".state",e)},getState:function(){return this.get(".state")},isClosed:function(){return this.get(".state")===this.STATE.CLOSE},close:function(){this.setState(this.STATE.CLOSE)}}},ns.ModelStatic)},3068:function(e,s){ns.Model.define("state-message-thread-list",{events:{"ns-model-init":"_onInit"},params:{thread_id:null},methods:{_onInit:function(){this.setData({HEIGHT_COMPACT_MESSAGE:29,countHiddenMessages:0,unloadedMessages:0,hiddenMessages:[],blockAutoMarkAsRead:!1})},getHiddenMessages:function(){return this.get(".hiddenMessages")},getCountHiddenMessages:function(){return this.get(".countHiddenMessages")},setHiddenMessages:function(e){this.set(".hiddenMessages",e),this.set(".countHiddenMessages",e.length)},resetHiddenMessages:function(){this.setHiddenMessages([])}}},ns.ModelStatic)},3069:function(e,s,t){t(3070),t(3071),t(3072),t(3073),t(3074),t(3075),t(3076),t(3077),t(3078),t(3079),t(3080),t(3081),t(3082),t(3083),t(3084),t(3085),t(3086),t(3087),t(3088),t(3089),t(3090),t(3091),t(3092),t(3093),t(3094),t(3095),t(3096),t(3097),t(3098),t(3099),t(3100),t(3101),t(3102),t(3103),t(3104),t(3105),t(3106),t(3107),t(3108),t(3109),t(3110),t(3111),t(3112),t(3113),t(3114),t(3115),t(3116),t(3117),t(3118),t(3119),t(3120),t(3121),t(3122),t(3123),t(3124),t(3125),t(3126),t(3127),t(3128),t(3129),t(3130),t(3131),t(3132),t(3133),t(3134),t(3135)},3070:function(e,s){ns.View.define("messages-item-labels",{models:{message:{"ns-model-changed":"keepValid","ns-model-changed.lid":"updateSelf"},labels:{"ns-model-changed":!1,"daria:mLabels:rename":"forceUpdate"}},yateModule:"messages",methods:{updateSelf:function(){this.forceUpdate()}}})},3071:function(e,s){ns.View.define("messages-item-labels-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed.lid":"forceUpdate"}),labels:ns.View.defineModelEvents({"daria:mLabels:rename":"forceUpdate"})}})},3072:function(e,s){ns.View.edefine("messages-item-userpic",{events:{"click .js-message-snippet-userpic":"onUserpicClick"},models:{message:!1},yateModule:"messages",methods:{onUserpicClick:function(e){e.preventDefault(),e.stopPropagation(),this.logClickMessageFromSearch("avatar");var s=e.target.href;s&&ns.page.go(s)}}},"messages-search-logger-mixin",ns.View)},3073:function(e,s){ns.View.define("messages-item-userpic-mixin",{events:{"click .js-message-snippet-userpic":"_messagesItemUserpicOnClick"},methods:{_messagesItemUserpicOnClick:function(e){e.preventDefault(),e.stopPropagation(),this.logClickMessageFromSearch("avatar");var s=e.target.href;s&&ns.page.go(s)}}})},3074:function(e,s){ns.View.define("messages-item-checkbox",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"}},events:{"ns-view-htmlinit":"onInit",click:"onClickCheckbox"},yateModule:"messages",methods:{onInit:function(){this.checkIfInCheckedThread()},checkIfInCheckedThread:function(){var e=this.getModel("messages-checked"),s=this.getModel("message");e.isCheckedByMid(s.getThreadId())&&e.check(s,!0,{sendNotification:!1})},_getNodesToMarkChecked:function(){return this.$node.add(".js-messages-item-checkbox-visual",this.$node)},onClickCheckbox:function(){this.toggleChecked(),this.afterClickCheckbox()},afterClickCheckbox:_.noop,toggleChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.toggleCheck(e);var t=s.isChecked(e);ns.events.trigger("daria:vMessagesItem:checked",this.$node,t,e)},onMessageCheckedToggle:function(e,s,t){if(!this.isVisible())return void this.invalidate();var a=this.getModel("message"),i=this.getModel("messages-checked"),n=i.isChecked(a);t===i.key&&(ns.events.trigger("daria:vMessagesItem:checked",this.$node,n,this.getModel("message")),this._setChecked({checked:n,force:!0}),this.afterMessageCheckedToggle(n,s))},afterMessageCheckedToggle:function(e,s){s=_.extend({sendNotification:!0},s),s.sendNotification&&this.sendThreadNotification(e)},sendThreadNotification:function(e){var s=this.getModel("message");ns.Model.get("message",{ids:s.get(".tid")}).trigger("ns-model-child-check-toggle",e)},_setChecked:function(e){var s=this._getNodesToMarkChecked(),t={force:!1,checked:!1};e=_.extend(t,e),s.toggleClass("is-checked",e.checked)},onCheckedReset:function(){if(!this.isVisible())return void this.invalidate();this._setChecked({checked:this.isChecked(),force:!0})},isChecked:function(){var e=this.getModel("message");return this.getModel("messages-checked").isChecked(e)}}})},3075:function(e,s){ns.View.define("messages-item-checkbox-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-checked-toggle":"_messagesItemCheckboxMessageCheckedToggle"}),"messages-checked":ns.View.defineModelEvents({"ns-model-reset-checked":"_messagesItemCheckboxCheckedReset"})},events:{"ns-view-htmlinit":"_messagesItemCheckboxHtmlInit","click .js-messages-item-checkbox":"_messagesItemCheckboxClickCheckbox"},methods:{_messagesItemCheckboxHtmlInit:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.isCheckedByMid(e.getThreadId())&&s.check(e,!0,{sendNotification:!1})},_messagesItemCheckboxClickCheckbox:function(e){e.preventDefault(),Jane.c("клик на чекбокс в списке писем"),e.shiftKey||(this._messagesItemCheckboxToggleChecked(),this.afterClickMessagesItemCheckbox())},_messagesItemCheckboxCheckedReset:function(){if(!this.isVisible())return void this.invalidate();this._messagesItemCheckboxSetChecked({checked:this.isChecked(),force:!0})},_messagesItemCheckboxMessageCheckedToggle:function(e,s,t){if(!this.isVisible())return void this.invalidate();var a=this.getModel("message"),i=this.getModel("messages-checked"),n=i.isChecked(a);t===i.key&&(ns.events.trigger("daria:vMessagesItem:checked",this.$node,n,this.getModel("message")),this._messagesItemCheckboxSetChecked({checked:n,force:!0}),this.afterCheckedToggleMessagesItemCheckbox(n,s))},_messagesItemCheckboxToggleChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.toggleCheck(e);var t=s.isChecked(e);ns.events.trigger("daria:vMessagesItem:checked",this.$node,t,e)},_messagesItemCheckboxSetCheckedNative:function(e){var s=this.$node.find(".js-messages-item-checkbox-visual");e=_.extend({force:!1,checked:!1},e),s.toggleClass("is-checked",e.checked)},_messagesItemCheckboxSetCheckedNb:function(e){var s=nb.$block(".js-messages-item-checkbox-visual",this.node);s&&(e.checked?s.check():s.uncheck())},_messagesItemCheckboxSetChecked:function(e){Daria.UISettings.shouldShowCheckboxInsideUserpic()?this._messagesItemCheckboxSetCheckedNative(e):this._messagesItemCheckboxSetCheckedNb(e)},messagesItemCheckboxAfterMessageCheckedToggle:function(e,s){if(s=_.extend({sendNotification:!0},s),s.sendNotification){var t=this.getModel("message");ns.Model.get("message",{ids:t.get(".tid")}).atrigger("ns-model-child-check-toggle",e)}}}})},3076:function(e,s){ns.View.edefine("messages-item-checkbox-nb",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"}},yateModule:"messages",methods:{_setChecked:function(e){var s=nb.$block(".nb-checkbox",this.node);s&&(e.checked?s.check():s.uncheck())}}},"messages-item-checkbox")},3077:function(e,s){ns.View.define("messages-item-thread-checkbox",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","ns-model-child-check-toggle":"onChildCheckToggle"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"},"messages-item-state":!1,settings:!1},events:{click:"onClickCheckbox"},yateModule:"messages",methods:{afterClickCheckbox:function(){this.toggleManuallyCheckedState()},toggleManuallyCheckedState:function(){var e=this.getModel("messages-checked").isChecked(this.getModel("message"));this.getModel("messages-item-state").set(".manuallyChecked",e)},afterMessageCheckedToggle:function(e,s){s=_.extend({affectChildren:!0},s),s.affectChildren&&this.affectChildren(e)},affectChildren:function(e){var s=this.getModel("message").getThreadMessages();this.changeChildrenCheckedState(e,s)},getActualMessagesCount:function(e,s,t){return 0!==e?e:s<t?s:t},changeChildrenCheckedState:function(e,s){var t=this.getModel("messages-checked"),a={sendNotification:!1};s.models.forEach((function(s){t.check(s,e,a)}))},onChildCheckToggle:function(){if(this.isVisible()){var e=this.getModel("message"),s=e.getThreadMessages(),t=this.getModel("messages-checked"),a={sendNotification:!1,affectChildren:!1},i=_.all(s.models,t.isChecked.bind(t));t.check(e,i,a)}}}},"messages-item-checkbox")},3078:function(e,s){ns.View.define("messages-item-thread-checkbox-mixin",{models:{"messages-item-state":!1,message:ns.View.defineModelEvents({"ns-model-child-check-toggle":"_messagesItemThreadCheckboxChildCheckToggle"})},methods:{messagesItemThreadCheckboxAfterClick:function(){var e=this.getModel("messages-checked").isChecked(this.getModel("message"));this.getModel("messages-item-state").set(".manuallyChecked",e)},messagesItemThreadCheckboxAfterMessageCheckedToggle:function(e,s){if(s=_.extend({affectChildren:!0},s),s.affectChildren){var t=this.getModel("message").getThreadMessages();this._messagesItemThreadCheckboxChangeChildrenCheckedState(e,t)}},_messagesItemThreadCheckboxChangeChildrenCheckedState:function(e,s){var t=this.getModel("messages-checked"),a={sendNotification:!1};s.models.forEach((function(s){t.check(s,e,a)}))},_messagesItemThreadCheckboxChildCheckToggle:function(){if(this.isVisible()){var e=this.getModel("message");if(e.isThreadModel()){var s=e.getThreadMessages(),t=this.getModel("messages-checked"),a={sendNotification:!1,affectChildren:!1},i=_.all(s.models,t.isChecked.bind(t));t.check(e,i,a)}}}}})},3079:function(e,s){ns.View.edefine("messages-item-thread-checkbox-nb",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","ns-model-child-check-toggle":"onChildCheckToggle"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"},"messages-item-state":!1,settings:!1},yateModule:"messages",methods:{_setChecked:function(e){var s=nb.$block(".nb-checkbox",this.node);s&&(e.checked?s.check():s.uncheck())}}},"messages-item-thread-checkbox")},3080:function(e,s){ns.View.edefine("messages-item-checkbox-wrap",{models:{message:!1,"messages-checked":!1},events:{"click .js-messages-item-checkbox-visual":"onCheckboxClick"},yateModule:"messages",methods:{patchLayout:function(){var e=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"":"-nb";return this.getModel("message").isThreadModel()?"layout-messages-item-thread-checkbox"+e:"layout-messages-item-checkbox"+e},isMessageChecked:function(){return this.getModel("messages-checked").isCheckedByMid(this.params.ids)},onCheckboxClick:function(e){e.preventDefault(),e.stopPropagation();var s=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"cbxavatar":"checkbox";this.isMessageChecked()&&this.logClickMessageFromSearch(s)}}},"messages-search-logger-mixin",ns.View)},3081:function(e,s){ns.View.defineNg("messages-item-checkbox-wrap-mixin",{models:{message:!1,"messages-checked":!1},events:{"click .js-messages-item-checkbox-visual":"_messagesItemCheckboxWrapCheckboxClick"},mixins:["messages-item-checkbox-mixin","messages-item-thread-checkbox-mixin"],methods:{_messagesItemCheckboxWrapCheckboxClick:function(){if(this.getModel("messages-checked").isCheckedByMid(this.params.ids)){var e=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"cbxavatar":"checkbox";this.logClickMessageFromSearch(e)}},isChecked:function(){var e=this.getModel("message");return this.getModel("messages-checked").isChecked(e)},afterClickMessagesItemCheckbox:function(){this.getModel("message").isThreadModel()&&this.messagesItemThreadCheckboxAfterClick()},afterCheckedToggleMessagesItemCheckbox:function(e,s){this.getModel("message").isThreadModel()?this.messagesItemThreadCheckboxAfterMessageCheckedToggle(e,s):this.messagesItemCheckboxAfterMessageCheckedToggle(e,s)}}})},3082:function(e,s){ns.View.define("messages-item-userpic-and-checkbox",{models:{message:!1,"messages-checked":!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"invalidate"}},yateModule:"messages"})},3083:function(e,s){ns.View.defineNg("messages-item-userpic-and-checkbox-mixin",{models:{settings:ns.View.defineModelEvents({"ns-model-changed.show_checkbox_inside_userpic":"forceUpdate","ns-model-changed.messages_avatars":"invalidate"})},mixins:["messages-item-userpic-mixin","messages-item-checkbox-wrap-mixin"]})},3084:function(e,s){function t(e){return n(e)||i(e)||a()}function a(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function n(e){if(Array.isArray(e)){for(var s=0,t=new Array(e.length);s<e.length;s++)t[s]=e[s];return t}}ns.View.define("important-toggleable-mixin",{models:{labels:!1,message:!1},yateModule:"messages",methods:{_importantToggleableIsImportant:function(){return this.getModel("message").isImportant()},_onImportantToggleableClick:function(e){e.stopPropagation(),e.preventDefault();var s=this._importantToggleableIsImportant()?"unlabel":"label",t=this.getModel("labels").getImportantLID(),a=this.getModel("message"),i=a.getMessagesCheckedModel(!0);this.countToggleableClick(["Важное","label"===s?"проставление":"снятие",this._getFlagContext(e.currentTarget),this.isNewImportantFlag(e.currentTarget)?"Новый флажок":"Старый флажок"]),Daria.MOPS.updateHelper(s,i,t)},_getFlagContext:function(e){var s=function(s){return Boolean($(e).closest(s).length)};switch(!0){case s(".js-message-head"):return"Развёрнутое письмо";case s(".js-thread-item"):return"Свёрнутое письмо треда";case s(".js-message-snippet"):return"Письмо в списке";case s(".js-mail-Message-Toolbar-Content"):return"Шапка треда";default:return"unknown"}},countToggleableClick:function(e){var s;(s=Jane.ToolbarMetric).messageControlsToolbar.apply(s,[null].concat(t(e)))},isNewImportantFlag:function(e){return $(e).hasClass("js-flag-new")}}})},3085:function(e,s){function t(e){return n(e)||i(e)||a()}function a(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function n(e){if(Array.isArray(e)){for(var s=0,t=new Array(e.length);s<e.length;s++)t[s]=e[s];return t}}ns.View.define("important-toggleable",{models:{labels:!1,message:{"ns-model-changed":!1,"ns-model-changed.lid":"_onMessageLidChange"}},params:function(e){return{ids:e.ids||e.thread_id}},events:{click:"_onImportantToggleableClick"},yateModule:"messages",methods:{_onMessageLidChange:function(){this.$node.toggleClass("is-active",this._importantToggleableIsImportant())},countToggleableClick:function(e){var s,a=this.getModel("message");(s=Jane.ToolbarMetric).messageControlsToolbar.apply(s,[a].concat(t(e)))}}},"important-toggleable-mixin")},3086:function(e,s){ns.View.define("important-toggleable-head",{models:{labels:!1,message:{"ns-model-changed":!1,"ns-model-changed.lid":"_onMessageLidChange"}},events:{click:"_onImportantToggleableClick"},yateModule:"messages"},"important-toggleable")},3087:function(e,s){ns.View.define("important-toggler",{models:{labels:!1,message:{"ns-model-changed":!1,"ns-model-changed.lid":"_onMessageLidChange"}},events:{click:"_onImportantToggleableClick"},yateModule:"messages",methods:{isNewImportantFlag:function(){return!0},_onMessageLidChange:function(){var e=this._importantToggleableIsImportant();this.$node.find(".js-message-snippet-importance").toggleClass("is-active",e),this.$node.toggleClass("mail-Important-Toggler-Container_visible",e)}}},"important-toggleable")},3088:function(e,s){!(function(){var e=null,s=_.debounce((function(){e&&e.close()}),500);ns.View.define("priority-toggleable-mixin",{models:{labels:!1,message:ns.View.defineModelEvents({"ns-model-changed.lid":"onMessageLidChange"}),settings:!1},params:function(e){return{ids:e.ids||e.thread_id}},ctor:function(){this.onDestroyedPopup=this.onDestroyedPopup.bind(this),this.onClosedPopup=this.onClosedPopup.bind(this),this.onPriorityToggleableUnlabel=this.onPriorityToggleableUnlabel.bind(this)},events:{"click .js-priority-toggleable":"onPriorityToggleableClick","mouseenter .js-priority-toggleable":"showPopup","mouseleave .js-priority-toggleable":"hidePopup"},yateModule:"messages",methods:{shouldShowPopup:function(){return Boolean(this.getModel("settings").getSign("show_priority_popup"))},setPriorityPopupSetting:function(e){this.getModel("settings").setSettings({show_priority_popup:e})},showPopup:function(t){this.shouldShowPopup()&&(t.stopPropagation(),t.preventDefault(),s.cancel(),e&&(e.destroy(),e=null),e=nb.block(ns.renderNode({isPriorityLabel:this._priorityToggleableIsPriority()},"js-priority-popup","messages")),e.on("nb-destroyed",this.onDestroyedPopup),e.on("nb-closed",this.onClosedPopup),e.$node.on("mouseenter",s.cancel).on("mouseleave",s),e.open({withoutTail:!1,autofocus:!1,how:{my:"top",at:"bottom",collision:"fit flip"},animation:!0,where:$(".js-priority-toggleable-icon",this.$node)}))},onPriorityToggleableUnlabel:function(e){e.stopPropagation(),e.preventDefault(),this._priorityToggleableIsPriority()&&this._onPriorityToggleableClick(e,"unlabel")},onPriorityToggleableClick:function(e){e.stopPropagation(),e.preventDefault();var s=this;this.getModel("labels").getPriorityLID()?this._onPriorityToggleableClick(e):this.createPriorityLabel("hamon_label").then((function(t){t&&s._onPriorityToggleableClick(e)}))},_onPriorityToggleableClick:function(e,s){this.shouldShowPopup()&&this.setPriorityPopupSetting(!1);var t=s||(this._priorityToggleableIsPriority()?"unlabel":"label"),a=this.getModel("labels").getPriorityLID(),i=this.getModel("message"),n=i.getMessagesCheckedModel(!0);Jane.ToolbarMetric.messageControlsToolbar(i,("label"===t?"поставить":"снять")+" отметку приоритетное"),Daria.MOPS.updateHelper(t,n,a)},createPriorityLabel:function(e){return ns.forcedRequest([{id:"do-labels-add-by-symbol",params:{symbol:e}},{id:"labels"}]).then((function(e){var s=e[0].get(".body.updated");return s||null})).fail((function(e){return Jane.ErrorLog.send({type:"create-label-error",msg:e}),null}))},hidePopup:function(){s()},onDestroyedPopup:function(){e=null},onClosedPopup:function(e,s){s.destroy()},_priorityToggleableIsPriority:function(){return this.getModel("message").isPriority()},onMessageLidChange:function(){this.$node.toggleClass("is-active",this._priorityToggleableIsPriority())}}})})()},3089:function(e,s){ns.View.defineNg("priority-toggleable",{mixins:["priority-toggleable-mixin"],params:ns.View.info("priority-toggleable-mixin").params,yateModule:"messages"})},3090:function(e,s){ns.View.defineNg("priority-toggleable-head",{mixins:["priority-toggleable-mixin"],params:ns.View.info("priority-toggleable-mixin").params,yateModule:"messages"})},3091:function(e,s){ns.View.define("read-toggleable",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread","# toMute":"onStateToMute","# toUnmute":"onStateToUnmute"}},params:function(e){return{ids:e.ids||e.thread_id,type:"messages"}},events:{"ns-view-init":"onInit",click:"onClick"},yateModule:"messages",methods:{TO_MUTE_TIMEOUT:2e3,onInit:function(){this.mReadMuteFsm=this.getModel("message-read-mute-fsm"),this.mMessage=this.getModel("message"),this.setStartState(),this.muteLabelLid=no.jpath(".lid",ns.Model.get("labels").getMuteThreadLabel()),this.canMute=Daria.IS_CORP||Daria.Config.pddDomain||Daria.Config.workspace},setStartState:function(){this.mReadMuteFsm.setInitialState(this.computeFsmModelState())},_readToggleableGetReadMuteFsmState:function(){return this.mReadMuteFsm.getState()},computeFsmModelState:function(){return this.mMessage.isNew()?"toRead":this.mMessage.isMuted()?"toUnmute":"toUnread"},onClick:function(e){e.stopPropagation(),e.preventDefault();var s=this.mReadMuteFsm.getState(),t="toRead"===s?"mark as read":"mark as unread";Jane.ToolbarMetric.messageControlsToolbar(this.mMessage,t),"toUnread"===s||"toRead"===s?this.mMessage.toggleMark():this.mMessage.toggleMute()},toggleState:function(){var e,s=this.mReadMuteFsm.getState(),t=this.mMessage.isNew();switch(s){case"toRead":e=this.canMute&&this.mMessage.isMutable()?"toMute":"toUnread";break;case"toUnread":e=this.mMessage.isMuted()?"toUnmute":"toRead";break;case"toMute":e=t?"toRead":"toUnmute";break;case"toUnmute":e=t?"toRead":"toUnread"}this.mReadMuteFsm.setState(e)},onMessageChange:function(e,s){s||this.setStartState()},onMessageNewChange:function(){if(this.mMessage.isMuted())return void this.mMessage.toggleMute();var e=this.mMessage.isThread(),s=this.mReadMuteFsm.getState();e&&"toRead"===s&&this.mMessage.isNew()||this.toggleState()},onMessageLidChange:function(e,s,t,a,i){this.mMessage.isThread()&&(this.mMessage.hasLabelInDiff(this.muteLabelLid,i)&&this.toggleState())},onStateToRead:function(){this.unbindMuteShowTimeout(),this.forceUpdate()},onStateToUnread:function(){this.unbindMuteShowTimeout(),this.forceUpdate()},onStateToMute:function(){this.forceUpdate(),this.bindMuteShowTimeout()},onStateToUnmute:function(){this.unbindMuteShowTimeout(),this.forceUpdate()},bindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId=_.delay(function(){this.unbindMuteShowTimeout(),this.$node&&(this.$node.is(":hover")?this.bindMuteShowTimeout():this.mReadMuteFsm.isCurrentState("toUnread")||this.mReadMuteFsm.setState("toUnread"))}.bind(this),this.TO_MUTE_TIMEOUT)},unbindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId&&(window.clearTimeout(this.from_ToMute_to_Unread_timerId),this.from_ToMute_to_Unread_timerId=0)},syncState:function(){this.mReadMuteFsm.getState()!==this.computeFsmModelState()&&(this.setStartState(),this.forceUpdate())}}}),ns.View.edefine("read-toggleable-thread",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread","# toMute":"onStateToMute","# toUnmute":"onStateToUnmute"}},params:function(e){return{ids:e.ids||e.thread_id,type:"thread"}},events:{"ns-view-show":"syncState"},yateModule:"messages"},"read-toggleable"),ns.View.edefine("read-toggleable-head",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread"}},params:function(e){return{ids:e.ids,type:"message"}},events:{"ns-view-show":"syncState"},yateModule:"messages"},"read-toggleable")},3092:function(e,s){ns.View.define("read-toggleable-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed":"_readToggleableOnMessageChange","ns-model-changed.new":"_readToggleableOnMessageNewChange","ns-model-changed.lid":"_readToggleableOnMessageLidChange"}),"state-message-thread-item":!1},events:{"ns-view-init":"_readToggleableOnInit","ns-view-htmlinit":"_readToggleableOnHtmlInit","ns-view-htmldestroy":"_readToggleableOnHtmlDestroy","click .js-read-toggleable":"_readToggleableOnClick"},ctor:function(){this._readToggleableOnStateToRead=this._readToggleableOnStateToRead.bind(this),this._readToggleableOnStateToUnread=this._readToggleableOnStateToUnread.bind(this),this._readToggleableOnStateToMute=this._readToggleableOnStateToMute.bind(this),this._readToggleableOnStateToUnmute=this._readToggleableOnStateToUnmute.bind(this)},methods:{_readToggleableGetReadMuteFsm:function(){return this._mReadMuteFsm||(this._mReadMuteFsm=this._readToggleableInitReadMuteFsm()),this._mReadMuteFsm},_readToggleableInitReadMuteFsm:function(){if(this.params){var e=ns.Model.get("message-read-mute-fsm",{ids:this.params.ids,type:"messages"});return e.on("# toRead",this._readToggleableOnStateToRead).on("# toUnread",this._readToggleableOnStateToUnread).on("# toMute",this._readToggleableOnStateToMute).on("# toUnmute",this._readToggleableOnStateToUnmute),e}},_readToggleableDeinitReadMuteFsm:function(){this._mReadMuteFsm&&(this._mReadMuteFsm.off("# toRead",this._readToggleableOnStateToRead).off("# toUnread",this._readToggleableOnStateToUnread).off("# toMute",this._readToggleableOnStateToMute).off("# toUnmute",this._readToggleableOnStateToUnmute),this._mReadMuteFsm=null)},TO_MUTE_TIMEOUT:2e3,_readToggleableOnInit:function(){this.setStartState()},_readToggleableOnHtmlInit:function(){this.$readToggleableNode=this.$node.find(".js-read-toggleable"),this.muteLabelLid=no.jpath(".lid",ns.Model.get("labels").getMuteThreadLabel()),this.canMute=Daria.IS_CORP||Daria.Config.pddDomain||Daria.Config.workspace,this._readToggleableGetReadMuteFsm()},_readToggleableOnHtmlDestroy:function(){this._readToggleableDeinitReadMuteFsm()},_readToggleableGetReadMuteFsmState:function(){return this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().getState()},setStartState:function(){this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().setInitialState(this.computeFsmModelState())},computeFsmModelState:function(){var e=this.getModel("message");return e.isNew()?"toRead":e.isMuted()?"toUnmute":"toUnread"},_readToggleableOnClick:function(e){e.stopPropagation(),e.preventDefault();var s=this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().getState(),t="toRead"===s?"mark as read":"mark as unread";Jane.ToolbarMetric.messageControlsToolbar(null,t),"toUnread"===s||"toRead"===s?this.getModel("message").toggleMark():this.getModel("message").toggleMute()},toggleState:function(){var e,s=this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().getState(),t=this.getModel("message"),a=t.isNew();switch(s){case"toRead":e=this.canMute&&t.isMutable()?"toMute":"toUnread";break;case"toUnread":e=t.isMuted()?"toUnmute":"toRead";break;case"toMute":e=a?"toRead":"toUnmute";break;case"toUnmute":e=a?"toRead":"toUnread"}this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().setState(e)},_readToggleableOnMessageChange:function(e,s){s||this.setStartState()},_readToggleableOnMessageNewChange:function(){var e=this.getModel("message");if(e.isMuted())return void e.toggleMute();var s=e.isThread(),t=this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().getState();s&&"toRead"===t&&e.isNew()||this.toggleState()},_readToggleableOnMessageLidChange:function(e,s,t,a,i){var n=this.getModel("message");n.isThread()&&(n.hasLabelInDiff(this.muteLabelLid,i)&&this.toggleState())},_readToggleableOnStateToRead:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()},_readToggleableOnStateToUnread:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()},_readToggleableOnStateToMute:function(){this.invalidate(),this.forceUpdate(),this.bindMuteShowTimeout()},_readToggleableOnStateToUnmute:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()},bindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId=_.delay(function(){this.unbindMuteShowTimeout(),this.$readToggleableNode&&(this.$readToggleableNode.is(":hover")?this.bindMuteShowTimeout():this._readToggleableGetReadMuteFsm()&&this._readToggleableGetReadMuteFsm().setState("toUnread"))}.bind(this),this.TO_MUTE_TIMEOUT)},unbindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId&&(window.clearTimeout(this.from_ToMute_to_Unread_timerId),this.from_ToMute_to_Unread_timerId=0)}}})},3093:function(e,s){!(function(){ns.View.define("message-empty",{events:{"ns-view-show":"onshow"},models:["settings"],yateModule:"messages",methods:{onshow:function(){var e=this.getModel("settings");e.getSetting("first_show_3pane")&&e.setSettings({first_show_3pane:""})}}})})()},3094:function(e,s){ns.View.edefine("message-thread",{params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids,mid:e.thread_id||e.ids}},models:{messages:{"ns-model-changed":"keepValid","ns-model-insert":"keepValid","ns-model-remove":"checkEmptyThread","ns-model-destroyed":"invalidate"},message:{"ns-model-changed":"_onMessageModelChange"},"messages-checked":{"run-action":"_runAction","ns-model-destroyed":"keepValid","ns-model-changed":"keepValid"},"module-message":!1,settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"lazyFixedRecalc","ns-model-changed.liza_minified_header":"lazyFixedRecalc"},"scroller-message":"keepValid","state-message-thread-list":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model:expand-list":"onMessageThreadListExpand"},"thread-info":"keepValid"},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","hotkeys.alignOpenMessage":"onAlignOpenMessage","resize@show window":"_toggleTitleTogglerLazy","daria:MOPS:action-complete":"toggleMarkSubject","mouseenter .js-toolbar-subject":"onHoverSubjectOn","mouseleave .js-toolbar-subject":"onHoverSubjectOff"},ctor:function(){this._toggleTitleTogglerLazy=_.throttle(this._toggleTitleToggler.bind(this),20),this.recalculateHeaderFixedState=_.throttle(this.recalculateHeaderFixedState.bind(this),20,{trailing:!0,leading:!0}),this._shouldPreserveScrollPosition=Daria.is2pane()},yateModule:"messages",methods:{LOAD_NEXT_PAGE_PADDING:100,CLASS_LONG_TITLE:"mail-Message-Toolbar_longTitle",fixedHeader:!1,onHtmlInit:function(){this._$toolbar=this.$node.find(".js-thread-toolbar"),this._$toolbarSubject=this.$node.find(".js-toolbar-subject"),this._toggleTitleToggler()},onShow:function(){this.checkEmptyThread()||(Daria.lom.save({current_folder:ns.page.current.params.current_folder,thread_id:this.params.thread_id}),this.fixedElementStart())},onHide:function(){this.fixedElementStop(),this.recalculateHeaderFixedState.cancel();var e=this.getModel("messages-checked"),s=this.getModel("message");e.isChecked(s)||s.uncheckThreadMessages(e)},shouldHideThreadControls:function(){return 1===this.getModel("message").getThreadCount()},_onMessageModelChange:function(e,s){".new"===s&&this.toggleMarkSubject(),this.$node.find(" > .mail-Message-Toolbar_thread").toggleClass("mail-MessageThread_asMessage",this.shouldHideThreadControls())},_runAction:function(e,s){var t=s.params||{},a=t.mMessagesChecked||this.getModel("messages-checked");return Daria.MOPS[s.action](a,t)},_toggleTitleToggler:function(){var e=this.initialHeight||this._$toolbarSubject[0].offsetHeight,s=this._$toolbarSubject[0].scrollHeight<=e;s||this.initialHeight||(this.initialHeight=this._$toolbarSubject[0].offsetHeight),this._$toolbarSubject.css("max-height",s?"":this._$toolbarSubject[0].scrollHeight),this._$toolbar.toggleClass(this.CLASS_LONG_TITLE,!s)},checkEmptyThread:function(){var e=ns.page.current;if(Daria.is2pane())return!1;if(this.params.thread_id!==e.params.thread_id)return!1;if(this.getModel("messages").isEmptyList()){var s=_.omit(e.params,"thread_id"),t=ns.router.generateUrl(e.page,s);return Daria.lom.deleteFid(s.current_folder),window.setTimeout((function(){ns.page.go(t)}),50),!0}return!1},onAlignOpenMessage:function(e,s){var t,a=ns.Model.get("focus"),i=a.getFocus();t=i&&"message-thread-item-wrap"===i.id&&i.isOpen()?i.node:this.node,s.scroller.scrollIntoView(t,s.alignOptions)},onMessageThreadListExpand:function(e,s){this.scrollAfterExpand(s.messageIndex,s.offset)},scrollAfterExpand:function(e,s){s=s||0;var t=this.getModel("scroller-message"),a=t.getScrollTop(),i=t.getNodeTop(this.node),n=this.getModel("state-message-thread-list"),o=n.get(".HEIGHT_COMPACT_MESSAGE")*e,r=a+o-s;r=Math.max(r,i),t.setScrollTop(r)},toggleMarkSubject:function(){var e=this.getModel("message");this.$node.find(".js-toolbar-subject").toggleClass("is-unread",e.isNew())},onHoverSubjectOn:function(){this.$node.find(".js-mail-Message-Toolbar").addClass("with-subject-hovered")},onHoverSubjectOff:function(){this.$node.find(".js-mail-Message-Toolbar").removeClass("with-subject-hovered")},getFocusableChildren:function(){var e=this.getModel("messages"),s=[this];if(e.getCount()>1){var t=Daria.nsTreeWalker.findView(this,["message-thread-pager"]);t&&t.shouldBeVisible()&&s.push(t);var a=Daria.nsTreeWalker.findView(this,["message-thread-list"]);a&&(s=s.concat(a.getFocusableChildren()))}return s},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"space":this.toggleCheck();break;case"enter":ns.page.go(Daria.Page.generateUrl.closeMessage());break;case"print":this.print()}},print:function(){Daria.Printer.printThread(this.params.ids)},toggleCheck:function(){var e=this.getModel("message");this.getModel("messages-checked").toggleCheck(e)},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}},"fixed-element-in-message-mixin","preserve-scroll-position-mixin")},3095:function(e,s){ns.View.define("message-thread-head-subject",{models:{message:{"ns-model-changed":"keepValid","ns-model-changed.subject":"invalidate","ns-model-changed.subject_prefix":"invalidate"}},params:function(e){return{ids:e.ids||e.thread_id}},yateModule:"messages"})},3096:function(e,s){ns.View.define("message-thread-expand",{events:{"click .js-expend-control":"onControlClick"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"updateCount"},"state-message-thread-list":{"ns-model-changed":"keepValid","ns-model-changed.countHiddenMessages":"updateControl","ns-model-destroyed":"keepValid"}},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}},yateModule:"messages",methods:{SELECTOR_FOR_COUNT_MESSAGES:".js-expend-control-count",onControlClick:function(e){e.stopPropagation(),this.toggleExpand()},toggleExpand:function(){this.getModel("state-message-thread-list").toggleExpand()},updateControl:function(){var e=this.getModel("state-message-thread-list"),s=e.getCountHiddenMessages();this.$node.toggleClass("is-disabled",!e.mayExpand()).toggleClass("is-folded",0===s)},updateCount:function(){var e=this.getModel("message").getThreadCount();this.$node.find(this.SELECTOR_FOR_COUNT_MESSAGES).text(i18n("%N_писем",e))},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":case"space":this.toggleExpand()}},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}})},3097:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(519),i=t.n(a),n=t(325),o=t(397),r=t(392);ns.View.edefine("message-thread-prev-next",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide",click:"onClick","click .js-open-prev-thread":"onOpenPrevThreadClick","click .js-open-next-thread":"onOpenNextThreadClick"},models:{message:!1},params:function(e){return{ids:e.ids||e.thread_id}},yateModule:"messages",ctor:function(){this.updateArrowBlocksBound=this.updateArrowBlocks.bind(this)},methods:{onHtmlInit:function(){this.$prevArrow=this.$node.find(".js-open-prev-thread"),this.$nextArrow=this.$node.find(".js-open-next-thread")},onShow:function(){this.updateArrowBlocks();var e=this.getMessagesModel();e.on("ns-model-insert",this.updateArrowBlocksBound),e.on("ns-model-remove",this.updateArrowBlocksBound)},onHide:function(){var e=this.getMessagesModel();e.off("ns-model-insert",this.updateArrowBlocksBound),e.off("ns-model-remove",this.updateArrowBlocksBound)},updateArrowBlocks:function(){this.$prevArrow.toggleClass("is-disabled",!this.canOpenThread(i.a.PREV)),this.$nextArrow.toggleClass("is-disabled",!this.canOpenThread(i.a.NEXT))},onClick:function(e){e.stopPropagation()},onOpenPrevThreadClick:function(){this.openThreadForPosition(i.a.PREV)},onOpenNextThreadClick:function(){this.openThreadForPosition(i.a.NEXT)},getMessagesModel:function(){return this._mMessages||(this._mMessages=ns.Model.get("messages",ns.page.current.params)),this._mMessages},canOpenThread:function(e){var s=this.getModel("message").isPinned(),t=this.getMessagesModel(),a=t.getNearestMessageByMid(this.params.ids,e),n=a&&a.isPinned()===s;return e===i.a.NEXT?n||!a&&t.canLoadMore():n},openThreadForPosition:function(e){var s=this,t=this.getMessagesModel(),a=t.getNearestMessageByMid(this.params.ids,e);if(a)return void this._openMessageFromThread(a,e);e===i.a.NEXT&&t.canLoadMore()&&t.loadMore().then((function(){if(s.canOpenThread(e)){var a=t.getNearestMessageByMid(s.params.ids,e);s._openMessageFromThread(a,e)}else s.$nextArrow.toggleClass("is-disabled",!0)}))},_openMessageFromThread:function(e,s){if(e){var t=Daria.Page.generateUrl.contentMessage3pane(e.getData());ns.page.go(t),this._finishActiveMessageViewScenario(),this._startMessageViewScenario(s)}},_startMessageViewScenario:function(e){var s=e===i.a.NEXT?o.m:o.n;this.scenarioManager.startScenario(n.e,s)},_finishActiveMessageViewScenario:function(){this.scenarioManager.finishScenarioIfActive(n.e,r.c)}}},"scenario-manager-mixin")},3098:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(325),i=t(397),n=t(392);ns.View.edefine("message-thread-item",{params:function(e){return{ids:e.ids,mid:e.ids}},models:{message:{"ns-model-changed":!1,"ns-model-changed.new":"_onMessageNsModelChangedNew","ns-model-changed.lid":"_redraw"},"messages-checked":!1,"account-information":!1,folders:!1,labels:!0,settings:!1,"state-message-thread-item":{"ns-model-changed":!1,"ns-model-changed.isOpened":"invalidate","ns-model-changed.isFocused":"_onStateChangeFocus"}},events:{"ns-view-htmlinit":"_onNsViewHtmlinit","daria:vMessageThread:readUnreadToggle@show":"_onDariaToggleReadUnread","click .js-message-toggle":"_onClickMessageToggle","click .js-message-toggle .js-toggle-important":"_onClickToggleImportant"},yateModule:"messages",methods:{_onNsViewHtmlinit:function(){this.getModel("messages-checked").checkByMidInParams()},openMessage:function(){this.getModel("state-message-thread-item").setOpen(!0)},_redraw:function(){return this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},_onClickMessageToggle:function(e){0===$(e.target).closest(".js-skip-click-message-item").length&&(e.stopPropagation(),this.getModel("state-message-thread-item").setOpen(!0),this.getModel("message").isNew()?Jane.c("Треды","клик по свернутому непрочитанному письму треда"):Jane.c("Треды","клик по свернутому прочитанному письму треда"),this._startMessageViewScenario())},_startMessageViewScenario:function(){this.scenarioManager.finishScenarioIfActive(a.e,n.c),this.scenarioManager.startScenario(a.e,i.k)},_onDariaToggleReadUnread:function(){this._toggleMark()},_onClickToggleImportant:function(e){e.stopPropagation(),this._toggleImportantLabel()},_toggleImportantLabel:function(){var e=this.getModel("message"),s=this.getModel("messages-checked"),t=ns.Model.get("labels").getImportantLID(),a=e.hasLabel(t)?"unlabel":"label";Daria.MOPS.updateHelper(a,s,{lid:t}).then(this._onSuccessToggleImportantLabel.bind(this,a))},_onSuccessToggleImportantLabel:function(e){this.$node.find(".js-toggle-important").toggleClass("b-ico_unimportant b-ico_important","label"!==e)},_onStateChangeFocus:function(){var e=this.getModel("state-message-thread-item"),s=e.get(".isFocused");this.$node.toggleClass("b-message_focus",s)},_onMessageNsModelChangedNew:function(){var e=this.$node.find(".js-message-toggle");e.length&&(this.getModel("message").isNew()?e.addClass("b-message_unread is-unread").removeClass("b-message_read"):e.removeClass("b-message_unread is-unread").addClass("b-message_read")),ns.events.trigger("daria:vMessageThreadItem:toggleMark")},_toggleMark:function(){return this.getModel("message").toggleMark()}}},"scenario-manager-mixin")},3099:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(325),i=t(397),n=t(392);ns.View.edefine("message-thread-item-wrap",{events:{"ns-view-hide":"_onNsViewHide","ns-view-touch":"onTouch","click .js-close-message":"close","ns-view-show":"_onNsViewShow"},models:{message:!1,"messages-checked":"keepValid","state-message-thread-item":{"ns-model-changed":"keepValid","ns-model-changed.isOpened":"_onItemOpenToggle","ns-model-changed.isVisible":"_onStateChangeVisible","ns-model-destroyed":"keepValid"}},yateModule:"messages",methods:{SEEN_TIMEOUT:500,LOADER_TIMEOUT:200,_timerMarkRead:null,_timerBeforeLoader:null,patchLayout:function(){return this.getModel("state-message-thread-item").isOpen()?"layout-message-thread-message":"layout-message-thread-item"},onTouch:function(){this.removeStateLoading()},_onNsViewShow:function(){this._onItemOpenToggle(),this.getModel("state-message-thread-item").set(".didRendered",!0)},_onNsViewHide:function(){this._clearReadTimer(),this._clearLoaderTimer(),this.closeSilently()},removeStateLoading:function(){this.$node.removeClass("is-loading")},closeSilently:function(){this.getModel("state-message-thread-item").destroy()},lazyMarkAsRead:function(){var e=this.getModel("state-message-thread-item");e.get(".forceMark")&&this._setReadTimerCallback(),e.set(".forceMark",!1)},_onItemOpenToggle:function(){var e=this.getModel("state-message-thread-item");e.isOpen()&&(this._timerBeforeLoader=setTimeout(function(){this.$node.addClass("is-loading")}.bind(this),this.LOADER_TIMEOUT)),this.$node.toggleClass("is-opened",e.isOpen()),this.update()},_onStateChangeVisible:function(){this._clearReadTimer();var e=ns.Model.get("state-message-thread-list",{thread_id:this.getModel("message").get(".tid")}).get(".blockAutoMarkAsRead"),s=this.getModel("state-message-thread-item");Daria.is3pane()&&e?s.get(".isVisible")&&s.set(".forceMark",!0):this._setReadTimer()},_setReadTimer:function(){var e=this.getModel("state-message-thread-item"),s=e.get(".isVisible"),t=e.get(".isIgnoreMarkRead");s&&!t&&(this._timerMarkRead=window.setTimeout(this._setReadTimerCallback.bind(this),this.SEEN_TIMEOUT))},_setReadTimerCallback:function(){var e=this.getModel("state-message-thread-item").get(".isIgnoreMarkRead"),s=this.getModel("message").isNew();!e&&s&&(this.getModel("message").toggleMark(),ns.events.trigger("daria:vMessageThreadList:checkVisible"))},_clearReadTimer:function(){window.clearTimeout(this._timerMarkRead)},_clearLoaderTimer:function(){clearTimeout(this._timerBeforeLoader)},isOpen:function(){return this.getModel("state-message-thread-item").isOpen()},open:function(){this.getModel("message").isNew()?Jane.c("Треды","клик по свернутому непрочитанному письму треда"):Jane.c("Треды","клик по свернутому прочитанному письму треда"),this.getModel("state-message-thread-item").setOpen(!0),this._startMessageViewScenario()},_startMessageViewScenario:function(){this.scenarioManager.finishScenarioIfActive(a.e,n.c),this.scenarioManager.startScenario(a.e,i.l)},close:function(){this.getModel("state-message-thread-item").setOpen(!1)},toggleCheck:function(){var e=this.getModel("message");this.getModel("messages-checked").toggleCheck(e)},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":this.open();break;case"print":this.print()}},print:function(){this.isOpen()&&Daria.Printer.printMessage(this.params.ids)},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}},"message-dimensions-mixin","scenario-manager-mixin",ns.View)},3100:function(e,s){ns.View.define("message-thread-item-userpic",{models:{message:!1},yateModule:"messages"})},3101:function(e,s){ns.View.define("first-user-scroll-mixin",{methods:{_subscribeFirstUserScroll:function(){this._subscribeFirstUserScrollTimeout||(this._subscribeFirstUserScrollTimeout=_.defer(function(){ns.events.on("daria:vScrollerMessage:scroll",this._onFirstUserScroll)}.bind(this)))},_unsubscribeFirstUserScroll:function(){clearTimeout(this._subscribeFirstUserScrollTimeout),this._subscribeFirstUserScrollTimeout=null,ns.events.off("daria:vScrollerMessage:scroll",this._onFirstUserScroll)},_onFirstUserScroll:function(){this._unsubscribeFirstUserScroll(),this.getModel("state-message-thread-list").set(".blockAutoMarkAsRead",!1),this.forEachItem((function(e){e.lazyMarkAsRead()}))}}})},3102:function(e,s){ns.ViewCollection.edefine("message-thread-list",{events:{"ns-view-init":"_onNsViewInit","ns-view-show":"_onNsViewShow","ns-view-hide":"_onNsViewHide","daria:vMessageThreadList:showMore@show":"_onMessagesLoad","daria:vMessageThreadList:expandUnread@show":"onExpandUnreadClick","daria:vMessageThreadList:checkVisible@show":"_checkVisibleMessages","daria:vMessageThreadList:scrollToNextUnread@show":"onScrollToNextUnread","daria:vScrollerMessage:scroll@show":"onScrollChanged","daria:layout-changed@show":"onScrollChanged"},models:{message:"keepValid",messages:{"ns-model-changed":"keepValid","ns-model-remove":"forceUpdate","ns-model-insert":"_onMessagesNsModelInsert"},"scroller-message":"keepValid","state-message-thread-list":"keepValid"},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}},split:{byModel:"messages",intoViews:function(){return this._openMessages(),"message-thread-item-wrap"}},ctor:function(){this._checkVisibleMessages=_.throttle(this._checkVisibleMessages.bind(this),50),this._onFirstUserScroll=this._onFirstUserScroll.bind(this)},yateModule:"messages",methods:{HEIGHT_LOADER_BLOCK:37,COUNT_MESSAGES_BEFORE_OPEN_MESSAGE:3,MESSAGE_TOP_BORDER_VISIBLE:70,_promiseMessagesLoad:null,_blockMessageAutoOpen:!1,_subscribeFirstUserScrollTimeout:null,_openMessages:function(){if(!this._blockMessageAutoOpen){this._getOpenedMessages().forEach((function(e){this._setMessageOpenState(e,!0)}),this),this._blockMessageAutoOpen=!0}},_getOpenedMessages:function(){var e=this.getModel("messages");if(Daria.is3pane()){var s=e.getUnreads();if(s.length>0)return s}var t,a=ns.Model.get("folders"),i=ns.page.current.params.current_folder;return t=a.isFolder(i,["sent","outbox"])?_.find(e.models,(function(e){return e.isOutcomeMessage()})):_.find(e.models,(function(e){return!e.isDraftLike()})),t||(t=e.models[0]),[t]},_setMessageOpenState:function(e,s,t){var a=_.extend({},this.params,{ids:e.get(".mid")});void 0===t&&(t=!0),ns.Model.get("state-message-thread-item",a).setOpen(s,t)},_onNsViewInit:function(){this.mStateMessageThreadList=this.getModel("state-message-thread-list")},_onNsViewShow:function(){this.getModel("scroller-message").init(),this._hideFirstPartMessages(),ns.events.trigger("daria:mFocus:buildTree"),ns.events.atrigger("daria:vMessageThreadList:checkVisible"),this._unsubscribeFirstUserScroll(),this._subscribeFirstUserScroll()},_onNsViewHide:function(){this._blockMessageAutoOpen=!1,this.mStateMessageThreadList.destroy(),this._unsubscribeFirstUserScroll(),this._removeClassForHiding(),ns.events.trigger("daria:mFocus:buildTree")},_hideFirstPartMessages:function(){var e=this.getModel("messages"),s=e.models,t=_.last(this._getOpenedMessages()),a=s.indexOf(t),i=[];if(s.length-1-a<=2)return void this.mStateMessageThreadList.setHiddenMessages(i);s.forEach((function(e,s){if(!(s<=a+1)){var t=this.getItemByModel(e);t&&t.$node&&(t.$node.addClass("is-hidden"),i.push(t))}}),this),this.mStateMessageThreadList.setHiddenMessages(i)},showMessages:function(){this._removeClassForHiding(),this.mStateMessageThreadList.resetHiddenMessages(),ns.events.trigger("daria:mFocus:buildTree")},_removeClassForHiding:function(){this.forEachValidItem((function(e){e.$node.removeClass("is-hidden")}))},_onMessagesLoad:function(){var e=this.getModel("messages"),s=e.canLoadMore(),t=this.mStateMessageThreadList.getCountHiddenMessages();if(t){this.showMessages();var a=s?0:this.HEIGHT_LOADER_BLOCK;return this.mStateMessageThreadList.trigger("ns-model:expand-list",{messageIndex:t,offset:a}),vow.resolve()}return this._promiseMessagesLoad&&!this._promiseMessagesLoad.isResolved()?this._promiseMessagesLoad:s?(this._promiseMessagesLoad=e.loadMore(!0),this._promiseMessagesLoad.then(function(){this.mStateMessageThreadList.resetHiddenMessages()}.bind(this)),this._promiseMessagesLoad):vow.reject()},_checkVisibleMessages:function(){if(!(this.$node.find(".js-body-loading").length>0)){var e=this.getModel("scroller-message"),s=e.getVDimensions();s.bottom-=this.MESSAGE_TOP_BORDER_VISIBLE,this.forEachValidItem((function(e){if(e.getModel("message").isNew()){var t=e.getModel("state-message-thread-item");if(t.get(".isOpened")){var a=e.isVisibleInScroller(s,!0);t.setVisible(a)}}}))}},onScrollChanged:function(){this.isVisible()&&this.isValid()&&this._checkVisibleMessages()},onExpandUnreadClick:function(){this.expandUnreadMessages(),this.showMessages(),this._scrollToNearestUnread(!0)},expandUnreadMessages:function(){this.getModel("messages").getUnreads().forEach((function(e){this._setMessageOpenState(e,!0,!1)}),this)},onScrollToNextUnread:function(){this._scrollToNearestUnread()},_scrollToNearestUnread:function(e){var s,t,a,i=this.getModel("messages"),n=i.models,o=n.length,r=this.getModel("scroller-message"),d=r.getScrollTop(),l=r.getScrollOffset();if(o<2)return void r.setScrollTop(0);for(;o--;)if(s=n[o],s.isNew()){var g=this.getItemByModel(s);if(!g)continue;if(!a&&(a=g,e))break;var c=g.getDimensions(!1);if(c.top-l>d){t=g;break}}if(t||(t=a||this.getItemByModel(n[0])),t){var h=t.getDimensions(!1),m=i.canLoadMore(),u=m?0:this.HEIGHT_LOADER_BLOCK;r.setScrollTop(h.top-l-u,!0)}else 0===d&&r.setScrollTop(1e5)},_onMessagesNsModelInsert:function(e,s){if(this.isVisible()){var t=s[0],a=_.extend({},this.params,{ids:t.get(".mid")}),i={qrIds:this.params.ids},n=ns.Model.get("state-message-thread-item",a),o=ns.Model.get("quick-reply-state",i),r=this;t===this.getModel("messages").models[0]?(this._unsubscribeFirstUserScroll(),this.mStateMessageThreadList.set(".blockAutoMarkAsRead",!0),this._subscribeFirstUserScroll()):n.once("ns-model-changed.didRendered",(function(){r.mStateMessageThreadList.trigger("ns-model:expand-list",{messageIndex:s.length})})),Daria.is3pane()&&!o.isVisible()&&s.forEach((function(e){e.isNew()&&this._setMessageOpenState(e,!0,!1)}),this),this.forceUpdate()}},getFocusableChildren:function(){var e=this.mStateMessageThreadList.get(".hiddenMessages"),s=[];return this.forEachValidItem((function(t){_.includes(e,t)||s.push(t)})),s.reverse()}}},"first-user-scroll-mixin",ns.ViewCollection)},3103:function(e,s){ns.View.define("message-thread-pager",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-message-thread-pager-loadMore":"onLoadMoreClick","click .js-message-thread-pager-expandUnread":"onExpandUnreadClick"},models:{message:!1,messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"updateCounters","ns-model-remove":"updateCounters"},"state-message-thread-list":{"ns-model-changed":!1,"ns-model-changed.countHiddenMessages":"updateCounters","ns-model-destroyed":"keepValid"}},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}},ctor:function(){this.updateCounters=_.throttle(this.updateCounters.bind(this),50)},yateModule:"messages",methods:{getFocusableChildren:function(){return[this]},NODE_CLASS:"mail-MessageThread-Pager",LOAD_MESSAGES_QUANTITY:30,onMessagesChanged:function(e,s){".new"===s.jpath&&this.updateCounters()},onHtmlInit:function(){this.$pagerLoadMore=this.$node.find(".js-message-thread-pager-loadMore"),this.$pagerExpandUnread=this.$node.find(".js-message-thread-pager-expandUnread")},onShow:function(){this.updateCounters()},onHide:function(){this.updateCounters.cancel()},updateCounters:function(){if(this.toggleVisible(),this.shouldBeVisible()){var e=!1;if(Daria.is2pane()){var s=this.getModel("messages"),t=s.getUnreads().length;e=t>0,this.$node.toggleClass(this.NODE_CLASS+"_withUnread",e),this.setTextInCounters(t)}Jane.c("Треды",'показ кнопки "показать N писем"'),e&&Jane.c("Треды",'показ кнопки "перейти к непрочитанным"')}},setTextInCounters:function(e){this.$pagerExpandUnread.html(i18n("%Messages_Перейти_к_N_непрочитанным",e))},onLoadMoreClick:function(){Jane.c("Треды",'клик по кнопке "показать N писем"'),ns.events.trigger("daria:vMessageThreadList:showMore")},onExpandUnreadClick:function(){Jane.c("Треды",'клик по кнопке "перейти к непрочитанным"'),ns.events.trigger("daria:vMessageThreadList:expandUnread")},shouldBeVisible:function(){var e=this.getModel("state-message-thread-list"),s=this.getModel("messages").canLoadMore(),t=e.getCountHiddenMessages();return Boolean(t||s)},toggleVisible:function(){this.$node.toggleClass("is-hidden",!this.shouldBeVisible())},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":Daria.Focus.moveItem(!0),this.onLoadMoreClick()}},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}})},3104:function(e,s){ns.View.define("message-thread-more-button",{events:{"click .js-toolbar-item-more":"onMoreButtonClick"},models:{"message-thread-toolbar":!0},yateModule:"messages",methods:{onMoreButtonClick:function(e){if(e.stopPropagation(),this.vPopup&&this.vPopup.isValid())return this.vPopup.closePopup(),void(this.vPopup=null);this.vPopup=ns.View.create("message-thread-toolbar-popup",this.params),this.vPopup.open({where:e.currentTarget})},closePopup:function(){this.vPopup&&this.vPopup.closePopup()}}})},3105:function(e,s){ns.View.define("message-thread-messages-count",{models:{message:!0,"messages-checked":!0},params:function(e){return{ids:e.thread_id||e.ids}},yateModule:"messages",methods:{showMessagesCount:function(){return this.getModel("message").hasRealData()?this.getModel("message").getThreadCount():null}}})},3106:function(e,s){ns.View.define("message-thread-reply-all",{events:{click:"onReplyAllThreadButton","ns-view-show":"onRefresh","daria:vMessageThreadReplyAll:replyAll":"onReplyAllHotkey"},models:{messages:{"ns-model-changed":!1,"ns-mode-insert":"onRefresh","ns-model-remove":"onRefresh"},"index-data":!1},params:function(e){return{thread_id:e.thread_id||e.ids}},yateModule:"messages",ctor:function(){this.onQuickReplyFormVisibilityChanged=this.onQuickReplyFormVisibilityChanged.bind(this),this.onRefresh=_.debounce(this.onRefresh.bind(this),20)},methods:{onRefresh:function(){this.reinitLastMessage()},showView:function(){Jane.c("Message view","Reply all bottom","show"),this.$node.removeClass("is-hidden")},hideView:function(){this.$node.addClass("is-hidden")},reinitLastMessage:function(){var e,s=this.getModel("messages").getLastReplyMessage();s&&s.get(".mid")&&!$(".thread-item-"+s.get(".mid")).hasClass("is-hidden")&&(e=s.get(".mid"));var t=this.lastMid;if(t===e)return void(e||this.hideView());if(t){var a=this.getQuickReplyState(t);a&&a.off("ns-model-changed.formIsShown",this.onQuickReplyFormVisibilityChanged)}if(e){this.getQuickReplyState(e).on("ns-model-changed.formIsShown",this.onQuickReplyFormVisibilityChanged)}this.lastMid=e,this.onQuickReplyFormVisibilityChanged()},onQuickReplyFormVisibilityChanged:function(){if(!this.lastMid)return void this.hideView();this.getQuickReplyState(this.lastMid).isVisible()?this.hideView():this.showView()},getQuickReplyState:function(e){return ns.Model.get("quick-reply-state",{qrIds:e})},getStateMessageThreadItem:function(e){return ns.Model.get("state-message-thread-item",{ids:e})},onReplyAllThreadButton:function(){this.openQuickReply(),Jane.c("Message view","Reply all bottom","click")},onReplyAllHotkey:function(){this.openQuickReply()},openQuickReply:function(){var e=this.lastMid;if(e){var s=this.getQuickReplyState(e),t=this.getStateMessageThreadItem(e);s.isVisible()?(ns.Model.get("compose-state",{ids:e,oper:"reply-all"}).setFocusField("send"),s.placeInViewport()):t.isOpen()?s.showForm():(s.set(".forceShow",!0),t.setOpen(!0))}}}},"message-actions")},3107:function(e,s){function t(e){return n(e)||i(e)||a()}function a(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function n(e){if(Array.isArray(e)){for(var s=0,t=new Array(e.length);s<e.length;s++)t[s]=e[s];return t}}ns.View.define("message-thread-toolbar-popup",{events:{"click .js-toolbar-item-forward":"_onForwardToolbarButton","click .js-toolbar-item-delete":"_onRemoveToolbarButton","click .js-toolbar-item-spam":"_onTospamToolbarButton","click .js-toolbar-item-not-spam":"_onNotspamToolbarButton","click .js-toolbar-item-archive":"_onArchiveToolbarButton","click .js-toolbar-item-labels-actions":"_openLabelsDropdown","click .js-toolbar-item-folders-actions":"_openFoldersDropdown","click .js-toolbar-item-pin":"_onPinToolbarButton","click .js-toolbar-item-unpin":"_onUnpinToolbarButton","click .js-toolbar-item-mark-important":"_onMarkImportantToolbarButton","click .js-toolbar-item-mark-unimportant":"_onMarkUnimportantToolbarButton","click .js-toolbar-item-mark-as-read":"_onReadToolbarButton","click .js-toolbar-item-mark-as-unread":"_onUnreadToolbarButton","click .js-kbd-print":"_onPrintToolbarButton"},models:{"message-thread-toolbar":!0,message:!0,"messages-checked":!1},params:function(e){return{mid:e.ids,ids:e.ids}},yateModule:"messages",methods:{open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then((function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))}),this)},closePopup:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer((function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()}))},_onForwardToolbarButton:function(){Jane.ToolbarMetric.messageThreadToolbar("forward"),this.closePopup();var e={mMessagesChecked:this.getMessagesCheckedInstance()};ns.action.run("forward",e)},_onRemoveToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("remove"),this._onToolbarButton("remove")},_onTospamToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("spam"),this._onToolbarButton("tospam")},_onNotspamToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("not spam"),this._onToolbarButton("notspam")},_onArchiveToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("archive"),this._onToolbarButton("archive")},_onPinToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("pin"),this._onToolbarButton("pin")},_onUnpinToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("unpin"),this._onToolbarButton("unpin")},_onMarkImportantToolbarButton:function(){Jane.ToolbarMetric.messageThreadToolbar("Important","add");var e=ns.Model.get("labels").getImportantLID();return this._onToolbarButton("label",{lid:e})},_onMarkUnimportantToolbarButton:function(){Jane.ToolbarMetric.messageThreadToolbar("Important","remove");var e=ns.Model.get("labels").getImportantLID();return this._onToolbarButton("unlabel",{lid:e})},_onReadToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("read"),this._onToolbarButton("mark")},_onUnreadToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("unread"),this._onToolbarButton("unmark")},_openLabelsDropdown:function(e){var s=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,s,"label"),this._openDropdown("labels",e)},_openFoldersDropdown:function(e){var s=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,s,"move"),this._openDropdown("folders",e)},_onToolbarButton:function(e,s){s=s||{},this.closePopup();var t=s.mMessagesChecked||this.getMessagesCheckedInstance();return Daria.MOPS[e](t,s)},getMessagesCheckedInstance:function(){return this._mMessagesChecked=ns.Model.get("messages-checked",{mid:this.params.ids}).checkByMidInParams(),this._mMessagesChecked},_openDropdown:function(e,s){var a=$(s.currentTarget);if(!a.hasClass("js-open-dropdown")){var i=ns.View.create(e+"-actions"),n=this.getMessagesCheckedInstance(),o=ns.Model.get("labels"),r=o.getImportantLID();i.open(s.currentTarget,n,{isInDropdown:!0,isInMore:!0,logMetrika:function(e,s){var a,i=["метка",e===r?"флажок":"пользовательская метка"];i=i.concat("label"===s?"проставление":"снятие"),(a=Jane.ToolbarMetric).messageThreadToolbar.apply(a,t(i))}}).then((function(){a.addClass("js-open-dropdown"),i.nbPopup.on("nb-closed",(function(){a.removeClass("js-open-dropdown")}))}))}},_onPrintToolbarButton:function(e){var s=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,s,"print")}}})},3108:function(e,s){ns.View.define("messages-date-pager-float",{models:{"messages-pager":!1,folders:!1,settings:!1,messages:!1,"scroller-messages":!1},"params-":["datePager"],events:{"ns-view-htmlinit":function(){var e=this;Promise.resolve().then((function(){e.pager=new Daria.MessagesPager(e.node,!0)}))},"ns-view-htmldestroy":function(){this.pager&&this.pager.unbindEvents(),delete this.pager},"ns-view-show":function(){this.pager&&this.pager.updateScroll(this.params),this.getModel("scroller-messages").init(),this.isHidden=!0,this.$node.addClass("block-messages-date-pager-float-box_hidden"),this._updateVisibility()},"ns-view-hide":function(){this.isHidden=!0,this.$node.addClass("block-messages-date-pager-float-box_hidden")},"daria:vScrollerMessages:scroll":"_updateVisibility","daria:layout-changed":"_updateVisibility","messages-date-pager.updateVisibility@show":"_updateVisibility"},yateModule:"messages",methods:{patchTree:function(){var e=this.super_.patchTree.call(this),s=this.getModel("messages-pager").getCountMonth();return e.isEmptyMessages=this.getModel("messages").isEmptyList(),e.hasSlider=s>5&&!this.params.pager_top||s>13&&this.params.pager_top,e},_updateVisibility:function(){var e=!1,s=ns.page.current.params,t=this.getModel("scroller-messages");this.$node.rect().top<t.getHeight()+150&&(e=!0,s.datePager&&!s.search&&ns.events.trigger("daria:vMessagesWrap:messages-scroll-load")),e!==this.isHidden&&(this.isHidden=e,this.$node.toggleClass("block-messages-date-pager-float-box_hidden",e))}}})},3109:function(e,s){ns.View.define("messages-empty",{events:{"click .js-label-filter-empty-list":"onClickLabelFilterEmptyList"},models:{filters:!0,messages:!1,"typefilter-tabs-state":!1},yateModule:"messages",methods:{onClickLabelFilterEmptyList:function(){var e=this,s=this.params.current_label;s&&(Jane.c(["Промо меток","Писем с такой меткой нет","клик по ставить метку автоматически"]),Jane.Services.run("#setup",(function(){Daria.Label.createFilter(s).then((function(){e.forceUpdate()}))})))}}})},3110:function(e,s){ns.View.define("messages-empty-wrap",{events:{"ns-view-htmlinit":"onHtmlInit"},models:{messages:"onMessagesChange"},yateModule:"messages",methods:{patchLayout:function(){return this.getModel("messages").isEmptyList()?"layout-messages-empty-view":"layout-messages-empty"},onHtmlInit:function(){var e=this.getModel("messages");this._isEmptyList=e.isEmptyList()},onMessagesChange:function(){var e=this.getModel("messages"),s=e.isEmptyList();s!==this._isEmptyList&&(this._isEmptyList=s,this.forceUpdate())}}})},3111:function(e,s){ns.View.define("messages-item-thread-toggle-mixin",{methods:{toggleThread:function(){var e=this.getModel("messages-item-state"),s=e.STATE;e.getState()===s.THREAD_SHORT?e.setState(s.CLOSE):e.setState(s.THREAD_SHORT)}}})},3112:function(e,s){ns.View.edefine("messages-item-thread-expand",{events:{click:"onClickThreadToggle"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-remove":"keepValid"},"messages-item-state":{"ns-model-changed":"onChangeState"}},yateModule:"messages",methods:{onChangeState:function(){var e=this.getModel("messages-item-state");this.$node.toggleClass("is-folded",e.getState()===e.STATE.CLOSE)},onClickThreadToggle:function(e){e.preventDefault(),e.stopPropagation(),this.toggleThread()}}},"messages-item-thread-toggle-mixin",ns.View)},3113:function(e,s){ns.View.define("messages-item-thread-expand-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed.count":"forceUpdate","ns-model-changed.firstline":"forceUpdate"}),"messages-item-state":ns.View.defineModelEvents({"ns-model-changed":"_messagesItemThreadExpandMixinChangeState"})},events:{"click .js-thread-toggle":"_messagesItemThreadExpandMixinOnClickThreadToggle"},yateModule:"messages",methods:{_messagesItemThreadExpandMixinOnClickThreadToggle:function(e){e.preventDefault(),e.stopPropagation(),this.toggleThread()},_messagesItemThreadExpandMixinChangeState:function(){var e=this.getModel("messages-item-state");this.$node.find(".js-thread-toggle").toggleClass("is-folded",e.getState()===e.STATE.CLOSE),ns.events.trigger("daria:vMessagesItemThreadExpandMixin:thread-expanded")}}},"messages-item-thread-toggle-mixin",ns.View)},3114:function(e,s,t){"use strict";function a(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}Object.defineProperty(s,"__esModule",{value:!0});var i,n=t(376),o=t.n(n),r=t(325),d=t(397),l=t(392),g=(i={},a(i,o.a.CLICK+!0,d.d),a(i,o.a.HOTKEY+!0,d.e),a(i,o.a.CLICK+!1,d.b),a(i,o.a.HOTKEY+!1,d.c),i);!(function(){var e=["go-to-replied-message-mixin","messages-search-logger-mixin","messages-item-thread-toggle-mixin","messages-item-labels-mixin","messages-item-thread-expand-mixin","important-toggleable-mixin","priority-toggleable-mixin","messages-item-userpic-and-checkbox-mixin","read-toggleable-mixin","scenario-manager-mixin"],s=ns.View.infoLite("attachments-widget").params;ns.View.defineNg("messages-item",{models:{message:ns.View.defineModelEvents({"ns-model-changed.count":"forceUpdate","ns-model-changed.field":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-changed.flags":"forceUpdate","ns-model-changed.lid":"forceUpdate","ns-model-changed.new":"_onToggleMark","ns-model-changed.subject":"forceUpdate","ns-model-changed.fid":"forceUpdate","ns-model-changed.tabId":"forceUpdate"}),"messages-checked":!1,"messages-item-state":!1,settings:ns.View.defineModelEvents({"ns-model-changed.enable_firstline":"forceUpdate","ns-model-changed.show_priority_label":"forceUpdate","ns-model-changed.liza_minified":"forceUpdate"})},params:{ids:null},events:{"ns-view-init":"onInit","ns-page-before-load@show":"onPageBeforeLoad","ns-page-after-load@show":"onPageAfterLoad","ns-page-error-load@show":"onPageErrorLoad",click:"onClick","click .js-show-attachments":"_showAttachments","click .js-message-snippet-importance":"_onImportantToggleableClick","daria:vMessagesItem:setFakeFocusIfOpened@show":"setFakeFocusIfOpened"},mixins:e,yateModule:"messages",methods:{timerID:null,delayBeforeOpen:500,onInit:function(){this._messageId=this.params.ids},onPageBeforeLoad:function(e,s,t){t!==ns.page.currentUrl&&(this.clearTimer(),this.toggleFakeFocusByParams(s[1].params),ns.Model.get("focus").setFocusAfterPageLoaded())},onPageAfterLoad:function(){ns.Model.get("focus").shouldSetFocusAfterPageLoaded()&&this.toggleFakeFocusByParams()},onPageErrorLoad:function(){ns.Model.get("focus").shouldSetFocusAfterPageLoaded()&&this.toggleFakeFocusByParams()},toggleFakeFocusByParams:function(e,s){e=e||ns.page.current.params;var t=this.isCurrentByParams(e),a=this.$node.hasClass("is-focused"),i=ns.Model.get("focus");s||t&&!a?i.hasFocus()?(i.saveViewAsLastFocused(this,i.indexColumns.MESSAGES),this.addFocus(),Daria.Focus.scrollIntoView(this.$node,i.indexColumns.MESSAGES)):i.setFocusByMid(this.params.ids,!0):!t&&a&&this.removeFocus()},setFakeFocusIfOpened:function(){var e=ns.page.current.params;this.isCurrentByParams(e)&&this.toggleFakeFocusByParams(e,!0)},_onToggleMark:function(){this.getSnippetNode().toggleClass("is-unread",this.getModel("message").isNew())},getSnippetNode:function(){return this.$node.find(".mail-MessageSnippet").eq(0)},onClick:function(e){return e.shiftKey?((new Daria.CBS).selectWithShift(this.params.ids),!1):!(!Daria.isLeftClickWithCtrl(e)&&!Daria.isMiddleButton(e))||(0!==$(e.target).closest(".js-skip-click-message-item").length||(Daria.is2pane()&&e.preventDefault(),ns.Model.get("focus").setFocusByMid(this.params.ids,!0),this.openMessage(),this.scenarioManager.finishScenarioIfActive(r.e,l.c),void(!Daria.is3pane()&&this._shouldOnlyToggleThread()||this._startMessageViewScenario(o.a.CLICK))))},_startMessageViewScenario:function(e){this.scenarioManager.finishScenarioIfActive(r.e,l.c);var s=this.getModel("message"),t=s.isThread()&&s.getThreadCount()>1,a=g[e+t];this.scenarioManager.startScenario(r.e,a)},_getOpenMessageInListSetting:function(){return ns.Model.get("settings").isSet("open-message-list")},_shouldOnlyToggleThread:function(){var e=this.getModel("message");return!this._getOpenMessageInListSetting()&&e.getThreadCount()>1},openMessage:function(){if(this.logClickMessageFromSearch("mail"),!Daria.is3pane()){var e,s=this.getModel("message"),t=this._getOpenMessageInListSetting();if(e=t?Daria.Page.generateUrl.contentMessage3pane(s.getData()):Daria.Page.generateUrl.contentMessage2pane(s.getData()),t){this.getModel("messages-item-state").close()}s.getThreadCount()>1&&Jane.c("Треды","открытие треда из списка писем"),this._shouldOnlyToggleThread()?this.toggleThread():ns.page.go(e),this.logOpenMessage&&this.logOpenMessage()}},switchOpen:function(){if(Daria.is2pane())return this.openMessage(),void this._startMessageViewScenario(o.a.HOTKEY);if(ns.Model.get("focus").getPreventOpenOnFocus()&&this.focusOn(),this.getModel("message").getThreadCount()<=1)return this.openMessage(),void this._startMessageViewScenario(o.a.HOTKEY);var e=this.getModel("messages-item-state");e.isClosed()?e.setState(e.STATE.THREAD_SHORT):e.close()},_showAttachments:function(e){e.preventDefault(),e.stopPropagation();var t=s(this.params);ns.View.create("attachments-widget-popup",t).showAt(e.currentTarget)},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn(e);break;case"blur":this.focusOff();break;case"space":this.toggleCheck();break;case"enter":this.switchOpen()}},focusOn:function(e){var s=(e||{}).preventOpenOnFocus;this.addFocus(),ns.Model.get("focus").cancelSetFocusAfterPageLoaded(),s||this.startOpenMessage()},focusOff:function(){if(Daria.is3pane()){var e=ns.Model.get("focus");switch(e.getIndexCurrentColumn()){case e.indexColumns.LEFT:break;case e.indexColumns.MESSAGES:this.clearTimer(),this.removeFocus();break;case e.indexColumns.MESSAGE:this.clearTimer(),this.removeFocus(),ns.events.trigger("daria:vMessagesItem:setFakeFocusIfOpened");break;default:this.clearTimer(),this.removeFocus()}}else this.clearTimer(),this.removeFocus()},addFocus:function(){this.$node.addClass("is-focused")},removeFocus:function(){this.$node.removeClass("is-focused")},getParentReferenceParams:function(){var e=ns.Model.get("message",{ids:this._messageId}).getThreadMessage();if(e&&ns.Model.get("messages-item-state",{ids:e.getThreadId()}).isClosed())return{params:{ids:e.getThreadId()}}},toggleCheck:function(){var e=this.getModel("message");this.getModel("messages-checked").toggleCheck(e)},isCurrentByParams:function(e){return e=e||ns.page.current.params,this.params.ids===e.thread_id||this.params.ids===e.ids},startOpenMessage:function(){var e=ns.page.current.params;Daria.is2pane()||ns.Model.get("folders").isFolder(e.current_folder,["draft","template"])||this.isCurrentByParams()||(this.clearTimer(),this.timerID=setTimeout(this.openMessage3pane.bind(this),this.delayBeforeOpen))},openMessage3pane:function(){var e=_.clone(ns.page.current.params);this.getModel("message").isThread()?(e.thread_id=this.params.ids,delete e.ids):(e.ids=this.params.ids,delete e.thread_id),this.isCurrentByParams()||(ns.page.go(ns.router.generateUrl("messages",e)),this._startMessageViewScenario(o.a.HOTKEY))},clearTimer:function(){clearTimeout(this.timerID),this.timerID=null},hasFocusedClass:function(){var e=ns.Model.get("focus");return e.isFocusedInColumn(e.indexColumns.MESSAGES,this)}}})})()},3115:function(e,s){ns.View.define("messages-item-date",{yateModule:"messages",models:{message:{"ns-model-changed":"keepValid","ns-model-changed.date":"forceUpdate","ns-model-changed.fid":"forceUpdate","ns-model-changed.tabId":"forceUpdate"},folders:{"ns-model-changed":!1,"daria:mFolders:rename":"forceUpdate"}}})},3116:function(e,s){ns.View.defineNg("messages-item-attachments",{yateModule:"messages"},"messages-item")},3117:function(e,s){ns.View.defineNg("messages-item-events",{models:{labels:!1,message:ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"}),"messages-item-state":ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"}),"message-widget-events":ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"})},events:{"ns-view-show":"onWidgetEventsShow","click .js-widget-events-accept":"acceptEvent","click .js-widget-events-decline":"declineEvent","click .js-widget-events-edit":"editEvent","click .js-toggles-WidgetEventsPopup_more":"closeAllPopups","click .js-widget-events-user":"onWidgetEventsUserClick"},yateModule:"messages",ctor:function(){this.sendShowLog=_.once(this.sendLogs.bind(this,"show"))},methods:{_LOG_OPTIONS:{show:{metrik:"show"},accepted:{metrik:["click","bth-go"],actionLogButton:!0},declined:{metrik:["click","btn-reject"],actionLogButton:!0},"see-calendar-link":{metrik:["click","btn-see-calendar-link"],actionLogButton:!0},clickMore:{metrik:["click","more"],actionLogButton:!0},mail:{metrik:["click","mail"],actionLogButton:!0}},_NAME_POPUP_USER_LIST:"widget-event-dropdown-",onWidgetEventsShow:function(){this.nbPopup=nb.find(this._NAME_POPUP_USER_LIST+this.params.ids),this.sendShowLog()},changeEvent:function(e){nb.trigger("popup-close");var s=ns.Model.get("message-body",{ids:this.params.ids}),t=s.getCalendarICS(),a=s.getSTID(),i={decision:e,hid:t,stid:a,ids:this.params.ids};ns.request(["save-event-by-ics"],i).then(this._changeEventRequest,this)},_changeEventRequest:function(e){if("ok"===e[0].status){var s=e[0]&&e[0].getEventInfo();if(!s)return;this.updateEventInfo(s);var t=this.getModel("message");t.isNew()&&t.toggleMark()}},updateEventInfo:function(e){this.getModel("message-widget-events").setEventInfo(e)},acceptEvent:function(e){e.preventDefault(),e.stopPropagation(),this.changeEvent("accepted"),this.sendLogs("accepted")},declineEvent:function(e){e.preventDefault(),e.stopPropagation(),this.changeEvent("declined"),this.sendLogs("declined")},editEvent:function(){this.sendLogs("see-calendar-link")},closeAllPopups:function(){this.nbPopup.isOpen()||this.sendLogs("clickMore"),nb.trigger("popup-close")},sendLogs:function(e){var s=this.getModel("message-widget-events"),t=this.getModel("message"),a=Boolean(s.get(".eventInfo")),i=Daria.Widgets.shouldShowTaksaCalendarWidget(t);"show"===e&&Daria.monitoring.stat.ics({mid:s.params.ids,show_v1:a,show_v2:i}),a&&(this.sendMetrik(e),this.sendActionLog(e))},sendMetrik:function(e){var s=this.getMetrikName(),t=this._LOG_OPTIONS[e].metrik;Jane.c(["Widgets","ICS",s].concat(t))},getMetrikName:function(){var e=this.getModel("message-widget-events");return e.get(".isOutdated")||!e.get(".isNotPast")?"ICS Outdated Inbox Widget":e.get(".eventInfo.isCancelled")?"ICS Cancel Inbox Widget":"event_update"===e.get(".eventInfo.calendarMailType")?"ICS Update Inbox Widget":"ICS Full Inbox Widget"},sendActionLog:function(e){var s=this.getModel("message-widget-events"),t="show"===e,a=t?"widget-show":"click-widget-btn",i=this._LOG_OPTIONS[e].actionLogButton,n={action:a,widget:"ics","widget-type":this.getActionType(),ids:{ids:[this.params.ids]}};t&&!s.get(".eventInfo.isCancelled")&&(n["widget-controls"]=this.getWidgetControlsList()),i&&(n.btn=e),Daria.actionLog(a,n)},getWidgetControlsList:function(){var e=this.getModel("message-widget-events"),s=e.get(".eventInfo.actions")||[],t=[];return-1!==s.indexOf("accept")&&t.push("btn-accept"),-1!==s.indexOf("decline")&&t.push("btn-decline"),e.get(".isNotOperate")||t.push("btn-see-calendar-link"),e.get(".isOutdated")||!e.get(".isNotPast")||e.get(".eventInfo.isCancelled")||t.push("btn-clickMore"),t},getActionType:function(){var e=this.getModel("message-widget-events");return e.get(".isOutdated")||!e.get(".isNotPast")?"ics-outdated":e.get(".eventInfo.isCancelled")?"ics-cancel":"event_update"===e.get(".eventInfo.calendarMailType")?"ics-update":"ics-full"},logOpenMessage:function(){this.sendLogs("mail")},onWidgetEventsUserClick:function(e){e.stopPropagation()}}},"messages-item")},3118:function(e,s){ns.View.define("messages-item-inner",{params:{ids:null},yateModule:"messages",methods:{}})},3119:function(e,s){ns.ViewCollection.define("messages-item-thread",{params:function(e){return{thread_id:e.ids}},split:{byModel:"messages",intoViews:"messages-item-wrap"},models:{messages:{"ns-model-changed":"keepValid","ns-model-remove":"checkCountAndUpdate","ns-model-insert":"forceUpdate"},"messages-checked":{"ns-model-changed":!1,"daria:mMessagesChecked:load-more-messages":"loadMoreMessages"}},events:{"ns-view-show":"_onShow","ns-view-hide":"_onHide","daria:vMessagesItemThread:loadMoreMessages@show":"_loadMoreMessages"},yateModule:"messages",methods:{_onShow:function(){ns.events.trigger("daria:mFocus:buildTree")},_onHide:function(){ns.events.trigger("daria:mFocus:buildTree")},loadMoreMessages:function(){var e=this.getModel("messages");e.canLoadMore()&&e.loadMore()},_loadMoreMessages:function(){if(this.__lockMessagesLoad)return!1;this.__lockMessagesLoad=!0;var e=this.getModel("messages").canLoadMore(),s=function(){this.update().always((function(){this.__lockMessagesLoad=!1}),this)}.bind(this);if(e)this.getModel("messages").loadMore().then(s,(function(){this.__lockMessagesLoad=!1}),this);else{this.node.querySelector(".ns-view-container-desc").childNodes.length!==this.getModel("messages").models.length&&(this.invalidate(),s())}return!1},isChecked:function(){return this.getModel("messages-checked").isChecked(this.getModel("message"))},checkCountAndUpdate:function(){if(!this.isVisible())return void this.forceUpdate();1===this.getModel("messages").getCount()?ns.page.go(Daria.Page.generateUrl.closeMessage()):this.forceUpdate()},getFocusableChildren:function(){var e=[];return this.forEachValidItem((function(s){e=e.concat(s.getFocusableChildren())})),e}}})},3120:function(e,s){ns.View.define("messages-item-thread-pager",{params:function(e){return{ids:e.ids,thread_id:e.ids}},models:{message:!1,messages:{"ns-model-changed":"updateIfVisible","ns-model-remove":"updateIfVisible","ns-model-insert":"updateIfVisible"}},events:{"ns-view-htmlinit":"onHtmlInit","click .js-messages-load-more":"loadMoreMessages"},yateModule:"messages",methods:{_canLoadMore:!1,onHtmlInit:function(){this._canLoadMore=this.canLoadMore()},canLoadMore:function(){return this.getModel("messages").canLoadMore()},loadMoreMessages:function(){ns.events.trigger("daria:vMessagesItemThread:loadMoreMessages")},updateIfVisible:function(){var e=this.canLoadMore();e!==this._canLoadMore&&(this._canLoadMore=e,this.forceUpdate())}}})},3121:function(e,s){ns.View.define("messages-item-widget-mixin",{methods:{updateWidget:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},getWidgetMetrikaString:function(e){return e=yr.nodeset2data(e||{})||{},this._getWidgetMetrika(this.getModel("message"),e).join(":")},countWidgetMetrika:Daria.memoizeMetricsById([],(function(){return this.__uniqueId}),(function(){return this.__getWidgetMetrika.apply(this,arguments)})),__getWidgetMetrika:function(e){e=yr.nodeset2data(e||{})||{};var s=this._getWidgetMetrika(this.getModel("message"),e);e.isClick?Jane.c(s):Jane.groupedCount(s)},_getWidgetMetrika:function(e,s){s=s||{};var t=e.get(".widget.info"),a=t.type,i=["Виджеты",t.valid?a:"Протухший ".concat(a),t.subtype];return s.label&&-1!==["pkpass","avia","hotels","calendar"].indexOf(a)&&i.push(s.label),s.isClick?i.push("клик"):i.push("показ","+"),i}}})},3122:function(e,s){ns.View.defineNg("messages-item-widget",{models:{message:ns.View.defineModelEvents({"ns-model-changed.field":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-changed.flags":"forceUpdate","ns-model-changed.new":"_onToggleMark","ns-model-changed.subject":"forceUpdate"}),"messages-checked":!1,"messages-item-state":!1,settings:!1},events:{click:"onClick","click .js-print-widget-button":"onClickPrint","click .js-delete-widget-button":"onClickDelete","click .js-compose-widget-button":"onClickCompose","daria:vThemesSelector:new-schema@show":"updateWidget"},yateModule:"messages",methods:{onClickPrint:function(e){this.onClickControl(e),Daria.Printer.printMessage(this.params.ids)},onClickDelete:function(e){this.onClickControl(e),Daria.MOPS.remove(this.getModel("message").getMessagesCheckedModel())},onClickCompose:function(e){this.onClickControl(e);var s=this.getModel("message").get('.widget.controls[.type == "compose"].attributes')[0]||{},t=s.mid,a=Boolean(s.fix_rcpt);if(t){var i={ids:t,oper:"template"};ns.request("message",{ids:t}).then((function(){this.createCustomTemplate(i,a)}),this).fail((function(){Jane.ErrorLog.send({type:"widget-bounce-compose-no-message",mid:t}),this.openMessage()}),this)}},createCustomTemplate:function(e,s){ns.request("compose-message",e).then((function(t){var a=t[0];this._createCustomTemplate(a,e,s)}),this).fail((function(){Jane.ErrorLog.send({type:"widget-bounce-compose-no-compose-message",mid:e.ids})}))},_createCustomTemplate:function(e,s,t){return ns.page.go(ns.router.generateUrl("compose2",s)).then((function(){var a,i=e.mMessage,n=e.mMessageBody,o=e.mComposeState,r=i.getSubject(),d=e._getMessageType(),l=n.getSubtype();a="plain"===l?Daria.Html2Text.html2text(n.getDraftBody(d)):n.getDraftBody(d);var g=n.getAddressField("to"),c=n.getAddressField("cc"),h=n.getAddressField("bcc"),m=n.getAddressField("phone"),u=_.clone(i.get(".lid")),f=i.getDelayedTime();if(!f){var p=ns.Model.get("labels").getDelayedMessageLabel();p&&(u=_.pull(u,p.lid))}var M=[{jpath:".overwrite",value:s.ids},{jpath:".ign_overwrite",value:"yes"},{jpath:".save_symbol",value:"draft"},{jpath:".ttype",value:d},{jpath:".lids",value:u},{jpath:".from_name",value:i.getFromName()},{jpath:".from_mailbox",value:i.getFromEmail()},{jpath:".inreplyto",value:n.getInReplyTo()},{jpath:".references",value:n.getReferences()},{jpath:".current_folder",value:i.getFolderId()},{jpath:".send_time",value:f}];r&&M.push({jpath:".subj",value:r}),t||(g&&M.push({jpath:".to",value:g},{jpath:".initial_to",value:g}),c&&(M.push({jpath:".cc",value:c},{jpath:".initial_cc",value:c}),o.setIfChanged(".isCcVisible",!0)),h&&(M.push({jpath:".bcc",value:h}),o.setIfChanged(".isBccVisible",!0))),m&&(M.push({jpath:".phone",value:m}),o.setIfChanged(".isPhoneVisible",!0)),a&&M.push({jpath:".send",value:a}),_.forEach(M,(function(s){e.set(s.jpath,s.value)})),t?o.setFocusField("to"):o.setFocusField("send")}))},onClickControl:function(e){e.preventDefault()},getWidgetImgLinkIcon:function(e){var s=/[A-Za-z0-9_-]*\.svg/g.exec(e);return s&&s[0]&&-1!==s[0].search(/\.svg$/)?s[0].substring(0,s[0].search(/\.svg$/)):e}}},"messages-item-widget-mixin","messages-item")},3123:function(e,s){ns.View.defineNg("messages-item-ticket",{yateModule:"messages"},"messages-item-widget")},3124:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(325),i=t(392);ns.View.edefine("messages-item-wrap",{events:{"ns-view-show":"onShow","click .js-messagesItem-toggle-opened":"onClickCloseMessage","click .js-mail-Message-Body_close_letter":"onClickCloseMessage"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"onMessageCountChanged","ns-model-changed.lid":"onMessageLidChanged","ns-model-checked-toggle":"onToggleCheck"},"messages-item-state":{"ns-model-changed":"keepValid","ns-model-changed.state":"onItemStateChanged"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onToggleCheck"}},yateModule:"messages","params+":{current_folder:null,search:null,scope:null,extra_cond:null,category:null,tabId:null},methods:{REG_EXP_FOR_TREE_WALKER:/^messages-item(-attachments|-events|-widget|-ticket)?$/,patchLayout:function(){var e=this.getModel("message"),s=Daria.Widgets.getWidgetName(e),t={};if(Daria.is3pane())return t.threadInner=this.isThreadListOpen(),Daria.messages.createMessagesItemLayout(t);var a=ns.page.current.params;return this.params.ids===a.thread_id?(ns.events.trigger("daria:vMessagesItemWrap:message-opened"),Daria.messages.createMessagesItemLayout({threadFull:!0})):this.params.ids===a.ids?(ns.events.trigger("daria:vMessagesItemWrap:message-opened"),"layout-message-opened"):s&&!e.isThread()?Daria.messages.createMessagesItemLayout({widget:s}):Daria.Widgets.shouldShowAttachments(e,ns.page.current.params)?Daria.messages.createMessagesItemLayout({threadInner:this.isThreadListOpen(),widget:"attachments"}):e.isThread()?Daria.messages.createMessagesItemLayout({threadInner:this.isThreadListOpen()}):Daria.messages.createMessagesItemLayout({})},onShow:function(){this.logWidgets()},logWidgets:Daria.memoizeMetricsById([],(function(){return this.__uniqueId}),(function(){return this._logWidgets()})),_logWidgets:function(){var e=this.getModel("message"),s=e.get(".widget");s&&this.writeLogForWidgets("exists",{mid:this.params.ids,widgetType:s.info.type,widgetSubType:s.info.subtype,origin:"list-widget"}),"widget"===Daria.Widgets.getWidgetName(e)&&s&&this.writeLogForWidgets("view",{mid:this.params.ids,widgetType:s.info.type,widgetSubType:s.info.subtype,origin:"list-widget"})},onMessageCountChanged:function(){this.getModel("messages-checked").trigger("daria:mMessagesChecked:load-more-messages")},isThreadListOpen:function(){var e=this.getModel("messages-item-state"),s=e.STATE;return e.getState()===s.THREAD_SHORT},isSearchTopResult:function(){return this.getModel("messages-checked").isSearchTopResultByMid(this.getModel("message").get(".mid"))},onToggleCheck:function(){var e=this.getModel("message"),s=this.getModel("messages-checked"),t=s.isChecked(e);this.$node.toggleClass("is-checked",t)},onMessageLidChanged:function(){var e=this.getModel("message"),s=e.isPinned()&&Daria.messages.checkUsePinsByParams(this.params);this.$node.toggleClass("is-pinned",s)},onItemStateChanged:function(){this.lazyUpdate(),this.getModel("messages-item-state").isClosed()&&this.uncheckMessagesInThread()},onClickCloseMessage:function(e){if(!this.isSubjectSelected()){var s=$(e.target);if(!s.closest(".js-skip-click-messages-item-wrap").length&&!s.closest(".js-skip-click-message-item").length){e.preventDefault(),e.stopPropagation();var t=this.getModel("message").getThreadCount();s.closest(".js-message-close-button").length?(Jane.c("Закрытие письма кликом в шапку в 2pane","Закрытие по крестику"),t>1&&Jane.c("Треды","Закрытие треда","Закрытие по крестику")):(Jane.c("Закрытие письма кликом в шапку в 2pane","Закрытие по шапке"),t>1&&Jane.c("Треды","Закрытие треда","Закрытие по шапке")),ns.page.go(Daria.Page.generateUrl.closeMessage()),ns.events.trigger("daria:vMessagesItemWrap:message-closed"),this.uncheckMessagesInThread(),this._finishMessageViewScenario()}}},_finishMessageViewScenario:function(){this.scenarioManager.finishScenarioIfActive(a.e,i.d)},uncheckMessagesInThread:function(){var e=this.getModel("messages-checked"),s=this.getModel("message");e.isChecked(s)||s.uncheckThreadMessages(e)},isSubjectSelected:function(){var e=this.$node.find(".js-toolbar-subject")[0];if(!e)return!1;var s=window.getSelection();return!(!s||s.isCollapsed)&&("function"==typeof s.containsNode&&s.containsNode(e,!0))},getFocusableChildren:function(){var e=this.getModel("messages-item-state"),s=e.getState(),t=e.STATE;switch(s){case t.THREAD_SHORT:var a=Daria.nsTreeWalker.findView(this,["messages-item-box",this.REG_EXP_FOR_TREE_WALKER]),i=Daria.nsTreeWalker.findView(this,["messages-item-box","messages-item-inner","messages-item-thread"]);return i?[a].concat(i.getFocusableChildren()):[a];default:var n=Daria.nsTreeWalker.findView(this,["messages-item-box"]),o=Daria.nsTreeWalker.findView(n,[this.REG_EXP_FOR_TREE_WALKER]);if(o)return[o];var r=Daria.nsTreeWalker.findView(n,["message-thread"]);if(r)return r.getFocusableChildren();var d=Daria.nsTreeWalker.findView(n,["message"]);if(d)return[d]}}}},"journal-log-mixin","scenario-manager-mixin",ns.View)},3125:function(e,s){ns.View.define("messages-notification",{events:{"ns-view-htmlinit":"_onHtmlInit","click .js-create-template":"onCreateTemplateClick"},models:{folders:"doForceUpdate"},"params+":_.clone(ns.Model.infoLite("messages").params),yateModule:"messages",methods:{_toUpdate:null,_onHtmlInit:function(){var e=this.$node.find(".js-infoline A");e.length&&e.attr("href",ns.router.generateUrl("messages",{search:"search",request:e.text(),force:1}))},onCreateTemplateClick:function(){ns.Model.get("compose-predefined-data").setData({save_symbol:"template"}),ns.page.go(ns.router.generateUrl("compose2"))},toUpdate:function(){if(null===this._toUpdate)if(this.params.current_folder){var e=ns.Model.get("folders");this._toUpdate=e.isFolder(this.params.current_folder,["spam","trash","template"])}else this._toUpdate=!1;return this._toUpdate},doForceUpdate:function(){this.toUpdate()&&this.forceUpdate()}}})},3126:function(e,s){function t(e,s){return n(e)||i(e,s)||a()}function a(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function i(e,s){var t=[],a=!0,i=!1,n=void 0;try{for(var o,r=e[Symbol.iterator]();!(a=(o=r.next()).done)&&(t.push(o.value),!s||t.length!==s);a=!0);}catch(e){i=!0,n=e}finally{try{a||null==r.return||r.return()}finally{if(i)throw n}}return t}function n(e){if(Array.isArray(e))return e}!(function(){var e=Daria.IS_CORP?["messages","message-type-labels"]:["collectors","messages","message-type-labels"];ns.View.define("messages-notification-search",{models:e.concat("typefilter-tabs-state","settings"),events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-search-reset-folder-filter":"onResetFolderFilterClick","click .js-search-request":"onSearchRequestClick","click .js-search-feedback-close":"onFeedbackClose","click .js-feedback-link":"onFeedbackLinkClick","ns-page-before-load@show":"onSearchPageClose"},yateModule:"messages",ctor:function(){this._resetFeedbackFlags()},methods:{onShow:function(){this._cancelAdvancedSubscription=Daria.React.reactOnAdvancedChange("Daria.vMessagesNotificationSearch:searchQuerySubscription",this.invalidate.bind(this)),this.shouldShowFeedback()&&this.markFeedbackShow(),this.setViewShowCount()},onHide:function(){this._cancelAdvancedSubscription()},onSearchPageClose:function(e,s){var a=t(s,2),i=a[0],n=a[1],o=i.page,r=i.params,d=n.page,l=n.params,g=o===d,c=r.search===l.search&&r.request===l.request;g&&c||this._resetFeedbackFlags()},getViewShowCount:function(){var e=Number(ns.Model.get("settings").getSetting("feedback_search_count"))||0;return this._hasViewShown?e:e%10+1},setViewShowCount:function(){this._hasViewShown||(ns.Model.get("settings").setSettings({feedback_search_count:this.getViewShowCount()}),this._hasViewShown=!0)},canShow:function(){return this.getModel("messages").getCount()>0||"rpopinfo"===this.params.scope},shouldShowFeedback:function(){if(null===this._shouldShowFeedback){var e=ns.Model.get("settings"),s=Number(e.getSetting("feedback_search_close_count"))||0,t=this.getViewShowCount(),a=Number(e.getSetting("feedback_search_show_date"))||0,i=Daria.now()-a>=Jane.Date.DAY,n=t%10==0;this._shouldShowFeedback=this.canShow()&&Daria.hasExperiment("85773")&&"ru"===Daria.Config.locale&&s<3&&i&&n}return this._shouldShowFeedback},onResetFolderFilterClick:function(){Daria.React.startSearch(this.params.request,{metrika:"messages-notification-search:reset-folder"},!0)},onSearchRequestClick:function(e){var s=$(e.currentTarget).data("request"),t={request:s,force:!0};ns.events.trigger("daria:search:autocomplete-search-started",t),Daria.React.startSearch(s,{metrika:"messages-notification-search:request-click",extraSearchParams:{force:!0}},!0)},onFeedbackClose:function(){var e=ns.Model.get("settings"),s=Number(e.getSetting("feedback_search_close_count"))||0;e.setSettings({feedback_search_close_count:s+1}),this.sendMetric("Клик","Закрыть"),this.$node.find(".js-search-feedback").remove(),this._shouldShowFeedback=!1},onFeedbackLinkClick:function(){this.sendMetric("Клик","Линк")},markFeedbackShow:function(){!0!==this._hasFeedbackShown&&(this.sendMetric("Показ"),ns.Model.get("settings").setSettings({feedback_search_show_date:Daria.now()}),this._hasFeedbackShown=!0)},_resetFeedbackFlags:function(){this._shouldShowFeedback=null,this._hasFeedbackShown=!1,this._hasViewShown=!1},wasSearchRequestSimplified:function(){return Daria.React.wasSearchRequestSimplified()},getSearchParams:function(){return Daria.React.getSearchParams()},sendMetric:function(){for(var e,s=arguments.length,t=new Array(s),a=0;a<s;a++)t[a]=arguments[a];(e=Jane).c.apply(e,["Поиск","Оцените поиск"].concat(t))}}})})()},3127:function(e,s){ns.View.define("messages-pager",{models:{messages:!0},events:{"folder.cleared@show":"onUpdate","daria:vMessagesPager:restruct":"onUpdate"},yateModule:"messages",methods:{onUpdate:function(){this.invalidate(),this.forceUpdate()}}})},3128:function(e,s){ns.View.define("messages-pager-date",{models:{"messages-pager":!0},events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","ns-view-htmldestroy":"onhtmldestroy"},yateModule:"messages",ctor:function(){this.pagerInitDebounce=_.debounce(this.pagerInit.bind(this),0)},methods:{patchTree:function(){var e=this.super_.patchTree.call(this),s=this.getModel("messages-pager").getCountMonth();return e.hasSlider=Boolean(s>5&&!this.params.pager_top||s>13&&this.params.pager_top),e},onshow:function(){this.pagerPromise.done(this.pagerUpdateScroll,this)},onhtmlinit:function(){this.pagerPromise=new vow.Promise(this.pagerInitDebounce)},onhtmldestroy:function(){this.pagerInitDebounce.cancel(),this.pagerPromise&&(this.pagerPromise.done(this.pagerUnbindEvents),delete this.pagerPromise)},pagerUpdateScroll:function(e){e.updateScroll(this.params)},pagerUnbindEvents:function(e){e.unbindEvents()},pagerInit:function(e,s){this.node?e(new Daria.MessagesPager(this.node)):s()}}})},3129:function(e,s){ns.View.define("messages-pager-load-more",{events:{"ns-view-htmlinit":"onHtmlinit","click .js-message-load-more":"_onClickMessageLoadMore","daria:vMessages:messages-load-start@show":"_onMessagesLoadStart","daria:vMessages:messages-load-stop@show":"_onMessagesLoadStop"},models:{messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"onMessagesChanged","ns-model-remove":"onMessagesChanged"}},yateModule:"messages",methods:{_canLoadMore:!1,onHtmlinit:function(){this._canLoadMore=this.canLoadMore()},canLoadMore:function(){return this.getModel("messages").canLoadMore()},_onMessagesLoadStart:function(){this.$node.addClass("is-loading")},_onMessagesLoadStop:function(){this.$node.removeClass("is-loading")},_onClickMessageLoadMore:function(){return this.loadMore(),Daria.is2pane()&&Jane.c("Футер в 2-пейн","Еще","клик"),!1},onMessagesChanged:function(){this.canLoadMore()!==this._canLoadMore&&this.forceUpdate()},loadMore:function(){ns.events.trigger("daria:vMessagesPager:messages-load")}}})},3130:function(e,s){ns.View.define("messages-pager-nav",{events:{"ns-view-htmlinit":"onHtmlinit"},models:{messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"onMessagesChanged","ns-model-remove":"onMessagesChanged"},"messages-pager":!0},yateModule:"messages",methods:{_toShow:!1,patchTree:function(){var e=this.super_.patchTree.call(this),s=/^((\d{2})\.)?(\d{4})$/;if(e.isShowPagerNav=this.toShow(),e.isShowPagerNav){var t,a,i,n=this.params.datePager.match(s),o=n[3],r=n[2];if(r){var d=Daria.MessagesPager.decDate(o,r),l=Daria.MessagesPager.incDate(o,r);t=d[1]+d[0],a=l[1]+l[0],i=r+o}else t=parseInt(o,10)-1,a=parseInt(o,10)+1,i=o;e.navigator={currentDateId:i,prevDateId:t,nextDateId:a}}return e},onHtmlinit:function(){this._toShow=this.toShow()},onMessagesChanged:function(){this.toShow()!==this._toShow&&this.forceUpdate()},toShow:function(){var e=this.getModel("messages"),s=e.isEmptyList(),t=e.canLoadMore();return Boolean(!t&&!s&&this.params.datePager)}}})},3131:function(e,s){ns.View.define("messages-search-session",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},yateModule:"messages",methods:{onShow:function(){Daria.React.getSearchSessionId()},onHide:function(){Daria.React.dropSearchSession()}}})},3132:function(e,s){ns.View.define("messages-list",{yateModule:"messages"})},3133:function(e,s){!(function(){var e=$.extend({},ns.Model.infoLite("messages").params);ns.View.define("messages-wrap",{"params+":e,paramsRewrite:function(e){var s=ns.page.current.params;return!Daria.Page.isParamsForSingleThread(s)&&"thread_id"in e&&delete e.thread_id,e},events:{"ns-view-show":"onShow","ns-view-touch":"repaintWaitforreply","daria:vScrollerMessages:scroll":"_messagesLoad"},models:{"scroller-messages":!1},yateModule:"messages",methods:{LOAD_NEXT_PAGE_PADDING:300,onShow:function(){this.getModel("scroller-messages").init()},_messagesLoad:function(){Daria.is2pane()&&!Daria.isFullThreadPage()||!this._canLoadMessagesOnScroll()||ns.events.trigger("daria:vMessagesWrap:messages-scroll-load")},_canLoadMessagesOnScroll:function(){var e=this.getModel("scroller-messages");if(Daria.is2pane()){return this.$node.rect().bottom<=e.getHeight()+this.LOAD_NEXT_PAGE_PADDING}return e.getScrollBottom()<this.LOAD_NEXT_PAGE_PADDING},repaintWaitforreply:function(){var e=this.params,s=ns.Model.get("labels").getWaitingForReplyLabel(),t=jpath(s,".count")[0],a=jpath(s,".lid")[0],i=ns.Model.get("folders").isFolder(e.current_folder,["sent"]);if(t&&i&&this.waitForReplyCountLast!==t){var n=Jane.tt("mail:js-letters-without-answer",{count:t,lid:a}),o=$(".js-intruder-without-answer",this.node);o.length?o.replaceWith(n):$(".js-toolbar-hr",this.node).after(n),this.waitForReplyCountLast=t}else t||($(".js-intruder-without-answer",this.node).remove(),this.waitForReplyCountLast=0)}}})})()},3134:function(e,s){ns.View.define("messages-headers-mixin",{methods:{__sortViewItems:function(){this._destroyHeaders(),this.super_.__sortViewItems.apply(this,arguments),this._initHeaders()},_onHtmlDestroy:function(){this._destroyHeaders()},_redrawHeaderTopResults:function(){this.$headerTopResults&&this.$headerTopResults.off().html(Jane.tt("messages:vMessages-header-top-results"))},_getHeaderOtherResultsRenderData:function(){var e=this.getModel("messages"),s=e.get(".details.total-found")||0,t=e.get(".details.top-relevant")||0,a=s-t;return a>0?e.isSearchNotFilter()?{headerText:t>0?i18n("%Search_OtherResults"):i18n("%Search_AllResults"),messagesCount:a}:{messagesCount:a}:null},_redrawHeaderOtherResults:function(){if(this.$headerOtherResults){var e=this._getHeaderOtherResultsRenderData(),s=e?Jane.tt("messages:vMessages-header-other-results",e):"";this.$headerOtherResults.off().html(s)}},_initHeaders:function(){this.isSearchResults()&&(this.$headerTopResults=this.$headerTopResults||$("<div/>"),this.$headerOtherResults=this.$headerOtherResults||$("<div/>"),this._updateHeaders())},_destroyHeaders:function(){this.$headerTopResults&&(this.$headerTopResults.off().remove(),this.$headerTopResults=null),this.$headerOtherResults&&(this.$headerOtherResults.off().remove(),this.$headerOtherResults=null)},_updateHeaders:function(){this._positionHeaderBefore(this.$headerTopResults,".js-is-search-top-result:first"),this._positionHeaderBefore(this.$headerOtherResults,".js-messages-item:first"),this._redrawHeaderTopResults(),this._redrawHeaderOtherResults()},_positionHeaderBefore:function(e,s){if(e){var t=this.$node.find(".js-messages-list").find(s);t.length?e.next()[0]!==t[0]&&e.insertBefore(t):e.off().remove()}}}})},3135:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(83),i=t.n(a),n=t(325),o=t(3136),r=t(439),d=t(426);!(function(){ns.ViewCollection.edefine("messages",{models:{settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"onToggleCompactMode"},messages:{"ns-model-changed":"keepValid","ns-model-insert":"onInsertMessages","ns-model-remove":"onRemoveMessages"},"messages-checked":{"run-action":"_runAction","ns-model-destroyed":!1,"ns-model-changed":!1},"typefilter-tabs-state":!1,"scroller-messages":!1},split:{byModel:"messages",intoViews:function(){return"messages-item-wrap"}},paramsRewrite:function(e){return Daria.is3pane()&&delete e.thread_id,e},events:{"ns-view-init":"oninit","ns-view-htmlinit":"_onHtmlInit","ns-view-hide":"_onHide","ns-view-show":"_onShow","ns-view-touch":"_onTouch","ns-view-htmldestroy":"_onHtmlDestroy","ns-page-after-load@init":"invalidateUnreadMessages","ns-page-after-load@show":"scrollToMessageDebounce","daria:vMessages:invalidate@init":"invalidate","daria:vMessages:recalculate@show":"_recalculateMessages","daria:vMessages:deselect@show":"deselect","daria:vMessages:closeWithShortcut@show":"onCloseWithShortcut","daria:vMessages:selectAll@show":"selectAll","daria:vMessages:selectAllInFolder":"selectAllInFolder","daria:vToolbarButton:label@show":"_onLabelToolbarButton","daria:vToolbarButton:unlabel@show":"_onUnlabelToolbarButton","daria:vToolbarButton:move@show":"_onMoveToolbarButton","daria:vToolbarButton:archive@show":"_onArchiveToolbarButton","daria:vToolbarButton:infolder@show":"_onInfolderToolbarButton","daria:vToolbarButton:tospam@show":"_onTospamToolbarButton","daria:vToolbarButton:notspam@show":"_onNotspamToolbarButton","daria:vToolbarButton:sendon@show":"_onSendonToolbarButton","daria:vToolbarButton:reply-tmpl@show":"_onReplyTmplToolbarButton","daria:vToolbarButton:deselect@show":"deselect","daria:vToolbarButton:select-all@show":"selectAll","daria:vMessagesWrap:messages-scroll-load@show":"_onMessagesScrollLoad","daria:vMessagesPager:messages-load@show":"_onMessagesLoad","dragndrop.drop@show":"_onDrop","resize@show window":"_onResizeWindow","layout-ratio-changed":"fillMessagesList","daria:folder-remove-done@show":"_onFolderRemove","daria:label-remove-done@show":"_onLabelRemove","daria:MOPS:action-complete@show":"_onActionComplete"},ctor:function(){this._onMessagesScrollLoad=_.debounce(this._onMessagesLoad.bind(this),50),this.scrollToMessageDebounce=_.debounce(this.scrollToMessage.bind(this),10)},yateModule:"messages",methods:{HEIGHT_MESSAGE_SNIPPET:39,_openMessageState:null,_itemsListChanged:!1,OPEN_MESSAGE_OFFSET_TOP:8,_recalculateMessages:function(){this.isUnreadList()&&ns.forcedRequest([this.getModel("messages")])},onInsertMessages:function(e,s){var t=this.getMessagesCheckedInstance();(t.isFolderSelected()||t.isListSelected())&&s.forEach((function(e){t.check(e,!0)})),this.forceUpdate(),this._itemsListWillUpdate()},onRemoveMessages:function(e,s){var t=ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,"trash"),a=ns.page.current.params.thread_id||ns.page.current.params.ids;t&&a&&s.some((function(e){return a===e.params.ids}))?ns.page.go(Daria.Page.generateUrl.closeMessage()):this.forceUpdate(),this._itemsListWillUpdate()},_onActionComplete:function(){this.loadMoreMessagesIfNeed()},loadMoreMessagesIfNeed:function(){var e=this.getModel("messages"),s=e.models.length,t=this.getModel("settings").getSetting("messages_per_page");e.canLoadMore()&&s<Math.round(t/2)&&this.getModel("messages").loadMore()},onCloseWithShortcut:function(){var e=this.getOpenMessageState();if(e){var s=ns.Model.get("message",{ids:e});s&&s.getThreadCount()>1&&Jane.c("Треды","Закрытие треда","Закрытие по хоткею"),ns.page.go(Daria.Page.generateUrl.closeMessage())}},oninit:function(){this.isSearchResults()&&this._startSearchScenarioIfNotActive()},_onHtmlInit:function(){this._htmlInited=!0;var e=this.params;$(".b-search-not-found").length?Jane.c(["Пейджер по датам","Ничего не нашлось"]):e.datePager&&Jane.c(["Пейджер по датам","Страница с результатами поиска"])},_onShow:function(e,s,t){this._shown=!0,this.logTimings(t,i.a.messages),this._cbt=new Daria.CBT(this.$node,{targetSelector:".js-cbt-item-target"});var a={$node:this.$node,selector:".js-message",mMessagesChecked:this.getModel("messages-checked")};this._cmBaseBindMenuableElements(a),this.isSearchResults()&&(Daria.React.saveShowSearchResultsTimestamp(),this._startSearchScenarioIfNotActive(),this._searchScenarioSuccessStep());var n=ns.page.current.params.category||"all";Daria.areTabsVisible()&&this.getModel("typefilter-tabs-state").isTabEnabled(n)&&this.sendTabMetrics(),this.loadMoreMessagesIfNeed(),Daria.MessagesLogger.log(this.getModel("messages").models)},_startSearchScenarioIfNotActive:function(){this.scenarioManager.hasActiveScenario(n.f)?this._initialScenario=this.scenarioManager.getActiveScenario(n.f):this._initialScenario=this.scenarioManager.startScenario(n.f,r.b)},_searchScenarioSuccessStep:function(){if(this.scenarioManager.hasActiveScenario(n.f)){var e=this.scenarioManager.getActiveScenario(n.f),s=e.getTimeFromStart();e.logStep(o.a,{duration:s})}},finishSearchScenarioOnLeave:function(){var e=this.scenarioManager.hasActiveScenario(n.f)&&this.scenarioManager.getActiveScenario(n.f),s=this._initialScenario!==e;if(this._initialScenario=null,e&&!s){var t=d.f;Daria.isSearchPage()?t=d.a:Daria.isComposePage()?t=d.g:Daria.isMessageOpenedInList()||Daria.isMessagePage()?t=d.h:Daria.isMessagesListPage()&&(t=d.e),this.scenarioManager.finishScenarioIfActive(n.f,t)}},__countShowLabelPromoMetrics:Daria.memoizeMetricsById([],(function(){return this.__uniqueId}),(function(){Jane.c(["Промо меток","Писем с такой меткой нет","показ блока"])})),_onTouch:function(){var e=this.getModel("messages"),s=e.isEmptyList();Daria.is2pane()&&this.params.current_label&&s?this.__countShowLabelPromoMetrics():Daria.is2pane()&&!Daria.isFullThreadPage()||(s||this.fillMessagesList(),ns.events.trigger("mail:splitter:toggleOnePaneMode",s)),this._moveDynamicNodes()},_moveDynamicNodes:function(){this._triggerItemsListUpdated()},_onHide:function(){this.scrollToMessageDebounce.cancel(),this._shown=!1,this._cbt&&this._cbt.destroy(),this.resetOpenMessageState(),this._cmBaseUnbindMenuableElements(),this.finishSearchScenarioOnLeave()},deselect:function(){this.getMessagesCheckedInstance().resetChecked()},selectAll:function(){this.getMessagesCheckedInstance().selectList()},selectAllInFolder:function(){if(this.params.current_folder){this.getMessagesCheckedInstance().selectFolder(this.params.current_folder)}},_onMessagesLoad:function(){!this.__lockMessagesLoad&&this.getModel("messages").canLoadMore()&&(this.__lockMessagesLoad=!0,ns.events.trigger("daria:vMessages:messages-load-start"),this.getModel("messages").loadMore().then((function(e){ns.Model.get("messages-pager",ns.page.current.params).invalidate(),this.__lockMessagesLoad=!1,ns.events.trigger("daria:vMessages:messages-load-stop"),Daria.MessagesLogger.log(e)}),this))},getMessagesCheckedInstance:function(){return this.getModel("messages-checked")},_onToolbarButton:function(e,s,t){var a=this;if(s=s||{},t=t||{},"move"===e&&ns.Model.get("folders").isArchive(s.fid)&&(e="archive"),!s._viewKey||s._viewKey===this.key){var i;t.refreshImmediately&&(i=this);var n=s.mMessagesChecked||this.getMessagesCheckedInstance(!0),o=n.getIds(e,s),r=Daria.MOPS.updateHelper(e,n,s,i);if(r){var d=ns.Model.get("mops-confirmation").getMops().action;return r.then((function(){if(("archive"===e||d)&&a.deselect(),!t.refreshImmediately&&!t.preventUpdate&&"label"!==e&&"unlabel"!==e)if(Daria.is3pane()){var i=Daria.messages.whereToGoAfterMove(e,n,_.extend({ids:o},s));ns.page.go(i.where)}else ns.page.go();ns.events.trigger("daria:vToolbarButton:loader:end"),$(document).trigger("b-mail-dropdown-closeall")})),"archive"===e||d||(n.isFolderSelected()||["remove","move","tospam","notspam","infolder"].indexOf(e)>-1||["mark","unmark"].indexOf(e)>-1&&!Daria.is3pane()?a.deselect():n.touch()),r}}},_scrollUpOnActionComplete:function(){ns.events.once("daria:MOPS:action-complete",(function(){$(window).scrollTop(0)}))},_onReplyTmplToolbarButton:function(e,s){this._replyHelper("reply-tmpl",s),this._scrollUpOnActionComplete()},_onSendonToolbarButton:function(e,s){this._replyHelper("sendon",s),this._scrollUpOnActionComplete()},_onDeselect:function(){$(document).trigger("b-mail-dropdown-closeall"),ns.events.trigger("daria:vMessages:deselect")},_onLabelToolbarButton:function(e,s){this._onToolbarButton("label",s,{preventUpdate:!0,_viewKey:s._viewKey})},_onUnlabelToolbarButton:function(e,s){this._onToolbarButton("unlabel",s,{preventUpdate:!0,_viewKey:s._viewKey})},_onTospamToolbarButton:function(e,s){this._onToolbarButton("tospam",s)},_onNotspamToolbarButton:function(e,s){this._onToolbarButton("notspam",s)},_onArchiveToolbarButton:function(e,s){this._onToolbarButton("archive",s)},_onInfolderToolbarButton:function(e,s){this._onToolbarButton("infolder",s)},_onMoveToolbarButton:function(e,s){this._onToolbarButton("move",s,{refreshImmediately:!0})},_onRemoveToolbarButton:function(e,s){this._onToolbarButton("remove",s)},_onMarkToolbarButton:function(e,s){this._onToolbarButton("mark",s,{preventUpdate:!0})},_onUnmarkToolbarButton:function(e,s){this._onToolbarButton("unmark",s,{preventUpdate:!0})},fillMessagesList:function(){this.isVisible()&&this._canFillMessagesList()&&this._onMessagesLoad()},_canFillMessagesList:function(){var e=this.getModel("scroller-messages");if(Daria.is2pane()){return this.$node.rect().bottom<=e.getHeight()}return e.getScrollHeight(!0)<=e.getOffsetHeight(!0)},_onResizeWindow:function(){Daria.is3pane()&&(this._lazyOnResize||(this._lazyOnResize=_.debounce((function(){this.fillMessagesList(),Daria.is3pv()&&ns.events.trigger("mail:splitter:update")}),100)),this._lazyOnResize())},_runAction:function(e,s){this._onToolbarButton(s.action,s.params)},_onFolderRemove:function(e,s){this.params.current_folder===s&&ns.page.go(ns.router.generateUrl("messages",{current_folder:ns.Model.get("folders").getFidBySymbol("inbox")}))},_onLabelRemove:function(e,s){this.params.current_label===s&&ns.page.go(ns.router.generateUrl("inbox"))},isUnreadList:function(){return"only_new"===this.params.extra_cond},isSearchResults:function(){return this.getModel("messages").isSearch()},invalidateUnreadMessages:function(){this.isUnreadList()&&!this.isVisible()&&this.getModel("messages").invalidate()},getOpenMessageState:function(){var e=ns.page.current.params;return Daria.Page.isParamsForSingleThread(e)?e.ids||"":e.ids||e.thread_id||""},resetOpenMessageState:function(){this._openMessageState=null},scrollToMessage:function(){if(Daria.is2pane()){var e=this.getOpenMessageState();if(e!==this._openMessageState){var s;e?(s=this.$node.find(".js-message-wrap-"+e),this.scrollMessageIntoViewport(s,!0)):!e&&this._openMessageState&&(s=this.$node.find(".js-message-wrap-"+this._openMessageState),this.scrollMessageIntoViewport(s,!1),this.highlightClosedMessage(s)),ns.events.trigger("daria:vMessages:scroll"),this._openMessageState=e}}},scrollMessageIntoViewport:function(e,s){var t=e.offset();if(t){var a=ns.Model.get("scroller-messages"),i=a.getScrollTop(),n=a.getHeight(),o=i+n,r=t.top,d=!1;if(s){var l=r-i;d=!(l>2*this.HEIGHT_MESSAGE_SNIPPET&&l<n/3)}else d=!(i<r&&r<o);if(d){var g=2*this.HEIGHT_MESSAGE_SNIPPET,c=r-g;a.setScrollTop(c,!0)}}},highlightClosedMessage:function(e){e.addClass("is-highlight"),$.Transitions.animFrame((function(){$.Transitions.animFrame((function(){e.removeClass("is-highlight")}))}))},onToggleCompactMode:function(){Daria.is2pane()&&this.$node.find(".js-messages-list").toggleClass("mail-MessagesList_height_small",Daria.CompactMode.isCompactMessagesList())},getFocusableChildren:function(){var e=[];return this.forEachValidItem((function(s){e=e.concat(s.getFocusableChildren())})),e},getTabCategory:function(){return ns.page.current.params.category||"all"},sendTabMetrics:Daria.memoizeMetricsById([],(function(){return this.getTabCategory()}),(function(){var e=this.getModel("typefilter-tabs-state").getMetrikaTitle(this.getTabCategory()),s=this.getModel("messages").isEmptyList(),t=s?"Показ промо":"Показ таба с письмами";Jane.c("Табы",e,t)})),_itemsListWillUpdate:function(){this._itemsListChanged=!0,ns.events.trigger("vMessages:items-list-will-update")},_triggerItemsListUpdated:function(){this._itemsListChanged&&(ns.events.trigger("vMessages:items-list-updated"),this._itemsListChanged=!1,Daria.MessagesLogger.log(this.getModel("messages").models))}}},"messages-headers-mixin","message-actions","context-menu-mixin-messages","scenario-manager-mixin",ns.ViewCollection)})()},3136:function(e,s,t){"use strict";t.d(s,"a",(function(){return a}));var a="successful-render"},3137:function(e,s){yr.externals["date-pager-url"]=function(e){var s;return s=e?no.extend({},ns.page.current.params,e):ns.page.current.params,ns.router.generateUrl("messages",s)},yr.externals.json=function(e){return JSON.stringify(e[0].data)},yr.externals["messages-item-format-date"]=function(e){var s=yr.nodeset2data(e),t=new Date,a=new Date(s.ts);return Jane.Date.isSameDay(t,a)?Jane.Date.format("%R",s.ts):t.getFullYear()!==a.getFullYear()?s.short:Jane.Date.format("%Date_df",s.ts)},yr.externals["widget-entity"]=function(e){var s={man:"Widgets-Person",plane:"Widgets-PlaneOneWay",planes:"Widgets-PlaneBothWays"};return e.replace(/&([a-z]+);/g,(function(e,t){var a=s[t];return a?'<svg xmlns="http://www.w3.org/2000/svg" class="svgicon svgicon-mail--'+a+'"><use xlink:href="#svgicon-mail--'+a+'"></use><rect height="100%" width="100%" style="fill: transparent;"></rect></svg>':"&"+t+";"}))},yr.externals["is-corp-email"]=function(e){return Daria.email.isCorp(e)},yr.externals["show-taksa-widgets"]=function(e){return Daria.Widgets.shouldShowTaksaWidgets(ns.Model.get("message",{ids:e}))},yr.externals["show-widgets-decor"]=function(){return ns.Model.get("settings").getSign("show_widgets_decor")},yr.externals["show-widgets-buttons"]=function(){return ns.Model.get("settings").getSign("show_widgets_buttons")}},3138:function(e,s,t){t(3139),t(3140),t(3141),ns.events.on("daria:vSetupOther:inboxattachs-changed",(function(){ns.Model.invalidate("messages")}))},3139:function(e,s){Daria.CBS=function(){this._mMessagesChecked=ns.Model.get("messages-checked",ns.page.current.params),this._mFocus=ns.Model.get("focus")},Daria.CBS.prototype.start=function(e){this._start=e,this._action=!this._mMessagesChecked.isCheckedByMid(this._start),this._previous=[]},Daria.CBS.prototype.getStart=function(){return this._start},Daria.CBS.prototype.select=function(e){var s=this._mFocus.getRange(this._start,e),t=this._action;if(this._checkByRange(s,t),this._previous.length){var a=_.difference(this._previous,s);this._checkByRange(a,!t)}this._previous=s},Daria.CBS.prototype.selectWithShift=function(e){for(var s=this._mMessagesChecked,t=s.getLastChecked(),a=t.params.ids,i=this._mFocus.getRange(a,e),n=!1,o=0,r=i.length;o<r;o++){var d=i[o].getModel("message");if(!s.isChecked(d)){n=!0;break}}this._checkByRange(i,n)},Daria.CBS.prototype._checkByRange=function(e,s){var t=this._mMessagesChecked;if(e.forEach((function(e){t.check(e.getModel("message"),s)})),e.length>0){var a=_.last(e);t.setLastChecked(a.getModel("message"))}}},3140:function(e,s){!(function(){var e={itemSelector:".js-cbt-item",checkboxSelector:".js-cbt-item-checkbox",targetSelector:"",level2Selector:".js-cbt-group",onPotentialDragNDrop:no.nop},s={mouseDown:"mousedown.cbt",mouseUp:"mouseup.cbt",mouseMove:"mousemove.cbt","daria:cbt:mousedown":"daria:cbt:mousedown"};Daria.CBT=function(s,t){this.options=_.extend({},e,t),this._$node=$(s),this._init()},Daria.CBT.prototype.destroy=function(){this._$node.off(".cbt"),this.$document.off(".cbt")},Daria.CBT.prototype.$document=$(document),Daria.CBT.prototype._init=function(){this._$node.on(s.mouseDown,this.options.targetSelector,this._onItemMouseDown.bind(this))},Daria.CBT.prototype.startSelection=function(e){var s=this._getCBTItem(e);return!!s&&(this._cbs=new Daria.CBS,this._cbs.start(s.dataset.id),!0)},Daria.CBT.prototype.selectByRange=function(e){var s=e.dataset.id;this._cbs.getStart()!==s&&this._cbs.select(s)},Daria.CBT.prototype._onItemMouseDown=function(e){if(1!==e.which||2===e.buttons)return!1;ns.events.trigger(s["daria:cbt:mousedown"]);var t=e.target.className;if("string"==typeof t&&t.indexOf("b-label")>-1)return!0;this._onMouseDown(e)},Daria.CBT.prototype._onMouseDown=function(e){this.startSelection(e.target)&&(e.preventDefault(),this.$document.on(s.mouseMove,this._doMouseSelection.bind(this)).on(s.mouseUp,this._stopMouseSelection.bind(this)))},Daria.CBT.prototype._doMouseSelection=function(e){e.stopPropagation(),e.preventDefault();var s=this._getCBTItem(e.target);s&&this.selectByRange(s)},Daria.CBT.prototype._stopMouseSelection=function(e){e.stopPropagation(),e.preventDefault(),this._cbs=null,this.$document.off(".cbt")},Daria.CBT.prototype._getCBTItem=function(e){var s=$(e).closest(this.options.itemSelector)[0];return s||null}})()},3141:function(e,s){Daria.messages.params4SimplePath=function(e){var s={current_folder:null,"hide-firstline":null,threaded:null};Daria.is3pane()&&(s.ids=null,s.thread_id=null);for(var t in e)if("_"!==t.charAt(0)&&!(t in s))return!1;return"current_folder"in e},Daria.messages.params4SimpleLabel=function(e){var s={current_label:null,important:null};Daria.is3pane()&&(s.ids=null,s.thread_id=null);for(var t in e)if("_"!==t.charAt(0)&&!(t in s))return!1;return"current_label"in e}},325:function(e,s,t){"use strict";function a(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}t.d(s,"a",(function(){return n})),t.d(s,"e",(function(){return o})),t.d(s,"c",(function(){return r})),t.d(s,"d",(function(){return d})),t.d(s,"f",(function(){return l})),t.d(s,"b",(function(){return g}));var i,n="compose-scenario",o="message-view-scenario",r="mark-as-read",d="mark-as-unread",l="search-scenario",g=(i={},a(i,n,"web_quality_metrics_log"),a(i,r,"web_quality_metrics_for_mark_mops"),a(i,d,"web_quality_metrics_for_mark_mops"),a(i,o,"web_quality_message_reading"),a(i,l,"web_quality_search"),i)},376:function(e,s){e.exports={CLICK:"click",HOTKEY:"hotkey"}},392:function(e,s,t){"use strict";t.d(s,"c",(function(){return a})),t.d(s,"a",(function(){return i})),t.d(s,"d",(function(){return n})),t.d(s,"b",(function(){return o}));var a="close-and-open-another-message",i="close-and-go-to-another-messages-list",n="close-expanded",o="close-and-go-to-another-page"},397:function(e,s,t){"use strict";t.d(s,"b",(function(){return a})),t.d(s,"c",(function(){return i})),t.d(s,"d",(function(){return n})),t.d(s,"e",(function(){return o})),t.d(s,"k",(function(){return r})),t.d(s,"l",(function(){return d})),t.d(s,"h",(function(){return l})),t.d(s,"i",(function(){return g})),t.d(s,"f",(function(){return c})),t.d(s,"g",(function(){return h})),t.d(s,"n",(function(){return m})),t.d(s,"m",(function(){return u})),t.d(s,"j",(function(){return f})),t.d(s,"a",(function(){return p}));var a="messages-list-message-click",i="messages-list-message-hotkey",n="messages-list-thread-click",o="messages-list-thread-hotkey",r="thread-message-click",d="thread-message-hotkey",l="message-prev-click",g="message-prev-hotkey",c="message-next-click",h="message-next-hotkey",m="thread-prev-click",u="thread-next-click",f="message-right-column-message-click",p="direct-url"},426:function(e,s,t){"use strict";t.d(s,"g",(function(){return a})),t.d(s,"e",(function(){return i})),t.d(s,"f",(function(){return n})),t.d(s,"a",(function(){return o})),t.d(s,"h",(function(){return r})),t.d(s,"b",(function(){return d})),t.d(s,"c",(function(){return l})),t.d(s,"d",(function(){return g}));var a="go-to-compose",i="go-to-another-messages-list",n="go-to-another-page",o="additional-search",r="open-message",d="cancel-search-click",l="cancel-search-hotkey",g="empty-search"},439:function(e,s,t){"use strict";t.d(s,"f",(function(){return a})),t.d(s,"d",(function(){return i})),t.d(s,"e",(function(){return n})),t.d(s,"a",(function(){return o})),t.d(s,"b",(function(){return r})),t.d(s,"c",(function(){return d}));var a="suggest-click",i="search-button-click",n="search-field-hotkey",o="additional-parameters-click",r="direct-url",d="return-to-search"},519:function(e,s){e.exports={PREV:"prev",NEXT:"next"}}});